# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem				1.0
PortGroup				python27 1.0

name					py27-numpy
epoch					20100319
version					1.4.1
revision				1
categories				python
platforms				darwin
maintainers				nomaintainer
description				Core utilities for the scientific library scipy
long_description		${description}

homepage				http://numpy.scipy.org/
master_sites			sourceforge:numpy
distname				numpy-${version}

checksums				md5 5c7b5349dc3161763f7f366ceb96516b \
						sha1 ec6078aa09acbcca3d90f9f36353fc83e7e1daa0 \
						rmd160 a0bbebd1138ffc93517095e3c06459cd9744a9d6

patchfiles				patch-f2py_setup.py.diff \
						patch-system_info.py.diff \
						patch-fcompiler_g95.diff

depends_lib-append		port:fftw-3 \
						port:py27-nose \
						port:atlas

build.env-append		ATLAS=${prefix}/lib \
						LAPACK=${prefix}/lib \
						BLAS=${prefix}/lib \
						CC="${worksrcpath}/c-wrapper" \
						CXX="${worksrcpath}/c++-wrapper" \
						F77="${worksrcpath}/f-wrapper" \
						F90="${worksrcpath}/f-wrapper"

destroot.env-append		ATLAS=${prefix}/lib \
						LAPACK=${prefix}/lib \
						BLAS=${prefix}/lib \
						CC="${worksrcpath}/c-wrapper" \
						CXX="${worksrcpath}/c++-wrapper" \
						F77="${worksrcpath}/f-wrapper" \
						F90="${worksrcpath}/f-wrapper"

# Variants

variant no_gcc description {No gcc compiler (disables fortran code)} {

}

if {![variant_isset gcc45] && \
	![variant_isset gcc44] && \
	![variant_isset gcc43] &&
	![variant_isset no_gcc]} { default_variants +gcc44 }

variant gcc45 conflicts gcc43 gcc44 description {Uses gcc45} {
	depends_lib-append	port:gcc45
	configure.compiler	macports-gcc-4.5
depends_skip_archcheck gcc46
}
variant gcc44 conflicts gcc43 gcc45 description {Uses gcc44 (default)} {
	depends_lib-append	port:gcc44
	configure.compiler	macports-gcc-4.4
depends_skip_archcheck gcc44
}

variant gcc43 conflicts gcc44 gcc45 description {uses gcc43} {
	depends_lib-append	port:gcc43
	configure.compiler	macports-gcc-4.3
depends_skip_archcheck gcc43
}

variant no_atlas description {Do not use the macports atlas libs} {
	build.env-delete	ATLAS=${prefix}/lib \
						LAPACK=${prefix}/lib \
						BLAS=${prefix}/lib

	destroot.env-delete ATLAS=${prefix}/lib \
						LAPACK=${prefix}/lib \
						BLAS=${prefix}/lib
	depends_lib-delete  port:atlas
}

variant universal {
	patchfiles-append   patch-setup.py.diff
}

pre-patch {
	ui_debug ("Generating wrappers")
	file copy -force ${filespath}/wrapper ${worksrcpath}/c-wrapper
	file copy -force ${filespath}/wrapper ${worksrcpath}/c++-wrapper
	file copy -force ${filespath}/wrapper ${worksrcpath}/f-wrapper

	reinplace "s|+++|\\\\.c|" ${worksrcpath}/c-wrapper
	reinplace "s/+++/(\\\\.cxx|\\\\.C|\\\\.cc)/" ${worksrcpath}/c++-wrapper
	reinplace "s|+++|\\\\.f|" ${worksrcpath}/f-wrapper

	reinplace "s|___|${prefix}|" ${worksrcpath}/c-wrapper
	reinplace "s|___|${prefix}|" ${worksrcpath}/c++-wrapper
	reinplace "s|___|${prefix}|" ${worksrcpath}/f-wrapper

	if {[variant_isset gcc45]} {
		reinplace "s|@@@|gcc-mp-4.5|" ${worksrcpath}/c-wrapper
		reinplace "s|@@@|g++-mp-4.5|" ${worksrcpath}/c++-wrapper
		reinplace "s|@@@|gfortran-mp-4.5|" ${worksrcpath}/f-wrapper
	} elseif {[variant_isset gcc44]} {
		reinplace "s|@@@|gcc-mp-4.4|" ${worksrcpath}/c-wrapper
		reinplace "s|@@@|g++-mp-4.4|" ${worksrcpath}/c++-wrapper
		reinplace "s|@@@|gfortran-mp-4.4|" ${worksrcpath}/f-wrapper
	} elseif {[variant_isset gcc43]} {
		reinplace "s|@@@|gcc-mp-4.3|" ${worksrcpath}/c-wrapper
		reinplace "s|@@@|g++-mp-4.3|" ${worksrcpath}/c++-wrapper
		reinplace "s|@@@|gfortran-mp-4.3|" ${worksrcpath}/f-wrapper
	}
	xinstall -m 755 ${worksrcpath}/c-wrapper ${worksrcpath}
	xinstall -m 755 ${worksrcpath}/c++-wrapper ${worksrcpath}
	xinstall -m 755 ${worksrcpath}/f-wrapper ${worksrcpath}
}

post-patch {
	reinplace "s|@@MPORTS_PYTHON@@|${python.bin}|" \
		${worksrcpath}/numpy/f2py/setup.py
}

livecheck.type  regex
livecheck.url   http://sourceforge.net/projects/numpy/files/
livecheck.regex "files\/NumPy\/(\\d+(?:\\.\\d+)*)\/numpy"
