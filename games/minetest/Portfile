# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

# NOTE: See the comprised 'subport' definitions of this Minetest Portfile below.
#       To install 'minetest' refer to the applicable 'subport' of this Portfile.

PortSystem              1.0
PortGroup               github 1.0
PortGroup               cmake  1.1

compiler.cxx_standard   2011
compiler.thread_local_storage  yes

name                    minetest
set github-author       ${name}
set github-project      ${name}

# Set a main revison for all subport definitions.  However, a subport might get an extra revision.
# NOTE: The additional port "revision 2" identifier in down below text of this Portfile
#       shall be deleted after the MT 5.7.0 release.
#       However, this main revision shall remain and be continuously amended as applicable.
revision                0


# Provide this main body part to the port only.  Any subport amends this respectively below.
if { ${subport} eq ${name} } {

# Make use of the most recent MT core release version at GitHub.  This is for livecheck also.
    github.setup        ${github-author} ${github-project} 5.6.1

# However, the MT game version could be different from the MT and subport version
    set game_version    ${github.version}

# Rationale:  The Minetest application evidently binds to a specific IrrLichtMT fork version.
# Furthermore, many MT players tend to stick with a certain MT version as long as possible,
# because their obvious goal is having fun in a self-built kingdom inside a MT game world.
# However, due to technical quirks and compatibility issues a migration of a MT game world,
# including virtual assets built by same players for hours or even years, would be risky.

# The MT core needs the MT game and to add on more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
    set main_distfile   ${distfiles}

# then add another distfile, with a direct URL as can't use the github PG again
    set game_distfile   ${game_version}${extract.suffix}
    set game_mastersite https://github.com/minetest/minetest_game/archive/

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Checksums for both the current MT core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  7b32331e0007f29003107592522d1c906935e44d \
                        sha256  425d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    9925064 \
                        ${game_distfile} \
                        rmd160  73d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  5dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    2590582
}


# Provide a part of the main body to the port and any subport respectively.

license                 LGPL-2.1+
categories              games
platforms               darwin
maintainers             @Zweihorn openmaintainer
description             open source infinite-world block sandbox game with survival and crafting

homepage                https://www.minetest.net


######
# START the comprised Minetest 'subport' definitions to this Portfile.
##

# New and improved approach with several 'subport' definitions as follows:
#
# 1. subport "minetest" is a stub and envelope which shall not be installed.
#
# 2. subport "minetest54" would provide legacy MT 5.4.0 ports by 'irrlicht' port. (FAIL)
#
# 3. subport "minetest55" provides legacy  MT 5.5.1 which depends on 'irrlicht 1.9.0mt6'.
#
# 4. subport "minetest56" provides stable MT 5.6.1 which depends on 'irrlicht 1.9.0mt8'.
#
# 5. subport "minetest57" provides unstable MT 5.7.0 and depends on 'irrlicht 1.9.0mt9'.
#
# 6. subport "minetest58" would provide unstable MT 5.8.0 depending on 'irrlicht 1.9.0mtX'
#    in the foreseeable future.
#
# NOTE: Beyond MT 5.8 dev the future of 'irrlicht 1.9.0mtX' might be unsure as
#       the MT core devs seek to fully integrate the former IrrLicht code into
#       the code base of MT core and/or might have the goal of SDL2 apparently.

# WIP - There will be variants ...


subport "${name}54" {

# The applicable MT 5.4 core release at GitHub.
    github.setup        ${github-author} ${github-project} 5.4.0

    known_fail          yes

# WIP - 'irrlicht' would need full XCode apparently and automatic build FAILS.

# However, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# The MT core needs the MT game and to add on more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
    set main_distfile   ${distfiles}

# Add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
    set game_distfile   ${game_version}${extract.suffix}
    set game_mastersite https://github.com/minetest/minetest_game/archive/

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Applicable checksums for both the MT 5.4 core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  8ab28fc0a50ff8bc37a3d46b7c4974f65ac20be5\
                        sha256  5ccca8c22491086105baea9964b619504ff4eb3e53bcf0762b76411fe7fa1e73 \
                        size    11205115 \
                        ${game_distfile} \
                        rmd160  e7d90f8c53c65bd57b1d9e35f03a40e3312c1181 \
                        sha256  520d2056085ec11e8806cf5a8f928537797d27a86704770bf408c113ea9881cb \
                        size    2474273

# NOTE: Minetest 5.4 and earlier had no IrrLichtMT fork version apparently.
    set port-irrlicht   port:irrlicht
# WIP - 'irrlicht' would need full XCode apparently and automatic build FAILS.
}


subport "${name}55" {

# The applicable MT 5.5 core release at GitHub.
    github.setup        ${github-author} ${github-project} 5.5.1

# However, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# The MT core needs the MT game and to add on more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
    set main_distfile   ${distfiles}

# Add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
    set game_distfile   ${game_version}${extract.suffix}
    set game_mastersite https://github.com/minetest/minetest_game/archive/

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Applicable checksums for both the MT 5.5 core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  7e20ef603e036bd28e3c63e2e12d4a2f2adf2300 \
                        sha256  7108c01554a975ca9ca0d75d150ac4d7ce42800e2ca7cc880100705156a24ebe \
                        size    9560030 \
                        ${game_distfile} \
                        rmd160  d92174c03c06086b73ad6e20375a528f9d707f05 \
                        sha256  5a24fec4ed838744906f020096c35616e7ba76eeec2b93b980a40af011107e7c \
                        size    2582897

# The Minetest program evidently binds to a specific IrrLichtMT fork version.
    set port-irrlicht   port:irrlichtmt-mt55
}


subport "${name}56" {

# NOTE: This is not redundant and is certainly worth the code because of:
#       1. Easier to copy and paste than to make extra complicated logical traps.
#       2. This copy will become the original to MT 5.6 after MT 5.7 release anyway.

# The applicable MT 5.5 core release at GitHub.
    github.setup        ${github-author} ${github-project} 5.6.1

# However, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# The MT core needs the MT game and to add on more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
    set main_distfile   ${distfiles}

# Add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
    set game_distfile   ${game_version}${extract.suffix}
    set game_mastersite https://github.com/minetest/minetest_game/archive/

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Checksums for both the current MT core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  7b32331e0007f29003107592522d1c906935e44d \
                        sha256  425d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    9925064 \
                        ${game_distfile} \
                        rmd160  73d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  5dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    2590582

# The Minetest program evidently binds to a specific IrrLichtMT fork version.
    set port-irrlicht   port:irrlichtmt-mt56
}


subport "${name}57" {

# The applicable MT 5.7 core release at GitHub.
    github.setup        ${github-author} ${github-project} 5.7.0

    known_fail          yes

# WIP - This is a stub and awaiting the MT 5.7 unstable release.  (ETA Feb 2023 ?!)

# However, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# The MT core needs the MT game and to add on more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
    set main_distfile   ${distfiles}

# Add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
    set game_distfile   ${game_version}${extract.suffix}
    set game_mastersite https://github.com/minetest/minetest_game/archive/

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# WIP - This is a fake and awaiting the MT 5.7 unstable release.  (ETA Feb 2023 ?!)
# NOTE: Non-applicable checksums for both the MT 5.7 core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  8b32331e0007f29003107592522d1c906935e44d \
                        sha256  825d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    8925064 \
                        ${game_distfile} \
                        rmd160  83d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  8dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    8590582

# The Minetest program evidently binds to a specific IrrLichtMT fork version.
    set port-irrlicht   port:irrlichtmt-mt57
}

##
# END of the 'subport' definitions and on to the common body of this Portfile below.
######


# Main body part to the port only.  Any subport amends this respectively below.
if { ${subport} eq ${name} } {

    PortGroup obsolete  1.0

    replaced_by         ${name}

    version             ${github.version}

# NOTE: Delete this revision identifier after the MT 5.7.0 release presumably.
#       This extra revision definition is needed to continue 'port upgrade outdated' for
#       the legacy MT 5.6 minetest single port.
    revision            2

    categories          games
    license             LGPL-2.1+

    homepage            https://www.minetest.net

# The Minetest program evidently binds to a specific IrrLichtMT fork version.
    set port-irrlicht   port:irrlichtmt
# NOTE: Obsolete definition 'port:irrlichtmt' needed for 'port -lint --nitpick' checks.

# Should not be removed.

}


# Continue the main body of the port and any subport respectively.

# rename directory - from github portgroup
post-extract {
    if {[file exists [glob -nocomplain ${workpath}/${github.author}-${github.project}-*]] && \
        [file isdirectory [glob -nocomplain ${workpath}/${github.author}-${github.project}-*]]} {
        move [glob ${workpath}/${github.author}-${github.project}-*] ${workpath}/${distname}
    }
}

if { ${subport} eq ${name} } {

# NOTE: Default description for the obsolete port would be: "minetest is replaced by minetest".
# Concatenates to: "minetest is replaced by minetest54, minetest55, minetest56, minetest57".
    long_description    ${description}54, ${name}55, ${name}56, ${name}57

} else {

    long_description    ${description} - \
                        This ${subport} depends on ${port-irrlicht} to provide the MT ${github.version} game. - \
                        Find more MT mods at <https://content.minetest.net/> and have fun.

}

depends_build-append    path:bin/doxygen:doxygen \
                        port:mesa

depends_lib-append      ${port-irrlicht} \
                        path:include/turbojpeg.h:libjpeg-turbo \
                        port:libogg \
                        port:libvorbis \
                        port:freetype \
                        port:gettext \
                        port:leveldb \
                        port:sqlite3 \
                        port:zstd \
                        path:lib/libluajit-5.1.2.dylib:luajit \
                        port:gmp \
                        port:curl \
                        port:jsoncpp \
                        port:spatialindex \
                        port:xorg-libX11 \
                        port:xorg-libXxf86vm

# see https://trac.macports.org/ticket/58315 - possibly fixable?
universal_variant       no
supported_archs         x86_64

# 001. the original build calls fixup_bundle to move all the deps into the app bundle.
#    this doesn't work correctly with macports destrooting, and isn't necessary for a macports install so deleted it
patchfiles-append       001-patch-src-CMakeLists-disable-bundlefixup.diff

# 002. patch to get the luajit include headers ahead of the system includes, or the build finds the
#    wrong lua headers if you have a newer version of lua installed
patchfiles-append       002-patch-cmake-Modules-FindLua-include-LUADIR-before-system.diff

# 003. patch main.cpp to not barf on the unrecognized command-line option -psn from Apple launch
patchfiles-append       003-patch-ignore-psn-option-mac-bundle.diff

configure.args-append   -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_INSTALL_PREFIX:PATH=${applications_dir} \
                        -DBUILD_UNITTESTS=OFF \
                        -DENABLE_UPDATE_CHECKER=OFF \
                        -DBUILD_CLIENT=ON \
                        -DBUILD_SERVER=ON \
                        -DENABLE_SOUND=ON \
                        -DENABLE_REDIS=OFF \
                        -DENABLE_POSTGRESQL=OFF \
                        -DENABLE_LEVELDB=ON \
                        -DENABLE_FREETYPE=ON \
                        -DENABLE_CURL=ON \
                        -DENABLE_GETTEXT=ON \
                        -DENABLE_SPATIAL=ON \
                        -DENABLE_SYSTEM_GMP=ON \
                        -DENABLE_SYSTEM_JSONCPP=ON \
                        -DCURSES_INCLUDE_PATH:FILEPATH=${prefix}/include \
                        -DENABLE_LUAJIT=ON \
                        -DLUA_INCLUDE_DIR:PATH=${prefix}/include/luajit-2.1 \
                        -DLUA_LIBRARY:FILEPATH=${prefix}/lib/libluajit-5.1.dylib \
                        -DVERSION_EXTRA=MacPorts-rev${revision}

post-destroot {
    move ${workpath}/minetest_game-${game_version}   ${destroot}${applications_dir}/minetest.app/Contents/Resources/games/minetest_game
}


# Main body part to the port only.  Any subport amended this respectively above.
# NOTE: Last not least: The late kill to the port and the early minetest57 subport ...
if { ${subport} eq ${name} || ${subport} eq "${name}57" } {

    fetch {}
    extract {}
    use_configure no
    build {}
    destroot {}
}
