# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

# Minetest (MT): See the comprised 'subport' definitions of this Minetest Portfile below.
# Refer to the applicable 'subport' in this Portfile to make most of your installation.

PortSystem              1.0
PortGroup               github 1.0
PortGroup               cmake  1.1

compiler.cxx_standard   2011
compiler.thread_local_storage  yes

name                    minetest
set mt-name             ${name}
set github_author       ${name}
set github_project      ${name}

# Set a main revison for all subport definitions.  Any subport might get an extra revision.
# However, this main revision should be maintained as applicable.
revision                2

# This port provides several versions of MT clients and additionally MT dedications by
# concurrently install of selectable subport definitions as well as some variants.

# Flags for preliminary setup of available MT dedications: MT-Developer, MT-Server
set mt-devel            no
set mt-server           no

# Subport flags for preliminary setup of available MT versions: MT 5.4, 5.5, 5.6, 5.7
set mt57                no
set mt56                no
set mt55                no
set mt54                no

if { ${subport} eq ${mt-name} }  {
    set mt00            yes
} else {
    set mt00            no
}

# Exclusive preliminary flag according to the current stable subport release of 'minetest'.
set mt56-stable         no

# Exclusive preliminary flag according to MT 5.4 legacy 'minetest' and 'port:irrlicht'.
set mt54-irrport        no

# WIP - Currently, there seems to be no need for a disruptive change (yet?).
set disruptive          no

if { ${mt00} && ${disruptive} }  {
# Portfile body specific to the general port.  Any subport amends this respectively below.

    PortGroup           obsolete 1.0

    replaced_by         ${mt-name}

# NOTE: Obsolete port used for 'port checksum' and 'port livecheck' checks and acts as the
#       obviously required subport container and envelope to the subport definitions below.
}

# Provide a part to the general Portfile body.

license                 LGPL-2.1+
categories              games
platforms               darwin
maintainers             @Zweihorn openmaintainer
homepage                https://www.minetest.net
description             open source infinite-world block sandbox game with survival and crafting


# Rationale:  The Minetest application evidently binds to a specific IrrLichtMT fork version.
# Furthermore, many MT players tend to stick with a certain MT version as long as possible,
# because their obvious goal is having fun in a self-built kingdom inside a MT game world.
# However, due to technical quirks and compatibility issues a migration of a MT game world,
# including virtual assets built by same players for months or even years, would be risky.
# Thus the demand for MT versions old and new alike.  These could be installed concurrently.

# Provision of several 'subport' definitions as follows:
#
# 1. Port "minetest" is an envelope, could be installed and always remains for maintenance.
#
# 2. Subport "minetest54" could provide legacy MT 5.4.0 ports by 'irrlicht' port. (WIP)
#
# 3. Subport "minetest55" provides legacy  MT 5.5.1 which depends on 'irrlicht 1.9.0mt6'.
#
# 4. Subport "minetest56" provides stable MT 5.6.1 which depends on 'irrlicht 1.9.0mt8'.
#
# 5. Subport "minetest57" would provide unstable MT 5.7.0 and depends on 'irrlicht 1.9.0mt9'.
#
# 6. Subport "minetest58" would provide unstable MT 5.8.0 depending on 'irrlicht 1.9.0mtX'
#    in the foreseeable future.
#
# NOTE: Beyond MT 5.8 dev the future of 'irrlicht 1.9.0mtX' might be unsure as
#       the MT core devs seek to fully integrate the former IrrLicht code into
#       the code base of MT core and/or might have the goal of SDL2 apparently.


if { ${mt00} }  {
# Portfile body part to the port only.  Any subport amends this respectively below.

# Currently, the MT 5.6 core release at GitHub is most applicable.
    github.setup        ${github_author} ${github_project} 5.6.1

# The applicable MT game version could be different from the MT core version.
    set game_version    ${github.version}

# The current Minetest release depends on IrrLichtMT 1.9.0mt8 for a successful build.
    set irrlicht_version  1.9.0mt8

# MT stable rocks: The goal is to stay at MT stable until new MT stable release from upstream.
# Thus integrate applicable IrrLichtMT if incorrect version and/or 'irrlichtmt' became obsolete.
# Needs a 'port install minetest57-devel' to install MT 5.7.0 unstable until MT 5.7.1 stable.

# Check if the current 'irrlichtmt' meets the 'minetest' requirements.
    set found_version  [exec port -q info --version irrlichtmt]

# The stable Minetest 5.6+ depends on IrrLichtMT 1.9.0mt8 for a successful build.
# After MT 5.7.1 becomes stable change this to "1.9.0mtX", "mt57-stable yes" accordingly.
    if { (${found_version} ne "1.9.0mt8") || ${disruptive} }  {
        set mt56-stable  yes
    }
# NOTE: By "mt56-stable eq no" logic will "set port-irrlichtmt yes" afterwards accordingly.
}

# WIP - subport "${mt-name}57" {
#    set mt57            yes
#    set sub-servername  "${mt-name}57server"
#    revision            0
#}
# WIP - subport "${mt-name}57-devel" {
#    set mt57            yes
#    set mt-devel        yes
#    set sub-servername  "${mt-name}57server-devel"
#    revision            0
#}
# WIP - subport "${mt-name}57-server" {
#    set mt57            yes
#    set mt-server       yes
#    set sub-servername  "${mt-name}server57"
#    revision            0
#}

if { ${mt57} }  {

# The applicable MT 5.7 core release at GitHub.
    github.setup        ${github_author} ${github_project} 5.7.0
# WIP - This is a stub and awaiting the MT 5.7 unstable release.  (ETA Feb 2023 ?!)

# Again, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# Minetest 5.5+ depends on IrrLichtMT and integrates this into the subport.
    set irrlicht_version  1.9.0mt9

    name                ${subport}
}

subport "${mt-name}56" {
    set mt56            yes
    set sub-servername  "${mt-name}56server"
    revision            0
}
subport "${mt-name}56-devel" {
    set mt56            yes
    set mt-devel        yes
    set sub-servername  "${mt-name}56server-devel"
    revision            0
}
subport "${mt-name}56-server" {
    set mt56            yes
    set mt-server       yes
    set sub-servername  "${mt-name}server56"
    revision            0
}

if { ${mt56} || ${mt56-stable} }  {

# The applicable MT 5.6 core release at GitHub.
    github.setup        ${github_author} ${github_project} 5.6.1

# Again, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# Minetest 5.5+ depends on IrrLichtMT and integrates this into the subport.
    set irrlicht_version  1.9.0mt8

    name                ${subport}
}

subport "${mt-name}55" {
    set mt55            yes
    set sub-servername  "${mt-name}55server"
    revision            0
}
#subport "${mt-name}55-devel" {
#    set mt55            yes
#    set mt-devel        yes
#    set sub-servername  "${mt-name}55server-devel"
#    revision            0
#}
subport "${mt-name}55-server" {
    set mt55 yes
    set mt-server yes
    set sub-servername  "${mt-name}server55"
    revision            0
}

if { ${mt55} }  {

# The applicable MT 5.5 core release at GitHub.
    github.setup        ${github_author} ${github_project} 5.5.1

# Again, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# Minetest 5.5+ depends on IrrLichtMT and integrates this into the subport.
    set irrlicht_version  1.9.0mt6

    name                ${subport}
}

subport "${mt-name}54" {
    set mt54            yes
    set sub-servername  "${mt-name}54server"
    revision            0
}
# WIP - subport "${mt-name}54-devel" {
#    set mt54            yes
#    set mt-devel        yes
#    set sub-servername  "${mt-name}54server-devel"
#    revision            0
#}
subport "${mt-name}54-server" {
    set mt54            yes
    set mt-server       yes
    set sub-servername  "${mt-name}server54"
    revision            0
}

if { ${mt54} }  {

# The applicable MT 5.4 core release at GitHub.
    github.setup        ${github_author} ${github_project} 5.4.0

# WIP - Current 'irrlicht' would need full XCode apparently and automatic build check FAILS.
# However, the new maintainer had the legacy port running since MT 0.4.17 and stay tuned.

# Again, the applicable MT game version could be different from the subport version.
    set game_version    ${github.version}

# Minetest 5.4 depends on original IrrLicht 1.8.4 could integrate this into the subport.
    set irrlicht_version  1.8.4

    name                ${subport}

# Check if to use 'port:irrlicht' or if to integrate IrrLicht 1.8.4 from upstream legacy.
    set found_version  [exec port -q info --version irrlicht]

    if { (${found_version} eq ${irrlicht_version} ) }  {
        set mt54-irrport  yes
    }
}

# NOTE: All subport definitions have to be given above.

# Provide a part to the general Portfile body.

# The MT core needs the MT game and to add any more files to a GitHub portgroup download
# we have to cache the preset distfiles from the GitHub portgroup respectively.
set main_distfile       ${distfiles}

# MT game: add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
set game_distfile       ${game_version}${extract.suffix}
set game_mastersite     https://github.com/minetest/minetest_game/archive/refs/tags/

# IrrLichtMt: add another distfile, with a direct URL as reuse of the GitHub Portgroup fails.
set irrlicht_distfile     ${irrlicht_version}${extract.suffix}
set irrlicht_mastersite   https://github.com/minetest/irrlicht/archive/refs/tags/


if { ${mt54} && ! ${mt54-irrport} }  {
# IrrLicht: add another distfile, with a direct URL of its own.
    set irrlicht_distfile       irrlicht-${irrlicht_version}.zip
    set irrlicht_mastersite     https://downloads.sourceforge.net/irrlicht/
}

distfiles               ${main_distfile}:main \
                        ${game_distfile}:game \
                        ${irrlicht_distfile}:irrlicht

master_sites            ${github.master_sites}:main \
                        ${game_mastersite}:game \
                        ${irrlicht_mastersite}:irrlicht

set port-irrlichtmt     no

if { ${mt00} && ! ${mt56-stable} }  {
# Depend on IrrLichtMT port and reduced file downloads accordingly.

    set port-irrlichtmt yes

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Checksums for both the most current MT core and MT game respectively.
    checksums           ${main_distfile} \
                        rmd160  7b32331e0007f29003107592522d1c906935e44d \
                        sha256  425d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    9925064 \
                        ${game_distfile} \
                        rmd160  73d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  5dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    2590582
}

if { ${mt57} }  {
# WIP - This is a fake and awaiting the MT 5.7 unstable release.  (ETA Feb 2023 ?!)
# WIP - Non-applicable checksums for both the MT 5.7 core and MT game respectively as '000' is not allowed.
# Checksums for the unstable MT 5.7 core and MT 5.7 game and IrrLichtMT respectively.
    checksums           ${main_distfile} \
                        rmd160  8b32331e0007f29003107592522d1c906935e44d \
                        sha256  825d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    8925064 \
                        ${game_distfile} \
                        rmd160  83d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  8dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    8590582 \
                        ${irrlicht_distfile} \
                        rmd160  9b752b255cea2c443474f78aeadba244e8f584a2 \
                        sha256  a81b4c362d724ce4bdb2c8f60e31df0b1bff10302e7e0458248f9d609bd12f16 \
                        size    908173
# NOTE: However, the checksums for IrrLichtMT 1.9.0mt9 should be the correct ones already.
}

if { ${mt56} || ${mt56-stable} }  {
# Checksums for the stable MT 5.6 core and MT 5.6 game and IrrLichtMT respectively.
    checksums           ${main_distfile} \
                        rmd160  7b32331e0007f29003107592522d1c906935e44d \
                        sha256  425d8e9363212dcb5bc7986dd12460c9c3784aca22eb1b90dad6a7fc2c6ef546 \
                        size    9925064 \
                        ${game_distfile} \
                        rmd160  73d35423b856d141cebfa16396fe5dcf834dcf89 \
                        sha256  5dc857003d24bb489f126865fcd6bf0d9c0cb146ca4c1c733570699d15abd0e3 \
                        size    2590582 \
                        ${irrlicht_distfile} \
                        rmd160  f44c5373f97e435f543ea5b14ef3ba45d83a6200 \
                        sha256  27594242da8c7cc1e5ef45922e1dfdd130c37d77719b5d927359eb47992051e0 \
                        size    909733
}

if { ${mt55} }  {
# Applicable checksums for the MT 5.5 core and MT 5.5 game and IrrLichtMT respectively.
    checksums           ${main_distfile} \
                        rmd160  7e20ef603e036bd28e3c63e2e12d4a2f2adf2300 \
                        sha256  7108c01554a975ca9ca0d75d150ac4d7ce42800e2ca7cc880100705156a24ebe \
                        size    9560030 \
                        ${game_distfile} \
                        rmd160  d92174c03c06086b73ad6e20375a528f9d707f05 \
                        sha256  5a24fec4ed838744906f020096c35616e7ba76eeec2b93b980a40af011107e7c \
                        size    2582897 \
                        ${irrlicht_distfile} \
                        rmd160  14fa2a62cdb73e5761589d67a9baf238e47280d9 \
                        sha256  265b48cb58f18eb774955765b64667d775d17d3fab98b977c0707aa00284323e \
                        size    1001588

# WIP - Some issues with current macOS SDK 11 libraries apparently and the linker FAILS on main.
}

if { ${mt54} && ${mt54-irrport} }  {
# Minetest 5.4 using the applicable 'irrlicht' port obviously.

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game

# Applicable checksums for both the MT 5.4 core and MT 5.4 game respectively.
    checksums           ${main_distfile} \
                        rmd160  8ab28fc0a50ff8bc37a3d46b7c4974f65ac20be5\
                        sha256  5ccca8c22491086105baea9964b619504ff4eb3e53bcf0762b76411fe7fa1e73 \
                        size    11205115 \
                        ${game_distfile} \
                        rmd160  e7d90f8c53c65bd57b1d9e35f03a40e3312c1181 \
                        sha256  520d2056085ec11e8806cf5a8f928537797d27a86704770bf408c113ea9881cb \
                        size    2474273
}

if { ${mt54} && ! ${mt54-irrport} }  {
# Original IrrLicht.  Minetest 5.4 and earlier obviously had no IrrLichtMT fork version.

    distfiles           ${main_distfile}:main \
                        ${game_distfile}:game \
                        ${irrlicht_distfile}:irrlicht

    master_sites        ${github.master_sites}:main \
                        ${game_mastersite}:game \
                        ${irrlicht_mastersite}:irrlicht

# Applicable checksums for both the MT 5.4 core and MT 5.4 game and IrrLicht respectively.
    checksums           ${main_distfile} \
                        rmd160  8ab28fc0a50ff8bc37a3d46b7c4974f65ac20be5\
                        sha256  5ccca8c22491086105baea9964b619504ff4eb3e53bcf0762b76411fe7fa1e73 \
                        size    11205115 \
                        ${game_distfile} \
                        rmd160  e7d90f8c53c65bd57b1d9e35f03a40e3312c1181 \
                        sha256  520d2056085ec11e8806cf5a8f928537797d27a86704770bf408c113ea9881cb \
                        size    2474273 \
                        ${irrlicht_distfile} \
                        rmd160  275eb79193a330b3924166e9cac8d74d37990256 \
                        sha256  f42b280bc608e545b820206fe2a999c55f290de5c7509a02bdbeeccc1bf9e433 \
                        size    27927144

# This is for IrrLicht 1.8.5 if needed...
#                        ${irrlicht_distfile} \
#                        rmd160  84daa2521f039c21be659363af20941583782046 \
#                        sha256  effb7beed3985099ce2315a959c639b4973aac8210f61e354475a84105944f3d \
#                        size    21827696

# WIP - Some issues with current macOS SDK 11 libraries apparently and the linker FAILS on main.
}


# Provide a part to the general Portfile body.

post-extract {
# WIP - needs some reshuffle and adaption of the extra downloads: IrrLichtMT / IrrLicht

# Rename and move directory - from GitHub portgroup
    if { [file exists [glob -nocomplain ${workpath}/${github.author}-${github.project}-*]] && \
         [file isdirectory [glob -nocomplain ${workpath}/${github.author}-${github.project}-*]] }  {
        move [glob ${workpath}/${github.author}-${github.project}-*] ${workpath}/${distname}
    }

# Only if MT 5.4 extract - IrrLicht
    if { ${mt54} && ! ${mt54-irrport} && [file exists ${distpath}/irrlicht-${irrlicht_version}.zip] }  {
        set done  [exec /usr/bin/unzip -q ${distpath}/irrlicht-${irrlicht_version}.zip -d ${workpath}]
    }

# Rename and move directory - IrrLichtMT
    if { ! (${mt54} || ${port-irrlichtmt} || [file exists ${workpath}/${distname}/lib/irrlichtmt]) && \
         [file exists ${workpath}/irrlicht-${irrlicht_version}] && \
         [file isdirectory ${workpath}/irrlicht-${irrlicht_version}] && \
         [file exists ${workpath}/${distname}/lib] && [file isdirectory ${workpath}/${distname}/lib] }  {
        move ${workpath}/irrlicht-${irrlicht_version} ${workpath}/${distname}/lib/irrlichtmt
    }
# Rename and move directory - IrrLicht
    if { ${mt54} && ! ${mt54-irrport} && ! [file exists ${workpath}/${distname}/lib/irrlicht] && \
         [file exists ${workpath}/irrlicht-${irrlicht_version}] && \
         [file isdirectory ${workpath}/irrlicht-${irrlicht_version}] && \
         [file exists ${workpath}/${distname}/lib] && [file isdirectory ${workpath}/${distname}/lib] }  {
        move ${workpath}/irrlicht-${irrlicht_version} ${workpath}/${distname}/lib/irrlicht
    }
}

set descr_trailer   "Find more MT mods at <https://content.minetest.net/> and have fun."

if { ${mt00} && ${disruptive} } {
# Portfile body part to the obsolete port only.  Any subport amends this respectively below.
    long_description    ${description}54, ${mt-name}55, ${mt-name}56, ${mt-name}57 \
                        \n* Please install stable '${stable-subport}' or choose another at your deliberation. \
                        \n* ${descr_trailer}
# NOTE: Default description for the obsolete port would be: "minetest is replaced by minetest".
# Concatenates to: "minetest is replaced by minetest54, minetest55, minetest56, minetest57".

} else {
# Portfile body part to any other subport.

    if { ${port-irrlichtmt} } {
# Try to continue the 'irrlichtmt' as applicable.  This looks good for 'port upgrade outdated'
# but could trouble MT players not aware of the quirks and some risk to their beloved MT worlds.
        set descr_client_server  "depends on 'port:irrlichtmt' to provide the MT ${github.version} game."
# Make 'depends_lib-append' happen for 'port-irrlichtmt' by:
        depends_lib-append  port:irrlichtmt
    }

    if { ${mt54-irrport} } {
# Any MT 5.4 subport will use the applicable 'irrlicht' accordingly.
        set descr_client_server  "depends on 'port:irrlicht' to provide the MT ${github.version} game."
# Make 'depends_lib-append' happen for 'port-irrlicht' by:
        depends_lib-append  port:irrlicht
    }

    if { ${mt54} && ! (${mt54-irrport} || ${mt-server}) } {
# Any MT 5.4 subport will integrate the original IrrLicht by the applicable 'irrlicht_version'.
        set descr_client_server  "integrates IrrLicht ${irrlicht_version} to provide the MT ${github.version} game."
    }

    if { ! ${mt54} && ! ${port-irrlichtmt} } {
# Any other subport will integrate IrrLichtMT by the applicable 'irrlicht_version' accordingly.
# However, a MT server will have no Irrlicht and no IrrLichtMT GUI anyway.
        if { ${mt-server} } {
            set descr_client_server  "provides a MT ${github.version} server without the IrrLicht GUI at CLI for MT multi-player games."
        } else {
            set descr_client_server  "integrates IrrLichtMT ${irrlicht_version} to provide the MT ${github.version} game."
        }

    }
# NOTE: We do the logic this way to avoid another nesting level intentionally
# WIP - The block for 'mt54' with integrated IrrLicht postponed due to compiling issues.

# Concatenate all applicable texts to the long description.
    long_description ${description} \
        \n* "This particular '${subport}' subport ${descr_client_server}" \
        \n* ${descr_trailer}
}


# Provide a part to the general Portfile body.

set subport-revtext     "_${subport}_${github.version}_${revision}"

depends_build-append    path:bin/doxygen:doxygen \
                        port:mesa

depends_lib-append      path:include/turbojpeg.h:libjpeg-turbo \
                        port:libogg \
                        port:libvorbis \
                        port:freetype \
                        port:gettext \
                        port:leveldb \
                        port:sqlite3 \
                        port:zstd \
                        path:lib/libluajit-5.1.2.dylib:luajit \
                        port:gmp \
                        port:curl \
                        port:jsoncpp \
                        port:spatialindex \
                        port:xorg-libX11 \
                        port:xorg-libXxf86vm

# see https://trac.macports.org/ticket/58315 - possibly fixable?
universal_variant       no
supported_archs         x86_64 arm64
# WIP - The arch arm64 is troubled water but will be the future sometimes anyway.

# 001. the original build calls fixup_bundle to move all the deps into the app bundle.
#    this doesn't work correctly with macports destrooting, and isn't necessary for a macports install so deleted it
patchfiles-append       001-patch-src-CMakeLists-disable-bundlefixup.diff

# 002. patch to get the luajit include headers ahead of the system includes, or the build finds the
#    wrong lua headers if you have a newer version of lua installed
patchfiles-append       002-patch-cmake-Modules-FindLua-include-LUADIR-before-system.diff

# 003. patch main.cpp to not barf on the unrecognized command-line option -psn from Apple launch
patchfiles-append       003-patch-ignore-psn-option-mac-bundle.diff

if { (${mt00} || ! ${mt-server}) && ! (${mt55} || ${mt54}) }  {
# 004. Patch minetest.6 for amendment of MacPorts example section and applicable tokens.
    patchfiles-append   004-patch-amend-minetest.6.diff
}

if { ${mt-server} && ! (${mt00} || ${mt55} || ${mt54}) }  {
# 005. Patch minetest.6 for amendment of MacPorts example section as dedicated MT server.
    patchfiles-append   005-patch-amend-server-minetest.6.diff
}

configure.args-append   -DCMAKE_BUILD_TYPE=Release \
                        -DCMAKE_INSTALL_PREFIX:PATH=${applications_dir} \
                        -DBUILD_UNITTESTS=OFF \
                        -DENABLE_UPDATE_CHECKER=OFF \
                        -DBUILD_CLIENT=ON \
                        -DBUILD_SERVER=ON \
                        -DENABLE_SOUND=ON \
                        -DENABLE_REDIS=OFF \
                        -DENABLE_POSTGRESQL=OFF \
                        -DENABLE_LEVELDB=ON \
                        -DENABLE_FREETYPE=ON \
                        -DENABLE_CURL=ON \
                        -DENABLE_GETTEXT=ON \
                        -DENABLE_SPATIAL=ON \
                        -DENABLE_SYSTEM_GMP=ON \
                        -DENABLE_SYSTEM_JSONCPP=ON \
                        -DCURSES_INCLUDE_PATH:FILEPATH=${prefix}/include \
                        -DENABLE_LUAJIT=ON \
                        -DLUA_INCLUDE_DIR:PATH=${prefix}/include/luajit-2.1 \
                        -DLUA_LIBRARY:FILEPATH=${prefix}/lib/libluajit-5.1.dylib \
                        -USE_GPROF=FALSE \
                        -DVERSION_EXTRA=MacPorts${subport-revtext}

if { ${mt54} && ! (${mt54-irrport} || ${mt-server}) }  {
    configure.args-append  -DIRRLICHT_INCLUDE_DIR=${workpath}/${distname}/lib/irrlicht
}

if { ! (${mt00} || ${mt-server}) }  {
    set static_sharedir      ${applications_dir}/${subport}.app/Contents/Resources
    set static_localedir     ${static_sharedir}/locale

    configure.args-append    -DSTATIC_SHAREDIR=${static_sharedir} \
                             -DSTATIC_LOCALEDIR=${static_localedir}
}

# Continue with the variants to subports and the general part of the Portfile body.

if { ${mt-devel} }  {

# Add the DevTest MT game for developers.
    configure.args-delete        -DCMAKE_BUILD_TYPE=Release \
                                 -DBUILD_UNITTESTS=OFF
    configure.args-append        -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                                 -DENABLE_DEVTEST=ON \
                                 -DBUILD_UNITTESTS=ON

    variant benchmarks description {Make a Benchmarks setup}  {
# Applies the MT option Benchmarks.
        configure.args-append    -DBUILD_BENCHMARKS=ON
    }

    variant GLES \
            description {Enforce extended MESA & GLES graphical support for the MT client} {
# GLES option for the MT client build (can lead to "wrong video-driver" warning at MT start).
    configure.args-append        -DENABLE_GLES=ON
    notes "NOTE: Usually, the availability of GLES would be checked by CMake automatically."
    }
}

set mt-version               "${mt-name}-${github.version}"
set irrlicht_include_dir     "${workpath}/${mt-version}/lib/irrlichtmt/include"

if { ${mt-server} }  {
# Improvements for a 24/7 dedicated MT server by dropping the MT client and move of files.

    set static_sharedir      ${prefix}/share/${sub-servername}
    set static_localedir     ${static_sharedir}/locale
    set psql                 postgresql13
    set psql-server          postgresql13-server
    set psql-name            "PostgreSQL-13"

# PostgreSQL database support for dedicated `minetestserver` improved multi-player service.
# NOTE: "postgresql13-server" benefits from RAM storage and poor little psql-client cannot.

    depends_build-delete     port:mesa
    depends_lib-append       port:postgresql13-server
    configure.args-delete    -DENABLE_CLIENT=ON \
                             -DENABLE_POSTGRESQL=OFF
    configure.args-append    -DENABLE_CLIENT=OFF \
                             -DENABLE_POSTGRESQL=ON \
                             -DSTATIC_SHAREDIR=${static_sharedir} \
                             -DSTATIC_LOCALEDIR=${static_localedir} \
                             -DIRRLICHT_INCLUDE_DIR=${irrlicht_include_dir}
# NOTE: No reason to set "-DCMAKE_INSTALL_PREFIX:PATH" as we will just copy from there.
#       Furthermore, the CMake seems to force an App and we have to live with that anyway.
# WIP - Unfortunately, some trouble with "-DSTATIC_SHAREDIR" and "-DSTATIC_LOCALEDIR" ?!
}


variant debug description {Make a MT Debug build for development and/or test purposes} {
# Debug applies the applicable MT options.
    configure.args-delete    -DCMAKE_BUILD_TYPE=Release \
                             -DCMAKE_BUILD_TYPE=RelWithDebInfo \
                             -DBUILD_UNITTESTS=OFF
    configure.args-append    -DCMAKE_BUILD_TYPE=Debug \
                             -DBUILD_UNITTESTS=ON
}


if { ! (${port-irrlichtmt} || ${mt54-irrport} || ${mt-server}) }  {
    pre-build {

# Fix01: irrlichtmt fails to install on Mac OS 10.6 <https://trac.macports.org/ticket/66439>
# Add <GL/glext.h> - OpenGL 1.2 and above compatibility profile and extension interfaces.
#
# Copied from: <https://registry.khronos.org/OpenGL/index_gl.php#headers>
# from section 'API and Extension Header Files' as of 2023-01-07

        if { ${os.major} <= 10 }  {
            xinstall ${filesdir}/fix01-glext.h ${irrlicht_include_dir}/glext.h
        }

# Fix02: minetest arm64 support <https://trac.macports.org/ticket/66600>
# The OpenGL headers all depend on the shared <KHR/khrplatform.h> header from the EGL Registry
# [OpenGL-Registry pull request 183](https://github.com/KhronosGroup/OpenGL-Registry/pull/183)
# for increased compatibility between OpenGL and OpenGL ES headers.
#
# Copied from: <https://registry.khronos.org/OpenGL/index_gl.php#headers>
# from section 'API and Extension Header Files' as of 2023-01-07

        if { ${os.arch} == {arm} }  {
            xinstall -d ${irrlicht_include_dir}/KHR
            xinstall ${filesdir}/fix02-khrplatform.h ${irrlicht_include_dir}/KHR/khrplatform.h
        }
    }
}

# Amend and rename the Minetest manual pages for better availability.

if { ${mt00} && ! ${disruptive} }  {
    post-destroot {
# Amend the Minetest manual pages for better readability as applicable.
        reinplace "s|#SUBPORT#|minetest|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#DESCR_CLIENT_SERVER#|${descr_client_server}|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#DESCR_TRAILER#|${descr_trailer}|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#PATH_CLIENT#|${applications_dir}/minetest.app/Contents/MacOS/minetest|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#PATH_SERVER#|${applications_dir}/minetest.app/Contents/MacOS/minetestserver|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#DOCPATH#|${applications_dir}/minetest.app/Contents/Resources/doc|g" \
            ${workpath}/${mt-version}/doc/minetest.6
        reinplace "s|#MANPAGE#|minetest|g" \
            ${workpath}/${mt-version}/doc/minetest.6
# Provide the man pages, the doc/ files and the MT game as should be applicable.
        xinstall -d ${destroot}${applications_dir}/minetest.app/Contents/Resources/doc
        copy {*}[glob ${workpath}/${mt-version}/doc/*] \
            ${destroot}${applications_dir}/minetest.app/Contents/Resources/doc
        if { ! [file exists ${destroot}${applications_dir}/minetest.app/Contents/Resources/minetest.conf.example] }  {
            copy ${workpath}/${mt-version}/minetest.conf.example \
                ${destroot}${applications_dir}/minetest.app/Contents/Resources/minetest.conf.example
        }
        xinstall -d ${destroot}${prefix}/man/man6
        xinstall -W ${workpath}/${mt-version}/doc \
            minetest.6 minetestserver.6 \
            ${destroot}${prefix}/man/man6
        copy ${workpath}/minetest_game-${game_version} \
            ${destroot}${applications_dir}/minetest.app/Contents/Resources/games/minetest_game
    }
}

if { ! ${mt00} && ! ${mt-server} }  {
    post-destroot {
# Amend the Minetest manual pages for better readability as applicable.
        if { ! (${mt55} || ${mt54}) }  {
            reinplace "s|#SUBPORT#|minetest|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#DESCR_CLIENT_SERVER#|${descr_client_server}|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#DESCR_TRAILER#|${descr_trailer}|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#PATH_CLIENT#|${applications_dir}/${subport}.app/Contents/MacOS/minetest|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#PATH_SERVER#|${applications_dir}/${subport}.app/Contents/MacOS/minetestserver|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#DOCPATH#|${static_sharedir}/doc|g" \
                ${workpath}/${mt-version}/doc/minetest.6
            reinplace "s|#MANPAGE#|${subport} OR man ${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetest.6
        }
# Move the App into a new folder to allow concurrently install of each subport respectively.
        move ${destroot}${applications_dir}/minetest.app \
            ${destroot}${applications_dir}/${subport}.app
        copy ${workpath}/${mt-version}/doc ${destroot}${static_sharedir}/doc
        if { ! [file exists ${destroot}${static_sharedir}/minetest.conf.example] }  {
            copy ${workpath}/${mt-version}/minetest.conf.example \
                ${destroot}${static_sharedir}/minetest.conf.example
        }
        xinstall -d ${destroot}${prefix}/man/man6
        copy ${workpath}/${mt-version}/doc/minetest.6 \
            ${destroot}${prefix}/man/man6/${subport}.6
        copy ${workpath}/${mt-version}/doc/minetestserver.6 \
            ${destroot}${prefix}/man/man6/${sub-servername}.6
        copy ${workpath}/minetest_game-${game_version} \
            ${destroot}${static_sharedir}/games/minetest_game
# WIP - reflecting on each subport, do we need to amend the man pages somehow or not?
    }
}

if { ${mt-server} && ! ${mt00} }  {
# WIP - need to correct the paths, consider file structure and add accordingly
    post-destroot {
# Amend the 'minetestserver' manual page for better readability as applicable.
        if { ! (${mt55} || ${mt54}) }  {
            delete ${workpath}/${mt-version}/doc/minetestserver.6
            move ${workpath}/${mt-version}/doc/minetest.6 \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#SUBPORT#|${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#SUBSERVER#|${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#DESCR_CLIENT_SERVER#|${descr_client_server}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#DESCR_TRAILER#|${descr_trailer}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL#|${psql}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL_SERVER#|${psql-server}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL_NAME#|${psql-name}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PATH_SERVER#|${prefix}/bin/${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#STATIC_SHAREDIR#|${static_sharedir}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#DOCPATH#|${prefix}/share/doc/${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL_SHARE#|${prefix}/share/${psql}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL_DOC#|${prefix}/share/doc/${psql}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#MANPAGE#|${sub-servername}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
            reinplace "s|#PSQL_MAN#|${psql-server}|g" \
                ${workpath}/${mt-version}/doc/minetestserver.6
        }
# Adjust file names and provide the man pages, the doc/ files and the MT game as applicable.
        xinstall -d ${destroot}/${prefix}/bin
        move ${destroot}${applications_dir}/minetest.app/Contents/MacOS/minetestserver \
            ${destroot}${prefix}/bin/${sub-servername}
        move ${destroot}${applications_dir}/minetest.app/Contents/Resources \
            ${destroot}${static_sharedir}
        if { ! [file exists ${destroot}${static_sharedir}/minetest.conf.example] }  {
            copy ${workpath}/${mt-version}/minetest.conf.example \
                ${destroot}${static_sharedir}/minetest.conf.example
        }
        xinstall -d ${destroot}${prefix}/man/man6
        copy ${workpath}/${mt-version}/doc/minetestserver.6 \
            ${destroot}${prefix}/man/man6/${sub-servername}.6
        move ${workpath}/${mt-version}/doc \
            ${destroot}${prefix}/share/doc/${sub-servername}
        if { ! [file exists ${destroot}${static_sharedir}/games/minetest_game] }  {
            copy ${workpath}/minetest_game-${game_version} \
                ${destroot}${static_sharedir}/games/minetest_game
        }
# Delete the App folder, as this is a dedicated MT server for CLI intentionally.
        delete ${destroot}${applications_dir}
    }
}

if { ${mt00} && ${disruptive} }  {
# Portfile body part to the obsolete port if disruptive model.
    fetch {}
    extract {}
    use_configure no
    build {}
    destroot {}
# NOTE: Last not least: The late kill to the port if disruptive model was chosen.
}
