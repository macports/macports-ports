#!/bin/sh
# $Id$

if [ -z "$PREFIX" ]; then
    PREFIX="@PREFIX@"
fi

MOULDATADIR="${PREFIX}/share/mystonline/data"
LOGDIR="${PREFIX}/var/log/PlasmaClient"
LOGFILE="PlasmaClient.$(date '+%s').log"
LOGLINK="PlasmaClient.log"
PLIST="org.macports.PlasmaClient"

if [ ! -d "${MOULDATADIR}" ]; then
    osascript \
        -e 'tell app "Finder"' \
        -e 'activate' \
        -e "display dialog \"PlasmaClient needs the Myst Online: URU Live again game data files. Install the “mystonline-cider” port and run the application to let it download all the game data. Then come back to PlasmaClient.\" buttons {\"OK\"} default button \"OK\" with title \"PlasmaClient\" with icon note" \
        -e 'end'
    exit
fi

USERNAME="$(defaults read $PLIST username)"
PASSWORD="$(defaults read $PLIST password)"
LASTLOGINFAILED=0
if [ -r "${LOGDIR}/${LOGLINK}" ]; then
    if [ -n "$(grep '^Login failed:' ${LOGDIR}/${LOGLINK})" ]; then
        LASTLOGINFAILED=1
    fi
fi


if [ -z "${USERNAME}" -o -z "${PASSWORD}" -o ${LASTLOGINFAILED} -eq 1 ]; then
    USERNAME="$(osascript \
        -e 'tell app "Finder"' \
        -e 'activate' \
        -e "display dialog \"PlasmaClient needs to know your Myst Online: URU Live again account name (email address). (If you enter this incorrectly, PlasmaClient will hang during startup.)\" default answer \"${USERNAME}\" buttons {\"Cancel\", \"OK\"} default button \"OK\" with title \"PlasmaClient\" with icon note" \
        -e 'return text returned of the result' \
        -e 'end')" || exit
    if [ -z "${USERNAME}" ]; then
        exit
    fi
    
    PASSWORD="$(osascript \
        -e 'tell app "Finder"' \
        -e 'activate' \
        -e "display dialog \"PlasmaClient needs to know your Myst Online: URU Live again password. (If you enter this incorrectly, PlasmaClient will hang during startup.)\" default answer \"${PASSWORD}\" with hidden answer buttons {\"Cancel\", \"OK\"} default button \"OK\" with title \"PlasmaClient\" with icon note" \
        -e 'return text returned of the result' \
        -e 'end')" || exit
    if [ -z "${PASSWORD}" ]; then
        exit
    fi
    
    defaults write $PLIST username "$USERNAME"
    defaults write $PLIST password "$PASSWORD"
fi

KEEPLOGS=10
cd "${LOGDIR}"
ls PlasmaClient.*.log 2>/dev/null | sort -n -r | sed "1,$((${KEEPLOGS} - 1))d" | xargs rm -f

rm -f "${LOGDIR}/${LOGLINK}"
ln -s "${LOGFILE}" "${LOGDIR}/${LOGLINK}"
echo "Logging to ${LOGDIR}/${LOGFILE}"

cd "${MOULDATADIR}"
"${PREFIX}/bin/PlasmaClient" "${USERNAME}" "${PASSWORD}" > "${LOGDIR}/${LOGFILE}" 2>&1
