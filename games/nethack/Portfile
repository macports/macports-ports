# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem         1.0

name               nethack
version            3.6.1
categories         games
platforms          darwin
license            Copyleft
maintainers        nomaintainer
description        Classic dungeon adventure game.
long_description   NetHack is a single-player, display-oriented Dungeons & \
    Dragons(tm)-like game, in development since 1987. It runs on a wide \
    variety of computer systems and graphical interfaces, although the text \
    interface is the most popular. Your goal is to grab as much treasure as \
    you can, retrieve the Amulet of Yendor, and escape the Mazes of Menace \
    alive.

homepage           https://www.nethack.org/
master_sites       sourceforge \
                   ${homepage}download/${version}/
distname           ${name}-[string map {{.} {}} ${version}]-src
extract.suffix     .tgz
checksums          md5 5c469058a0d2876c274c102d56f47bb5 \
                   sha1 006fc177206f68375a87e17371de5d86555c329f \
                   rmd160 6f7a0fbcf5754e8df8d3257c711d72d4abb5f673 \
                   size 4640769

depends_lib        port:ncurses
worksrcdir         ${name}-${version}

patch.pre_args     -p1
patchfiles         patch-gamestate-dir.diff \
                   patch-manpage-dir.diff
post-patch {
    reinplace "s|__PREFIX__|${prefix}|" \
        "${worksrcpath}/sys/unix/Makefile.doc" \
        "${worksrcpath}/sys/unix/hints/macosx10.10"
}

configure.dir      ${worksrcpath}/sys/unix
configure.cmd      ./setup.sh
configure.pre_args hints/macosx10.10

use_parallel_build no
build.args-append  CC=${configure.cc} \
                   CXX=${configure.cxx} \
                   CPP=${configure.cpp}

pre-destroot {
    file mkdir "${destroot}${prefix}/share/man/man6"
}

destroot.target    all install manpages
destroot.keepdirs  "${destroot}${prefix}/var/games/nethack/save/"

post-destroot {
    reinplace "s|${destroot}||" "${destroot}${prefix}/bin/nethack"

    # Prevent existing preferences files being overwritten.
    foreach f { logfile record sysconf } {
        file rename ${destroot}${prefix}/var/games/nethack/${f} \
            ${destroot}${prefix}/var/games/nethack/${f}.dist
    }
}

post-activate {
    # Make initially-missing preferences files from earlier versions.
    foreach f { logfile record sysconf } {
        if {![file exists ${prefix}/var/games/nethack/${f}]} {
            file copy ${prefix}/var/games/nethack/${f}.dist \
                ${prefix}/var/games/nethack/${f}
        }
    }
}

variant x11 {
    patchfiles-append  x11/patch-x11-interface.diff
    depends_lib-append port:xorg-libXaw
}
