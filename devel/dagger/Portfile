# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

github.setup        dagger dagger 0.19.11 v
github.tarball_from releases
revision            0

categories          devel
maintainers         {judaew @judaew} openmaintainer
license             Apache-2

description         A portable devkit for CI/CD pipelines
long_description    \
    Using Dagger, software teams can develop powerful CI/CD pipelines with \
    minimal effort, then run them anywhere. Benefits include: \
    \n- Unified dev and CI environments. Write your pipeline once, Dagger will \
    run it the same everywhere. \
    \n- Reduced CI lock-in. No more re-writing everything from scratch every \
    6 months.
homepage            https://dagger.io

switch ${build_arch} {
    x86_64 {
        distfiles           dagger_v${version}_darwin_amd64${extract.suffix}
        checksums           rmd160  6489620f627a0558e167d713e29bf01eb3f3741d \
                            sha256  d7a2cf9608e5ba744bdcf18cd3cc7db2e43fc8a3f287f31d444994fa8fca5b47 \
                            size    20807137
    }
    arm64 {
        distfiles           dagger_v${version}_darwin_arm64${extract.suffix}
        checksums           rmd160  0bc40d3912f66ce4f645a29c75a8a0f2664d678a \
                            sha256  02d69381a07abd4314f20ae4c99d05c4535e06b895a79f0fd5b6fc5abb8d3a1c \
                            size    19597111
    }
    default {
        known_fail  yes
        pre-fetch {
            ui_error "${subport} @ ${version} only supported for architectures ${supported_archs}"
            return -code error "Unsupported architecture: ${build_arch}"
        }
    }
}

extract.mkdir       yes
use_configure       no
build {}

destroot {
    xinstall -m 0755 ${worksrcpath}/${name} ${destroot}${prefix}/bin/

    # Shell completion
    xinstall -d ${destroot}${prefix}/etc/bash_completion.d
    xinstall -d ${destroot}${prefix}/share/zsh/site-functions
    xinstall -d ${destroot}${prefix}/share/fish/vendor_completions.d
    system "${destroot}${prefix}/bin/${name} completion bash > ${destroot}${prefix}/etc/bash_completion.d/${name}"
    system "${destroot}${prefix}/bin/${name} completion zsh > ${destroot}${prefix}/share/zsh/site-functions/_${name}"
    system "${destroot}${prefix}/bin/${name} completion fish > ${destroot}${prefix}/share/fish/vendor_completions.d/${name}.fish"
}
