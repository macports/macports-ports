# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0
PortGroup       gitlab 1.0

name            libbsd
categories      devel

description     library for utility functions from BSD systems
long_description {*}${description} :\
                This library provides useful functions commonly found\
                on BSD systems, and lacking on others like GNU systems.\
                Thus making it easier to port projects with strong BSD\
                origins, without needing to embed the same code over\
                and over again on each project.\
                However, this ${name} port provides a minimized subset\
                of utilities and was reduced to those BSD functions\
                which are not available to Mac OS X / macOS platforms\
                by SDK on default.

homepage        https://libbsd.freedesktop.org/wiki/

license         MIT BSD ISC
maintainers     @Zweihorn openmaintainer


subport libbsd-devel {}

if {${subport} eq ${name}} {

    # This is the libbsd default

    known_fail      yes

    version         0.11.7

    revision        0

    master_sites    https://libbsd.freedesktop.org/releases/

    use_xz          yes

    checksums       rmd160  76c606f4e2c6bfce1fe9fff221de23a14b6887a7 \
                    sha256  9baa186059ebbf25c06308e9f991fda31f7183c0f24931826d83aa6abd8a0261 \
                    size    418508

    conflicts       libbsd-devel

    livecheck.type  regex
    livecheck.url   https://libbsd.freedesktop.org/releases/
    livecheck.regex {libbsd-([0-9.]+)\.tar\.xz}

} else {

    # This is the libbsd-devel subport for Development

    long_description {*}${long_description} \
        This ${subport} sub-port provides the development version of\
        the ${name} port, as appropriate.

    # Development sub-port and we are using a git branch to build.

    gitlab.instance https://gitlab.freedesktop.org
    gitlab.setup    libbsd libbsd 73b25a8f871b3a20f6ff76679358540f95d7dbfd

    checksums       rmd160  50e567fa91f0e019c55a9f0ef8b6d2ec904cebd7 \
                    sha256  b498bd46a85e471e74ad3c20dc3045f02f8d345babf59ccec9d10f57a6a509d3 \
                    size    135723

    # We explicitly set version instead of the 'gitlab.version' default
    # to avoid possible hassle with 'port outdated' etc.

    version         2023-08-10

    revision        0

    conflicts       libbsd

    patchfiles      patch010-configure.ac.diff \
                    patch015-src_Makefile.am.diff \
                    patch016-src_Makefile.am_libbsd.sym.diff \
                    patch017-test_Makefile.am.diff \
                    patch018-man_Makefile.am.diff

    # For a git branch the file '.dist-version' will be missing, so we
    # make one.  Otherwise we would get an error from a script.
    # Currently, no need to check the file.

    pre-configure   {
                    set outfile [open "${worksrcpath}/.dist-version" w]
                    puts $outfile "${version}_${revision}"
                    close $outfile
                    }

    configure.cmd   ./autogen && ./configure

    depends_build   port:autoconf \
                    port:automake \
                    port:libtool \
                    port:pkgconfig

    # We need to do a 'make check' for running the tests.

    test.run        yes
    test.target     check

notes "
This build of ${name} was derived from a GitLab development branch and\
is therefore to be used with care and might be unstable.\
The relevant branch under <${gitlab.homepage}> is: '${gitlab.version}'\
\n
CAVEAT: Currently, the utility 'closefrom' would fail the tests and\
should NOT be used for building other programs.
"

    # The gitlab.setup provides for the livecheck by default but fails.
    # WIP - The 'libbsd/-/commit' fails and a more correct url would be:
    # https://gitlab.freedesktop.org/libbsd/libbsd/-/tree/73b25a8f871b3a20f6ff76679358540f95d7dbfd

}

depends_lib      port:libmd
