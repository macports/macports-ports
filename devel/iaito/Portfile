# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           qmake5 1.0

github.setup        radareorg iaito 5.3.1
revision            2

categories          devel
platforms           darwin
license             GPL-3
maintainers         {i0ntempest @i0ntempest} openmaintainer

description         Fork of Cutter from the last working commit with radare2
long_description    iaito (formerly Cutter) is a free and open-source reverse engineering framework\
                    powered by radare2. Its goal is making an advanced, customizable\
                    and FOSS reverse-engineering platform while keeping the user\
                    experience at mind. Cutter is created by reverse engineers for\
                    reverse engineers.

homepage            https://www.radare.org/n/iaito.html

checksums           rmd160  1c2eb4693f82314e4eb43dcafdf5bef6a4df54e5 \
                    sha256  68971bf1957a3463d415681ba72a1b85240bc0c32029cab6bcd8a1277426f318 \
                    size    2806153

depends_lib-append  port:radare2
qt5.depends_component \
                    qtsvg
                    
compiler.cxx_standard 2017
configure.args-append \
                    src/Iaito.pro \
                    INCLUDEPATH+=${prefix}/include/libr \
                    INCLUDEPATH+=${prefix}/include/libr/sdb

destroot {
    copy ${worksrcpath}/iaito.app ${destroot}${applications_dir}
}

proc python-depends {python_branch} {
        global frameworks_dir
        set python_version [string map {. ""} ${python_branch}]
        set ::python_framework ${frameworks_dir}/Python.framework
        global python_framework
        # same here, and creating an alias of the variable in proc namespace so we can use it here

        depends_lib-append  port:python${python_version} \
                            port:py${python_version}-pyside2

        configure.args-append \
                            CONFIG+=IAITO_ENABLE_PYTHON \
                            CONFIG+=IAITO_ENABLE_PYTHON_BINDINGS \
                            INCLUDEPATH+=${python_framework}/Versions/${python_branch}/include/python${python_branch}/ \
                            LIBS+="-L${python_framework}/Versions/${python_branch}/lib -lpython${python_branch}" \
                            LIBS+=-F${frameworks_dir} \
                            QMAKE_RPATHDIR+=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/shiboken2/ \
                            QMAKE_RPATHDIR+=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/PySide2/ \
                            PYTHON_FRAMEWORK_DIR=${python_framework} \
                            SHIBOKEN_EXECUTABLE=${python_framework}/Versions/${python_branch}/bin/shiboken2 \
                            SHIBOKEN_INCLUDEDIR=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/shiboken2_generator/include/ \
                            SHIBOKEN_LIBRARY=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/shiboken2/libshiboken2.cpython-*-darwin.*.dylib \
                            PYSIDE_INCLUDEDIR=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/PySide2/include/ \
                            PYSIDE_LIBRARY=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/PySide2/libpyside2.cpython-*-darwin.*.dylib \
                            PYSIDE_TYPESYSTEMS=${python_framework}/Versions/${python_branch}/lib/python${python_branch}/site-packages/PySide2/typesystems

        pre-destroot {
            move ${worksrcpath}/iaito.app/Contents/MacOS/iaito ${worksrcpath}/iaito.app/Contents/MacOS/iaito.bin
            copy ${filespath}/iaito ${worksrcpath}/iaito.app/Contents/MacOS/
            reinplace "s|@PYFRAMEWORK@|${python_framework}|g" ${worksrcpath}/iaito.app/Contents/MacOS/iaito
            reinplace "s|@PYVER@|${python_branch}|g" ${worksrcpath}/iaito.app/Contents/MacOS/iaito
        }
}

variant python38 conflicts python39 description {Enable Python support and bindings using Python 3.8} {
    set ::python_branch 3.8
    # :: refers to global namespace, so the variable is created in global ns and is usable in pre-destroot
    python-depends ${::python_branch}
}

variant python39 conflicts python38 description {Enable Python support and bindings using Python 3.9} {
    set ::python_branch 3.9
    # :: refers to global namespace, so the variable is created in global ns and is usable in pre-destroot
    python-depends ${::python_branch}
}

if {![variant_isset python38]} {
    default_variants +python39
}
