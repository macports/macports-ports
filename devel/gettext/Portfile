# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               compiler_blacklist_versions 1.0
PortGroup               muniversal 1.0
PortGroup               clang_dependency 1.0

name                    gettext
version                 0.20.2
categories              devel
maintainers             {ryandesign @ryandesign}
# libs are LGPL and executables are GPL
license                 {LGPL-2.1+ GPL-3+}
homepage                https://www.gnu.org/software/gettext/
master_sites            gnu
platforms               darwin freebsd linux
use_parallel_build      yes

checksums               rmd160  32e99c55361970315dd9d43f9e36dd43f05fc09e \
                        sha256  ecb9d0908ca41d5ca5fef974323b3bba6bec19eebba0b44f396de98cfcc089f1 \
                        size    23717789

# https://trac.macports.org/ticket/31167
compiler.blacklist-append   {clang < 211.10.1}

depends_lib             port:libiconv \
                        port:ncurses

configure.cppflags      -no-cpp-precomp

# Also needed by later clangs.
if {${os.platform} eq "darwin" && ${os.major} < 11 && ${cxx_stdlib} eq "libc++"} {
    clang_dependency.extra_versions 3.7
}

configure.args-append   ac_cv_prog_AWK=/usr/bin/awk \
                        ac_cv_path_GREP=/usr/bin/grep \
                        ac_cv_path_SED=/usr/bin/sed

if {${subport} in "${name} ${name}-runtime"} {
    configure.args-append \
                        --disable-csharp \
                        --disable-java \
                        --with-included-gettext
}

test.run                yes
test.target             check

subport libasprintf {
    revision                0

    license                 LGPL-2.1+

    description             autosprintf library, part of gettext

    long_description        ${subport} makes the C formatted output \
                            routines (fprintf et al.) usable in C++ \
                            programs, for use with <string> strings \
                            and <iostream> streams. This library is \
                            part of gettext and a prerequisite for the \
                            gettext tools.

    worksrcdir              ${distname}/${name}-runtime/${subport}
}

subport ${name}-runtime {
    revision                0
    description             GNU internationalization (i18n) and localization (l10n) runtime library

    long_description        ${subport} is the ${description}, used for writing multilingual programs. \
                            This is part of GNU gettext. For building applications with gettext \
                            you need gettext tools provided by the gettext port. \
                            ${subport} provides the libintl library.

    worksrcdir              ${distname}/${subport}

    configure.args-append   --disable-libasprintf

    post-destroot {
        delete ${destroot}${prefix}/lib/charset.alias
        delete ${destroot}${prefix}/share/locale/locale.alias
    }

    pre-activate {
        # gettext < 0.20 installed files now installed by gettext-runtime.
        # This deactivate hack can be removed after June 2021.
        if {![catch {set installed [lindex [registry_active gettext] 0]}]} {
            set installed_version [lindex ${installed} 1]
            if {[vercmp ${installed_version} 0.20] < 0} {
                registry_deactivate_composite gettext "" [list ports_nodepcheck 1]
            }
        }
    }
}

subport libtextstyle {
    revision                0
    description             a text styling library, part of gettext
    long_description        ${subport} provides an easy way to add styling to programs that \
                            produce output to a console or terminal emulator window. \
                            The library is part of gettext and a prerequisite for tools like \
                            msgfmt and friends.

    worksrcdir              ${distname}/${subport}
}

if {${subport} eq ${name}} {
    epoch                   2
    revision                0
    description             GNU internationalization (i18n) and localization (l10n) tools
    long_description        ${name} provides the tools like msgfmt for writing multilanguage applications. \
                            The tools are required during the build of applications which use \
                            the gettext system for multilanguage support. The libraries for \
                            runtime (libintl) are provided via the gettext-runtime subport.

    depends_lib-append      port:libtextstyle \
                            port:gettext-runtime

    # Set configure.dir and build.dir rather than worksrcdir so that the
    # muniversal portgroup will copy the entire worksrcdir and not just
    # this subdirectory, because the build compiles files outside of this
    # directory and we need separate builds of everything for each arch.
    configure.dir           ${worksrcpath}/${name}-tools
    build.dir               ${configure.dir}

    configure.args-append   --disable-openmp \
                            --with-included-libunistring \
                            --with-included-libxml \
                            --with-installed-libtextstyle \
                            --without-emacs

    # Don't use possibly installed cvs or git to create the autopoint
    # archive because the archives they create for each architecture
    # under muniversal will differ and cannot be merged.
    configure.args-append   --without-cvs \
                            --without-git

    # Don't use xz because then xz would be required by various ports
    # that just want to use gettext.
    configure.args-append   --without-xz

    # Disable libasprintf to make the lang-c++ test not fail.
    configure.args-append   --disable-libasprintf

    # The gettext-tools installation also installs libintl again. Here
    # I remove the libintl parts because they are provided by the runtime
    # subport gettext-runtime
    post-destroot {
        delete ${destroot}${prefix}/include/libintl.h
        delete ${destroot}${prefix}/lib/libintl.a
        delete ${destroot}${prefix}/lib/libintl.dylib
        delete ${destroot}${prefix}/lib/libintl.8.dylib
        delete ${destroot}${prefix}/share/locale/locale.alias
    }
}

livecheck.type          regex
livecheck.url           https://ftp.gnu.org/gnu/gettext/?C=M&O=D
livecheck.regex         ${name}-(\[0-9.\]+)\\.tar
