# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           kde4    1.1

name                akonadi
version             1.4.0
revision            1
categories          devel kde kde4
maintainers         nomaintainer
description         A personal information management storage service.
long_description    Akonadi is an extensible cross-desktop storage service \
for PIM data and metadata providing concurrent read, write, and query access.
platforms           darwin
homepage            http://pim.kde.org/akonadi/
master_sites        http://download.akonadi-project.org/
use_bzip2           yes

checksums           md5     ed19efb982f7debd7e109cf1397d0588 \
                    sha1    a83943aa46537fee4e07953fedf29f5c13487937 \
                    rmd160  a69885807127684aa40e6203bd76cc09275dc427

depends_lib-append  port:soprano \
					port:boost \
                    port:shared-mime-info

depends_run-append  path:libexec/mysqld:mysql5-server

patchfiles          patch-akonadi-prefix.h.cmake.diff

post-patch {
    reinplace s|@@APPS@@|${applications_dir}| ${workpath}/${distname}/akonadi-prefix.h.cmake

    # fix '#include "utils.h"' -> "src/utils.h" to avoid a conflict
    # with the 'utils.h' header installed by the cdparanoia port
    foreach fixfile { server/src/handler/fetchhelper.cpp \
                          server/src/storage/entities.xsl \
                          server/src/storage/itemretriever.cpp } {
        reinplace "/include/s@\\(utils\\.h\\)@src/\\1@g" \
            ${workpath}/${distname}/${fixfile}
    }
}

configure.args-append   -DMYSQLD_EXECUTABLE="${prefix}/libexec/mysqld"

post-configure {
    # Avoid interference by cdparanoia's ${prefix}/include/utils.h
    fs-traverse x ${build.dir} {
        if {[file isfile ${x}] && "flags.make" == [file tail ${x}]} {
            reinplace "s|-I${prefix}/include|-isystem${prefix}/include|g" ${x}
        }
    }
}

platform darwin 9 {
    if {[info exists universal_target] && ${universal_target} == "10.4"} {
# Needed if compiling for 10.4 universal on 10.5
        post-configure {
            reinplace "s|#define HAVE_EXECINFO_H 1||" ${workpath}/build/config-akonadi.h
        }
    }
}

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     "${name}-(\\d+(?:\\.\\d+)*)${extract.suffix}"
