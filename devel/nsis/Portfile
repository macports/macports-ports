# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name                nsis
version             3.01
categories          devel
license             zlib CPL-1 MIT
platforms           darwin
maintainers         nomaintainer

description         NSIS is a tool for creating win32 installers.
long_description    NSIS (Nullsoft Scriptable Install System) is a tool \
            that allows programmers to create software installers \
            for Windows. It is released under an open source \
            license and is completely free for any use.

homepage            http://nsis.sourceforge.net/
master_sites        sourceforge

distfiles           nsis-${version}-src.tar.bz2 \
                    nsis-${version}.zip

checksums           nsis-3.01-src.tar.bz2 \
                    rmd160  9674b933a3d0df881a441d3caf2119dae5cbff20 \
                    sha256  604c011593be484e65b2141c50a018f1b28ab28c994268e4ecd377773f3ffba1 \
                    nsis-3.01.zip \
                    rmd160  6a6193c61d6c59adc6384dd268ea160571b6933b \
                    sha256  daa17556c8690a34fb13af25c87ced89c79a36a935bf6126253a9d9a5226367c

worksrcdir          nsis-${version}-src
use_bzip2           yes

depends_build       port:scons port:i386-mingw32-gcc

extract.only        nsis-${version}-src.tar.bz2

post-extract {
    system "cd ${workpath} && unzip ${distpath}/nsis-${version}.zip"
}

use_configure       no

# nsis can only ever be built 32-bit, but relies on libiconv. Since the
# dependency is limited to only iconv, we will rely on the base system
# 32-bit libiconv installation. Should MacPorts switch to 32-bit/64-bit
# universal builds by default, this decision should be revisited.
set scons.args      "PREFIX=\"${prefix}\" PREFIX_DEST=\"${destroot}\" SKIPSTUBS=all SKIPPLUGINS=all SKIPUTILS=all SKIPMISC=all"
# APPEND_CPPPATH=\"${prefix}/include\" APPEND_LIBPATH=\"${prefix}/lib\"

build {
    system "cd ${worksrcpath} && scons ${scons.args}"
}

destroot {
    system "cd ${worksrcpath} && scons ${scons.args} install"
    foreach dir {Bin Docs Include Plugins Contrib Examples Menu Stubs} {
        file delete -force ${destpath}${prefix}/share/nsis/${dir}
        file copy -force ${workpath}/nsis-${version}/${dir} ${destpath}${prefix}/share/nsis
    }
    system "chmod -R go-w '${destpath}${prefix}/share/nsis'"
}
