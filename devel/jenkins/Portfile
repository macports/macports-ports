# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           java 1.0

name                jenkins
version             2.401.3
revision            0
categories          devel java
maintainers         {gmail.com:slashapp @slashapp} openmaintainer

homepage            https://jenkins.io
description         The leading open source automation server,\
                    Jenkins provides hundreds of plugins to support building,\
                    deploying and automating any project.
long_description    ${description}

platforms           {darwin any}
supported_archs     noarch
license             MIT

master_sites        https://get.jenkins.io/war-stable/${version}/
set jenkins_war     ${name}.war
distfiles           ${jenkins_war}

checksums           rmd160  0a762953129148086beced9450a364467a136b40 \
                    sha256  a798a0c5481a8ffb0320d9121f6cf49dc575c369028daae17a4dd398b69e000d \
                    size    98398119

java.version        11+
java.fallback       openjdk11

use_configure       no
extract {}
build {}
test {}

set jenkins_plist       org.macports.${name}.plist
set jenkins_exec_dir    ${prefix}/libexec/${name}
set jenkins_home_dir    ${prefix}/var/lib/${name}
set jenkins_log_dir     ${prefix}/var/log/${name}
set jenkins_exec        ${jenkins_exec_dir}/${jenkins_war}
set jenkins_log         ${jenkins_log_dir}/${name}.log
set jenkins_pid         ${prefix}/var/run/${name}.pidfile
set jenkins_host        127.0.0.1
set jenkins_port        8080
set jenkins_user        jenkins
set jenkins_group       jenkins

destroot.keepdirs-append \
    ${destroot}${jenkins_home_dir} \
    ${destroot}${jenkins_log_dir}

destroot {
    set jenkins_dirs [list \
        ${jenkins_home_dir} \
        ${jenkins_exec_dir} \
        ${jenkins_log_dir} \
    ]

    foreach d ${jenkins_dirs} {
        xinstall -d -m 0755 -g ${jenkins_group} -o ${jenkins_user} \
            ${destroot}${d}
    }

    set jenkins_exec_files [list \
        ${distpath}/${jenkins_war}
    ]

    foreach f ${jenkins_exec_files} {
        xinstall -m 0644 -g ${jenkins_group} -o ${jenkins_user} \
            ${f} \
            ${destroot}${jenkins_exec_dir}
    }
}

post-deactivate {
    # Cleanup all Jenkins-created files, which are significant
    delete -force ${jenkins_home_dir}
    delete -force ${jenkins_log_dir}
}

add_users               ${jenkins_user} \
                        group=${jenkins_group} \
                        home=${jenkins_home_dir} \
                        shell=/bin/sh \
                        realname=Jenkins

startupitem.create      yes

# Note: To avoid breakage when a Java port is updated/removed, use 'java_home' to select at runtime
startupitem.init         "export JAVA_HOME=\$(/usr/libexec/java_home --failfast --version ${java.version})"

# Enable additional logging, for diagnostic purposes
startupitem.debug       yes
startupitem.logevents   yes

startupitem.start \
    "su ${jenkins_user} -c \
    \"\${JAVA_HOME}/bin/java \
    -Duser.home=${jenkins_home_dir} \
    -jar ${jenkins_exec} \
    --httpListenAddress=${jenkins_host} \
    --httpPort=${jenkins_port}\""

startupitem.stop \
    "su ${jenkins_user} -c \
    \"kill \$(cat ${jenkins_pid})\""

startupitem.logfile \
    ${jenkins_log}

startupitem.pidfile \
    manual ${jenkins_pid}

notes-append "
To configure Jenkins service, edit parameters as follows:
  - Read document at https://jenkins.io/doc/book/installing/initial-settings/
  - \$ sudo vi /Library/LaunchDaemons/${jenkins_plist}
To enable the Jenkins service, use `port load`, as follows:
  - \$ sudo port load ${name}
Once the service is enabled, Jenkins will:
  - Listen by default on: http://localhost:8080
Here is the default Administrator password, created after port first loaded:
  - \$ sudo cat ${jenkins_home_dir}/.jenkins/secrets/initialAdminPassword
"

livecheck.url "https://www.jenkins.io/download/"
livecheck.regex {war-stable/([0-9.]+)/jenkins}
