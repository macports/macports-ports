# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           cmake  1.1

# NOTE: See the comprised 'subport' definitions of this Portfile below.
#       'irrlichtmt' referred by the applicable 'subport' from the 'minetest' Portfile.

# Current version for the Minetest fork of IrrLicht
github.setup        minetest irrlicht 1.9.0mt9

# MT core version stub for the quite "unused" main 'irrlichtmt' port envelope.
set mtbuild         unused

name                irrlichtmt
revision            0

homepage            https://github.com/minetest/irrlicht

categories          devel
license             zlib
maintainers         {l2dy @l2dy} @Zweihorn openmaintainer
description         a fork of Irrlicht by the Minetest developers

# Checksums for the current irrlichtmt
checksums           rmd160  9b752b255cea2c443474f78aeadba244e8f584a2 \
                    sha256  a81b4c362d724ce4bdb2c8f60e31df0b1bff10302e7e0458248f9d609bd12f16 \
                    size    908173

###
# START of the comprised 'subport' definitions to this Portfile.
###

# New and improved approach with several 'subport' definitions as follows:
#
# 1. MT 5.4 ports are using the 'irrlicht' port.  This is out of scope here.
#
# 2. subport "${name}-mt55" provides 'irrlicht 1.9.0mt6' for MT 5.5.1 ports.
#
# 3. subport "${name}-mt56" provides 'irrlicht 1.9.0mt8' for MT 5.6.1 ports.
#
# 4. subport "${name}-mt57" provides 'irrlicht 1.9.0mt9' for MT 5.7.0 ports.
#
# 5. subport "${name}-mt58" would provide 'irrlicht 1.9.0mtX' for MT 5.8.0 ports.
#
# NOTE: The future of 'irrlicht 1.9.0mtX' might be unsure beyond MT 5.8 dev as
#       the MT core devs seek to fully integrate the former IrrLicht code into
#       their MT core code base and/or might have the goal of SDL2 apparently.


subport "${name}-mt57" {

    # Applicable MT core version for current irrlichtmt referred as subport only.
    set mtbuild     5.7.0

    conflicts "${name}" "${name}-mt55" "${name}-mt56"

    # Nothing more to do yet, as this subport owns the port body until further notice.
}

subport "${name}-mt56" {

    github.setup    minetest irrlicht 1.9.0mt8
    set mtbuild     5.6.1

    conflicts "${name}" "${name}-mt55" "${name}-mt57"

    checksums       rmd160  4da410c24f67e8c0ebd9880308b8d796d2f86676 \
                    sha256  ebe82027878cfa813af118d11cb4d1b30814829830c586cfa2df2b95c02ff8a1 \
                    size    909812
}

subport "${name}-mt55" {

    github.setup    minetest irrlicht 1.9.0mt6
    set mtbuild     5.5.1

    conflicts "${name}" "${name}-mt56" "${name}-mt57"

    checksums       rmd160  c4c1bfbb8ee1bee2ee9a1af5d33bcba9e4bc9a41 \
                    sha256  73e2eced77e0e0ae8e3a4ab6c0c0f52c0b0280adc26e3f2cce4cfe54b54193e9 \
                    size    1001712
}

###
# END of the 'subport' definitions and on to the common body of this Portfile below.
###


# WIP - why does this not work as expected and warns user of install?
if { ${subport} eq ${name} } {

    conflicts "${name}-mt55" "${name}-mt56" "${name}-mt57"

    known_fail yes
}

worksrcdir          ${subport}

long_description    IrrlichtMt is ${description}. - \
                    This ${subport} port provides ${github.project} ${github.version} for MT ${mtbuild} ports.

depends_lib         path:include/turbojpeg.h:libjpeg-turbo \
                    port:libpng \
                    port:zlib

pre-build {

# Fix01: irrlichtmt fails to install on Mac OS 10.6 <https://trac.macports.org/ticket/66439>
# Add <GL/glext.h> - OpenGL 1.2 and above compatibility profile and extension interfaces.
#
# Copied from: <https://registry.khronos.org/OpenGL/index_gl.php#headers>
# from section 'API and Extension Header Files' as of 2023-01-07

    if {${os.major} <= 10} {
        xinstall ${filesdir}/glext.h ${worksrcpath}/include/${name}
    }

# Fix02: minetest arm64 support <https://trac.macports.org/ticket/66600>
# The OpenGL headers all depend on the shared <KHR/khrplatform.h> header from the EGL Registry.
# This is a new dependency, introduced in [OpenGL-Registry pull request 183](https://github.com/KhronosGroup/OpenGL-Registry/pull/183)
# for increased compatibility between OpenGL and OpenGL ES headers.
#
# Copied from: <https://registry.khronos.org/OpenGL/index_gl.php#headers>
# from section 'API and Extension Header Files' as of 2023-01-07

    if {${os.arch} == {arm}} {
        xinstall -d ${worksrcpath}/include/KHR
        xinstall ${filesdir}/khrplatform.h ${worksrcpath}/include/KHR/${name}
    }
}
