# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    nodejs-devel
version                 0.5.3
categories              devel net
platforms               darwin
maintainers             ciserlohn

description             Evented I/O for V8 JavaScript

long_description        Node's goal is to provide an easy way to build scalable network programs in JavaScript. \
                        Node is similar in design to and influenced by systems like Ruby's Event \
                        Machine or Python's Twisted. Node takes the event model a bit further-it \
                        presents the event loop as a language construct instead of as a library.

conflicts               nodejs

homepage                http://nodejs.org/
master_sites            ${homepage}dist/v${version}/

checksums               sha1    2f1a54d32c94eee8f18186c948c22c329898d540 \
                        rmd160  ace56eb02cd1b885602512573eb4ddfee2707646

distname                node-v${version}

depends_build           port:python27

patchfiles              patch-Makefile-python.diff

proc rec_glob {basedir pattern} {
    set files [glob -directory $basedir -nocomplain -type f $pattern]
    foreach dir [glob -directory $basedir -nocomplain -type d *] {
        eval lappend files [rec_glob $dir $pattern]
    }
    return $files
}

set py27_bin ${prefix}/bin/python2.7

post-patch {
    foreach f [concat ${worksrcpath}/tools/node-waf ${worksrcpath}/tools/waf-light ${worksrcpath}/wscript [rec_glob ${worksrcpath} *.py]] {
        reinplace "s|/usr/bin/env python|${py27_bin}|" ${f}
    }
}

pre-configure {
    foreach {badport badfile} "libev ${prefix}/include/ev.h c-ares ${prefix}/include/ares.h" {
        if {[file exists ${badfile}]} {
            ui_error "${name} cannot be built while ${badport} is active."
            ui_error "Please deactivate ${badport} and try again."
            ui_error "You can reactivate ${badport} again later."
            return -code error "${badport} is installed"
        }
    }
}

configure.args          --without-ssl

variant ssl description {Add secure socket layer support} {
    depends_build-append    port:pkgconfig
    depends_lib-append      port:openssl
    configure.args-delete   --without-ssl
}

default_variants        +ssl

# V8 only supports ARM and IA-32 processors
supported_archs         i386 x86_64

universal_variant       no

# "V8 doesn't like cache."
configure.ccache        no

test.run                yes

# TODO: Fix the doc installation
#variant doc description {Build and install manpages} {
#    use_configure   no
#    build {}
#    destroot.target doc install
#
#    depends_lib-append      port:asciidoc \
#                            port:libxslt
#}

build.args-append   CC=${configure.cc} \
                    CXX=${configure.cxx} \
                    CFLAGS="${configure.cflags} ${configure.cc_archflags}" \
                    LDFLAGS="${configure.ldflags} ${configure.ld_archflags}" \
                    PYTHON=${py27_bin}

livecheck.type      regex
livecheck.regex     node-v(\\d+\\.\[13579\]+\\.\\d+)
