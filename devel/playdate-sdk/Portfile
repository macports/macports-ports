# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                playdate-sdk
version             1.12.3
revision            0
categories          devel
maintainers         {idleberg @idleberg} openmaintainer
license             Restrictive

description         Playdate SDK
long_description    This package installs includes a rich set of APIs, a \
                    compiler, and documentation for Playdate game development.

homepage            https://play.date/dev/
master_sites        https://download-keycdn.panic.com/playdate_sdk/
distname            PlaydateSDK-${version}
distfiles           ${distname}.zip

checksums           rmd160  b3312e20880832d5a41bd312d936ffe9440bde70 \
                    sha256  97ff5005093b4b05af7f5a053d1d260de7821f5576105d749cc317f212c7b5af \
                    size    30076091

depends_extract     port:xar

worksrcdir          ${name}-${version}

extract {
    xinstall -d "${worksrcpath}/pkg"
    xinstall -d "${worksrcpath}/files"
    system -W ${distpath} "unzip ${distpath}/${distfiles} -d ${worksrcpath}/pkg"
    system -W ${worksrcpath}/pkg "${prefix}/bin/xar -xf ${worksrcpath}/pkg/PlaydateSDK.pkg -C ${worksrcpath}/files"
    system -W ${worksrcpath}/files/PlaydateSDK.pkg "cat Payload | gunzip -dc | cpio -i"
    system -W ${worksrcpath}/files/PlaydateSDK.pkg "cp -R PlaydateSDK ${worksrcpath}/${name}"
}

use_configure no

build {}

destroot {
    # Binaries
    copy -force ${worksrcpath}/${name}/bin/Playdate\ Simulator.app ${destroot}${applications_dir}
    copy -force ${worksrcpath}/${name}/bin/pdc ${destroot}${prefix}/bin
    copy -force ${worksrcpath}/${name}/bin/pdutil ${destroot}${prefix}/bin

    # Libraries, API, and resources
    foreach dir {"C_API" "CoreLibs" "Disk" "Resources"} {
        xinstall -d "${destroot}${prefix}/share/${name}/${dir}"
        copy ${worksrcpath}/${name}/${dir} ${destroot}${prefix}/share/${name}
    }

    # Documentation
    foreach dir {"Designing for Playdate" "Inside Playdate"} {
        xinstall -d "${destroot}${prefix}/share/doc/${name}/${dir}"
        copy ${worksrcpath}/${name}/${dir} ${destroot}${prefix}/share/doc/${name}
        copy -force "${worksrcpath}/${name}/${dir}.html" \
            "${destroot}${prefix}/share/doc/${name}/${dir}.html"
    }
    copy -force "${worksrcpath}/${name}/PlaydateSDK.docset" \
        "${destroot}${prefix}/share/doc/${name}"

    # Examples
    foreach dir [glob -type d -nocomplain -tails -directory "${worksrcpath}/${name}/Examples/" *] {
        xinstall -d "${destroot}${prefix}/share/examples/${name}/${dir}"
        copy ${worksrcpath}/${name}/Examples/${dir} ${destroot}${prefix}/share/examples/${name}
    }

    # Set permissions for the Playdate Simulator's data store
    xinstall -d -m 777 "${destroot}${prefix}/share/Disk/Data"
}


notes {
    Setting the PLAYDATE_SDK_PATH environmental variable is recommended, but not required:

        export PLAYDATE_SDK_PATH=${prefix}/share/playdate-sdk

    You may also want to add $PLAYDATE_SDK_PATH/bin to your shell $PATH variable. This allows running pdc,
    pdutil and the Simulator from any location without a fully qualified path.

    See https://sdk.play.date/1.12.3/Inside%20Playdate.html#_set_playdate_sdk_path_environment_variable
}

test.run            yes

test {
    foreach example [glob -type d -nocomplain -tails -directory "${prefix}/share/examples/${name}" *] {
        if {[file exists "${prefix}/share/examples/${name}/${example}/Source/main.lua"]} {
            ui_msg "Compiling Examples/${example}"
            system -W "${prefix}/share/examples/${name}/${example}" \
                "${prefix}/bin/pdc -sdkpath ${prefix}/share/${name} --no-compress Source /tmp/${example}.pdx"
            file delete -force "/tmp/${example}.pdx"
        }
    }
}

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     "PlaydateSDK-(\d+(?:\.\d+)*)"
