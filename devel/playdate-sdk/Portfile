# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                playdate-sdk
version             1.12.2
revision            0
categories          devel
maintainers         @idleberg
license             PLAYDATE SDK LICENSE-1
platforms           darwin

description         Playdate SDK
long_description    This package installs includes a rich set of APIs, a \
                    compiler, and documentation for Playdate game development.

homepage            https://play.date/dev/
master_sites        https://download-keycdn.panic.com/playdate_sdk/
distname            PlaydateSDK-${version}
distfiles           ${distname}.zip

checksums           rmd160  f0768a68c50b9d92029b562fff36e9235562de80 \
                    sha256  42c793eb1e5d5251f3f1b8ac0cd1b1489c5f3e5a763b130c31205496d12389ce \
                    size    30080744

depends_extract     port:xar

worksrcdir          ${name}-${version}

extract {
    system -W ${workpath} "mkdir -p ${worksrcpath}/pkg"
    system -W ${workpath} "mkdir -p ${worksrcpath}/files"
    system -W ${distpath} "unzip ${distpath}/${distfiles} -d ${worksrcpath}/pkg"
    system -W ${worksrcpath}/pkg "${prefix}/bin/xar -xf ${worksrcpath}/pkg/PlaydateSDK.pkg -C ${worksrcpath}/files"
    system -W ${worksrcpath}/files/PlaydateSDK.pkg "cat Payload | gunzip -dc | cpio -i"
    system -W ${worksrcpath}/files/PlaydateSDK.pkg "cp -R PlaydateSDK ${worksrcpath}/${name}"
}

use_configure no

build {}

destroot {
    # Binaries
    file copy ${worksrcpath}/${name}/bin/Playdate\ Simulator.app ${destroot}${applications_dir}
    copy ${worksrcpath}/${name}/bin/pdc ${destroot}${prefix}/bin
    copy ${worksrcpath}/${name}/bin/pdutil ${destroot}${prefix}/bin

    # Libraries, API, and resources
    foreach dir {C_API CoreLibs Disk Resources} {
        file delete -force ${destroot}${prefix}/share/${name}/${dir}
        file mkdir ${destroot}${prefix}/share/${name}/${dir}
        file copy ${worksrcpath}/${name}/${dir}/ \
            ${destroot}${prefix}/share/${name}/
    }

    # Documentation
    foreach docs {Designing\ for\ Playdate Inside\ Playdate} {
        file delete -force ${destroot}${prefix}/share/${name}/${docs}
        file mkdir ${destroot}${prefix}/share/doc/${name}/${docs}
        file copy ${worksrcpath}/${name}/${docs}/ \
            ${destroot}${prefix}/share/doc/${name}/
        file copy ${worksrcpath}/${name}/${docs}.html \
            ${destroot}${prefix}/share/doc/
    }
    file copy ${worksrcpath}/${name}/Inside\ Playdate\ with\ C.html \
    ${destroot}${prefix}/share/doc/${name}/
    file copy ${worksrcpath}/${name}/PlaydateSDK.docset \
    ${destroot}${prefix}/share/doc/${name}/

    # Examples
    file delete -force ${destroot}${prefix}/share/doc/${name}/Examples
    file mkdir ${destroot}${prefix}/share/doc/${name}/Examples
    file copy ${worksrcpath}/${name}/Examples/ \
        ${destroot}${prefix}/share/doc/${name}/

    system "export PLAYDATE_SDK_PATH=${destroot}${prefix}/share/${name}"
}

test.run            yes

test {
    foreach example [glob -type d -nocomplain -tails -directory ${worksrcpath}/Examples *] {
        system -W "${worksrcpath}/Examples/${example}" "${destroot}${prefix}/bin/pdc Source"
    }
}

livecheck.type      regex
livecheck.url       ${homepage}
livecheck.regex     "Download Playdate SDK (\\d+(?:\\.\\d+)*) for macOS"
