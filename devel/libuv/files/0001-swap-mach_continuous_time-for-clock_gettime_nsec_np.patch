From fe095dab221e72e3aea6516965d5cd341ecaf0b4 Mon Sep 17 00:00:00 2001
From: Fred Wright <fw@fwright.net>
Date: Wed, 19 Feb 2025 23:47:55 +0000
Subject: [PATCH 1/3] swap mach_continuous_time for clock_gettime_nsec_np

See: https://github.com/macports/macports-ports/pull/27671#issuecomment-2664257623
See: https://github.com/macports/macports-ports/pull/27671#issuecomment-2670030330
---
 src/unix/darwin.c | 14 +++-----------
 1 file changed, 3 insertions(+), 11 deletions(-)

diff --git a/src/unix/darwin.c b/src/unix/darwin.c
index 009efbef..e9f86490 100644
--- a/src/unix/darwin.c
+++ b/src/unix/darwin.c
@@ -25,15 +25,13 @@
 #include <stdint.h>
 #include <errno.h>
 
-#include <mach/mach.h>
-#include <mach/mach_time.h>
+#include <time.h>
 #include <mach-o/dyld.h> /* _NSGetExecutablePath */
 #include <sys/resource.h>
 #include <sys/sysctl.h>
 #include <unistd.h>  /* sysconf */
 
 static uv_once_t once = UV_ONCE_INIT;
-static mach_timebase_info_data_t timebase;
 
 
 int uv__platform_loop_init(uv_loop_t* loop) {
@@ -51,15 +49,9 @@ void uv__platform_loop_delete(uv_loop_t* loop) {
 }
 
 
-static void uv__hrtime_init_once(void) {
-  if (KERN_SUCCESS != mach_timebase_info(&timebase))
-    abort();
-}
-
-
 uint64_t uv__hrtime(uv_clocktype_t type) {
-  uv_once(&once, uv__hrtime_init_once);
-  return mach_continuous_time() * timebase.numer / timebase.denom;
+  (void) type;
+  return clock_gettime_nsec_np(CLOCK_MONOTONIC_RAW);
 }
 
 
-- 
2.48.0

