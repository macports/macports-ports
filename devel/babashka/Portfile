# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

github.setup        babashka babashka 1.3.176 v
revision            0
fetch.type          git

categories          devel
license             EPL-1.0
maintainers         {@kakuhen} openmaintainer
platforms           darwin
description         Native, fast starting Clojure interpreter for scripting
long_description    Babashka is a native Clojure interpreter for scripting with \
    fast startup. Its main goal is to leverage Clojure in places where you \
    would be using bash otherwise.

depends_build       port:leiningen
depends_lib         port:clojure

# To keep number of variants small and maintenance simple, we only provide
# variants for each actively supported LTS release of Java.

variant jdk17 conflicts jdk11 description {Build using JDK 17} {
    depends_build-append port:openjdk17-graalvm-native-image
}

variant jdk11 conflicts jdk17 description {Build using the older JDK 11} {
    depends_build-append port:openjdk11-graalvm-native-image
}

# Use latest LTS release of Java as default variant
default_variants    +jdk17
use_configure       no
patchfiles          project-clj-patch.diff

# Leaving this stub since we cannot declare global variables in the scope of pre-fetch
set graalvm_home /Library/Java/JavaVirtualMachines

pre-fetch {
    if {![variant_isset jdk11] && ![variant_isset jdk17]} {
        error "Either +jdk11 or +jdk17 is required"
    }
}

post-fetch {
    system -W ${worksrcpath} "git submodule update --init"
}

build {
    if {[variant_isset jdk17]} {
        set graalvm_home ${graalvm_home}/openjdk17-graalvm/Contents/Home
    } elseif {[variant_isset jdk11]} {
        set graalvm_home ${graalvm_home}/openjdk11-graalvm/Contents/Home
    }
    system -W ${worksrcpath} "./script/uberjar"
    system -W ${worksrcpath} "GRAALVM_HOME=${graalvm_home} ./script/compile"
}

destroot {
    xinstall -m 0755 ${worksrcpath}/bb ${destroot}${prefix}/bin
}
