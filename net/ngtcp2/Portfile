# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.1
PortGroup               github 1.0
PortGroup               openssl 1.0

openssl.branch          1.1

# Until next release use commit due to: https://github.com/ngtcp2/ngtcp2/issues/805
github.setup            ngtcp2 ngtcp2 edf5c7630555ddded7050b1dde7a5cc34b1c7451
version                 0.15.0
revision                1
categories              net devel
maintainers             {@barracuda156 gmail.com:vital.had} openmaintainer
license                 MIT
description             ngtcp2 project is an effort to implement RFC9000 QUIC protocol
long_description        {*}${description}
homepage                https://nghttp2.org/ngtcp2
checksums               rmd160  88ba59c7c369e0fd4d4a5cacc317790e135ef3e4 \
                        sha256  4bbd24552df2d9c9402a9a55e46484a467021b1589d86513139b346a89e17c6f \
                        size    590494

depends_lib-append      path:lib/pkgconfig/gnutls.pc:gnutls \
                        port:cunit \
                        port:jemalloc \
                        port:libev \
                        port:nghttp3

# Do not force build examples: https://github.com/ngtcp2/ngtcp2/issues/804
patchfiles              patch-examples.diff

compiler.cxx_standard   2017

configure.args-append   -DENABLE_EXAMPLES:BOOL=OFF \
                        -DENABLE_GNUTLS:BOOL=ON \
                        -DENABLE_JEMALLOC:BOOL=ON \
                        -DENABLE_OPENSSL:BOOL=ON \
                        -DENABLE_SHARED_LIB:BOOL=ON \
                        -DENABLE_WERROR:BOOL=OFF

if {${os.platform} eq "darwin" && ${os.major} < 10} {
    # Until jemalloc fixed for 10.5 and below: https://trac.macports.org/ticket/65945
    depends_lib-delete  port:jemalloc
    configure.args-replace \
                        -DENABLE_JEMALLOC:BOOL=ON -DENABLE_JEMALLOC:BOOL=OFF
}

test.run                yes
test.target             check
