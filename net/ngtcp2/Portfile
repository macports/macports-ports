# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               openssl 1.0

# Disable adding openssl dependency by default.
# Specify in variants below as required.
openssl.branch          no_version

github.setup            ngtcp2 ngtcp2 1.19.0 v
revision                0
categories              net devel
maintainers             {@barracuda156 gmail.com:vital.had} openmaintainer
license                 MIT
description             ${name} project is an effort to implement RFC9000 QUIC protocol
long_description        {*}${description}
homepage                https://nghttp2.org/ngtcp2
checksums               rmd160  6a3c174b46dbc017cb74f13f6b106f810407e231 \
                        sha256  f11f7da5065f2298f8b5f079a11f1a6f72389271b8dedd893c8eb26aba94bce9 \
                        size    686448
github.tarball_from     releases

use_xz                  yes

depends_build-append    path:bin/pkg-config:pkgconfig

compiler.cxx_standard   2017

configure.args-append   --disable-silent-rules \
                        --enable-lib-only=yes \
                        --enable-werror=no \
                        --with-openssl=no

variant gnutls description "Enable GnuTLS backend" {
    depends_lib-append  port:gnutls
    configure.args-append \
                        --with-gnutls=yes
}

variant openssl description "Enable OpenSSL backend" {
    # 3.5 to be exact, if there's a versioned port for it in the future
    openssl.branch      3
    configure.args-delete \
                        --with-openssl=no
}

variant wolfssl description "Enable wolfSSL backend" {
    depends_lib-append  port:wolfssl
    configure.args-append \
                        --with-wolfssl=yes
}

variant picotls description "Enable Picotls backend" {
    if {![variant_isset openssl]} {
        openssl.branch  3
        openssl.depends_type \
                        build
    }
    depends_build-append \
                        port:picotls
    configure.args-append \
                        --with-picotls=yes
    configure.cppflags-append \
                        -I${prefix}/include/picotls
    configure.ldflags-append \
                        -lpicotls-core -lpicotls-minicrypto -lpicotls-openssl
}

# Do not force build examples:
# https://github.com/ngtcp2/ngtcp2/issues/804
variant examples description "Build examples" {
    depends_lib-append  port:brotli \
                        port:libev \
                        port:nghttp3
    if {(${os.platform} eq "darwin" && ${os.major} > 9) || \
        ${os.platform} ne "darwin"} {
        # https://trac.macports.org/ticket/65945
        depends_lib-append \
                        path:lib/pkgconfig/jemalloc.pc:jemalloc
    }

    compiler.cxx_standard \
                        2020
    configure.args-append \
                        --with-libbrotlidec=yes \
                        --with-libbrotlienc=yes
    configure.args-delete \
                        --enable-lib-only=yes
}

default_variants-append +gnutls

test.run                yes
test.target             check
