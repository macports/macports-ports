# $Id: Portfile,v 1.7 2006/06/23 02:34:27 markd Exp $
PortSystem      1.0

name                    monarch
version                 1.0
revision		3
categories              net
maintainers             markd@opendarwin.org
description             A GUI configuration tool for Nagios written in perl
long_description        ${description}
homepage                http://sourceforge.net/projects/monarch
platforms               darwin
master_sites            sourceforge
checksums               md5 2cb50c2313adad3d96305e7eeb997db4
use_bzip2		yes

depends_lib             port:mysql5 \
			port:p5-libwww-perl \
			port:p5-xml-libxml-common \
			port:p5-xml-namespacesupport \
			port:p5-xml-sax \
			port:p5-xml-libxml \
			port:p5-nmap-scanner \
			port:p5-cgi.pm \
			port:p5-dbi \
			port:p5-dbd-mysql \
			port:p5-cgi-ajax \
			port:p5-class-accessor

use_configure		no
build {}

pre-fetch {
        ui_msg "\n

                   **************************************************
                   **** If MySQL is being installed during the   ****
		   **** Monarch install (first-time MySQL        ****
		   **** install, is recommended that you pre-    ****
		   ****	install MySQL5 with the +server variant  ****
		   **** so MySQL will start system boot.  To do  ****
		   **** so:					 ****

                      1) Cancel this install now with Cntrl-C.
                      2) Type \"port install mysql5 +server\"
                      3) Re-run the Monarch port install
                   ************************************************
                \n"
}

set monarchdir ${prefix}/share/groundwork/monarch
set monarchinstalldir ${prefix}/var/groundwork/monarch

post-patch {
	reinplace "s|/usr/bin/mysqldump|${prefix}/bin/mysqldump5|g" \
		${worksrcpath}/MonarchFile.pm
}

destroot {
        xinstall -m 755 -d ${destroot}${monarchdir}
        system "cp -R ${worksrcpath}/* ${destroot}${monarchdir}"
}

post-destroot {
        eval reinplace "s|/usr/bin/perl|${prefix}/bin/perl|g" \
                [glob ${destroot}${monarchdir}/*.pl]

	reinplace "s|/usr/local/groundwork/monarch|${prefix}/var/groundwork/monarch|g" \
                ${destroot}${monarchdir}/monarch_setup.pl


# Enable Nmap Scanner - THIS IS BROKEN AND AWAITS A FUTURE REVISION
	eval reinplace "s|/usr/local/groundwork/bin/perl|${prefix}/bin/perl|g" \
		[glob ${destroot}${monarchdir}/*.cgi]

        eval reinplace "s|/usr/local/groundwork/bin/perl|${prefix}/bin/perl|g" \
                [glob ${destroot}${monarchdir}/*.p*]  

        eval reinplace "s|/usr/local/groundwork/monarch|${monarchinstalldir}|g" \
		[glob ${destroot}${monarchdir}/*.*]
		
	xinstall -m 755 -d ${destroot}${monarchinstalldir}/bin

	system "cd ${worksrcpath}/nmap_scan && gcc -g -O2 -Wall -o nmap_scan_one nmap_scan.c"

	xinstall -m 4750 ${worksrcpath}/nmap_scan/nmap_scan_one \
		${destroot}${monarchinstalldir}/bin
	xinstall -m 755 ${destroot}${monarchdir}/nmap_scan_one.pl \
		${destroot}${monarchinstalldir}/bin

#Delete precompiled Linux version of nmap_scan_one
	file delete ${destroot}${monarchdir}/nmap_scan_one

# End enable Nmap-Scanner

# Set permissions & modes
	system "chown -R nagios:nagios ${destroot}${monarchdir}/*"
	system "chmod +x ${destroot}${monarchdir}/*.cgi"
}

post-activate {

ui_msg "\n **** To complete the Monarch installation ****
        
Read the README at ${prefix}/share/groundwork/monarch/ for full information.

1) Setup MySQL and prepare it for Monarch
   Configure MySQL (new MySQL installs)
        sudo -u mysql ${prefix}/lib/mysql5/bin/mysql_install_db
 
   Start MySQL.
        sudo ${prefix}/share/mysql5/mysql/mysql.server start

   Set MySQL to start at system boot (optional)
        sudo launchctl load -w /Library/LaunchDaemons/org.darwinports.mysql5.plist

   Set a root MySQL password.
        Follow the instructions that were given after you executed 'mysql_install_db' above.

   Create a Monarch MySQL user ...
        mysql5 -u root -p (login with new root password when prompted)
        mysql> grant CREATE,INSERT,SELECT,DELETE,UPDATE on monarch.* to monarch@localhost;
        mysql> grant CREATE,INSERT,SELECT,DELETE,UPDATE on monarch.* to monarch;
        mysql> quit;

   Create the monarch database:
	mysql5 -u root -p
	mysql> create database monarch;
	mysql> exit

   Run monarch_setup.pl
	cd ${prefix}/share/groundwork/monarch
	sudo ./monarch_setup.pl

   Responses for the monarch_setup.pl program
	What is the host name of your MySQL database server? - localhost
	What is the name of the user that will have access to the database? - monarch
	What is the name of the database you will use for your Monarch installation? - monarch
	Enter web server's user account - nagios
	Enter web server's user group - nagios
	Please enter your web server's relative path to cgi-bin - /cgi-bin
	What is your web server's document root - /Library/WebServer/Documents
	Enter the full path of your cgi-bin directory - /Library/WebServer/CGI-Executables/
	Enter the full installation path for Monarch - ${prefix}/var/groundwork/monarch
	Enter the full path to your nagios.cfg file - ${prefix}/etc/nagios
	Enter the full path to your nagios binary file - ${prefix}/bin
	
   Verify Monarch DB:
        mysql5 -u root -p
        mysql> use monarch;
        mysql> show tables;
        mysql> exit;

 
2) Set your Apache user and group to the Nagios user
        sudo pico /etc/httpd/httpd.conf
        
	user nagios
	group nagios


3) Create a ParserDetails.ini for module XML::SAX
   Execute this command
        perl -MXML::SAX -e \"XML::SAX->add_parser(q(XML::SAX::PurePerl))->save_parsers()\"

4) Goto http://localhost/cgi-bin/monarch.cgi

	Login with super_user/password


5) Configure Monarch with a web browser

Control -> Setup -> Nagios Version -> 2.x

Control -> Nagios Main Configuration -> Load from nagios.cfg (to start from an existing Nagios configuration)
				        Set default configuration (to start a new Nagios installation)

Control -> Nagios Cgi Configuration -> Load from cgi.cfg (to load an existing Nagios configuration)
				       Set default configuration (to start a new Nagios installation)

Control -> Load (to populate the database with an existing configuration)


6) Copy the optional monarch_ez.cgi interface to your cgi-bin/ directory 
        cd ${monarchdir}
        sudo cp -p monarch_ez.cgi /Library/WebServer/CGI-Executables/ 
        sudo cp -p monarch_scan.cgi /Library/WebServer/CGI-Executables/

   NOTE: The nmap discovery functions in the monarch_ez.cgi interface do not work yet in this version.
\n"
}
