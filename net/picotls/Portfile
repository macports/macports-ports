# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           openssl 1.0

# O_CLOEXEC
legacysupport.newest_darwin_requires_legacy 10

github.setup        h2o picotls df13092f6c5c2f08c5227e096a1590603229dfc8
version             2023.12.04
revision            0
categories          net security
license             MIT
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer
description         &{name} is a TLS 1.3 (RFC 8446) protocol stack written in C
long_description    {*}${description}. &{name} is designed to be fast, tiny and low-latency, \
                    with the primary user being the H2O HTTP/2 server for serving \
                    HTTP/1, HTTP/2 and HTTP/3 over QUIC.

fetch.type          git

if {${os.platform} eq "darwin" && ${os.major} < 14} {
    # Lion+ (with Xcode 4.1+) have git; earlier need to bring their own.
    # However Lion through Mavericks fail with SSL errors.
    depends_build-append \
                    port:git
    git.cmd         ${prefix}/bin/git
}

post-fetch {
    system -W ${worksrcpath} "git submodule update --init"
}

depends_lib-append  port:brotli \
                    port:mbedtls3

# picotls.c: error: ‘ptls_handshake_properties_t’ has no member named ‘client’
# https://github.com/h2o/picotls/issues/505
compiler.blacklist-append \
                    *gcc-4.*

configure.args-append \
                    -DWITH_AEGIS=OFF \
                    -DWITH_DTRACE=OFF \
                    -DWITH_MBEDTLS=ON

destroot {
    move ${cmake.build_dir}/cli ${destroot}${prefix}/bin/picotls_cli
    foreach lib {libpicotls-core.a libpicotls-mbedtls.a libpicotls-minicrypto.a libpicotls-openssl.a} {
        copy ${cmake.build_dir}/${lib} ${destroot}${prefix}/lib
    }
}

test.run            yes
test.target         check
