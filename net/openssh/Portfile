# $Id: Portfile,v 1.7 2004/11/07 00:53:56 jkh Exp $

PortSystem      1.0
name            openssh
version         3.8.1p1
revision        0
categories      net 
maintainers     yeled@opendarwin.org
description     OpenSSH secure login server
long_description  OpenSSH is a FREE version of the SSH protocol suite of \
          network connectivity tools that increasing numbers of people on the \
          Internet are coming to rely on. Many users of telnet, rlogin, ftp, \
          and other such programs might not realize that their password is \
          transmitted across the Internet unencrypted, but it is. OpenSSH \
          encrypts all traffic (including passwords) to effectively eliminate \
          eavesdropping, connection hijacking, and other network-level \
          attacks. Additionally, OpenSSH provides a myriad of secure \
          tunneling capabilities, as well as a variety of authentication \
          methods. 
homepage        http://www.openssh.com/
platforms       darwin
checksums       md5 1dbfd40ae683f822ae917eebf171ca42
master_sites    ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable \
		ftp://carroll.cac.psu.edu/pub/OpenBSD/OpenSSH/portable/
depends_lib     lib:libssl.0.9.7:openssl lib:libz.1.1.4:zlib

# Specified -fno-builtin because GCC 3.3 has log() as a builtin
# (from math.h) while OpenSSH has its own log() function
# -- from fink.
configure.env CPPFLAGS="-fno-builtin -I${workpath}/include"
configure.args --with-ssl-dir=${prefix} --sysconfdir=${prefix}/etc/ssh \
  --with-privsep-path=${prefix}/var/empty --with-md5-passwords \
  --with-pid-dir=${prefix}/var/run --with-tcp-wrappers \
  --with-pam --disable-suid-ssh --with-random=/dev/urandom

destroot.target install-nokeys

post-destroot {
  xinstall -o root -m 755 -d ${destroot}${prefix}/etc/rc.d ${destroot}${prefix}/var/run ${destroot}${prefix}/var/run
  destroot.keepdirs ${destroot}${prefix}/var/run ${destroot}${prefix}/var/empty
  xinstall -o root -m 755 -c ${portpath}/files/openssh.sh ${destroot}${prefix}/etc/rc.d
  reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/rc.d/openssh.sh
}

# For X11 Forwarding
variant  apple-x11 { # set for X11 forwarding
  configure.args-append --with-xauth=/usr/X11R6/bin/xauth
 }

variant kerberos {
  configure.args-append --with-kerberos5=/usr
}

variant darwin {
  depends_run  path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup
  # ln -s /usr/include/pam to work/include/security because 'security' was 
  # renamed to 'pam' in OS X.
  pre-configure { system "mkdir ${workpath}/include"
    system "ln -s /usr/include/pam ${workpath}/include/security" }
  post-install {
  ui_msg "===============================================================================\n"
  ui_msg "Setup instructions:\n\t
    Make sure SSHSERVER=-NO- is set in /etc/hostconfig or untick\n\t'Remote Sharing' option in System Preferences > Sharing.\n\tOPTIONAL: Copy your /etc/ssh_host* files to ${prefix}/etc/ssh/\n\tRun: `sudo killall sshd && sudo ${prefix}/etc/rc.d/openssh.sh`\n"
ui_msg "===============================================================================\n"
  }
}

