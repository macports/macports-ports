# $Id: Portfile,v 1.2 2003/09/18 06:59:42 fkr Exp $

PortSystem 1.0
name		openssh
version		3.6.1p1
categories	net 
maintainers	charlie@rubberduck.com
description	OpenSSH secure login server
long_description	\
	OpenSSH is a FREE version of the SSH protocol suite of \
	network connectivity tools that increasing numbers of people on the \
	Internet are coming to rely on. Many users of telnet, rlogin, ftp, \
	and other such programs might not realize that their password is \
	transmitted across the Internet unencrypted, but it is. OpenSSH \
	encrypts all traffic (including passwords) to effectively eliminate \
	eavesdropping, connection hijacking, and other network-level \
	attacks. Additionally, OpenSSH provides a myriad of secure \
	tunneling capabilities, as well as a variety of authentication \
	methods.  \
	\
	*** Setup instructions: \
	*** Make sure SSHSERVER=-NO- is set in /etc/hostconfig or untick "Remote \
	*** Sharing" option in System Preferences > Sharing. \
	*** OPTIONAL: Copy your /etc/ssh_host* files to ${prefix}/etc/ssh/ \
	*** Run: `sudo killall sshd && sudo ${prefix}/etc/rc.d/openssh.sh`

homepage	http://www.openssh.com/
platforms	darwin
checksums	${distname}${extract.sufx} md5 d4c2c88b883f097fe88e327cbb4b2e2a \
              3.6.1p1.patch md5 170540992d086081cc1dc55217e05c64
master_sites	ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable
patch_sites     http://rubberduck.com/~yeled/BSD
patchfiles      3.6.1p1.patch
depends_run	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup
depends_lib	lib:libssl.0.9.7:openssl lib:libz.1.1.4:zlib

# ln -s /usr/include/pam to work/include/security because 'security' was 
# renamed to 'pam' in OS X.
pre-configure { system "mkdir ${workpath}/include"
	system "ln -s /usr/include/pam ${workpath}/include/security" }

# Specified -fno-builtin because GCC 3.3 has log() as a builtin
# (from math.h) while OpenSSH has its own log() function
# -- from fink.
configure.env	CPPFLAGS="-fno-builtin -I${workpath}/include"
configure.args	--with-ssl-dir=${prefix} --sysconfdir=${prefix}/etc/ssh \
		--with-privsep-path=${prefix}/var/empty --with-md5-passwords \
		--with-pid-dir=${prefix}/var/run --with-tcp-wrappers \
		--with-pam --disable-suid-ssh --with-random=/dev/urandom

destroot.target	install-nokeys

# We touch a few files here to stop the destroot bug of removing empty dirs
post-destroot {
	system "install -o root -m 755 -d ${destroot}${prefix}/etc/rc.d \
		${destroot}${prefix}/var/run ${destroot}${prefix}/var/run"
	system "touch ${destroot}${prefix}/var/run/.turd \
		${destroot}${prefix}/var/empty/.turd "
	system "install -o root -m 755 -c \
		${portpath}/files/openssh.sh ${destroot}${prefix}/etc/rc.d"
	reinplace "s|__PREFIX|${prefix}|g" \
		${destroot}${prefix}/etc/rc.d/openssh.sh
	}

# For X11 Forwarding
variant		apple-x11	{ # set for X11 forwarding
		configure.args-append --with-xauth=/usr/X11R6/bin/xauth
	}
