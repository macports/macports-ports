# $Id$

PortSystem          1.0

name                rsync
version             3.0.7
revision            1
categories          net
platforms           darwin freebsd sunos
maintainers         nomaintainer
description         Tool that provides fast incremental file transfer.
long_description    rsync is an open source utility that provides fast \
                    incremental file transfer. rsync is freely available \
                    under the GNU General Public License and is currently \
                    being maintained by Wayne Davison. \
                    \
                    Rsync version ${version} has been released. This is a \
                    bug-fix release. Related pages: \
                    http://rsync.samba.org/ftp/rsync/rsync-${version}-NEWS

homepage            http://samba.org/rsync/
master_sites        http://rsync.samba.org/ftp/rsync/ \
                    http://rsync.samba.org/ftp/rsync/src/

checksums           md5     b53525900817cf1ba7ad3a516ab5bfe9 \
                    sha1    63426a1bc71991d93159cd522521fbacdafb7a61 \
                    rmd160  aa3bdec0d7692ac1de52f2efc925e9a34bbd917b

depends_lib         port:popt port:libiconv

# these come from http://rsync.samba.org/ftp/rsync/rsync-patches-3.0.7.tar.gz
# and need to be updated with each release
patchfiles          patch-fileflags.diff \
                    patch-crtimes.diff
patch.pre_args      -p1

configure.args      --with-rsyncd-conf=${prefix}/etc/rsyncd.conf
configure.cflags   "-Os -I${prefix}/include"

pre-configure {
    system "cd ${worksrcpath}; ./prepare-source"
}

post-destroot {
    xinstall -d ${destroot}${prefix}/share/doc/${name}
    xinstall -m 644 -W ${worksrcpath} \
                    COPYING INSTALL NEWS OLDNEWS TODO README doc/README-SGML \
                    doc/profile.txt doc/rsync.sgml \
                    ${destroot}${prefix}/share/doc/${name}
}

livecheck.type      regex
livecheck.regex     "Rsync version (\\d+(?:\\.\\d+)*) released"

variant rsyncd description {Installs rsyncd.conf and a StartupItem for rsyncd} {
    post-destroot {
        xinstall -m 644 ${filespath}/rsyncd.conf.example \
                        ${destroot}${prefix}/etc/rsyncd.conf.example
        reinplace "s|__PREFIX__|${prefix}|g" \
            ${destroot}${prefix}/etc/rsyncd.conf.example
    }

    post-install {
        ui_msg "****************************************************************"
        ui_msg "*                                                              *"
        ui_msg "* To use the rsyncd server you must copy                       *"
        ui_msg "* ${prefix}/etc/rsyncd.conf.example to rsyncd.conf and add    *"
        ui_msg "* your modules there. See 'man rsyncd.conf' for more           *"
        ui_msg "* information.                                                 *"
        ui_msg "*                                                              *"
        ui_msg "****************************************************************"
    }

    startupitem.create  yes
    startupitem.name    rsyncd
    startupitem.logfile ${prefix}/var/log/rsyncd.log
    startupitem.start   "${prefix}/bin/rsync --daemon --config=${prefix}/etc/rsyncd.conf"
    startupitem.stop    "kill `cat ${prefix}/var/run/rsyncd.pid`"
    startupitem.pidfile auto ${prefix}/var/run/rsyncd.pid
}
