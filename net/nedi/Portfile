# $Id:

PortSystem	1.0

name			nedi
version			1.0.w
revision		2
categories		net
maintainers		markd@macports.org
platforms		darwin

description		Network Discovery Suite

long_description	A low noise network discovery, management, and inventory \
			system for Cisco networks with a user friendly web interface.

homepage		http://www.nedi.ch/
master_sites	        sourceforge

distname		${name}-${version}
extract.suffix		.tgz
worksrcdir		${name}
checksums		md5 cd1ce2df6bac11d51679bd491619f564
default_variants	+server

depends_lib		port:perl5.8 \
			port:mysql5 \
			port:p5-net-snmp \
			port:p5-net-ssh-perl \
			port:p5-net-telnet \
			port:p5-net-telnet-cisco \
			port:p5-algorithm-diff \
			port:p5-dbi \
			port:p5-dbd-mysql \
			port:rrdtool

variant server  {
# This variant doesn't do anything in this port, it only exists to trigger the server
# variant in the mysql5 port in cases where mysql5 was not already installed.
}

startupitem.create	yes
startupitem.name	nedimonitor
startupitem.start	"${prefix}/share/${name}/moni.pl"

variant snmptrapd {
}

use_configure		no
patch {}
build {}

destroot {
	set nedidir ${prefix}/share/
	xinstall -m 755 -d ${destroot}${nedidir}
	system "cp -R ${worksrcpath} ${destroot}${nedidir}"
}

post-destroot {
# Fix general paths
       eval reinplace "s|/usr/bin/perl|${prefix}/bin/perl|g" \
                [glob ${destroot}${prefix}/share/${name}/*.pl] \
		[glob ${destroot}${prefix}/share/${name}/inc/*.pl] \
                [glob ${destroot}${prefix}/share/${name}/html/inc/*.pl]

	reinplace "s|netstat|/usr/sbin/netstat|g" \
                ${destroot}${prefix}/share/${name}/inc/libmisc.pl

        reinplace "s|/etc/nedi.conf|${prefix}/share/nedi/nedi.conf|g" \
                ${destroot}${prefix}/share/${name}/html/inc/libmisc.php
# Fix RRDtool paths
	reinplace "s|\"rrdtool\"|\"${prefix}/bin/rrdtool\"|g" \
                ${destroot}${prefix}/share/${name}/inc/libmisc.pl
	reinplace "s|/var/nedi/rrd|${prefix}/share/${name}/rrd|g" \
		${destroot}${prefix}/share/${name}/html/inc/libgraph.php
	reinplace "s|\"rrdtool\"|\"${prefix}/bin/rrdtool\"|g" \
                ${destroot}${prefix}/share/${name}/html/inc/libgraph.php

# Create directory for rrd files
        xinstall -m 755 -d ${destroot}${prefix}/share/${name}/rrd

# Keep these empty directories
        destroot.keepdirs \
                ${destroot}${prefix}/share/${name}/db/cfg \
		${destroot}${prefix}/share/${name}/html/log \
		${destroot}${prefix}/share/${name}/rrd

# Rename nedi.conf to nedi.conf.sample so port upgrades don't overwrite an installed nedi.conf
# Also set permissions on nedi.conf because it has passwords.
	file rename ${destroot}${prefix}/share/${name}/nedi.conf \
		${destroot}${prefix}/share/${name}/nedi.conf.sample
		system "chmod 600 ${destroot}${prefix}/share/${name}/nedi.conf.sample"
}

pre-install {
# MacPorts currently only supports one startupitem per portfile, and if the snmptrapd
# variant was invoked that makes two.  So use the snmptrapd.plist file from filespath
# and copy and link it as startupitem's do.
	if { [variant_isset snmptrapd] } {
	file mkdir ${destroot}${prefix}/etc/LaunchDaemons/org.macports.snmptrapd/
	file copy ${filespath}/org.macports.snmptrapd.plist \
		${destroot}${prefix}/etc/LaunchDaemons/org.macports.snmptrapd/
	system "cd /Library/LaunchDaemons && ln -sf \
		${prefix}/etc/LaunchDaemons/org.macports.snmptrapd/org.macports.snmptrapd.plist"
	}
}

post-activate {

ui_msg "\n#### To complete the NeDi OS X installation ####


1) Using NeDi as an SNMP trap receiver
----------------------------------------------
-If you want to use NeDi to receive SNMP traps, you must install the NeDi port
 using the MacPorts variant +snmptrapd as shown:

	sudo port install nedi +snmptrapd 

-If the snmptrapd variant was not used to install NeDi, remove NeDi so it can be reinstalled.

	sudo port uninstall nedi
	sudo port clean --all nedi


2) Setup MySQL (for new installs)
-----------------------------------------------
-Configure MySQL:
        sudo -u mysql ${prefix}/lib/mysql5/bin/mysql_install_db

-Start MySQL and set it to run at system boot:
	sudo launchctl load -w /Library/LaunchDaemons/org.macports.mysql5.plist

-Set the root MySQL password:
   Follow the instructions that were given after you executed 'mysql_install_db' above.


3) Install PHP5 with SNMP support and Apache 2
------------------------------------------------
	sudo port install php5 +apache2 +mysql5 +snmp

	sudo ${prefix}/apache2/bin/apxs -a -e -n \"php5\" libphp5.so


4) Turn on Apache 2
------------------------------------------------
-Turn off Apple's Apache 1.3 (Personal Web Sharing in System Preferences).  Then execute
 these commands:

	cd ${prefix}/apache2/conf
	sudo cp httpd.conf.sample httpd.conf

   Edit the user/group variables in the Apache 2 httpd.conf to be your selected NeDi user/group.

   Start Apache 2 and set it to run at system boot:
	sudo launchctl load -w /Library/LaunchdDaemons/org.macports.apache2.plist


5) Configure NeDi, initialize database, and Login to NeDi
-----------------------------------------------
-Set NeDi owner: sudo chown -R <nedi-user>:<nedi-group> ${prefix}/share/${name}/
-Apache symlink: ln -s ${prefix}/share/${name}/html/  ${prefix}/apache2/htdocs/nedi
-Edit nedi.conf Backend/Authen/Device Access sections: sudo pico ${prefix}/share/${name}/nedi.conf
	Leave nedi.conf permissions at 600 to protect your network passwords!
backend		MSQ
dbpass		<nedidb-password>
authuser	mysql

comm <my-commnity-string> (community string of your Cisco devices)
<usr> <pass> <enablepass> (user/pass of your Cisco devices)

-Initialize the NeDi database:
	cd ${prefix}/share/${name}
	sudo ./nedi.pl -i
	When prompted for \"MySQL admin user:\" and enter 'root' and then MySQL root password.

-Set Nedi MySQL user to use old style passwords
	mysql -u root -p
	mysql> SET PASSWORD FOR nedi@localhost = OLD_PASSWORD('<nedidb-pwd>');

-Verify the NeDi DB:
        mysql -u root -p
        mysql> use nedi;
        mysql> show tables;
        mysql> exit;

-Login to the NeDi web interface: http://localhost/nedi/index.php
	Initial user/pass is 'admin'/'admin'


6) Discover Your Network with NeDi
-----------------------------------------------
-Edit nedi.conf Device Acc. variables: sudo pico ${prefix}/share/${name}/nedi.conf

comm <my-community-string>
<usr>  <pass>  <enablepass>

-Make any other desired changes in nedi.conf
-Start NeDi data collection:
	cd ${prefix}/share/${name}/nedi.pl
	sudo -u <nedi-user> nedi.pl -c -d (debug)
-Put a command in the crontab to discover your network at regular intervals.
	A typical interval is 1 hour; to get accurate NeDi rrdtool graphs at
	NeDi's default settings you must run NeDi at 1 hour intervals.
	Otherwise, you must adjust NeDi's default rrdtool settings.  To run
	NeDi every hour, the cron entry is:

0 * * * * cd ${prefix}/share/${name} ; ./nedi.pl -c >> /dev/null 2>&1


7) Set NeDi to receive device alerts and SNMP traps.  (optional)
-----------------------------------------------
-To enable NeDi alerts

	sudo load lauchctl load -w /Library/LaunchDaemons/org.macports.nedimonitor.plist

-To enable the NeDi SNMP trap receiver: (See Step 1 about the +snmptrapd variant)
 Use the snmpconf Unix utility to create an snmptrapd.conf file with the entry:

	traphandle      default ${prefix}/share/nedi/trap.pl

-Then load the startup script to run the Unix snmptrapd daemon:

	sudo load lauchctl load -w /Library/LaunchDaemons/org.macports.snmptrapd.plist
\n"
}
