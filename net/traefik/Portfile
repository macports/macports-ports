# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

github.setup        traefik traefik 2.9.6 v
github.tarball_from releases
revision            0

categories          net security devel
maintainers         {judaew @judaew} openmaintainer
license             MIT

description         The Cloud Native Application Proxy
long_description    \
    Traefik (pronounced traffic) is a modern HTTP reverse proxy and load \
    balancer that makes deploying microservices easy. Traefik integrates with \
    your existing infrastructure components (Docker, Swarm mode, Kubernetes, \
    Marathon, Consul, Etcd, Rancher, Amazon ECS, ...) and configures itself \
    automatically and dynamically. Pointing Traefik at your orchestrator \
    should be the only configuration step you need.

set arch ${build_arch}

if {${build_arch} eq "x86_64"} {
    set arch "amd64"
}

distfiles           traefik_v${version}_darwin_${arch}${extract.suffix} \
                    traefik-v${version}.src${extract.suffix}

checksums           traefik_v${version}_darwin_amd64${extract.suffix} \
                        rmd160  f52dc60f0e11102be25d78f1662d8cc556fd2aed \
                        sha256  ec77878aeced70966dd3a5442902860af54f70cbb2b840c72ae7cd0e5fc8949f \
                        size    37051798 \
                    traefik_v${version}_darwin_arm64${extract.suffix} \
                        rmd160  9e3044f21a4d35a4ef4d9ffa8442e637f49d1717 \
                        sha256  fc6b3354736a7f0367736274f033a5000ab7017ef2e56bdf7dcc6c8b60bab325 \
                        size    36413517 \
                    traefik-v${version}.src${extract.suffix} \
                        rmd160  3d57c32aa8e3d6aa90318108090648f5a2f58ed7 \
                        sha256  67b6f8c98b5207b46cf8ce64f5d98d1c713e9f0aeb091099496d3fe9755d6312 \
                        size    10662199

extract.mkdir       yes
use_configure       no
build {}

destroot {
    xinstall -m 0755 ${worksrcpath}/${name} ${destroot}${prefix}/bin/

    xinstall -d ${destroot}${prefix}/share/examples/${name}
    xinstall -m 0644 -W ${worksrcpath} \
        traefik.sample.toml traefik.sample.yml \
        ${destroot}${prefix}/share/examples/${name}

    xinstall -d ${destroot}${prefix}/etc/${name}
}
destroot.keepdirs ${destroot}${prefix}/etc/${name}

startupitem.create  yes
startupitem.start   \
    "${prefix}/bin/${name} --configfile=${prefix}/etc/${name}/traefik.toml"
startupitem.stop    "kill \$(cat ${prefix}/var/run/${name}.pid) "
startupitem.pidfile auto ${prefix}/var/run/${name}.pid

github.livecheck.regex  {([^"r-]+)}

notes "
A config must be created in
    ${prefix}/etc/traefik/traefik.toml

An example config is
    ${prefix}/share/examples/traefik/traefik.toml

Launch ${name} as daemon with
    sudo port load ${name}
or
    sudo launchctl load -w \\
        /Library/LaunchDaemons/org.macports.traefik.plist
"
