# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           java 1.0
PortGroup           xcode 1.0

name                duck
github.setup        iterate-ch cyberduck 9-2-5 release
master_sites        https://github.com/iterate-ch/cyberduck/archive/refs/tags/release-${version}
worksrcdir          cyberduck-release-${version}

revision            0

categories          net

license             GPL-2+
maintainers         {ijackson @JacksonIsaac} openmaintainer

description         CLI for Cyberduck (a multi-protocol file transfer tool)
long_description    The universal file transfer tool 'duck' which runs \
    in your shell on Linux and OS X or your Windows command line prompt. \
    Edit files on remote servers, download, upload and copy between servers \
    with FTP, SFTP or WebDAV plus support for cloud storage Amazon S3 & \
    OpenStack Swift deployments.


checksums           rmd160  cb5c8a99d21d4140f4fd9f053428438923cb8879 \
                    sha256  530746217e7212a709d2b586cf12507c1701ac6623c10470dc9bcb0b059f9f73 \
                    size    32208819

java.version        11+
java.fallback       openjdk11

depends_build       bin:mvn3:maven3
use_configure       no

set maven_local_repository ${worksrcpath}/.m2/repository

pre-build {
    file mkdir ${maven_local_repository}
    system -W ${worksrcpath}/cli/osx "mvn3 package -Dmaven.repo.local=${maven_local_repository} -DskipTests -Drevision=0 -DskipITs"
    file mkdir ${workpath}/DerivedData
    file mkdir ${workpath}/ResultBundle
}

build {
    set env(HOME) ${workpath}
    set ::env(JAVA_HOME) [exec /usr/libexec/java_home -v ${java.version}]
    
    system -W ${worksrcpath} \
        "xcodebuild \
         -derivedDataPath ${workpath}/DerivedData \
         -resultBundlePath ${workpath}/ResultBundle \
         -project ${worksrcpath}/Cyberduck.xcodeproj \
         -configuration Release \
         -target cli \
         CODE_SIGNING_ALLOWED=NO \
         CODE_SIGNING_REQUIRED=NO \
         SYMROOT=${worksrcpath}/cli/osx/target \
         VERSION=${version} \
         REVISION=0
}

destroot {
    copy -- ${worksrcpath}/osx/target/release/Cyberduck.app \
    ${destroot}${applications_dir}
}
