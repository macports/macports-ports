# $Id: Portfile,v 1.6 2005/02/01 18:57:49 rshaw Exp $

PortSystem 1.0

name			squid
version			2.5.STABLE7
revision		2
categories		net
platforms		darwin
maintainers		mww@opendarwin.org rshaw@opendarwin.org
description		advanced proxy caching server for http, https, ftp, gopher
long_description	Squid is a high-performance proxy caching server for \
				web clients, supporting FTP, gopher, and HTTP data \
				objects. Unlike traditional caching software, Squid \
				handles all requests in a single, non-blocking, \
				I/O-driven process. Squid keeps meta data and \
				especially hot objects cached in RAM, caches DNS \
				lookups, supports non-blocking DNS lookups, and \
				implements negative caching of failed requests.

homepage		http://www.squid-cache.org/
master_sites	${homepage}/Versions/v2/2.5/
checksums		md5 bf63e34906c68d716896eec0351108dc
use_bzip2		yes
patchfiles		patch-cf.data.pre.diff

configure.args	--with-pthreads \
				--mandir=${prefix}/share/man \
				--sysconfdir=${prefix}/etc/squid \
				--datadir=${prefix}/share/squid \
				--localstatedir=${prefix}/var/squid

build.args		DEFAULT_PID_FILE=${prefix}/var/run/squid/squid.pid

pre-destroot {
	addgroup squid
	set gid [existsgroup squid]
	adduser squid gid=${gid} realname=Squid\ Proxy home=${prefix}/var/squid
}
destroot.keepdirs	${destroot}${prefix}/var/run/squid \
					${destroot}${prefix}/var/squid/cache \
					${destroot}${prefix}/var/squid/logs
post-destroot	{
	reinplace "s%/etc/squid/%${prefix}&%g" \
		${destroot}${prefix}/share/man/man8/squid.8
	# squid start/stop rc script (if non-Darwin)
	if {![variant_isset darwin]} {
		xinstall -d -m 0755 ${destroot}${prefix}/etc/rc.d
		xinstall -m 0755 ${filespath}/squid.sh.in \
			${destroot}${prefix}/etc/rc.d/squid.sh
		reinplace "s%__PREFIX%${prefix}%g" \
			${destroot}${prefix}/etc/rc.d/squid.sh
		reinplace "s%__UID%squid%g" \
			${destroot}${prefix}/etc/rc.d/squid.sh
	}
	xinstall -o squid -g squid -m 755 -d \
		${destroot}${prefix}/var/run/squid \
		${destroot}${prefix}/var/squid \
		${destroot}${prefix}/var/squid/cache \
		${destroot}${prefix}/var/squid/logs
	cd ${destroot}${prefix}/etc/squid
	file delete -force squid.conf
	file rename squid.conf.default squid.conf-dist
	file delete -force mime.conf
	file rename mime.conf.default mime.conf-dist
}

pre-install {
	addgroup squid
	set gid [existsgroup squid]
	adduser squid gid=${gid} realname=Squid\ Proxy home=${prefix}/var/squid
}

post-activate {
	# Make sure initial conf files are present and setup correctly
	if {![file exists ${prefix}/etc/squid/squid.conf]} {
		xinstall -m 0644 ${prefix}/etc/squid/squid.conf-dist \
			${prefix}/etc/squid/squid.conf
	}
	if {![file exists ${prefix}/etc/squid/mime.conf]} {
		xinstall -m 0644 ${prefix}/etc/squid/mime.conf-dist \
			${prefix}/etc/squid/mime.conf
	}
}

platform darwin {
	startupitem.create			yes
	startupitem.name			Squid
	startupitem.start			"PATH=${prefix}/sbin:/bin:/usr/bin; export PATH"
	startupitem.start-append	"cd ${prefix}/var/squid"
	startupitem.start-append	"\[ -d \"${prefix}/var/squid/cache/00\" \] \\"
	startupitem.start-append	"\t|| su -fm squid -c \"exec ${prefix}/sbin/squid -s -z\""
	startupitem.start-append	"su -fm squid -c \"exec ${prefix}/sbin/squid -s\""
	startupitem.stop			"PATH=${prefix}/sbin:/bin:/usr/bin; export PATH"
	startupitem.stop-append		"cd ${prefix}/var/squid"
	startupitem.stop-append		"su -fm squid -c \"exec ${prefix}/sbin/squid -k shutdown\""
	startupitem.restart			"StopService; StartService"
}

