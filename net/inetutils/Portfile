# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0

name                    inetutils
version                 2.5
revision                0
categories              net
license                 GPL-3+
maintainers             {mps @Schamschula} openmaintainer
description             Inetutils is a collection of common network programs, including \
                        ftp, telnet, rsh, rlogin, tftp and the corresponding daemons.
long_description        {*}${description} Other tools include hostname, ifconfig, \
                        logger, ping, ping6, rcp, rexec, talk, and traceroute. \
                        Additional daemons include inetd, rexecd, syslogd and uucpd.
platforms               darwin
homepage                https://www.gnu.org/software/${name}/
master_sites            gnu:${name}
use_xz                  yes

checksums               rmd160  927d61e49ee415b56535eb4d04896e1c4c411460 \
                        sha256  87697d60a31e10b5cb86a9f0651e1ec7bee98320d048c0739431aac3d5764fb6 \
                        size    1670424

depends_lib             port:readline

configure.args          --infodir=${prefix}/share/info \
                        --mandir=${prefix}/share/man \
                        --disable-servers \
                        --disable-whois

variant client description {Enable all clients (with g prefix)} {
    post-patch {
        # grsh has a hard reference to ${prefix}/bin/rlogin
        reinplace -locale C "s|/rlogin|/grlogin|g" ${worksrcpath}/paths
        reinplace -locale C "s|/rsh|/grsh|g" ${worksrcpath}/paths
    }

    configure.args-append   --program-prefix=g
    configure.args-delete   --disable-hostname \
                            --disable-ifconfig \
                            --disable-ping \
                            --disable-ping6 \
                            --disable-talk \
                            --disable-tftp \
                            --disable-traceroute \
                            --disable-logger

    post-destroot {
        file attributes ${destroot}${prefix}/bin/grcp -permissions +s
        file attributes ${destroot}${prefix}/bin/grlogin -permissions +s
        file attributes ${destroot}${prefix}/bin/grsh -permissions +s

        xinstall -m 755 -d ${destroot}${prefix}/libexec/gnubin
        foreach binary [glob -tails -directory ${destroot}${prefix}/bin g*] {
            ln -s ${prefix}/bin/${binary} ${destroot}${prefix}/libexec/gnubin/[string range $binary 1 end]
        }

        xinstall -m 755 -d ${destroot}${prefix}/libexec/gnubin/man/man1
        foreach manpage [glob -tails -directory ${destroot}${prefix}/share/man/man1 g*] {
            ln -s ${prefix}/share/man/man1/${manpage}.gz ${destroot}${prefix}/libexec/gnubin/man/man1/[string range $manpage 1 end].gz
        }
    }

notes "
All clients are now installed with the \"g\" prefix. This means that you'll now, for\
example, find GNU telnet at ${prefix}/bin/gtelnet. If you dislike typing gtelnet,\
you can create a shell alias or you can add ${prefix}/libexec/gnubin to your PATH,\
wherein non-g* prefixed symlinks are installed. In other words,\
${prefix}/libexec/gnubin contains GNU binaries without any prefix to the file\
names, so you can type telnet and get GNU telnet just as before.\
The (g)whois client has been removed as it duplicates the separate whois port"
}

variant server description {Enable server daemons} {
    configure.args-delete    --disable-servers

    # see: https://lists.gnu.org/archive/html/bug-inetutils/2023-12/msg00001.html
    # and https://lists.gnu.org/archive/html/bug-inetutils/2023-12/msg00002.html
    patchfiles               patch-src-syslogd.c.diff

    post-destroot {
        xinstall -m 755 -d ${destroot}${prefix}/libexec/gnubin/man/man8
        foreach manpage [glob -tails -directory ${destroot}${prefix}/share/man/man8 g*] {
            ln -s ${prefix}/share/man/man8/${manpage}.gz ${destroot}${prefix}/libexec/gnubin/man/man8/[string range $manpage 1 end].gz
        }
    }
}

default_variants +client
