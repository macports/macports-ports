# $Id$

PortSystem          1.0

name                libiconv
version             1.12
categories          textproc
maintainers         ryandesign
platforms           darwin freebsd linux
homepage            http://www.gnu.org/software/libiconv/
distfiles           ${distname}${extract.suffix}:gnu
extract.only        ${distname}${extract.suffix}

master_sites \
	gnu::gnu \
	http://www2d.biglobe.ne.jp/~msyk/software/libiconv/:cp932fix

description \
	Character set conversion library

long_description \
	A character-set conversion library which implements the \
	iconv() API for dealing with unicode and other types of \
	conversion.

checksums \
	${distname}${extract.suffix} \
		md5 c2be282595751535a618ae0edeb8f648 \
		sha1 a5738d7dfbbd01c49e8ce026ea4ffa0f01af0179 \
		rmd160 74a63c1a2963ac1729c1ac7adfec8fd397a685bd \
	${distname}-cp932-devel.patch.gz \
		md5 124d240bff22e20b86e86d8c8e3bae1c \
		sha1 d989b1ce0a829fa3a12c08c3634efd5f169b399a \
		rmd160 2042116888ee28572c1f7bcc2756e4a29edfbad0

depends_build \
	bin:gperf:gperf

patchfiles \
    patch-utf8mac.diff

pre-fetch {
    if {[variant_isset universal]} {
        if {![catch {registry_active libiconv}]} {
            return -code error "libiconv needs to be deactivated/uninstalled \
            before +universal variant can be installed"
        }
    }
}

configure.args \
	--enable-static \
	--mandir=${prefix}/share/man \
	--docdir=${prefix}/share/doc/${name}-${version} \
	--without-libiconv-prefix \
	--without-libintl-prefix \
	--disable-nls \
	--enable-extra-encodings

pre-build {
	if {![variant_isset disable_utf8mac] || [variant_isset enable_cp932fix]} {
		system "cd ${worksrcpath} && make -f Makefile.devel"
	}
}

test.run            yes
test.target         check

platform darwin 7 {
	build.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.3
	configure.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.3
	depends_build-append \
		port:gperf
}

platform darwin 8 {
	build.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.4
	configure.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.4
	if {[variant_isset universal]} {
		# Fix universal build on PowerPC
		configure.ldflags-append "-isysroot ${sysroot}"
	}
}

platform freebsd {
	patchfiles-append patch-Makefile.devel
	pre-fetch { variant_set disable_utf8mac }
}

platform linux {
	pre-fetch { variant_set disable_utf8mac }
}

post-destroot {
	if {[file exists ${destroot}${prefix}/lib/charset.alias]} {
		delete ${destroot}${prefix}/lib/charset.alias
	}
}

# Do not support UTF-8-MAC encoding
variant disable_utf8mac {
	patchfiles-delete patch-utf8mac.diff
}

# Do not support extra encodings
variant disable_extra_encodings {
	configure.args-delete --enable-extra-encodings
}

# Apply a patch to fix the conversion problem between Shift-JIS and Unicode (See Microsoft KB Q170559)
variant enable_cp932fix {
	distfiles-append ${distname}-cp932-devel.patch.gz:cp932fix
	post-patch {
		system "cd ${worksrcpath} && gzip -dc '${distpath}/${distname}-cp932-devel.patch.gz' | patch -p1"
	}
}

livecheck.check freshmeat
