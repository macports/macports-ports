# $Id$

PortSystem 1.0

name                couchdb-devel
version             0.7.3a
categories          databases
platforms           darwin
description         couchdb is a document database server
maintainers         jwa
long_description    ${description}
homepage            http://incubator.apache.org/couchdb/
master_sites        http://incubator.apache.org/couchdb/
checksums           sha1 bf6506dd200ea18ea1331391da7aaece1188208d

distname            couchdb-${version}
fetch.type          svn
svn.url             http://svn.apache.org/repos/asf/incubator/couchdb/trunk
svn.tag		647574
worksrcdir          trunk

depends_lib	port:automake \
    port:autoconf \
    port:libtool \
    port:help2man \
    port:icu \
    port:spidermonkey \
    port:erlang

set dbgroup couchdb
set dbuser couchdb
set logdir ${prefix}/var/log/couchdb
set dbdir ${prefix}/var/lib/couchdb
set piddir ${prefix}/var/run/
set plistloc ${prefix}/etc/LaunchDaemons/org.macports.CouchDB

pre-configure {
    system "cd ${worksrcpath}; ./bootstrap"
}

variant server description {adds a startup item} {
    addgroup ${dbgroup}
    adduser ${dbuser} gid=[existsgroup ${dbgroup}]

    startupitem.create	yes
    startupitem.type	launchd
    startupitem.name	CouchDB
    startupitem.start	"${prefix}/bin/couchdb -b -o ${logdir}/couchdb.stdout -e ${logdir}/couchdb.stderr"
    startupitem.stop	"${prefix}/bin/couchdb -d"
}

pre-destroot {
    if { [variant_isset server] } {
	xinstall -m 755 -o ${dbuser} -g ${dbgroup} -d \
	    ${destroot}${dbdir} \
	    ${destroot}${logdir} \
	    ${destroot}${piddir}
	destroot.keepdirs-append \
	    ${destroot}${dbdir} \
	    ${destroot}${logdir} \
	    ${destroot}${piddir}
    }
}

pre-install {
    if { [variant_isset server] } {
	system "touch ${destroot}${piddir}/couchdb.pid"
	system "chown -R ${dbuser}:${dbgroup} ${destroot}${dbdir} ${destroot}${logdir} ${destroot}${piddir}/couchdb.pid"
	system "cd ${destroot}${plistloc}; patch <${filespath}/patch-org.macports.CouchDB.plist.diff"
    }
}

livecheck.check	regex
livecheck.url	http://svn.apache.org/repos/asf/incubator/couchdb/trunk
livecheck.version	${svn.tag}
livecheck.regex	Revision (\[0-9\]+)
