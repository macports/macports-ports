# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0
PortGroup           conflicts_build 1.0
PortGroup           cxx11 1.0
PortGroup           muniversal 1.0

name                mongodb
epoch               1
version             3.2.3
license             {AGPL-3 OpenSSLException}
categories          databases
maintainers         ryandesign

description         High-performance, schema-free document-oriented database
long_description    ${description}

platforms           darwin

homepage            http://www.mongodb.org/
master_sites        http://downloads.mongodb.org/src/
distname            ${name}-src-r${version}

checksums           rmd160  d67e7100b477c51a1317312d6fd938ccfeebed14 \
                    sha256  82030ada190095b5d95c0b59e9cf74efe9db602b49d2b8857b06f2683a5227fa

depends_build       port:scons

depends_lib         port:libpcap \
                    path:lib/libssl.dylib:openssl

license_noconflict  scons

pre-extract {
    if {${build_arch} eq "i386"} {
        ui_error "Building ${subport} @${version} for ${build_arch} currently fails."
        ui_error "See https://jira.mongodb.org/browse/SERVER-22810"
        return -code error "incompatible architecture"
    }
    if {[variant_isset universal]} {
        ui_error "Building ${subport} @${version} with the universal variant currently fails."
        ui_error "See https://jira.mongodb.org/browse/SERVER-22810"
        return -code error "incompatible architecture"
    }
}

use_configure       no

# mongodb 3.0.5 and later requires C++11. Forcing the use of libc++ is
# acceptable because mongodb already requires OS X 10.7 or later, so we
# know libc++ is available; mongodb doesn't provide any libraries for
# other ports to use; and the only C++ libraries mongodb uses (boost,
# pcre, snappy) are bundled.
configure.cxx_stdlib libc++

compiler.blacklist-append *gcc* {clang < 503.0.40} macports-clang-3.3

# TODO: fix me
conflicts_build     libbson mongo-c-driver mongo-cxx-driver

build.cmd           ${prefix}/bin/scons
build.target        all mongobridge mongosniff
build.args          CC="${configure.cc}" \
                    CPPPATH="${prefix}/include" \
                    CXX="${configure.cxx}" \
                    LIBPATH="${prefix}/lib" \
                    --disable-warnings-as-errors \
                    --libc++ \
                    --osx-version-min=${macosx_deployment_target} \
                    --ssl

# Specify a short variant dir because the default variant dir is deeply nested
# and can be very long, so long that on some systems the build will fail with
# "Argument list too long"; see https://jira.mongodb.org/browse/SERVER-13829
build.args-append   VARIANT_DIR=MP

supported_archs     i386 x86_64
lappend merger_build_args(x86_64) --wiredtiger=on
lappend merger_build_args(i386) --wiredtiger=off
foreach arch ${supported_archs} {
    lappend merger_build_args(${arch}) CCFLAGS='-arch ${arch}' LINKFLAGS='-arch ${arch}' TARGET_ARCH=${arch}
    lappend merger_destroot_args(${arch}) {*}$merger_build_args(${arch})
}
if {![variant_isset universal] && [info exists merger_build_args(${build_arch})]} {
    build.args-append {*}$merger_build_args(${build_arch})
}

destroot.args       {*}${build.args}
destroot.destdir    --prefix=${destroot}${prefix}

set dbdir           ${prefix}/var/db/mongodb
set logdir          ${prefix}/var/log/mongodb
set mongouser       _mongo
add_users           ${mongouser} group=${mongouser} realname=MongoDB\ Server

post-destroot {
    if {[variant_isset universal]} {
        system -W ${worksrcpath} "lipo -create ${worksrcpath}-i386/mongobridge ${worksrcpath}-x86_64/mongobridge -output mongobridge"
    }
    xinstall -W ${worksrcpath} mongobridge ${destroot}${prefix}/bin

    xinstall -m 755 -o ${mongouser} -g ${mongouser} -d \
        ${destroot}${dbdir} \
        ${destroot}${logdir}
    destroot.keepdirs-append  \
        ${destroot}${dbdir} \
        ${destroot}${logdir}
}

startupitem.create      yes
startupitem.executable  sudo -u ${mongouser} ${prefix}/bin/mongod --dbpath ${dbdir} --logpath ${logdir}/mongodb.log --logappend

if {${os.platform} eq "darwin" && ${os.major} < 11} {
    depends_build
    depends_lib
    pre-fetch {
        ui_error "${name} @${version} requires OS X 10.7 or greater."
        return -code error "incompatible OS X version"
    }
}

livecheck.url       ${homepage}downloads
livecheck.regex     {mongodb-src-r(\d+\.\d*[02468]\.\d+)\.}
