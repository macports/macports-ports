# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

name                pgloader
categories          databases
platforms           darwin
license             Permissive
homepage            https://pgloader.io
github.setup        dimitri pgloader 3.6.1 v
maintainers         @jrjsmrtn

description         Extract, transform and load data into PostgreSQL
long_description    pgloader imports data from different kind of sources \
                    and COPY it into PostgreSQL. \
                    \
                    The command language is described in the manual page \
                    and allows to describe where to find the data source, \
                    its format, and to describe data processing and \
                    transformation. \
                    \
                    Supported source formats include CSV, fixed width flat \
                    files, dBase3 files (DBF), and SQLite and MySQL \
                    databases. In most of those formats, pgloader is able \
                    to auto-discover the schema and create the tables and \
                    the indexes in PostgreSQL. In the MySQL case it's \
                    possible to edit CASTing rules from the pgloader \
                    command directly.

set cffi_patchfile  ${filespath}/patch-cffi-0.20.0-darwin-fallback-library-path.diff
set docsrcpath      ${worksrcpath}/docs
set doc_targets     {}

depends_build       port:freetds \
                    port:gawk \
                    port:sbcl

depends_lib         port:curl \
                    port:libzip \
                    port:sqlite3 \
                    port:unzip

variant man description {Build and install man pages} {
    depends_build-append port:py-sphinx
    lappend doc_targets man
}

variant docs requires man description {Build and install documentation} {
    depends_build-append port:py-sphinx_rtd_theme
    lappend doc_targets html
}

default_variants    +man

checksums           rmd160  d3b8f68c54a750c495c11b71270eed6b384b682f \
                    sha256  3969ed5a362848ead94285943f06d99c913139a5b1d5dfed47127f8b8179e66c \
                    size    3691019

patchfiles          patch-makefile.diff

use_configure       no

pre-build {
    system -W ${worksrcpath} "${build.cmd} cffi"
    system -W ${worksrcpath} "patch -p0 < ${cffi_patchfile}"
}

post-build {
    if {[variant_isset man] || [variant_isset docs]} {
        system -W ${docsrcpath} "${build.cmd} ${doc_targets}" 
    }
}

destroot {
    set bindir ${destroot}${prefix}/bin
    xinstall -d ${bindir}
    xinstall -m 755 ${worksrcpath}/build/bin/pgloader ${bindir}

    if {[variant_isset man]} {
        set mandir ${destroot}${prefix}/share/man/man1
        set manfiles [glob ${docsrcpath}/_build/man/*.1]
        xinstall -m 644 {*}${manfiles} ${mandir}
    }

    if {[variant_isset docs]} {
        set docdir ${destroot}${prefix}/share/doc/${name}
        xinstall -m 755 -d ${docdir}
        xinstall -m 644 -W ${worksrcpath} \
            INSTALL.md ISSUE_TEMPLATE.md LICENSE README.md TODO.md \
            ${docdir}
        file copy ${docsrcpath}/_build/html ${docdir}
    }
}
