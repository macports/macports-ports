# $Id: Portfile,v 1.12 2005/10/18 04:36:09 jberry Exp $

PortSystem 1.0

name			mysql5
version			5.0.13-rc
revision		3
categories		databases
platforms		darwin
maintainers		jberry@opendarwin.org mww@opendarwin.org
description		Multithreaded SQL database server
long_description	MySQL is an open-source, multi-threaded SQL database \
				with a command syntax very similar to mSQL.

homepage		http://www.mysql.com/
master_sites	http://ftp.plusline.de/mysql/Downloads/MySQL-5.0/
distname		mysql-${version}
checksums		md5 d9500d81b4253142a2a3c68b53942aab

depends_lib		port:zlib \
				port:openssl

set dbdir       ${prefix}/var/db/${name}
set mysqluser	mysql

configure.args	--mandir=${prefix}/share/man \
				--infodir=${prefix}/share/info \
				--localstatedir=${dbdir} \
				--libdir=${prefix}/lib/${name} \
				--bindir=${prefix}/lib/${name}/bin \
				--includedir=${prefix}/include/${name} \
				--datadir=${prefix}/share/${name} \
				--sysconfdir=${prefix}/etc/${name} \
				--program-transform-name='s/mysql/mysql5/g' \
				--with-zlib-dir=${prefix} \
				--with-openssl=${prefix} \
				--with-unix-socket-path=${prefix}/var/run/${name}/mysqld.sock \
				--with-mysqld-user=${mysqluser} \
				--without-docs \
				--without-bench

platform darwin 8 {
	configure.env	CC=/usr/bin/gcc-4.0 CPP=/usr/bin/cpp-4.0 CXX=/usr/bin/g++-4.0
}
				
variant server {
	# Create a startupitem to start/stop the server
	startupitem.create	yes
	startupitem.start	"${prefix}/share/mysql5/mysql/mysql5.server start"
	startupitem.stop	"${prefix}/share/mysql5/mysql/mysql5.server stop"
}

pre-destroot {
	# Some directories we must have in all cases
	xinstall -m 755 -d ${destroot}${prefix}/etc/${name}
	destroot.keepdirs-append ${destroot}${prefix}/etc/${name}
	
	# Setup only for server
	if { [variant_isset server] } {
		addgroup ${mysqluser}
		set gid [existsgroup ${mysqluser}]
		adduser ${mysqluser} gid=${gid} realname=MySQL\ Server

		# Some directories we must have only if we're running as a server
		xinstall -m 755 -o root -d ${destroot}${prefix}/var/run
		
		xinstall -m 755 -o ${mysqluser} -g ${mysqluser} -d \
			${destroot}${dbdir} \
			${destroot}${prefix}/var/run/${name}
		destroot.keepdirs-append  \
			${destroot}${dbdir} \
			${destroot}${prefix}/var/run/${name}
	}
}

post-destroot {
	system "rm -rf ${destroot}${prefix}/mysql-test/"
	system "cd ${destroot}${prefix}/bin && ln -sf ../lib/${name}/bin/mysql5 ."

	# Cleanup names in some of the scripts to account for our name mangling
	reinplace s|mysqlmanager|mysql5manager|		${destroot}${prefix}/share/mysql5/mysql/mysql5.server
	reinplace s|mysqld_safe|mysql5d_safe|		${destroot}${prefix}/share/mysql5/mysql/mysql5.server
	reinplace s|MYSQLD=mysqld|MYSQLD=mysql5d|	${destroot}${prefix}/lib/mysql5/bin/mysql5d_safe
}

post-install {
	if { [variant_isset server] } {
		ui_msg "******************************************************"
		ui_msg "* You might want to run"
		ui_msg "* sudo -u ${mysqluser} mysql_install_db"
		ui_msg "* if this is a new install" 
		ui_msg "******************************************************"
	}
}
