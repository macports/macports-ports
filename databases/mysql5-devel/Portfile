# $Id$

PortSystem 1.0

name			mysql5-devel
set vers 5.1.21
version			${vers}-beta

categories		databases
platforms		darwin

maintainers		openmaintainer@macports.org jwa

description		Multithreaded SQL database server
long_description	MySQL is an open-source, multi-threaded SQL database \
				with a command syntax very similar to mSQL.

homepage		http://www.mysql.com/
master_sites		http://dev.mysql.com/get/Downloads/MySQL-5.1/ \
    http://mysql.mirrors.pair.com/Downloads/MySQL-5.1/ \
    http://mysql.he.net/Downloads/MySQL-5.1/ \
    http://mysql.orst.edu/Downloads/MySQL-5.1 \
    http://mysql.oss.eznetsols.org/Downloads/MySQL-5.1/ \
    http://mirrors.sunsite.dk/mysql/Downloads/MySQL-5.1/ \
    http://sunsite.informatik.rwth-aachen.de/mysql/Downloads/MySQL-5.1/ \
    http://ftp.plusline.de/mysql/Downloads/MySQL-5.1/

distname mysql-${version}

checksums md5 c8e428a526b21d53c494a75b0ee01ffb \
    sha1 50ceb0df1d37a1eb94d46f60314edde2d7608bda \
    rmd160 111328f8795124940b1feaf2d840684d3e46710b

depends_lib port:zlib \
    port:openssl

set dbdir       ${prefix}/var/db/${name}
set mysqluser	mysql

configure.args	--mandir=${prefix}/share/man \
    --infodir=${prefix}/share/info \
    --localstatedir=${dbdir} \
    --libdir=${prefix}/lib/${name} \
    --bindir=${prefix}/lib/${name}/bin \
    --includedir=${prefix}/include/${name} \
    --datadir=${prefix}/share/${name} \
    --sysconfdir=${prefix}/etc/${name} \
    --program-suffix=5 \
    --with-zlib-dir=${prefix} \
    --with-ssl=${prefix} \
    --with-extra-charsets=complex \
    --with-unix-socket-path=${prefix}/var/run/${name}/mysqld.sock \
    --with-mysqld-user=${mysqluser} \
    --without-docs \
    --without-bench \
    --with-plugins=all \
    --without-server \
    --enable-thread-safe-client

post-configure {
    reinplace "s;openssl_includes = -I;openssl_includes_includes = -I${prefix}/include/openssl;" ${worksrcpath}/tests/Makefile
}

platform darwin 6 {
    pre-fetch {
	return -code error "no support for systems prior to 10.4"
    }
}

platform darwin 7 {
    pre-fetch {
	return -code error "no support for systems prior to 10.4"
    }
}

platform darwin 8 {
    configure.compiler	gcc-4.0
    configure.cppflags-append	-I${worksrcpath}/include
}
				
variant server {
    configure.args-delete --without-server
    # Create a startupitem to start/stop the server
    startupitem.create	yes
    startupitem.start	"${prefix}/share/${name}/mysql/mysql.server start"
    startupitem.stop	"${prefix}/share/${name}/mysql/mysql.server stop"
}

# the directory ${prefix}/sql-bench
destroot.violate_mtree	yes

pre-destroot {
    # Some directories we must have in all cases
    xinstall -m 755 -d ${destroot}${prefix}/etc/${name}
    destroot.keepdirs-append ${destroot}${prefix}/etc/${name}
	
    # Setup only for server
    if { [variant_isset server] } {
	addgroup ${mysqluser}
	set gid [existsgroup ${mysqluser}]
	adduser ${mysqluser} gid=${gid} realname=MySQL\ Server

	# Some directories we must have only if we're running as a server
	xinstall -m 755 -o root -d ${destroot}${prefix}/var/run
		
	xinstall -m 755 -o ${mysqluser} -g ${mysqluser} -d \
	    ${destroot}${dbdir} \
	    ${destroot}${prefix}/var/run/${name}
	destroot.keepdirs-append  \
	    ${destroot}${dbdir} \
	    ${destroot}${prefix}/var/run/${name}
    }
}

post-destroot {
    system "rm -rf ${destroot}${prefix}/mysql-test/"
	
    # Symlink mysql binaries into bin directory
    foreach f [glob -tails -directory ${destroot}${prefix}/lib/${name}/bin my*] {
	ln -sf ${prefix}/lib/${name}/bin/${f} ${destroot}${prefix}/bin
    }
}

post-install {
    if { [variant_isset server] } {
	ui_msg "******************************************************"
	ui_msg "* In order to setup the database, you might want to run"
	ui_msg "* sudo -u ${mysqluser} mysql_install_db5"
	ui_msg "* if this is a new install" 
	ui_msg "******************************************************"
    }
}

livecheck.check		regex
livecheck.url		http://dev.mysql.com/
livecheck.version	${vers}
livecheck.regex		"Beta (5\.1\.\[0-9\.\]+)"
