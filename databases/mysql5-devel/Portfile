# $Id$

PortSystem 1.0

name			mysql5-devel
version			5.1.18-beta

categories		databases
platforms		darwin

maintainers		openmaintainer@macports.org jwa@macports.org

description		Multithreaded SQL database server
long_description	MySQL is an open-source, multi-threaded SQL database \
				with a command syntax very similar to mSQL.

homepage		http://www.mysql.com/
master_sites		http://dev.mysql.com/get/Downloads/MySQL-5.1/ \
    http://mysql.mirrors.pair.com/Downloads/MySQL-5.1/ \
    http://mysql.he.net/Downloads/MySQL-5.1/ \
    http://mysql.orst.edu/Downloads/MySQL-5.1 \
    http://mysql.oss.eznetsols.org/Downloads/MySQL-5.1/ \
    http://mirrors.sunsite.dk/mysql/Downloads/MySQL-5.1/ \
    http://sunsite.informatik.rwth-aachen.de/mysql/Downloads/MySQL-5.1/ \
    http://ftp.plusline.de/mysql/Downloads/MySQL-5.1/

distname mysql-${version}

checksums md5 50aace960b9489e5d57be4224755cdf4 \
    sha1 952440720f7d56507445ad656781b6df0a23a4f5

depends_lib port:zlib \
    port:openssl

patchfiles	patch-mysys-base64.c
				
set dbdir       ${prefix}/var/db/${name}
set mysqluser	mysql

configure.args	--mandir=${prefix}/share/man \
    --infodir=${prefix}/share/info \
    --localstatedir=${dbdir} \
    --libdir=${prefix}/lib/${name} \
    --bindir=${prefix}/lib/${name}/bin \
    --includedir=${prefix}/include/${name} \
    --datadir=${prefix}/share/${name} \
    --sysconfdir=${prefix}/etc/${name} \
    --with-zlib-dir=${prefix} \
    --with-ssl=${prefix} \
    --with-extra-charsets=complex \
    --with-unix-socket-path=${prefix}/var/run/${name}/mysqld.sock \
    --with-mysqld-user=${mysqluser} \
    --without-docs \
    --without-bench \
    --with-plugins=all \
    --without-server \
    --enable-thread-safe-client

post-configure {
    reinplace "s;openssl_includes = -I;openssl_includes_includes = -I${prefix}/include/openssl;" tests/Makefile
}

platform darwin 6 {
    ui_msg "no support for systems prior to 10.4"
}

platform darwin 7 {
    ui_msg "no support for systems prior to 10.4"
}

platform darwin 8 {
    configure.env	CC=/usr/bin/gcc-4.0 CPP=/usr/bin/cpp-4.0 CXX=/usr/bin/g++-4.0
}
				
variant server {
    configure.args-delete --without-server
    # Create a startupitem to start/stop the server
    startupitem.create	yes
    startupitem.start	"${prefix}/share/mysql5/mysql/mysql.server start"
    startupitem.stop	"${prefix}/share/mysql5/mysql/mysql.server stop"
}

pre-destroot {
    # Some directories we must have in all cases
    xinstall -m 755 -d ${destroot}${prefix}/etc/${name}
    destroot.keepdirs-append ${destroot}${prefix}/etc/${name}
	
    # Setup only for server
    if { [variant_isset server] } {
	addgroup ${mysqluser}
	set gid [existsgroup ${mysqluser}]
	adduser ${mysqluser} gid=${gid} realname=MySQL\ Server

	# Some directories we must have only if we're running as a server
	xinstall -m 755 -o root -d ${destroot}${prefix}/var/run
		
	xinstall -m 755 -o ${mysqluser} -g ${mysqluser} -d \
	    ${destroot}${dbdir} \
	    ${destroot}${prefix}/var/run/${name}
	destroot.keepdirs-append  \
	    ${destroot}${dbdir} \
	    ${destroot}${prefix}/var/run/${name}
    }
}

post-destroot {
    system "rm -rf ${destroot}${prefix}/mysql-test/"
	
    # Symlink mysql binaries into bin directory, with a 5 appended to the name
    foreach f [glob -tails -directory ${destroot}${prefix}/lib/${name}/bin my*] {
	system "cd ${destroot}${prefix}/bin && ln -sf ../lib/${name}/bin/${f} ${f}5"
    }
}

post-install {
    if { [variant_isset server] } {
	ui_msg "******************************************************"
	ui_msg "* In order to setup the database, you might want to run"
	ui_msg "* sudo -u ${mysqluser} mysql_install_db5"
	ui_msg "* if this is a new install" 
	ui_msg "******************************************************"
    }
}
