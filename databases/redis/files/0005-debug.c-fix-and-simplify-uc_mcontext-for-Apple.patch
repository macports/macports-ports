From 366f3fa68cad44188ac8245020b663d29cf557ea Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Wed, 11 Sep 2024 18:16:35 +0800
Subject: [PATCH 5/5] debug.c: fix and simplify uc_mcontext for Apple

---
 src/debug.c | 18 ++++++------------
 1 file changed, 6 insertions(+), 12 deletions(-)

diff --git src/debug.c src/debug.c
index 78bacc946..a7b885068 100644
--- src/debug.c
+++ src/debug.c
@@ -1210,21 +1210,15 @@ static void* getAndSetMcontextEip(ucontext_t *uc, void *eip) {
     } \
     return old_val; \
 } while(0)
-#if defined(__APPLE__) && !defined(MAC_OS_10_6_DETECTED)
-    /* OSX < 10.6 */
-    #if defined(__x86_64__)
-    GET_SET_RETURN(uc->uc_mcontext->__ss.__rip, eip);
-    #elif defined(__i386__)
-    GET_SET_RETURN(uc->uc_mcontext->__ss.__eip, eip);
-    #else
+#if defined(__APPLE__)
+    /* OSX PowerPC */
+    #if defined(__POWERPC__)
     GET_SET_RETURN(uc->uc_mcontext->__ss.__srr0, eip);
-    #endif
-#elif defined(__APPLE__) && defined(MAC_OS_10_6_DETECTED)
-    /* OSX >= 10.6 */
-    #if defined(_STRUCT_X86_THREAD_STATE64) && !defined(__i386__)
-    GET_SET_RETURN(uc->uc_mcontext->__ss.__rip, eip);
+    /* OSX x86 */
     #elif defined(__i386__)
     GET_SET_RETURN(uc->uc_mcontext->__ss.__eip, eip);
+    #elif defined(__x86_64__) || defined(_STRUCT_X86_THREAD_STATE64)
+    GET_SET_RETURN(uc->uc_mcontext->__ss.__rip, eip);
     #else
     /* OSX ARM64 */
     void *old_val = (void*)arm_thread_state64_get_pc(uc->uc_mcontext->__ss);
-- 
2.46.0

