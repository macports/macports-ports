# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               active_variants 1.1

name                    couchdb
version                 3.5.0
revision                0

categories              databases
license                 Apache-2
maintainers             {ciserlohn @ci42} {makr @mohd-akram} openmaintainer

description             CouchDB is a document database server

long_description        ${description} with a restful HTTP API, capable of \
                        storing arbitrary JSON documents, building powerful \
                        data views, defined in JavaScript, and processed in \
                        parallel using Map/Reduce. \
                        It leaves out SQL and transactions for simplicity's \
                        sake, to improve scalability and to relax users' lives.

homepage                https://couchdb.apache.org/

master_sites            apache
master_sites.mirror_subdir ${name}/source/${version}/
distname                apache-${name}-${version}

checksums               rmd160  a50644f972825032b10c53cbac6b5b179a248b2a \
                        sha256  6a98b90a9a980bbef2c35b4996a8e71a2f1ae5227546c85f04c436101bdf78bf \
                        size    24165005

depends_build           port:erlang

depends_lib             path:lib/pkgconfig/icu-uc.pc:icu \
                        port:ncurses \
                        path:lib/libssl.dylib:openssl \
                        port:zlib

# erlang is not universal
universal_variant       no

require_active_variants erlang ssl

set dbgroup             ${name}
set dbuser              ${name}
set logdir              ${prefix}/var/log/${name}
set dbdir               ${prefix}/var/db/${name}
set confdir             ${prefix}/etc/${name}
set datadir             ${prefix}/share/${name}
set docdir              ${prefix}/share/doc/${name}
set rundir              ${prefix}/var/run/${name}

startupitem.create      yes
startupitem.uniquename  org.apache.couchdb
startupitem.user        ${dbuser}
startupitem.group       ${dbgroup}
startupitem.executable  ${prefix}/bin/couchdb

add_users               ${dbuser} group=${dbgroup} home=${rundir} \
                        realname=CouchDB\ Database\ Server

configure.pre_args
configure.args          --disable-spidermonkey

set root                ${worksrcpath}/rel/couchdb
set dest                ${prefix}/libexec/${name}

destroot.target         release

post-destroot {
    xinstall -d ${destroot}${dest}

    copy ${root}/bin ${root}/lib ${root}/releases ${root}/erts-16.0 \
        ${destroot}${dest}
    delete ${destroot}${dest}/bin/couchdb.cmd
    ln -s ${dest}/bin/couchdb ${dest}/bin/remsh ${dest}/bin/weatherreport \
        ${destroot}${prefix}/bin

    xinstall -d ${destroot}${confdir}
    copy {*}[glob ${root}/etc/*] ${destroot}${confdir}

    xinstall -d ${destroot}${docdir}
    copy ${root}/LICENSE ${destroot}${docdir}
    move ${destroot}${confdir}/local.ini ${destroot}${docdir}

    xinstall -d ${destroot}${datadir}
    copy ${root}/share/www ${destroot}${datadir}

    copy ${root}/share/docs/couchdb.1 ${destroot}${prefix}/share/man/man1

    # TODO - patch the source to use these paths directly
    ln -s ${confdir} ${destroot}${dest}/etc
    ln -s ${datadir} ${destroot}${dest}/share
    ln -s ${dbdir} ${destroot}${dest}/data

    xinstall -m 755 -o ${dbuser} -g ${dbgroup} -d \
        ${destroot}${dbdir} \
        ${destroot}${logdir} \
        ${destroot}${rundir}

    destroot.keepdirs-append \
        ${destroot}${dbdir} \
        ${destroot}${logdir} \
        ${destroot}${rundir}
}

post-activate {
    if {![file exists ${confdir}/local.ini]} {
        copy ${docdir}/local.ini ${confdir}/local.ini
    }
}

livecheck.type          regex
livecheck.url           https://couchdb.apache.org/downloads.html
livecheck.regex         apache-${name}-(\[0-9.\]+\[0-9\]+)
