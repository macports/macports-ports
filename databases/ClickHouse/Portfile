# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github  1.0
PortGroup           cmake   1.1

github.setup        ClickHouse ClickHouse 22.4.2.1 v -stable

description         ClickHouse® is a free analytics DBMS for big data

long_description \
    ClickHouse® is an open-source column-oriented database management \
    system that allows generating analytical data reports in real-time.

notes {
    Install the ClickHouse-server port to run ClickHouse as a system service.
}

categories          databases
maintainers         @slarew openmaintainer
license             Apache-2
platforms           darwin

# clickhouse overrides the deployment target so match it
macosx_deployment_target 10.15

installs_libs       no

# require vanilla clang
compiler.whitelist  macports-clang-13 macports-clang-14

cmake.build_type    RelWithDebInfo
cmake.generator     Ninja

variant debug description "Enable debug binaries" {
    cmake.build_type    Debug
}

# Fetch with git and then fetch all the submodules.
fetch.type          git
post-fetch {
    system -W ${worksrcpath} "git submodule update --init --recursive --depth 1"
}

# Reset these variables to remove ${prefix}/include because ClickHouse really
# wants to build against its own dependencies.
compiler.cpath
compiler.library_path
configure.env
configure.ldflags
configure.cppflags

# point cmake at llvm prefix
set llvm_prefix [exec [exec ${configure.cc} -print-prog-name=llvm-config] --prefix]
cmake.module_path ${llvm_prefix}

configure.args-append \
    -DENABLE_CCACHE=OFF \
    -DENABLE_TESTS=OFF

post-destroot {
    # Comply with porthier.
    file delete -force ${destroot}${prefix}/cmake
    file delete -force ${destroot}${prefix}/lib

    # Fix prefix in config files
    reinplace -W ${destroot}${prefix}/etc -- "s|/etc|${prefix}/etc|g" \
        clickhouse-server/config.xml \
        clickhouse-server/users.xml \
        clickhouse-keeper/keeper_config.xml \
        clickhouse-client/config.xml
    reinplace -W ${destroot}${prefix}/etc -- \
        "s|/var/lib/clickhouse|${prefix}/var/db/clickhouse|g" \
        clickhouse-server/config.xml \
        clickhouse-server/users.xml \
        clickhouse-keeper/keeper_config.xml \
        clickhouse-client/config.xml
    reinplace -W ${destroot}${prefix}/etc -- "s|/var/log|${prefix}/var/log|g" \
        clickhouse-server/config.xml \
        clickhouse-server/users.xml \
        clickhouse-keeper/keeper_config.xml \
        clickhouse-client/config.xml

    file rename ${destroot}${prefix}/etc/clickhouse-server/config.xml ${destroot}${prefix}/etc/clickhouse-server/config.xml.dist
    file rename ${destroot}${prefix}/etc/clickhouse-server/users.xml ${destroot}${prefix}/etc/clickhouse-server/users.xml.dist
    file rename ${destroot}${prefix}/etc/clickhouse-keeper/keeper_config.xml ${destroot}${prefix}/etc/clickhouse-keeper/keeper_config.xml.dist
    file rename ${destroot}${prefix}/etc/clickhouse-client/config.xml ${destroot}${prefix}/etc/clickhouse-client/config.xml.dist
}

universal_variant   no
