# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             openjdk-distributions
categories       java devel
maintainers      {breun.nl:nils @breun} openmaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
# These ports use prebuilt binaries for a particular architecture, they are not universal binaries
universal_variant no

# Note: This is the version/revision for the parent stub only
version          1.0
revision         0

set long_description_corretto \
   "No-cost, multiplatform, production-ready distribution of OpenJDK."

set long_description_ibm_semeru \
    "The IBM Semeru Runtimes are free production-ready open source binaries to run your Java applications built with\
the OpenJDK class libraries and the Eclipse OpenJ9 JVM."

set long_description_sap \
    "Sap builds of openjdk for everyone who wish to use OpenJDK to run their applications."

set long_description_temurin \
    "Eclipse Temurin provides secure, TCK-tested and compliant, production-ready Java runtimes."

set long_description_graalvm \
    "GraalVM is a universal virtual machine for running applications written in JavaScript, Python, Ruby, R,\
    JVM-based languages like Java, Scala, Groovy, Kotlin, Clojure, and LLVM-based languages such as C and C++."

set long_description_zulu \
    "Azul® Zulu® is a Java Development Kit (JDK), and a compliant implementation of the Java Standard Edition (SE)\
    specification that contains all the Java components needed to build and run Java SE applications. Zulu has been\
    verified by passing all tests of the OpenJDK Community Technology Compatibility Kit (TCK) as available for each\
    respective Java SE version."

# Dummy default values
set build          0
set openj9_version 0

set obsoleted_ports {
    openjdk
    openjdk8-graalvm
    openjdk8-openj9-large-heap
    openjdk11-openj9-large-heap
    openjdk16
    openjdk16-graalvm
    openjdk16-temurin
    openjdk16-zulu
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0

    replaced_by  openjdk-distributions
    description
    long_description
    homepage
    master_sites
}

if {${subport} eq ${name}} {
    set meta true
    description          "Meta port encompassing binary OpenJDK releases"
    long_description     {*}${description}
    homepage
    master_sites

    distfiles
    patchfiles
    supported_archs      noarch
    use_configure        no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo $subport is a stub port > ${docdir}/README"
    }

    notes {
        The openjdk-distributions port is not installable, but recommends users to install\
        the latest Long Term Support (LTS) subport
    }
}

subport openjdk7-zulu {
    # https://www.azul.com/downloads/?version=java-7-lts&os=macos&package=jdk
    supported_archs  x86_64

    version      7.54.0.13
    revision     0

    set openjdk_version 7.0.342

    description  Azul Zulu Community OpenJDK 7 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    checksums    rmd160  5b7a9a2a6c08501a6585df46389d8438b1df23d7 \
                 sha256  dcc720d6fe21f4c73d41e3276c032396f4e0a91f51b0fcf2b6530a3daa93c61d \
                 size    68525632

    worksrcdir   ${distname}/zulu-7.jdk

    configure.cxx_stdlib libstdc++
}

subport openjdk8-corretto {
    # https://github.com/corretto/corretto-8/releases
    supported_archs  x86_64 arm64

    version     8.332.08.1
    revision    0

    description  Amazon Corretto OpenJDK 8 (Long Term Support)
    long_description ${long_description_corretto}

    master_sites https://corretto.aws/downloads/resources/${version}/

    if {${configure.build_arch} eq "x86_64"} {
        distname     amazon-corretto-${version}-macosx-x64
        checksums    rmd160  4d61d171dccf47712455d3b4e3976a56de7ac665 \
                     sha256  6a6e9a6d2592c3705ef736256486133e0c7f4adf8cbd90e8c95f2bda460c01ed \
                     size    118754955
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     amazon-corretto-${version}-macosx-aarch64
        checksums    rmd160  cb801bae9d5b436a6ffe014d4827e2a78aece294 \
                     sha256  0801bcdf8bb85032a450ac78ffadcf9cfc0d1218c5cdf8a25e3ad1b31200a21e \
                     size    102882291
    }

    worksrcdir   amazon-corretto-8.jdk
}

# Remove after 2022-10-19
subport openjdk8-graalvm {
    version      21.0.0.2
    revision     2
    replaced_by  openjdk11-graalvm
}

subport openjdk8-openj9 {
    # https://developer.ibm.com/languages/java/semeru-runtimes/downloads?os=macOS
    supported_archs  x86_64

    version      8u332
    revision     0

    set build    09
    set openj9_version 0.32.0

    homepage     https://developer.ibm.com/languages/java/semeru-runtimes/

    description  Open Java Development Kit 8 (IBM Semeru) with Eclipse OpenJ9 VM
    long_description ${long_description_ibm_semeru}

    master_sites https://github.com/ibmruntimes/semeru8-binaries/releases/download/jdk${version}-b${build}_openj9-${openj9_version}/
    distname     ibm-semeru-open-jdk_x64_mac_${version}b${build}_openj9-${openj9_version}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  2311bc6a6bc259adee9c7bba01f0133ce2846f21 \
                 sha256  f4b1ec4b1ba3eb318642ddcbb0c02d67e6edfc9e37a7c3bfb13630e4806942e2 \
                 size    128972742
}

subport openjdk8-temurin {
    # https://adoptium.net/temurin/releases/
    supported_archs  x86_64

    version      8u332
    revision     0

    set build    09

    description  Eclipse Temurin, based on OpenJDK 8
    long_description ${long_description_temurin}

    master_sites https://github.com/adoptium/temurin8-binaries/releases/download/jdk${version}-b${build}/
    distname     OpenJDK8U-jdk_x64_mac_hotspot_${version}b${build}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  20fa5b11b34ee833b62cca7d9d7d6f76b9047759 \
                 sha256  a75e8182bb8e77a02c7b4d9f93120c64c1988e2c415b3646d4f4496544e87291 \
                 size    107924497
}

subport openjdk11-corretto {
    # https://github.com/corretto/corretto-11/releases
    supported_archs  x86_64 arm64

    version      11.0.15.9.1
    revision     0

    description  Amazon Corretto OpenJDK 11 (Long Term Support)
    long_description ${long_description_corretto}

    master_sites https://corretto.aws/downloads/resources/${version}/

    if {${configure.build_arch} eq "x86_64"} {
        distname     amazon-corretto-${version}-macosx-x64
        checksums    rmd160  752d92e2e87d3feda836e7c7afa39982ea6b24f3 \
                     sha256  36afb7f091cd9b986a50c3f878f167c59eae615f004b2cb1c5c394f9f2fc215a \
                     size    187526579
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     amazon-corretto-${version}-macosx-aarch64
        checksums    rmd160  d1980a49d5539b892a6ed09f7d100501da1c7d80 \
                     sha256  939f0cc40f4dd749647e352ea2759fbf73c8c59662476ca237113abf9eed0710 \
                     size    185394420
    }

    worksrcdir   amazon-corretto-11.jdk
}

subport openjdk11-graalvm {
    # https://github.com/graalvm/graalvm-ce-builds/releases
    supported_archs  x86_64 arm64

    version      22.1.0
    revision     0

    description  GraalVM Community Edition based on OpenJDK 11
    long_description ${long_description_graalvm}

    master_sites https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${version}/

    if {${configure.build_arch} eq "x86_64"} {
        distname     graalvm-ce-java11-darwin-amd64-${version}
        checksums    rmd160  6c4afee0143d6cf4373fa8faf36a6e3eeb4bce22 \
                     sha256  c4c9df94ca47b83b582758b87d39042732ba0193fc63f1ab93f6818005a1fe6b \
                     size    435795441
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     graalvm-ce-java11-darwin-aarch64-${version}
        checksums    rmd160  5e834b8bc8ea1150e1f8f95bdc623a81d904fddc \
                     sha256  06bc19a0b1e93aa3df5e15c08e97f8cef624cb6070eeae40a69a51ec7fd41152 \
                     size    404445467
    }

    worksrcdir   graalvm-ce-java11-${version}
}

subport openjdk11-openj9 {
    # https://developer.ibm.com/languages/java/semeru-runtimes/downloads?os=macOS
    supported_archs  x86_64 arm64

    version      11.0.15
    revision     0

    set build    10
    set openj9_version 0.32.0

    homepage     https://developer.ibm.com/languages/java/semeru-runtimes/

    description  Open Java Development Kit 11 (IBM Semeru) with Eclipse OpenJ9 VM
    long_description ${long_description_ibm_semeru}

    master_sites https://github.com/ibmruntimes/semeru11-binaries/releases/download/jdk-${version}%2B${build}_openj9-${openj9_version}/
    distname     ibm-semeru-open-jdk_x64_mac_${version}_${build}_openj9-${openj9_version}

    if {${configure.build_arch} eq "x86_64"} {
        distname     ibm-semeru-open-jdk_x64_mac_${version}_${build}_openj9-${openj9_version}
        checksums    rmd160  2d8d7a2633be194c0975642e9b3ef070c9f55a97 \
                     sha256  53d18ed227d02ebc73344255a07b6331aa7d990abfd12fce1396376afcfd17cc \
                     size    203564021
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     ibm-semeru-open-jdk_aarch64_mac_${version}_${build}_openj9-${openj9_version}
        checksums    rmd160  5c09b0cd81b4466b320a7c997c9ba2eaf67933f6 \
                     sha256  f71a81f3496ad5cda9bb1f2f23dbb47360202dedca126cf8e92437b3f017d11e \
                     size    180597648
    }

    worksrcdir   jdk-${version}+${build}
}

subport openjdk11-sap {
    # https://sap.github.io/SapMachine/latest/11
    supported_archs  x86_64

    version      11.0.15.0.1
    revision     0
    
    description  OpenJDK 11 builds (Long Term Support) maintained and supported by SAP
    long_description ${long_description_sap}
    
    master_sites https://github.com/SAP/SapMachine/releases/download/sapmachine-${version}/
    distname     sapmachine-jdk-${version}_osx-x64_bin
    worksrcdir   sapmachine-jdk-${version}.jdk
    
    checksums    rmd160  c5cb8d973381ee35aaab6f11367c1f41bfa7e5af \
                 sha256  7744b3632fba1c6e8339b9fb74c46728f8109c07070df49d898799832a934abd \
                 size    186905770

}

subport openjdk11-temurin {
    # https://adoptium.net/temurin/releases/
    supported_archs  x86_64

    version      11.0.15
    revision     0

    set build    10

    description  Eclipse Temurin, based on OpenJDK 11
    long_description ${long_description_temurin}

    master_sites https://github.com/adoptium/temurin11-binaries/releases/download/jdk-${version}%2B${build}/

    distname     OpenJDK11U-jdk_x64_mac_hotspot_${version}_${build}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  5d66fe3d953619e7a6ca326110654344f1883773 \
                 sha256  ebd8b9553a7b4514599bc0566e108915ce7dc95d29d49a9b10b8afe4ab7cc9db \
                 size    186328533
}

# Remove after 2022-09-14
subport openjdk16 {
    version      16.0.2
    revision     1
    replaced_by  openjdk17
}

# Remove after 2022-10-19
subport openjdk16-graalvm {
    version      21.2.0
    revision     1
    replaced_by  openjdk17-graalvm
}

# Remove after 2022-09-14
subport openjdk16-temurin {
    version      16.0.2
    revision     1
    replaced_by  openjdk17-temurin
}

# Remove after 2022-09-14
subport openjdk16-zulu {
    version      16.32.15
    revision     1
    replaced_by  openjdk17-zulu
}

if {${os.platform} eq "darwin"} {
    # https://trac.macports.org/wiki/PortfileRecipes#compare-osx-darwin-version
    if {[string match *-openj9 ${subport}] && ${os.major} < 14} {
        # See https://www.ibm.com/support/pages/semeru-runtimes-support
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.10 Yosemite or later."
            return -code error
        }
    } elseif {[string match *-temurin ${subport}] && ${os.major} < 16} {
        # See https://adoptium.net/supported_platforms.html
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.12 Sierra or later."
            return -code error
        }
    } elseif {[string match *-zulu ${subport}] && ${os.major} < 18} {
        # See https://www.azul.com/downloads/?os=macos&package=jdk
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.14 Mojave or later."
            return -code error
        }
    }
}

if {[string match *-graalvm ${subport}]} {
    homepage     https://www.graalvm.org
} elseif {[string match *-zulu ${subport}]} {
    homepage     https://www.azul.com/downloads/
} elseif {[string match *-sap ${subport}]} {
    homepage     https://sapmachine.io/
} elseif {[string match *-temurin ${subport}]} {
    homepage     https://adoptium.net
} elseif {[string match *-corretto ${subport}]} {
    homepage     https://aws.amazon.com/corretto/
}

livecheck.type  none

use_configure    no
build {}

if {!(${subport} in ${obsoleted_ports}) && ![info exists meta]} {
    if {![string match *-temurin ${subport}]} {
        variant BundledApp \
            description { Advertise the JVM capability "BundledApp". This is required by some java-based app bundles to recognize and use the JVM.} {}

        variant JNI \
            description { Advertise the JVM capability "JNI". This is required by some java-based app bundles to recognize and use the JVM.} {}
    }

    variant Applets \
        description { Advertise the JVM capability "Applets".} {}

    variant WebStart \
        description { Advertise the JVM capability "WebStart".} {}

    patch {
        foreach var { Applets BundledApp JNI WebStart } {
            if {[variant_isset ${var}]} {
                reinplace -E "s|^(\[\[:space:\]\]*<string>)CommandLine(</string>)|\\1${var}\\2\\\n\\1CommandLine\\2|" ${worksrcpath}/Contents/Info.plist
            }
        }
    }

    test.run    yes
    test.cmd    Contents/Home/bin/java
    test.target
    test.args   -version

    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes

    set target /Library/Java/JavaVirtualMachines/${subport}
    set destroot_target ${destroot}${target}

    destroot {
        xinstall -m 755 -d ${destroot_target}
        copy ${worksrcpath}/Contents ${destroot_target}

        if {${subport} eq "openjdk7-zulu"} {
            # MacPorts reports this file as broken
            delete ${destroot_target}/Contents/Home/jre/lib/xawt/libmawt.dylib
        }
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${target}/Contents/Home
    "
}    
