# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             sap-sapmachine
categories       java devel
maintainers      nomaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
# These ports use prebuilt binaries for a particular architecture, they are not universal binaries
universal_variant no

# Latest Long Term Support (LTS) major version
version          17

set long_description_sap \
    "Sap builds of openjdk for everyone who wish to use OpenJDK to run their applications."

set obsoleted_ports {
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0

}

if {${subport} eq "sap-sapmachine"} {
    depends_run-append    port:sapmachine-openjdk${version}
    description           OpenJDK builds (Long Term Support) maintained and supported by SAP
    long_description      {*}${long_description_sap}
    distfiles
    patchfiles
    supported_archs       noarch
    use_configure         no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo $subport is a stub port > ${docdir}/README"
    }
}

subport sapmachine-openjdk11 {
    # https://sap.github.io/SapMachine/latest/11
    supported_archs  x86_64

    version      11.0.14.1
    revision     0

    description  OpenJDK 11 builds (Long Term Support) maintained and supported by SAP
    long_description ${long_description_sap}

    master_sites https://github.com/SAP/SapMachine/releases/download/sapmachine-${version}/
    distname     sapmachine-jdk-${version}_osx-x64_bin
    worksrcdir   sapmachine-jdk-${version}.jdk

    checksums    rmd160  22e2f87e45bb3bec3df2d862398e03a6d0a84f98 \
                 sha256  497c5d0e697867f44f62a6cf5a8caabe2ceb623dd6c229278a3d5c1d3d11d9fb \
                 size    186755870

}

subport sapmachine-openjdk17 {
    # https://sap.github.io/SapMachine/latest/17
    supported_archs  x86_64 arm64

    version      17.0.2
    revision     0

    description  OpenJDK 17 builds (Long Term Support) maintained and supported by SAP
    long_description ${long_description_sap}

    master_sites https://github.com/SAP/SapMachine/releases/download/sapmachine-${version}/

    if {${configure.build_arch} eq "x86_64"} {
        distname     sapmachine-jdk-${version}_macos-x64_bin
        checksums    rmd160  5c2458e509263d50ffdc5a647e2d4f3dd830c8e5 \
                     sha256  228b9952002dd60e626c46b8ff051e8e25d577d358390cd52dd7e4ea50863cef \
                     size    180149241
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     sapmachine-jdk-${version}_macos-aarch64_bin
        checksums    rmd160  0aab18f0e415d024d0461ba5ba3f9e2b00f0f4e5 \
                     sha256  06c28b5365527db346b5d2e121e5f70baaef0ddde07766c59c17bfc577a0e4c2 \
                     size    177867623
    }
    worksrcdir   sapmachine-jdk-${version}.jdk
}

if {[string match sapmachine-openjdk* ${subport}]} {
    homepage     https://sapmachine.io/
}

livecheck.type  none

use_configure    no
build {}

if {[string match sapmachine-openjdk* ${subport}]} {
    test.run    yes
    test.cmd    Contents/Home/bin/java
    test.target
    test.args   -version

    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes

    set target /Library/Java/JavaVirtualMachines/${subport}
    set destroot_target ${destroot}${target}

    destroot {
        xinstall -m 755 -d ${destroot_target}
        copy ${worksrcpath}/Contents ${destroot_target}
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${target}/Contents/Home
    "
}    
