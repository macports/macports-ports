# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                openjdk
# Latest Long Term Support (LTS) major version
version             17
revision            0
categories          java devel
platforms           darwin
supported_archs     noarch
license             GPL-2+
maintainers         nomaintainer
universal_variant   no

if {${subport} eq "openjdk"} {
        description         Openjdk builds
        long_description    Openjdk Builds of Openjdk, Open-Source implementation of the Java \
                            Platform, Standard Edition, and related projects.
        homepage            https://openjdk.java.net
        depends_run-append  port:openjdk${version}
        distfiles
        patchfiles
        supported_archs     noarch
        use_configure    no
        build {}
        destroot {
            set docdir ${destroot}${prefix}/share/doc/${subport}
            xinstall -d ${docdir}
            system "echo ${subport} is a stub port > ${docdir}/README"
        }
    }

subport openjdk8 {
    # https://github.com/openjdk/jdk8u/tags
    # use tags having '-ga' at end
    # remove 'jdk' from begining of the tag, '-ga' from the end of the tag and add to it the version
    set u 322
    version             8u${u}
    revision            0
    epoch               1
    set jver 1.8.0_${u}
    set tpath /Library/Java
    description         Openjdk 8u
    long_description    Openjdk 8u builds of Openjdk, Open-Source implementation \
                        of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    fetch.type          git
    git.url             https://github.com/openjdk/jdk8u
    git.branch             jdk${version}-ga
    worksrcdir          openjdk8
    # remove pre-patch phase after jdk8u341-ga tag
    pre-patch {
        reinplace "s|JDK_UPDATE_VERSION=|JDK_UPDATE_VERSION=${u}|g" ${worksrcpath}/common/autoconf/version-numbers
    }
    patchfiles          patch-openjdk8u-xcode-configure1.diff \
                        patch-openjdk8u-xcode-configure2.diff
    use_xcode           yes
    use_configure    yes
    configure.cmd       sh ./configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk8-bootstrap.jdk/Contents/Home \
                        --with-debug-level=release \
                        --with-freetype-include=${prefix}/include/freetype2 \
                        --with-freetype-lib=${prefix}/lib \
                        --with-target-bits=64 \
                        --with-conf-name=openjdk${version}
    build.type          gnu
    build.target        images
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk8-bootstrap \
                        port:freetype
    set jdkn jdk${jver}.jdk
    set bundle_dir /build/openjdk${version}/images/j2sdk-bundle/${jdkn}/Contents
    set jren jre${jver}.jre
    destroot.violate_mtree      yes
    set pathb ${tpath}/JavaVirtualMachines/${subport}.jdk
    set jrepath /build/openjdk${version}/images/j2re-bundle/${jren}/Contents
    set pathc ${tpath}/JavaVirtualMachines/${subport}.jre

    pre-destroot {
        xinstall -m 755 -d ${destroot}${pathc}
        copy ${worksrcpath}${jrepath} ${destroot}${pathc}
    }

    destroot {
        xinstall -m 755 -d ${destroot}${pathb}
        copy ${worksrcpath}${bundle_dir} ${destroot}${pathb}
    }

    post-destroot {
        delete ${worksrcpath}
    }

    notes "
    If you want to make ${subport} the default JDK, add this to shell profile:
    export JAVA_HOME=${pathb}/Contents/Home
    "
}

subport openjdk11 {
    # https://github.com/openjdk/jdk11u/tags
    # use tags having '-ga' at end
    # remove 'jdk-' from the begining of the tag, '-ga' from the end of the tag and add to it the version
    version             11.0.14.1
    revision            0
    epoch               1
    set tpath /Library/Java
    description         Openjdk 11 updates
    long_description    Openjdk 11 updates of Openjdk, Open-Source implementation \
                        of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64 arm64
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-debug-level=optimized \
                        --with-native-debug-symbols=none \
                        --with-version-pre=release \
                        --with-target-bits=64 \
                        --with-sysroot=`xcrun --sdk macosx --show-sdk-path`
    configure.post_args --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk11-bootstrap.jdk/Contents/Home \
                        --disable-warnings-as-errors \
                        --with-conf-name=openjdk${version}
    fetch.type          git
    git.url             https://github.com/openjdk/jdk11u
    git.branch             jdk-${version}-ga
    worksrcdir          openjdk11
    build.type          gnu
    build.target        images
    build.post_args     CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk11-bootstrap
    set jdkn jdk-${version}.jdk
    set bundle_dir /build/openjdk${version}/images/jdk-bundle/${jdkn}/Contents
    destroot.violate_mtree      yes
    set pathb ${tpath}/JavaVirtualMachines/${subport}.jdk

    destroot {
        xinstall -m 755 -d ${destroot}${pathb}
        copy ${worksrcpath}${bundle_dir} ${destroot}${pathb}
    }

    post-destroot {
        delete ${worksrcpath}
    }

    notes "
    If you want to make ${subport} the default JDK, add this to shell profile:
    export JAVA_HOME=${pathb}/Contents/Home
    "
}

subport openjdk13 {
    # https://github.com/openjdk/jdk13u/tags
    # use tags having '-ga' at end
    # remove 'jdk-' from the begining of the tag, '-ga' from the end of the tag and add to it the version
    version             13.0.10
    revision            0
    epoch               1
    set tpath /Library/Java
    description         Openjdk 13 updates
    long_description    Openjdk 13 updates of Openjdk, Open-Source implementation \
                        of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-debug-level=optimized \
                        --with-native-debug-symbols=none \
                        --with-version-pre=release \
                        --with-target-bits=64 \
                        --with-sysroot=`xcrun --sdk macosx --show-sdk-path`
    configure.post_args --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk13-bootstrap.jdk/Contents/Home \
                        --disable-warnings-as-errors \
                        --with-conf-name=openjdk${version}
    fetch.type          git
    git.url             https://github.com/openjdk/jdk13u
    git.branch             jdk-${version}-ga
    worksrcdir          openjdk13
    build.type          gnu
    build.target        images
    build.post_args     CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk13-bootstrap
    set jdkn jdk-${version}.jdk
    set bundle_dir /build/openjdk${version}/images/jdk-bundle/${jdkn}/Contents
    destroot.violate_mtree      yes
    set pathb ${tpath}/JavaVirtualMachines/${subport}.jdk

    destroot {
        xinstall -m 755 -d ${destroot}${pathb}
        copy ${worksrcpath}${bundle_dir} ${destroot}${pathb}
    }

    post-destroot {
        delete ${worksrcpath}
    }

    notes "
    If you want to make ${subport} the default JDK, add this to shell profile:
    export JAVA_HOME=${pathb}/Contents/Home
    "
}

subport openjdk15 {
    # https://github.com/openjdk/jdk15u/tags
    # use tags having '-ga' at end
    # remove 'jdk-' from the begining of the tag, '-ga' from the end of the tag and add to it the version
    version             15.0.6
    revision            0
    epoch               1
    set tpath /Library/Java
    description         Openjdk 15 updates
    long_description    Openjdk 15 updates of Openjdk, Open-Source implementation \
                        of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    patchfiles          patch-openjdk15u-build-fix.diff
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-debug-level=optimized \
                        --with-native-debug-symbols=none \
                        --with-version-pre=release \
                        --with-target-bits=64 \
                        --with-sysroot=`xcrun --sdk macosx --show-sdk-path`
    configure.post_args --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk15-bootstrap.jdk/Contents/Home \
                        --disable-warnings-as-errors \
                        --with-conf-name=openjdk${version}
    fetch.type          git
    git.url             https://github.com/openjdk/jdk15u
    git.branch             jdk-${version}-ga
    worksrcdir          openjdk15
    build.type          gnu
    build.target        images
    build.post_args     CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk15-bootstrap
    set jdkn jdk-${version}.jdk
    set bundle_dir /build/openjdk${version}/images/jdk-bundle/${jdkn}/Contents
    destroot.violate_mtree      yes
    set pathb ${tpath}/JavaVirtualMachines/${subport}.jdk

    destroot {
        xinstall -m 755 -d ${destroot}${pathb}
        copy ${worksrcpath}${bundle_dir} ${destroot}${pathb}
    }

    post-destroot {
        delete ${worksrcpath}
    }

    notes "
    If you want to make ${subport} the default JDK, add this to shell profile:
    export JAVA_HOME=${pathb}/Contents/Home
    "
}

subport openjdk17 {
    # https://github.com/openjdk/jdk17u/tags
    # use tags having '-ga' at end
    # remove 'jdk-' from the begining of the tag, '-ga' from the end of the tag and add to it the version
    version             17.0.2
    revision            0
    epoch               1
    set tpath /Library/Java
    description         Openjdk 17 updates
    long_description    Openjdk 17 updates of Openjdk, Open-Source implementation \
                        of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64 arm64
    use_configure    yes
    # Xcode is required for latest metal graphics
    use_xcode           yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-debug-level=optimized \
                        --with-native-debug-symbols=none \
                        --with-version-pre=release \
                        --with-target-bits=64
    configure.post_args --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk17-bootstrap.jdk/Contents/Home \
                        --disable-warnings-as-errors \
                        --with-conf-name=openjdk${version}
    fetch.type          git
    git.url             https://github.com/openjdk/jdk17u
    git.branch             jdk-${version}-ga
    worksrcdir          openjdk17
    build.type          gnu
    build.target        images
    build.post_args     CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk17-bootstrap
    set jdkn jdk-${version}.jdk
    set bundle_dir /build/openjdk${version}/images/jdk-bundle/${jdkn}/Contents
    destroot.violate_mtree      yes
    set pathb ${tpath}/JavaVirtualMachines/${subport}.jdk

    destroot {
        xinstall -m 755 -d ${destroot}${pathb}
        copy ${worksrcpath}${bundle_dir} ${destroot}${pathb}
    }

    post-destroot {
        delete ${worksrcpath}
    }

    notes "
    If you want to make ${subport} the default JDK, add this to shell profile:
    export JAVA_HOME=${pathb}/Contents/Home
    "
}
