# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             openjdk
categories       java devel
maintainers      {breun.nl:nils @breun} openmaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
supported_archs  x86_64

# Latest Long Term Support (LTS) major version
version          11

if {${subport} eq "openjdk"} {
    # The openjdk port is not installable, but recommends users to install the latest Long Term Support (LTS) subport
    PortGroup    obsolete 1.0
    replaced_by  openjdk${version}
}

# Dummy default values for the obsoleted openjdk port
set build        0
set openj9_version 0

set long_description_adoptopenjdk_intro \
   "OpenJDK build provided by AdoptOpenJDK, built from a fully open-source set of build scripts and infrastructure."

set long_description_adoptopenjdk_hotspot \
    "${long_description_adoptopenjdk_intro} HotSpot is the VM from the OpenJDK community and the most widely used VM.\
It is suitable for all workloads."

set long_description_adoptopenjdk_openj9 \
    "${long_description_adoptopenjdk_intro} OpenJ9 is the virtual machine from the Eclipse community. It is an enterprise-grade\
VM designed for low memory usage and fast start-up and is used in IBM’s JDK. It is suitable for running all workloads."

set long_description_adoptopenjdk_openj9xl \
    "${long_description_adoptopenjdk_openj9} This version uses non-compressed references and should be used for\
applications which require heaps that are over ~57 GB."

set long_description_graalvm \
    "GraalVM is a universal virtual machine for running applications written in JavaScript, Python, Ruby, R,\
    JVM-based languages like Java, Scala, Groovy, Kotlin, Clojure, and LLVM-based languages such as C and C++."

set long_description_zulu \
    "Azul® Zulu® is a Java Development Kit (JDK), and a compliant implementation of the Java Standard Edition (SE)\
    specification that contains all the Java components needed to build and run Java SE applications. Zulu has been\
    verified by passing all tests of the OpenJDK Community Technology Compatibility Kit (TCK) as available for each\
    respective Java SE version."

subport openjdk8 {
    version      8u282
    revision     1

    set build    08

    description  Open Java Development Kit 8 (AdoptOpenJDK) with HotSpot VM
    long_description ${long_description_adoptopenjdk_hotspot}

    master_sites https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk${version}-b${build}/
    distname     OpenJDK8U-jdk_x64_mac_hotspot_${version}b${build}
    worksrcdir   jdk${version}-b${build}

    configure.cxx_stdlib libstdc++

    checksums    rmd160  3187d760b3cbeaaf01d47481f069a3e2d1011cfd \
                 sha256  1766d756f6e4a5d41b539f2ecf83e5a33e9336bd75f1602e8f4b4afbb8f47aaa \
                 size    101808251
}

subport openjdk8-graalvm {
    version      21.0.0.2
    revision     1

    description  GraalVM Community Edition based on OpenJDK 8
    long_description ${long_description_graalvm}

    master_sites https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${version}/
    distname     graalvm-ce-java8-darwin-amd64-${version}
    worksrcdir   graalvm-ce-java8-${version}
    
    checksums    rmd160  2fc5f23a1558b5e125ef91ad137270fe4f2b4d0c \
                 sha256  25a653a44b3ad63479d7ae35d921c8d39282ff1849243f1afc0ffddd443e9079 \
                 size    349277690
}

subport openjdk8-openj9 {
    version      8u282
    revision     1

    set build    08
    set openj9_version 0.24.0

    description  Open Java Development Kit 8 (AdoptOpenJDK) with Eclipse OpenJ9 VM
    long_description ${long_description_adoptopenjdk_openj9}

    master_sites https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk${version}-b${build}_openj9-${openj9_version}/
    distname     OpenJDK8U-jdk_x64_mac_openj9_${version}b${build}_openj9-${openj9_version}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  b66caafe41d50052fa438dfcef5fdf58430f42c8 \
                 sha256  265d4fb01b61ed7a3a9fae6a50bcf6322687b5f08de8598d8e42263cbd8b5772 \
                 size    115586057
}

subport openjdk8-zulu {
    version      8.54.0.21
    revision     0

    set openjdk_version 8.0.292

    description  Azul Zulu Community OpenJDK 8 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/
    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    worksrcdir   ${distname}/zulu-8.jdk

    configure.cxx_stdlib libstdc++

    checksums    rmd160  886fe3a9b2161d63ce14bd10be8f571984e4f82d \
                 sha256  369e0d0d76d73cb161978ff07d7020820bb3cd2465f6f91219bb6492e302f4dd \
                 size    108162260
}

subport openjdk8-openj9-large-heap {
    version      8u282
    revision     1

    set build    08
    set openj9_version 0.24.0

    description  Open Java Development Kit 8 (AdoptOpenJDK) with Eclipse OpenJ9 VM for large heap sizes
    long_description ${long_description_adoptopenjdk_openj9xl}

    master_sites https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk${version}-b${build}_openj9-${openj9_version}/
    distname     OpenJDK8U-jdk_x64_mac_openj9_macosXL_${version}b${build}_openj9-${openj9_version}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  e4797c143ca666baa428a252bb130251af25a1b2 \
                 sha256  64f2b106bc5c65ed963a72893e3d676df58704718dd86fc0fcbbb61e615e4742 \
                 size    116297701
}

# Remove after 2021-11-28
subport openjdk10 {
    version      10.0.2
    revision     3

    PortGroup    obsolete 1.0
    replaced_by  openjdk11
}

subport openjdk11 {
    version      11.0.10
    revision     1

    set build    9

    description  Open Java Development Kit 11 (AdoptOpenJDK) with HotSpot VM
    long_description ${long_description_adoptopenjdk_hotspot}

    master_sites https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-${version}%2B${build}/
    distname     OpenJDK11U-jdk_x64_mac_hotspot_${version}_${build}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  3c1f62a95095aee9f0ee3d02ba4a4a67f5425ba1 \
                 sha256  ee7c98c9d79689aca6e717965747b8bf4eec5413e89d5444cc2bd6dbd59e3811 \
                 size    186160219
}

subport openjdk11-graalvm {
    version      21.1.0
    revision     0

    description  GraalVM Community Edition based on OpenJDK 11
    long_description ${long_description_graalvm}

    master_sites https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${version}/
    distname     graalvm-ce-java11-darwin-amd64-${version}
    worksrcdir   graalvm-ce-java11-${version}
    
    checksums    rmd160  61d5ec36d1671168fbcc236e4653a3be24198a69 \
                 sha256  b53cd5a085fea39cb27fc0e3974f00140c8bb774fb2854d72db99e1be405ae2b \
                 size    396142137
}

subport openjdk11-openj9 {
    version      11.0.10
    revision     1

    set build    9
    set openj9_version 0.24.0

    description  Open Java Development Kit 11 (AdoptOpenJDK) with Eclipse OpenJ9 VM
    long_description ${long_description_adoptopenjdk_openj9}

    master_sites https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-${version}%2B${build}_openj9-${openj9_version}/
    distname     OpenJDK11U-jdk_x64_mac_openj9_${version}_${build}_openj9-${openj9_version}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  68da07a92466f0ce17d814e29f20985b95689853 \
                 sha256  58f931dc30160b04da2d94af32e0dfa384f4b2cf92b7217c0937fd057e668d54 \
                 size    196594593
}

subport openjdk11-openj9-large-heap {
    version      11.0.10
    revision     1

    set build    9
    set openj9_version 0.24.0

    description  Open Java Development Kit 11 (AdoptOpenJDK) with Eclipse OpenJ9 VM for large heap sizes
    long_description ${long_description_adoptopenjdk_openj9xl}

    master_sites https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-${version}%2B${build}_openj9-${openj9_version}/
    distname     OpenJDK11U-jdk_x64_mac_openj9_macosXL_${version}_${build}_openj9-${openj9_version}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  66e4e36eb013a66d7970c3874046b80e771cd36d \
                 sha256  ac6998c1a7945dab9d008e3702a69ed86488321aea197961f72375e8bc8bc114 \
                 size    195829115
}

subport openjdk11-zulu {
    version      11.48.21
    revision     0

    set openjdk_version 11.0.11

    description  Azul Zulu Community OpenJDK 11 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/
    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    worksrcdir   ${distname}/zulu-11.jdk

    checksums    rmd160  49e6888a1ec6749b09ac5daf725e46d9cb02e8f2 \
                 sha256  866b25c47aa3bedddc57fbe38fd7d2e0f888d314b85d1e88b2fb12100f3c166c \
                 size    195386841
}

# Remove after 2022-02-15
subport openjdk12 {
    version      12.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk12-openj9 {
    version      12.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk12-openj9-large-heap {
    version      12.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk13 {
    version      13.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk13-openj9 {
    version      13.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk13-openj9-large-heap {
    version      13.0.2
    revision     1
}

subport openjdk13-zulu {
    version      13.40.15
    revision     0

    set openjdk_version 13.0.7

    description  Azul Zulu Community OpenJDK 13 (Medium Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/
    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    worksrcdir   ${distname}/zulu-13.jdk

    checksums    rmd160  f84e38dc8b92928b6aed9e35b6da3eb5f63e4b23 \
                 sha256  a53b31c4eb6db57feceefd16ebadd07525514bdec8dbab6f9644e81ac1b97543 \
                 size    200105932
}

# Remove after 2022-02-15
subport openjdk14 {
    version      14.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk14-openj9 {
    version      14.0.2
    revision     1
}

# Remove after 2022-02-15
subport openjdk14-openj9-large-heap {
    version      14.0.2
    revision     1
}

# Remove after 2022-03-22
subport openjdk15 {
    version      15.0.2
    revision     1
}

# Remove after 2022-03-22
subport openjdk15-openj9 {
    version      15.0.2
    revision     1
}

# Remove after 2022-03-22
subport openjdk15-openj9-large-heap {
    version      15.0.2
    revision     1
}

subport openjdk15-zulu {
    version      15.32.15
    revision     0

    set openjdk_version 15.0.3

    description  Azul Zulu Community OpenJDK 15 (Medium Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/
    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    worksrcdir   ${distname}/zulu-15.jdk

    checksums    rmd160  9b67ab3d55b7b358417dbd22e5d8c10d67ed4370 \
                 sha256  87df2e9adc1e27c2ffe9a1f8b88d0ba3eeb4cc81c77fc6a3a02788e22484d07b \
                 size    201723476
}

subport openjdk16 {
    version      16
    revision     1

    set build    36

    description  Open Java Development Kit 16 (AdoptOpenJDK) with HotSpot VM
    long_description ${long_description_adoptopenjdk_hotspot}

    master_sites https://github.com/AdoptOpenJDK/openjdk16-binaries/releases/download/jdk-${version}%2B${build}/
    distname     OpenJDK16-jdk_x64_mac_hotspot_${version}_${build}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  7ef653cce09364235a659cc9dd721281fec95d98 \
                 sha256  b66761b55fd493ed2a5f4df35a32b338ec34a9e0a1244439e3156561ab27c511 \
                 size    199955659
}

subport openjdk16-graalvm {
    version      21.1.0
    revision     0

    description  GraalVM Community Edition based on OpenJDK 16
    long_description ${long_description_graalvm}

    master_sites https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${version}/
    distname     graalvm-ce-java16-darwin-amd64-${version}
    worksrcdir   graalvm-ce-java16-${version}

    checksums    rmd160  4bec36c128b42d324f6e7a513501e7c7c7b2fd4c \
                 sha256  dafece9d03251304a6d9fc242862cfc08b85e2b8921d3b019a8a19b95af78e2c \
                 size    404268013
}

subport openjdk16-openj9 {
    version      16
    revision     1

    set build    36
    set openj9_version 0.25.0

    description  Open Java Development Kit 16 (AdoptOpenJDK) with Eclipse OpenJ9 VM
    long_description ${long_description_adoptopenjdk_openj9}

    master_sites https://github.com/AdoptOpenJDK/openjdk16-binaries/releases/download/jdk-${version}%2B${build}_openj9-${openj9_version}/
    distname     OpenJDK16-jdk_x64_mac_openj9_${version}_${build}_openj9-${openj9_version}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  94087f2b59cc2a27d289488f7b76a714a57706b5 \
                 sha256  e6075cbe939b4de165cc8b4b91352f8885d549873f5cd419e75eba737502542e \
                 size    206412428
}

subport openjdk16-zulu {
    version      16.28.11
    revision     0

    set openjdk_version 16.0.0

    description  Azul Zulu Community OpenJDK 16 (Short Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/
    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    worksrcdir   ${distname}/zulu-16.jdk

    checksums    rmd160  1c60ae0f5ab1f6d3482ca5470145a5fd0b93f543 \
                 sha256  6d47ef22dc56ce1f5a102ed39e21d9a97320f0bb786818e2c686393109d79bc5 \
                 size    206457844
}

if {${os.platform} eq "darwin"} {
    # https://trac.macports.org/wiki/PortfileRecipes#compare-osx-darwin-version
    if {[string match *-zulu ${subport}] && ${os.major} < 17} {
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.13 Mavericks or later."
            return -code error
        }
    } elseif {${os.major} < 14} {
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.10 Yosemite or later."
            return -code error
        }
    }
}

if {${subport} in [list openjdk12 openjdk13 openjdk14 openjdk15]} {
    PortGroup    obsolete 1.0
    # Can replace with openjdk17 when it is added and openjdk16 is obsoleted
    replaced_by  openjdk16
} elseif {${subport} in [list openjdk12-openj9 openjdk12-openj9-large-heap openjdk13-openj9 openjdk13-openj9-large-heap openjdk14-openj9 openjdk14-openj9-large-heap openjdk15-openj9 openjdk15-openj9-large-heap]} {
    PortGroup    obsolete 1.0
    # Can replace with openjdk17-openj9 when it is added and openjdk16-openj9 is obsoleted
    replaced_by  openjdk16-openj9
}

if {[string match *-graalvm ${subport}]} {
    homepage     https://www.graalvm.org
} elseif {[string match *-zulu ${subport}]} {
    homepage     https://www.azul.com/downloads/zulu-community/
} else {
    homepage     https://adoptopenjdk.net
}

livecheck.type  none

variant Applets \
    description { Advertise the JVM capability "Applets".} {}

variant BundledApp \
    description { Advertise the JVM capability "BundledApp". This is required by some java-based app bundles to recognize and use the JVM.} {}

variant JNI \
    description { Advertise the JVM capability "JNI". This is required by some java-based app bundles to recognize and use the JVM.} {}

variant WebStart \
    description { Advertise the JVM capability "WebStart".} {}

patch {
    foreach var { Applets BundledApp JNI WebStart } {
        if {[variant_isset ${var}]} {
            reinplace -E "s|^(\[\[:space:\]\]*<string>)CommandLine(</string>)|\\1${var}\\2\\\n\\1CommandLine\\2|" ${worksrcpath}/Contents/Info.plist
        }
    }
}

use_configure    no

build {}

# macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
destroot.violate_mtree yes

set target /Library/Java/JavaVirtualMachines/${subport}
set destroot_target ${destroot}${target}

destroot {
    xinstall -m 755 -d ${destroot_target}
    copy ${worksrcpath}/Contents ${destroot_target}
}

notes "
If you have more than one JDK installed you can make ${subport} the default
by adding the following line to your shell profile:

    export JAVA_HOME=${target}/Contents/Home
"
