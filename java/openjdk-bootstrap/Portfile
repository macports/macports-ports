# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                openjdk-bootstrap
# Latest Long Term Support (LTS) major version
version             17
revision            0
categories          java devel
platforms           darwin
supported_archs     noarch
license             GPL-2+
maintainers         nomaintainer
universal_variant   no

if {${subport} eq "openjdk-bootstrap"} {
    description         Openjdk builds
    long_description    Openjdk Builds of Openjdk, Open-Source implementation of the Java \
                        Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    depends_run-append  port:openjdk${version}-bootstrap
    distfiles
    patchfiles
    supported_archs     noarch
    use_configure    no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo ${subport} is a stub port > ${docdir}/README"
    }
}

set long_description_openjdk-ga \
    "Production-ready open-source builds of the Openjdk, \
    Open Source implementation of the Java Platform, Standard Edition, and related projects."

subport openjdk8-bootstrap {
    version             8u201
    revision            0
    description         Openjdk 8
    long_description    {*}${long_description_openjdk-ga}
    homepage            https://javadl.sun.com/
    distfiles           ${distname}.dmg
    master_sites        ${homepage}webapps/download/AutoDL?BundleId=236866_42970487e3af4f5aa5bca3f542482c60
    fetch {
        system -W ${distpath} "${prefix}/bin/curl -o ${distpath}/${distfiles} -L ${master_sites}"
    }
    extract {
        system -W ${workpath} "mkdir -p ${worksrcpath}/dmg"
        system -W ${workpath} "mkdir -p ${worksrcpath}/pkg"
        system -W ${workpath} "mkdir -p ${worksrcpath}/files"
        system -W ${distpath} "hdiutil attach ${distpath}/${distfiles} -mountroot ${worksrcpath}/dmg"
        system -W ${worksrcpath}/dmg "cp ${worksrcpath}/dmg/*/*.pkg ${worksrcpath}/pkg"
        system -W ${worksrcpath}/dmg "hdiutil detach ${worksrcpath}/dmg/*"
        system -W ${worksrcpath}/pkg "mv ${worksrcpath}/pkg/*.pkg ${worksrcpath}/pkg/jdk${version}.pkg"
        system -W ${worksrcpath}/pkg "${prefix}/bin/xar -xf ${worksrcpath}/pkg/jdk${version}.pkg -C ${worksrcpath}/files"
        system -W ${worksrcpath} "tar -xf ${worksrcpath}/files/jdk180201.pkg/Payload -C ${worksrcpath}"
    }
    supported_archs     x86_64
    checksums           rmd160  b237dd06774127454df314a28fa6b297b50a0dbf \
                        sha256  5b52df4b3efd51480c40ad5abfa18a075365afbb2040bbc5e9f2db568435a6e2 \
                        size    257863467
    distname            jdk-8u201-macosx-x64
    worksrcdir          jdk${version}
    depends_fetch       port:curl
    depends_extract     port:xar
}

subport openjdk11-bootstrap {
    version             11
    revision            0
    set build           28
    description         openjdk 11 builds
    long_description    {*}${long_description_openjdk-ga}
    homepage            https://jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/ga/jdk${version}/

    checksums           rmd160  c914d38c78b2943c7b47ff2da4e8da89438f96cd \
                        sha256  6b969d2df6a9758d9458f5ba47939250e848dfba8b49e41c935cf210606b6d38 \
                        size    182717049

    distname            openjdk-11_osx-x64_bin
    worksrcdir          jdk-11.jdk
}

subport openjdk13-bootstrap {
    version             13
    revision            0
    set build           33
    description         openjdk 13 builds
    long_description    {*}${long_description_openjdk-ga}
    homepage            https://jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/GA/jdk${version}/5b8a42f3905b406298b72d750b6919f6/${build}/GPL/

    checksums           rmd160  d9dd9241fa5d6fbdf0ab59acdb8e21e8c5f98a5f \
                        sha256  1a9c096630a0e4f27ce61ac9e477378b8581c537568186d4afd0b416a7e9dd68 \
                        size    189943388

    distname            openjdk-13_osx-x64_bin
    worksrcdir          jdk-13.jdk
    use_xcode           no
    use_configure    no
}

subport openjdk15-bootstrap {
    version             15
    revision            0
    set build           36
    description         openjdk 15 builds
    long_description    {*}${long_description_openjdk-ga}
    homepage            https://jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/GA/jdk${version}/779bf45e88a44cbd9ea6621d33e33db1/${build}/GPL/

    checksums           rmd160  3b40c853f52afa324178c90deb867659e9d99c24 \
                        sha256  ab842c8c0953b816be308c098c1a021177a4776bef24da85b6bafbbd657c7e1a \
                        size    192743279

    distname            openjdk-15_osx-x64_bin
    worksrcdir          jdk-15.jdk
    use_xcode           no
    use_configure    no
}

subport openjdk17-bootstrap {
    version             17
    revision            0
    set build           35
    description         openjdk 17 builds
    long_description    {*}${long_description_openjdk-ga}
    homepage            https://jdk.java.net
    supported_archs     x86_64 arm64
    master_sites        https://download.java.net/java/GA/jdk${version}/0d483333a00540d886896bac774ff48b/${build}/GPL/
    if {${configure.build_arch} eq "x86_64"} {
        checksums           rmd160  22047e850be0cfafb6d16a9bf6d08914ca724c9a \
                            sha256  18e11cf9bbc6f584031e801b11ae05a233c32086f8e1b84eb8a1e9bb8e1f5d90 \
                            size    184007871
        distname            openjdk-17_macos-x64_bin
    } elseif {${configure.build_arch} eq "arm64"} {
        checksums           rmd160  fbcfd2cc8d00322902f7c8c257985e43130d097a \
                            sha256  b5bf6377aabdc935bd72b36c494e178b12186b0e1f4be50f35134daa33bda052 \
                            size    181735146
        distname            openjdk-17_macos-aarch64_bin
    }
    worksrcdir          jdk-17.jdk
    use_xcode           no
    use_configure    no
}

if {[string match openjdk*-bootstrap ${subport}]} {
    use_xcode           no
    use_configure    no
    build {}
    destroot.violate_mtree      yes

    set path /Library/Java/JavaVirtualMachines/${subport}.jdk

    destroot {
        xinstall -m 755 -d ${destroot}${path}
        copy ${worksrcpath}/Contents ${destroot}${path}
    }
    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
    export JAVA_HOME=${path}/Contents/Home
    "
}
