# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                Openjdk-U
# Latest Long Term Support (LTS) major version
version             17
revision            0
description         Replaced by Openjdk${version}u
categories          java devel
platforms           darwin
supported_archs     noarch
license             GPL-2+
maintainers         nomaintainer
universal_variant   no

set long_description_openjdk-ga \
    "Production-ready open-source builds of the Openjdk, \
    Open Source, Open Innovation, Open Standards \
    implementation of the Java Platform, Standard Edition, and related projects."

set long_description_graalvm \
    "GraalVM – a high-performance JDK distribution. It is designed to \
    accelerate the execution of applications written in Java and other JVM languages while \
    also providing runtimes for JavaScript, Ruby, Python, and a number of other popular \
    languages. GraalVM’s polyglot capabilities make it possible to mix multiple programming \
    languages in a single application while eliminating any foreign language call costs.
    "

set obsoleted_ports {
    Openjdk-U
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0
}

if {${subport} eq "Openjdk-U"} {
    # The openjdk port is not installable, but recommends users to install the latest Long Term Support (LTS) subport
    replaced_by  openjdk${version}u
}

# For openjdk 8 : Use openjdk 8 prebuilt binaries of openjdk projects (current project:- https://openjdk.java.net/projects/graal)
# For openjdk 8 or later : Add ports with major version as odd numbers. Use 'https://git.openjdk.java.net/(git repository name from https://github.com/openjdk)'
# For openjdk 8 or older : Use the openjdk[Major version]-boot for boot jdk and Use the openjdk[Major versionu]-j2 for openjdk
# For openjdk 9 or later : Use boot jdk as mentioned in Openjdk's installation guide (https://openjdk.java.net/install/)
# For openjdk 11 or later subports : Use the openjdk[Major version]-boot for boot jdk and Use the openjdk[Major versionu]-j for openjdk 

subport openjdk8-boot {
    version             21.0.0.2
    description         Openjdk 8 GraalVM
    long_description    ${long_description_graalvm}
    homepage            https://www.graalvm.org/
    master_sites        https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${version}
    supported_archs     x86_64

    checksums           rmd160  2fc5f23a1558b5e125ef91ad137270fe4f2b4d0c \
                        sha256  25a653a44b3ad63479d7ae35d921c8d39282ff1849243f1afc0ffddd443e9079 \
                        size    349277690

    distname            graalvm-ce-java8-darwin-amd64-${version}
    worksrcdir          graalvm-ce-java8-${version}
    set jdk_path ${worksrcdir}/Contents/Home
}

subport openjdk8u-j2 {
    # Project Skara jdk8u transition: https://hg.openjdk.java.net/jdk8u/jdk8u → https://hg.openjdk.java.net/jdk8u/monojdk8u → https://git.openjdk.java.net/jdk8u → https://github.com/openjdk/jdk8u
    # https://github.com/openjdk/jdk8u/tags
    version             8u332-b03
    set bv 1.8.0_332
    set tpath /Library/Java
    description         Openjdk 8u
    long_description    Openjdk 8u builds of Openjdk, Open-Source implementation of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk8u
    use_xcode           yes
    patch {
        reinplace "s|JDK_UPDATE_VERSION=|JDK_UPDATE_VERSION=332|g" ${worksrcpath}/common/autoconf/version-numbers
    }
    use_configure    yes
    configure.cmd       sh ./configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/graalvm-ce-java8-21.0.0.2/Contents/Home \
                        --with-freetype-include=${prefix}/include/freetype2 \
                        --with-freetype-lib=${prefix}/lib \
                        --with-conf-name=openjdk${bv}
    build.type          gnu
    build.target        images
    build.post_args     JOBS=`sysctl -n hw.ncpu`
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk8-boot \
                        port:freetype
}

subport openjdk11-boot {
    version             11.0.2
    set build           9
    description         openjdk 11 builds
    long_description    ${long_description_openjdk-ga}
    homepage            jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/GA/jdk11/${build}/GPL/

    checksums           rmd160  e20276958ef069ed748d881ef1eaac7dea6e121d \
                        sha256  f365750d4be6111be8a62feda24e265d97536712bc51783162982b8ad96a70ee \
                        size    182670822

    distname            openjdk-11.0.2_osx-x64_bin
    worksrcdir          jdk-11.0.2.jdk
    set jdk_path ${worksrcdir}/Contents/Home
}

subport openjdk11u-j {
    # https://github.com/openjdk/jdk11u/tags
    version             11.0.15+3
    set bv 11.0.15
    set tpath /Library/Java
    description         Openjdk 11 updates
    long_description    Openjdk 11 updates of Openjdk, Open-Source implementation of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk11u
    use_xcode           yes
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-11.0.2.jdk/Contents/Home \
                        --with-conf-name=openjdk${bv}
    build.type          gnu
    build.target        images
    build.post_args     JOBS=`sysctl -n hw.ncpu` \
                        CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk11-boot
}

subport openjdk13-boot {
    version             13.0.2
    set build           8
    description         openjdk 13 builds
    long_description    ${long_description_openjdk-ga}
    homepage            jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/GA/jdk${version}/d4173c853231432d94f001e99d882ca7/${build}/GPL/

    checksums           rmd160  c2e64b7097507ac8143f7413202747e4dc71c260 \
                        sha256  08fd2db3a3ab6fb82bb9091a035f9ffe8ae56c31725f4e17d573e48c39ca10dd \
                        size    189969691

    distname            openjdk-13.0.2_osx-x64_bin
    worksrcdir          jdk-13.0.2.jdk
    use_xcode           no
    use_configure    no
    set jdk_path ${worksrcdir}/Contents/Home
}

subport openjdk13u-j {
    # https://github.com/openjdk/jdk13u/tags
    version             13.0.11+1
    set bv 13.0.11
    set tpath /Library/Java
    description         Openjdk 13 updates
    long_description    Openjdk 13 updates of Openjdk, Open-Source implementation of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk13u
    use_xcode           yes
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home \
                        --with-conf-name=openjdk${bv}
    build.type          gnu
    build.target        images
    build.post_args     JOBS=`sysctl -n hw.ncpu` \
                        CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk13-boot
}

subport Openjdk15-boot {
    version             15.0.2
    set build           7
    description         openjdk 15 builds
    long_description    ${long_description_openjdk-ga}
    homepage            jdk.java.net
    supported_archs     x86_64
    master_sites        https://download.java.net/java/GA/jdk${version}/0d1cfde4252546c6931946de8db48ee2/${build}/GPL/

    checksums           rmd160  42a09647ae7a4a8f56da6ccf2c4401a3db8a9aa9 \
                        sha256  578b17748f5a7d111474bc4c9b5a8a06b4a4aa1ba4a4bc3fef014e079ece7c74 \
                        size    192067136

    distname            openjdk-15.0.2_osx-x64_bin
    worksrcdir          jdk-15.0.2.jdk
    use_xcode           no
    use_configure    no
    set jdk_path ${worksrcdir}/Contents/Home
}

subport openjdk15u-j {
    # https://github.com/openjdk/jdk15u/tags
    version             15.0.7+1
    set bv 15.0.7
    set tpath /Library/Java
    description         Openjdk 15 updates
    long_description    Openjdk 15 updates of Openjdk, Open-Source implementation of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk15u
    use_xcode           yes
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-15.0.2.jdk/Contents/Home \
                        --with-conf-name=openjdk${bv}
    build.type          gnu
    build.target        images
    build.post_args     JOBS=`sysctl -n hw.ncpu` \
                        CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk15-boot
}

subport openjdk17u-j {
    # https://github.com/openjdk/jdk17u/tags
    version             17.0.3+3
    set bv 17.0.3
    set tpath /Library/Java
    description         Openjdk 17 updates
    long_description    Openjdk 17 updates of Openjdk, Open-Source implementation of the Java Platform, Standard Edition, and related projects.
    homepage            https://openjdk.java.net
    supported_archs     x86_64 arm64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk17u
    use_xcode           yes
    use_configure    yes
    configure.cmd       sh configure
    configure.pre_args  --prefix=${tpath}
    configure.args      --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk17-oracle/Contents/Home \
                        --with-conf-name=openjdk${bv}
    build.type          gnu
    build.target        images
    build.post_args     JOBS=`sysctl -n hw.ncpu` \
                        CONF_CHECK=ignore
    use_parallel_build  no
    depends_build       port:autoconf \
                        port:gmake
    depends_lib         port:openjdk17-oracle
}

if {[string match *-j2 ${subport}]} {
    set pathb ${tpath}/JavaVirtualMachines
    destroot {
        xinstall -m 775 -d ${destroot}${pathb}
        copy ${worksrcpath}/build/openjdk${bv}/images/j2sdk-bundle/jdk${bv}.jdk ${destroot}${pathb}
        copy ${worksrcpath}/build/openjdk${bv}/images/j2re-bundle/jre${bv}.jre ${destroot}${pathb}
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default by adding the following line to your shell profile:
    export JAVA_HOME=${pathb}/jdk${bv}.jdk/Contents/Home
    If you want to make JRE the default java you can make ${subport} the default by adding the following line to your shell profile:
    export JAVA_HOME=${pathb}/jre${bv}.jre/Contents/Home
    "
} elseif {[string match *-j ${subport}]} {
    set pathb ${tpath}/JavaVirtualMachines
    destroot {
        xinstall -m 775 -d ${destroot}${pathb}
        copy ${worksrcpath}/build/openjdk${bv}/images/jdk-bundle/jdk-${bv}.jdk ${destroot}${pathb}
    }

    notes "
        If you have more than one JDK installed you can make ${subport} the default by adding the following line to your shell profile:
        export JAVA_HOME=${pathb}/jdk-${bv}.jdk/Contents/Home
    "
} elseif {[string match *-boot ${subport}]} {
    use_xcode           no
    use_configure    no
    build {}
    destroot.violate_mtree      yes

    set path /Library/Java/JavaVirtualMachines

    destroot {
        xinstall -m 775 -d ${destroot}${path}
        copy ${worksrcpath} ${destroot}${path}
    }
    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${path}/${jdk_path}
    "
}
