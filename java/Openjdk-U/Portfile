# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                Openjdk-U
version             17
revision            0
categories          java devel 
platforms           darwin
supported_archs     noarch
license             GPL-2
maintainers         nomaintainer openmaintainer
description         Open Source, Open Innovation, Open Standards implementation of the Java Platform, Standard Edition, and related projects.
long_description    build Updates of Openjdk, Open Source, Open Innovation, Open Standards implementation of the Java Platform, Standard Edition, and related projects provided by build group
homepage            openjdk.java.net

set long_description_openjdk-u \
    "Updates to Openjdk, \
    Open Source, Open Innovation, Open Standards implementation \
    of the Java Platform, Standard Edition, and related projects."

set obsoleted_ports {
    Openjdk-updates
    Openjdk12u
    Openjdk14u
    Openjdk16u
}

if {${subport} eq "openjdk-updates"} {
    # The openjdk port is not installable, but recommends users to install the latest Long Term Support (LTS) subport
    replaced_by         openjdk${version}u
}

subport openjdk11u {
    # https://github.com/openjdk/jdk11u/tags
    version             11.0.15+1
    description         openjdk 11 update builds
    long_description    ${long_description_openjdk-u}
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk11u
    depends_build       port:autoconf \
                        port:gmake \
                        port:bash
    depends_lib         port:openjdk11u-boot
    use_configure    yes
    configure.cmd       sh configure --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-11.0.2.jdk/Contents/Home
    use_xcode           yes
    use_parallel_build  no
    build.type          gnu
    build.target        jdk
    build.pre_args      JOBS=2
    build.post_args     ${build.target}
}

subport openjdk12u {
    version             12.0.2
    replaced_by         openjdk13u
}

subport openjdk13u {
    # https://github.com/openjdk/jdk13u/tags
    version             13.0.11+1
    description         openjdk 13 update builds
    long_description    ${long_description_openjdk-u}
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk13u
    depends_build       port:autoconf \
                        port:gmake \
                        port:bash
    depends_lib         port:openjdk13u-boot
    use_configure    yes
    configure.cmd       sh configure --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-13.0.2.jdk/Contents/Home
    use_xcode           yes
    use_parallel_build  no
    build.type          gnu
    build.target        jdk
    build.pre_args      JOBS=2
    build.post_args     ${build.target}
}

subport openjdk14u {
    version             14.0.2
    replaced_by         openjdk15u
}

subport openjdk15u {
    # https://github.com/openjdk/jdk15u/tags
    version             15.0.7+1
    description         openjdk 15 update builds
    long_description    ${long_description_openjdk-u}
    supported_archs     x86_64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk15u
    depends_build       port:autoconf \
                        port:gmake \
                        port:bash
    depends_lib         port:openjdk15u-boot
    use_configure    yes
    configure.cmd       sh configure --with-boot-jdk=/Library/Java/JavaVirtualMachines/jdk-15.0.2.jdk/Contents/Home
    use_xcode           yes
    use_parallel_build  no
    build.type          gnu
    build.target        jdk
    build.pre_args      JOBS=2
    build.post_args     ${build.target}
}

subport openjdk16u {
    version             16.0.2
    replaced_by         openjdk17u
}

subport openjdk17u {
    # https://github.com/openjdk/jdk17u/tags
    version             17.0.3+1
    description         openjdk 17 update builds
    long_description    ${long_description_openjdk-u}
    supported_archs     x86_64 arm64
    fetch.type          git
    git.url             https://git.openjdk.java.net/jdk17u
    depends_build       port:autoconf \
                        port:gmake \
                        port:bash
    depends_lib         port:openjdk17-oracle
    use_configure    yes
    configure.cmd       sh configure --with-boot-jdk=/Library/Java/JavaVirtualMachines/openjdk17-oracle/Contents/Home
    use_xcode           yes
    use_parallel_build  no
    build.target        jdk
    if {${configure.build_arch} eq "x86_64"} {
        build.pre_args      JOBS=2
    } elseif {${configure.build_arch} eq "arm64"} {
        build.pre_args      JOBS=8
    }
    build.post_args     ${build.target}
}

if {[string match *-u ${subport}]} {
    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes
    
    destroot.pre_args   -i ${destroot.target}
    destroot.target     /Library/Java/JavaVirtualMachines/jdk-${version}.jdk
    destroot {
        mkdir /Library/Java
        mkdir /Library/Java/JavaVirtualMachines
        mv ${worksrcpath}/build/*/jdk /Library/Java/JavaVirtualMachines/jdk-${version}.jdk
        rmdir ${worksrcpath}
    }

    notes "
        If you have more than one JDK installed you can make ${subport} the default by adding the following line to your shell profile:
        export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-${version}.jdk
    "
}
 
