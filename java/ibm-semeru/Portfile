# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             ibm-semeru
categories       java devel
maintainers      nomaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
# These ports use prebuilt binaries for a particular architecture, they are not universal binaries
universal_variant no

# Latest Long Term Support (LTS) major version
version          17

set long_description_ibm_semeru \
    "The IBM Semeru Runtimes are free production-ready open source binaries to run your Java applications built with\
the OpenJDK class libraries and the Eclipse OpenJ9 JVM."

set obsoleted_ports {
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0

}

if {${subport} eq "ibm-semeru"} {
    depends_run-append    port:ibm-semeru-openjdk${version}
    description           Open Java Development Kit (IBM Semeru) with Eclipse OpenJ9 VM
    long_description      {*}${long_description_ibm_semeru}
    distfiles
    patchfiles
    supported_archs       noarch
    use_configure         no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo $subport is a stub port > ${docdir}/README"
    }
}

subport ibm-semeru-openjdk8 {
    # https://developer.ibm.com/languages/java/semeru-runtimes/downloads?os=macOS
    supported_archs  x86_64

    version      8u322
    revision     0

    set build    06
    set openj9_version 0.30.0

    homepage     https://developer.ibm.com/languages/java/semeru-runtimes/

    description  Open Java Development Kit 8 (IBM Semeru) with Eclipse OpenJ9 VM
    long_description ${long_description_ibm_semeru}

    master_sites https://github.com/ibmruntimes/semeru8-binaries/releases/download/jdk${version}-b${build}_openj9-${openj9_version}/
    distname     ibm-semeru-open-jdk_x64_mac_${version}b${build}_openj9-${openj9_version}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  a340dad7c239dbd53ea848ae8844d3046d95e2fd \
                 sha256  c617b44f13a4fb28d5e31bb1448f2a35600d1f9abeab2e2127da360e08cef3f3 \
                 size    129140293
}

subport ibm-semeru-openjdk11 {
    # https://developer.ibm.com/languages/java/semeru-runtimes/downloads?os=macOS
    supported_archs  x86_64

    version      11.0.14.1
    revision     0

    set build    1
    set openj9_version 0.30.1

    homepage     https://developer.ibm.com/languages/java/semeru-runtimes/

    description  Open Java Development Kit 11 (IBM Semeru) with Eclipse OpenJ9 VM
    long_description ${long_description_ibm_semeru}

    master_sites https://github.com/ibmruntimes/semeru11-binaries/releases/download/jdk-${version}%2B${build}_openj9-${openj9_version}/
    distname     ibm-semeru-open-jdk_x64_mac_${version}_${build}_openj9-${openj9_version}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  d434bc2fdc141267e2b46862494a2aedeac05327 \
                 sha256  215e1ff6fa821309548253653e74025d6a830180abe6001db7717fde4eb991d9 \
                 size    203401477
}

subport ibm-semeru-openjdk17 {
    # https://developer.ibm.com/languages/java/semeru-runtimes/downloads?os=macOS
    supported_archs  x86_64

    version      17.0.2
    revision     0

    set build    8
    set openj9_version 0.30.0

    homepage     https://developer.ibm.com/languages/java/semeru-runtimes/

    description  Open Java Development Kit 17 (IBM Semeru) with Eclipse OpenJ9 VM
    long_description ${long_description_ibm_semeru}

    master_sites https://github.com/ibmruntimes/semeru17-binaries/releases/download/jdk-${version}+${build}_openj9-${openj9_version}/
    distname     ibm-semeru-open-jdk_x64_mac_${version}_${build}_openj9-${openj9_version}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  501fdff9007a1333496e86dd49275d4dc5d11735 \
                 sha256  fbbc233c187b6cbc9c62a850617fc9a7764686ed2686c9c106ca98f9f1d24e59 \
                 size    207963045
}

if {${os.platform} eq "darwin"} {
    # https://trac.macports.org/wiki/PortfileRecipes#compare-osx-darwin-version
    if {[string match ibm* ${subport}] && ${os.major} < 14} {
        # See https://www.ibm.com/support/pages/semeru-runtimes-support
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.10 Yosemite or later."
            return -code error
        }
    }
}

livecheck.type  none

use_configure    no
build {}

if {[string match ibm-semeru-openjdk* ${subport}]} {
    test.run    yes
    test.cmd    Contents/Home/bin/java
    test.target
    test.args   -version

    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes

    set target /Library/Java/JavaVirtualMachines/${subport}
    set destroot_target ${destroot}${target}

    destroot {
        xinstall -m 755 -d ${destroot_target}
        copy ${worksrcpath}/Contents ${destroot_target}
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${target}/Contents/Home
    "
}    
