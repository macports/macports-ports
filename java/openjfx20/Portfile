# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0

name            openjfx20
version         20
revision        0

set build       19

categories      java devel
maintainers     {@lhaeger} openmaintainer
platforms       darwin
license         GPL-2
supported_archs x86_64 arm64

description     OpenJFX20

long_description OpenJFX is an open source, next generation client application platform \
                 for desktop, mobile and embedded systems built on Java for use with JDK 20. \
                 It is a modern, efficient, and fully featured toolkit for developing rich client \
                 applications.

homepage        https://openjdk.org/projects/openjfx/

depends_build   port:openjdk19-bootstrap \
                port:gradle \
                port:apache-ant \
                port:ksh \
                port:cmake \
                port:ninja

master_sites    https://git.openjdk.org/jfx20u/archive/refs/tags 
distname        ${version}+${build}
checksums       rmd160  36b6c335a7046b7c4d9d724bfc022595f264100f \
                sha256  4e24932efcf137265740344093cf7beaa00e7b21771fa3899a74a9c0fc24d551 \
                size    59581036

worksrcdir      jfx20u-${version}-${build}

pre-patch {
    if {${os.platform} eq "darwin" && ${os.major} < 18} {
        system -W ${worksrcpath} "test -d \"/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk\" && cd ${worksrcpath} && patch -p0 < ${portpath}/files/xcode-cli.diff || cd ${worksrcpath}"
    }
}

if {${os.platform} eq "darwin" && ${os.major} > 18} {
    patchfiles        xcode-cli.diff
}


post-patch {
    xinstall -m 755 -d ${worksrcpath}/Home
    if {${os.platform} eq "darwin" && ${os.major} > 18} {
        reinplace "s|/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk|${configure.sdkroot}|g" ${worksrcpath}/buildSrc/mac.gradle
    }
}

use_configure   no

set jdk_path /Library/Java/JavaVirtualMachines/openjdk19-bootstrap/Contents/Home
set ant_path ${prefix}/share/java/apache-ant
set gradle_home_path ${worksrcpath}/Home

build {
    system -W ${worksrcpath} "export GRADLE_USER_HOME=\"${gradle_home_path}\" && export JAVA_HOME=\"${jdk_path}\" && export JDK_HOME=\"${jdk_path}\" && ${prefix}/bin/ksh ./gradlew"
}

# macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
destroot.violate_mtree yes

set target /Library/Java/Extensions/openjfx20

destroot {
    xinstall -m 755 -d ${destroot}${target}
    copy ${worksrcpath}/build/sdk/legal   ${destroot}${target}/legal
    copy ${worksrcpath}/build/sdk/lib     ${destroot}${target}/lib
    copy ${worksrcpath}/build/modular-sdk ${destroot}${target}/modular-sdk
}

notes "
To use ${name}, install any of openjdk20 port
"

# openjfx20 releases depend on openjdk20 releases
livecheck.type      regex
livecheck.url       https://github.com/openjdk/jdk20u/tags
livecheck.regex     jdk-(\[0-9.\]+)-ga
