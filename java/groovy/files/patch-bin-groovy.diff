--- src/bin/groovy.orig	Wed Sep 29 09:47:26 2004
+++ src/bin/groovy	Thu Oct 21 19:18:22 2004
@@ -47,6 +47,22 @@
   shift 2
 fi
 
+# Attempt to set JAVA_HOME if it's not already set
+if [ -z "$JAVA_HOME" ]; then
+	
+	# Set JAVA_HOME for Darwin
+	if $darwin; then
+		
+		[ -z "$JAVA_HOME" -a -d "/Library/Java/Home" ] &&
+			export JAVA_HOME="/Library/Java/Home"
+			
+		[ -z "$JAVA_HOME" -a -d "/System/Library/Frameworks/JavaVM.framework/Home" ] &&
+			export JAVA_HOME="/System/Library/Frameworks/JavaVM.framework/Home"
+		
+	fi
+	
+fi
+
 # For Cygwin, ensure paths are in UNIX format before anything is touched
 if $cygwin ; then
     [ -n "$GROOVY_HOME" ] &&
@@ -60,8 +76,25 @@
 fi
 
 # Locate GROOVY_HOME if not it is not set
-if [ "x$GROOVY_HOME" = "x" ]; then
-    GROOVY_HOME=`cd "$DIRNAME/.."; pwd`
+if [ -z "$GROOVY_HOME" -o ! -d "$GROOVY_HOME" ] ; then
+  # resolve links - $0 may be a link to groovy's home
+  PRG="$0"
+  progname=`basename "$0"`
+
+  # need this for relative symlinks
+  while [ -h "$PRG" ] ; do
+    ls=`ls -ld "$PRG"`
+    link=`expr "$ls" : '.*-> \(.*\)$'`
+    if expr "$link" : '/.*' > /dev/null; then
+    PRG="$link"
+    else
+    PRG=`dirname "$PRG"`"/$link"
+    fi
+  done
+
+  pushd "`dirname \"$PRG\"`/.." > /dev/null
+  GROOVY_HOME="`pwd -P`"
+  popd > /dev/null
 fi
 
 # Use default groovy-classworlds config
