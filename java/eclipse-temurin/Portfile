# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             eclipse-temurin
categories       java devel
maintainers      nomaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
# These ports use prebuilt binaries for a particular architecture, they are not universal binaries
universal_variant no

# Latest Long Term Support (LTS) major version
version          17

set long_description_temurin \
    "Eclipse Temurin provides secure, TCK-tested and compliant, production-ready Java runtimes."

set obsoleted_ports {
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0

}

if {${subport} eq "eclipse-temurin"} {
    depends_run-append    port:temurin-openjdk${version}
    description           Eclipse Temurin, based on OpenJDK
    long_description      {*}${long_description_temurin}
    distfiles
    patchfiles
    supported_archs       noarch
    use_configure         no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo $subport is a stub port > ${docdir}/README"
    }
}

subport temurin-openjdk8 {
    # https://adoptium.net/releases.html?variant=openjdk8&jvmVariant=hotspot
    supported_archs  x86_64

    version      8u322
    revision     0

    set build    06

    description  Eclipse Temurin, based on OpenJDK 8
    long_description {*}${long_description_temurin}

    master_sites https://github.com/adoptium/temurin8-binaries/releases/download/jdk${version}-b${build}/
    distname     OpenJDK8U-jdk_x64_mac_hotspot_${version}b${build}
    worksrcdir   jdk${version}-b${build}

    checksums    rmd160  335f1bfa3cee50eee7da9d78514dd28e665ae553 \
                 sha256  96a3124bf0f5ca777954239893cc89ea34c4bc9a9b7c1559aa2c69baa0ee84e3 \
                 size    108075347
}

subport temurin-openjdk11 {
    # https://adoptium.net/releases.html?variant=openjdk11&jvmVariant=hotspot
    supported_archs  x86_64

    version      11.0.14.1
    revision     0

    set build    1

    description  Eclipse Temurin, based on OpenJDK 11
    long_description {*}${long_description_temurin}

    master_sites https://github.com/adoptium/temurin11-binaries/releases/download/jdk-${version}%2B${build}/

    distname     OpenJDK11U-jdk_x64_mac_hotspot_${version}_${build}
    worksrcdir   jdk-${version}+${build}

    checksums    rmd160  256cf096156ca678da017e8768c7f12c841e9c10 \
                 sha256  8c69808f5d9d209b195575e979de0e43cdf5d0f1acec1853a569601fe2c1f743 \
                 size    191413871
}

subport temurin-openjdk17 {
    # https://adoptium.net/releases.html?variant=openjdk17&jvmVariant=hotspot
    supported_archs  x86_64 arm64

    # Java 17 is the first Temurin release with arm64 support
    supported_archs  x86_64 arm64

    version 17.0.2
    set build    8
    revision     0

    description  Eclipse Temurin, based on OpenJDK 17
    long_description {*}${long_description_temurin}

    master_sites https://github.com/adoptium/temurin17-binaries/releases/download/jdk-${version}%2B${build}/

    if {${configure.build_arch} eq "x86_64"} {
        distname     OpenJDK17U-jdk_x64_mac_hotspot_${version}_${build}
        checksums    rmd160  90939e1b687b025674faf1f45b1274fe2e420109 \
                     sha256  3630e21a571b7180876bf08f85d0aac0bdbb3267b2ae9bd242f4933b21f9be32 \
                     size    192611208
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     OpenJDK17U-jdk_aarch64_mac_hotspot_${version}_${build}
        checksums    rmd160  e4063da6a1139c137af930c8cf5c5988bb75354d \
                     sha256  157518e999d712b541b883c6c167f8faabbef1d590da9fe7233541b4adb21ea4 \
                     size    182550014
    }

    worksrcdir   jdk-${version}+${build}
}

if {${os.platform} eq "darwin"} {
    # https://trac.macports.org/wiki/PortfileRecipes#compare-osx-darwin-version
    if {[string match eclipse* ${subport}] && ${os.major} < 16} {
        # See https://adoptium.net/supported_platforms.html
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.12 Sierra or later."
            return -code error
        }
    }
}

if {[string match temurin-openjdk* ${subport}]} {
    homepage     https://adoptium.net
}

livecheck.type  none

use_configure    no
build {}

if {[string match temurin-openjdk* ${subport}]} {
    test.run    yes
    test.cmd    Contents/Home/bin/java
    test.target
    test.args   -version

    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes

    set target /Library/Java/JavaVirtualMachines/${subport}
    set destroot_target ${destroot}${target}

    destroot {
        xinstall -m 755 -d ${destroot_target}
        copy ${worksrcpath}/Contents ${destroot_target}
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${target}/Contents/Home
    "
}    
