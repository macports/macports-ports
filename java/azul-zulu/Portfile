# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem       1.0

name             azul-zulu
categories       java devel
maintainers      nomaintainer
platforms        darwin
# These ports use prebuilt binaries, 'NoMirror' makes sure MacPorts doesn't mirror/distribute these third-party binaries
license          GPL-2 NoMirror
# These ports use prebuilt binaries for a particular architecture, they are not universal binaries
universal_variant no

# Latest Long Term Support (LTS) major version
version          17

set long_description_zulu \
    "Azul® Zulu® is a Java Development Kit (JDK), and a compliant implementation of the Java Standard Edition (SE)\
    specification that contains all the Java components needed to build and run Java SE applications. Zulu has been\
    verified by passing all tests of the OpenJDK Community Technology Compatibility Kit (TCK) as available for each\
    respective Java SE version."

set obsoleted_ports {
    zulu-openjdk9
    zulu-openjdk10
    zulu-openjdk12
    zulu-openjdk14
    zulu-openjdk16
}

if {${subport} in ${obsoleted_ports}} {
    PortGroup    obsolete 1.0

}

if {${subport} eq "azul-zulu"} {
    depends_run-append    port:zulu-openjdk${version}
    description           Azul Zulu Community OpenJDK (Long Term Support)
    long_description      {*}${long_description_zulu}
    distfiles
    patchfiles
    supported_archs       noarch
    use_configure         no
    build {}
    destroot {
        set docdir ${destroot}${prefix}/share/doc/${subport}
        xinstall -d ${docdir}
        system "echo $subport is a stub port > ${docdir}/README"
    }
}

subport zulu-openjdk7 {
    # https://www.azul.com/downloads/?version=java-7-lts&os=macos&package=jdk
    supported_archs  x86_64

    version      7.52.0.11
    revision     0

    set openjdk_version 7.0.332

    description  Azul Zulu Community OpenJDK 7 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
    checksums    rmd160  ad2a8a147e47327854ce5adfd7c9ae9da3f363e6 \
                 sha256  c677a720a1e06fbf6fe20a8d15ea54a184fb783ece7a6707efe67ab6376846ae \
                 size    68509988

    worksrcdir   ${distname}/zulu-7.jdk

    configure.cxx_stdlib libstdc++
}

subport zulu-openjdk8 {
    # https://www.azul.com/downloads/?version=java-8-lts&os=macos&package=jdk
    supported_archs  x86_64 arm64

    version      8.60.0.21
    revision     0

    set openjdk_version 8.0.322

    description  Azul Zulu Community OpenJDK 8 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    if {${configure.build_arch} eq "x86_64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
        checksums    rmd160  01ca97a28d979f5468542fc4ff53a1185d54d119 \
                     sha256  dece2b4105501353adf58fdd04a8ae959e2112e6ff9a743cbf222598f8ebc2ca \
                     size    108226544
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_aarch64
        checksums    rmd160  063f83e35c5c8057c95333f65647461f636cf626 \
                     sha256  87410301c7e0e33ece61b4404c3c8ebfc3e75dd9f74d3ebae30833631e2dff60 \
                     size    105912737
    }

    worksrcdir   ${distname}/zulu-8.jdk

    configure.cxx_stdlib libstdc++
}

# Remove after 2022-05-07
subport zulu-openjdk9 {
    version     9.0.7.1
    revision    1
    replaced_by openjdk11-zulu
}

# Remove after 2022-05-07
subport zulu-openjdk10 {
    version     10.3.5
    revision    1
    replaced_by openjdk11-zulu
}

subport zulu-openjdk11 {
    # https://www.azul.com/downloads/?version=java-11-lts&os=macos&package=jdk
    supported_archs  x86_64 arm64

    version      11.54.25
    revision     0

    set openjdk_version 11.0.14.1

    description  Azul Zulu Community OpenJDK 11 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    if {${configure.build_arch} eq "x86_64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
        checksums    rmd160  1b144473c0ec1086ab295b3d7601a8e7611ce59e \
                     sha256  fbfe3da2024a170b77efd94946aeb95ffe54377134403f92c682376e1f06e8f5 \
                     size    193388486
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_aarch64
        checksums    rmd160  1b0182a86c1ae1a42741de3ae5e885b15186a924 \
                     sha256  2076f8ce51c0e9ad7354e94b79513513b1697aa222f9503121d800c368b620a3 \
                     size    176884357
    }

    worksrcdir   ${distname}/zulu-11.jdk
}

# Remove after 2022-05-07
subport zulu-openjdk12 {
    version     12.3.11
    revision    1
    replaced_by openjdk13-zulu
}

subport zulu-openjdk13 {
    # https://www.azul.com/downloads/?version=java-13-mts&os=macos&package=jdk
    supported_archs  x86_64 arm64

    version      13.46.15
    revision     0

    set openjdk_version 13.0.10

    description  Azul Zulu Community OpenJDK 13 (Medium Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    if {${configure.build_arch} eq "x86_64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
        checksums    rmd160  c37417003a010428e69a0b53e8800d9997e87577 \
                     sha256  ed9142deef3d230928207ab64456ca0285213939afe78cd914c5b6689269e87d \
                     size    200591500
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_aarch64
        checksums    rmd160  6a0bcb3c4485dbdb768e54ea7a7165c0a2199431 \
                     sha256  92eb552b109a1e68809c319df6dc29798fdd64a07098bd5821387e8b298657e5 \
                     size    179912266
    }

    worksrcdir   ${distname}/zulu-13.jdk
}

# Remove after 2022-05-07
subport zulu-openjdk14 {
    version     14.29.23
    revision    1
    replaced_by openjdk15-zulu
}

subport zulu-openjdk15 {
    # https://www.azul.com/downloads/?version=java-15-mts&os=macos&package=jdk
    supported_archs  x86_64 arm64

    version      15.38.17
    revision     0

    set openjdk_version 15.0.6

    description  Azul Zulu Community OpenJDK 15 (Medium Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    if {${configure.build_arch} eq "x86_64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
        checksums    rmd160  3a46d9f2b822667113a3fe400300dcd56466f218 \
                     sha256  59a2e0fac951fb48ccd11a39d16752bf7e375871d5fe92d3a63f032ddfbe8b44 \
                     size    202445259
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_aarch64
        checksums    rmd160  5f413443e65273dc53b059cea7965b2e6f8ed95b \
                     sha256  3a0b2e6b36af26d996b5ec73418203e462be233da021f41c1834196e3bc2e60d \
                     size    176748838
    }

    worksrcdir   ${distname}/zulu-15.jdk
}

# Remove after 2022-05-07
subport zulu-openjdk16 {
    version     16.0.83
    revision    2
    replaced_by openjdk17-zulu
}

subport zulu-openjdk17 {
    # https://www.azul.com/downloads/?version=java-17-lts&os=macos&package=jdk
    supported_archs  x86_64 arm64

    version      17.32.13
    revision     0

    set openjdk_version 17.0.2

    description  Azul Zulu Community OpenJDK 17 (Long Term Support)
    long_description ${long_description_zulu}

    master_sites https://cdn.azul.com/zulu/bin/

    if {${configure.build_arch} eq "x86_64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_x64
        checksums    rmd160  3eced1f7701de4306f1fa24bc204cc56679afb03 \
                     sha256  89d04b2d99b05dcb25114178e65f6a1c5ca742e125cab0a63d87e7e42f3fcb80 \
                     size    193143505
    } elseif {${configure.build_arch} eq "arm64"} {
        distname     zulu${version}-ca-jdk${openjdk_version}-macosx_aarch64
        checksums    rmd160  ec8b93727a88ab77a692aac411a7cb63ce0ff709 \
                     sha256  54247dde248ffbcd3c048675504b1c503b81daf2dc0d64a79e353c48d383c977 \
                     size    190938303
    }

    worksrcdir   ${distname}/zulu-17.jdk
}

if {${os.platform} eq "darwin"} {
    # https://trac.macports.org/wiki/PortfileRecipes#compare-osx-darwin-version
    if {[string match *-zulu ${subport}] && ${os.major} < 18} {
        # See https://www.azul.com/downloads/?os=macos&package=jdk
        known_fail yes
        pre-fetch {
            ui_error "${name} ${version} is only supported on Mac OS X 10.14 Mojave or later."
            return -code error
        }
    }
}

if {[string match zulu-openjdk* ${subport}]} {
    homepage     https://www.azul.com/downloads/
}

livecheck.type  none

use_configure    no
build {}

if {[string match zulu-openjdk* ${subport}]} {
    test.run    yes
    test.cmd    Contents/Home/bin/java
    test.target
    test.args   -version

    # macOS Java tools expect to find Java virtual machines under /Library/Java/JavaVirtualMachines, which is not under ${prefix}.
    destroot.violate_mtree yes

    set target /Library/Java/JavaVirtualMachines/${subport}
    set destroot_target ${destroot}${target}

    destroot {
        xinstall -m 755 -d ${destroot_target}
        copy ${worksrcpath}/Contents ${destroot_target}

        if {${subport} eq "azul-zulu7"} {
            # MacPorts reports this file as broken
            delete ${destroot_target}/Contents/Home/jre/lib/xawt/libmawt.dylib
        }
    }

    notes "
    If you have more than one JDK installed you can make ${subport} the default
    by adding the following line to your shell profile:
        export JAVA_HOME=${target}/Contents/Home
    "
}    
