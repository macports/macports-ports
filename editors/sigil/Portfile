# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.1
PortGroup               conflicts_build 1.0
PortGroup               github 1.0
PortGroup               qt5 1.0

github.setup            Sigil-Ebook Sigil 1.2.1
revision                0
name                    sigil
platforms               darwin
categories              editors
maintainers             {@i0ntempest me.com:szf1234} openmaintainer
license                 GPL-3+

description             Sigil, the ePub editor

long_description        Sigil is a multi-platform WYSIWYG ebook editor. It is \
                        designed to edit books in ePub format

checksums               rmd160  bae62f7b15f64f204c7f35527c9f364569aac786 \
                        sha256  c2274204bdf1fb452b006c62551c43e969673923bde253ac5f1b8ebfeaff76dd \
                        size    21461363

qt5.depends_component   qttools qtwebengine
qt5.min_version         5.12

depends_lib-append      port:hunspell \
                        port:minizip \
                        port:pcre \
                        port:zlib

patchfiles              pcre.patch
conflicts_build         libzip
compiler.cxx_standard   2011

configure.args          -DCMAKE_BUILD_WITH_INSTALL_RPATH=OFF \
                        -DSYSTEM_LIBS_REQUIRED=ON \
                        -DUSE_SYSTEM_LIBS=ON
post-extract {
    if {[variant_isset python38]} {
        reinplace "s|PythonInterp 3.7|PythonInterp 3.8|g" ${worksrcpath}/CMakeLists.txt
        reinplace "s|PythonLibs 3.7|PythonLibs 3.8|g" ${worksrcpath}/CMakeLists.txt
    }
}

pre-configure {
    if {![variant_isset python38] && ![variant_isset python37]} {
        ui_error "Sigil requires Python, please use a Python variant."
        return -code error
    }
}

destroot {
    copy ${destroot.dir}/bin/Sigil.app ${destroot}${applications_dir}
}

proc python-depends {python_branch frameworks_dir PATH} {
    set python_version [string map {. ""} ${python_branch}]
    depends_lib-append  port:python${python_version} \
                        port:py${python_version}-chardet \
                        port:py${python_version}-cssselect \
                        port:py${python_version}-cssutils \
                        port:py${python_version}-html5lib \
                        port:py${python_version}-lxml \
                        port:py${python_version}-Pillow \
                        port:py${python_version}-regex \
                        port:py${python_version}-six
    configure.env-append PATH=${frameworks_dir}/Python.framework/Versions/${python_branch}/bin:${PATH}
}

variant python38 conflicts python37 description {Use Python 3.8 during build} {
    set python_branch 3.8
    python-depends ${python_branch} ${frameworks_dir} $env(PATH)
}

variant python37 conflicts python38 description {Use Python 3.7 during build} {
    set python_branch 3.7
    python-depends ${python_branch} ${frameworks_dir} $env(PATH)
}

if {![variant_isset python37]} {
    default_variants +python38
}
