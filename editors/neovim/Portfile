# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               cmake 1.1

name                    neovim
categories              editors
platforms               {darwin >= 15}
maintainers             {l2dy @l2dy} \
                        {judaew @judaew} \
                        openmaintainer
license                 Apache-2 Vim GPL-2+

description             Neovim is a aggressively refactored fork of Vim

long_description \
    Neovim is a project that seeks to aggressively refactor Vim. It already adds \
    a new plugin architecture, job control, and a remote API.

homepage                https://neovim.io

depends_build-append    port:pkgconfig

depends_lib             port:gettext \
                        port:libuv \
                        port:unibilium \
                        path:lib/libluajit-5.1.2.dylib:luajit \
                        port:lua51-lpeg \
                        port:luv-luajit \
                        port:libiconv \
                        port:libutf8proc \
                        port:tree-sitter

cmake.build_type        Release

configure.args-append   -DLUA_PRG=${prefix}/bin/luajit

patch.pre_args-replace  -p0 -p1

# Building parsers is normally an extra step, see https://github.com/neovim/neovim/issues/29042
patchfiles              0001-build-and-install-tree-sitter-parsers.patch \
                        0002-include-lua51-headers-to-build-properly.patch

post-patch {
    reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/CMakeLists.txt

    # workaround for https://github.com/neovim/neovim/pull/30749
    reinplace "s|lpeg.so lpeg\${CMAKE_SHARED_LIBRARY_SUFFIX}|lpeg\${CMAKE_SHARED_LIBRARY_SUFFIX} lpeg.so|g" ${worksrcpath}/cmake/FindLpeg.cmake
}

notes {
    If you would like to re-use your existing Vim configuration with Neovim,
    follow the advice in `:help nvim-from-vim`:

        nvim -c 'tab h nvim-from-vim'

    For a full list of differences with Vim, read `:help vim-differences`.
}

subport neovim-devel {}

if {${subport} eq ${name}} {
    # stable

    github.setup        neovim neovim 0.11.6 v
    github.tarball_from archive
    revision            1
    conflicts           neovim-devel

    # cat cmake.deps/deps.txt \
    #     | perl -n -e '/(TREESITTER_.*)_URL https:\/\/github.com\/([^\/]*)\/([^\/]*)\/archive\/([^\d]*)((?:\d+\.){2}\d+)([^\d\.]*)/ && print join(" ", $2, $3, $5, $4 || "\"\"", $6 || "\"\"", lc($1), "\n")' \
    #     | column -t
    set deps {
        tree-sitter           tree-sitter-c         0.24.1  v  ""  treesitter_c
        tree-sitter-grammars  tree-sitter-lua       0.4.0   v  ""  treesitter_lua
        tree-sitter-grammars  tree-sitter-vim       0.7.0   v  ""  treesitter_vim
        neovim                tree-sitter-vimdoc    4.0.0   v  ""  treesitter_vimdoc
        tree-sitter-grammars  tree-sitter-query     0.6.2   v  ""  treesitter_query
        tree-sitter-grammars  tree-sitter-markdown  0.5.0   v  ""  treesitter_markdown
    }

    checksums           ${name}-${version}.tar.gz \
                        rmd160  fac2c51040936066843baa4636dea3d4186fc48e \
                        sha256  d1c8e3f484ed1e231fd5f48f53b7345b628e52263d5eef489bb8b73ca8d90fca \
                        size    13012085 \
                        tree-sitter-c-0.24.1.tar.gz \
                        rmd160  12c732f8ccc097fd1ef4f171c19a89d06cfb85cd \
                        sha256  25dd4bb3dec770769a407e0fc803f424ce02c494a56ce95fedc525316dcf9b48 \
                        size    379147 \
                        tree-sitter-lua-0.4.0.tar.gz \
                        rmd160  2d738c83f4a1ec560fdbaae2ac7e156f93b96a22 \
                        sha256  b0977aced4a63bb75f26725787e047b8f5f4a092712c840ea7070765d4049559 \
                        size    63999 \
                        tree-sitter-vim-0.7.0.tar.gz \
                        rmd160  e0b265437742feaa02279a32b4064bcb9f76d4a6 \
                        sha256  44eabc31127c4feacda19f2a05a5788272128ff561ce01093a8b7a53aadcc7b2 \
                        size    364666 \
                        tree-sitter-vimdoc-4.0.0.tar.gz \
                        rmd160  60712382cbd18f39b06cbca4ca7da78d74b2b18d \
                        sha256  8096794c0f090b2d74b7bff94548ac1be3285b929ec74f839bd9b3ff4f4c6a0b \
                        size    58862 \
                        tree-sitter-query-0.6.2.tar.gz \
                        rmd160  88297accb6c01db114779d3cb584e916d756513d \
                        sha256  90682e128d048fbf2a2a17edca947db71e326fa0b3dba4136e041e096538b4eb \
                        size    43386 \
                        tree-sitter-markdown-0.5.0.tar.gz \
                        rmd160  8582b36c12a8a825d2873e9ec25b2c2572a80253 \
                        sha256  14c2c948ccf0e9b606eec39b09286c59dddf28307849f71b7ce2b1d1ef06937e \
                        size    419516
} else {
    # devel

    github.setup        neovim neovim 28c294363f37d013af69e2779d734c132037f73f
    github.tarball_from archive
    version             20260131-[string range ${github.version} 0 6]
    revision            1
    conflicts           neovim
    github.livecheck.branch \
                        nightly

    # see stable's version of `deps` for how to regenerate
    set deps {
        tree-sitter           tree-sitter-c         0.24.1  v  ""  treesitter_c
        tree-sitter-grammars  tree-sitter-lua       0.4.1   v  ""  treesitter_lua
        tree-sitter-grammars  tree-sitter-vim       0.8.0   v  ""  treesitter_vim
        neovim                tree-sitter-vimdoc    4.1.0   v  ""  treesitter_vimdoc
        tree-sitter-grammars  tree-sitter-query     0.8.0   v  ""  treesitter_query
        tree-sitter-grammars  tree-sitter-markdown  0.5.1   v  ""  treesitter_markdown
    }

    checksums           ${name}-${github.version}.tar.gz \
                        rmd160  bb0f6d78322b0aafc8071ef7500ad45cc0cbb186 \
                        sha256  39dec25db4a357f99945674fc52fe0ab2622edfa6faba2642a79fbebb32863a0 \
                        size    13521261 \
                        tree-sitter-c-0.24.1.tar.gz \
                        rmd160  12c732f8ccc097fd1ef4f171c19a89d06cfb85cd \
                        sha256  25dd4bb3dec770769a407e0fc803f424ce02c494a56ce95fedc525316dcf9b48 \
                        size    379147 \
                        tree-sitter-lua-0.4.1.tar.gz \
                        rmd160  b0b9cb3284234a5f7cb989cf9a290100299ea9a9 \
                        sha256  cef44b8773bde69d427b5e50ca95e417c86c0be91caa37a6782c90d6f529da70 \
                        size    65878 \
                        tree-sitter-vim-0.8.0.tar.gz \
                        rmd160  1c322ec0aa4eec07934ca4d1e5c279154c9ab7d5 \
                        sha256  aa0a45027408bc33da0f2244272dbdc0b4e71bd18f71e5b885f6f7cbae407338 \
                        size    356943 \
                        tree-sitter-vimdoc-4.1.0.tar.gz \
                        rmd160  c801127ac229d5486fd35de126044d5262ead6ff \
                        sha256  020e8f117f648c8697fca967995c342e92dbd81dab137a115cc7555207fbc84f \
                        size    61551 \
                        tree-sitter-query-0.8.0.tar.gz \
                        rmd160  f557a6fdfff64f4e473f8e0a887e3543383fe9f6 \
                        sha256  c2b23b9a54cffcc999ded4a5d3949daf338bebb7945dece229f832332e6e6a7d \
                        size    40303 \
                        tree-sitter-markdown-0.5.1.tar.gz \
                        rmd160  de88629307c75d24b2daa8019f6fcf85142938aa \
                        sha256  acaffe5a54b4890f1a082ad6b309b600b792e93fc6ee2903d022257d5b15e216 \
                        size    419433
}

# Add each dependency's master_site, tag it and associate it back to the distfile
# e.g.: master_sites-append https://github.com/tree-sitter/tree-sitter-c/archive/v0.23.4:treesitter_c
#       distfiles-append    tree-sitter-c-0.23.4.tar.gz:treesitter_c
foreach {gh_author gh_project gh_version gh_tag_prefix gh_tag_suffix dirname} ${deps} {
    master_sites-append https://github.com/${gh_author}/${gh_project}/archive/[join ${gh_tag_prefix}]${gh_version}[join ${gh_tag_suffix}]:${dirname}
    distfiles-append    ${gh_project}-${gh_version}${extract.suffix}:${dirname}
}

# Only extract Neovim's source and not its dependencies
extract.only        ${distname}${extract.suffix}
post-extract {
    # Create the file structure where the build job expects the dependencies
    # e.g. file mkdir ${workpath}/build/build/downloads/treesitter_c
    #      file copy \
    #          ${distpath}/tree-sitter-c-0.23.4.tar.gz \
    #          ${workpath}/build/build/downloads/treesitter_c/v0.23.4.tar.gz
    foreach {_ gh_project gh_version gh_tag_prefix gh_tag_suffix dirname} ${deps} {
        file mkdir ${workpath}/build/build/downloads/${dirname}
        file copy \
            ${distpath}/${gh_project}-${gh_version}${extract.suffix} \
            ${workpath}/build/build/downloads/${dirname}/[join ${gh_tag_prefix}]${gh_version}[join ${gh_tag_suffix}]${extract.suffix}
    }
}
