# $Id: Portfile

PortSystem 1.0
name			smokeping
version			2.0.9
categories		net
maintainers		markd@macports.org
description		A deluxe latency logging and graphing system.
long_description	SmokePing is a deluxe latency measurement tool. \
			It can measure, store, and display latency, latency \
			distribution, and packet loss. SmokePing uses RRDtool \
			to maintain a longterm data-store and to draw pretty \
			graphs, giving up to the minute information on the \
			state of each network connection.

platforms		darwin
homepage                http://oss.oetiker.ch/smokeping/
master_sites		http://oss.oetiker.ch/smokeping/pub/
checksums		md5 512c0bc38176451df7d664050b1283d9

patchfiles		patch-bin-smokeping.dist \
			patch-bin-tSmoke.dist \
			patch-etc-config.dist \
			patch-htdocs-smokeping.cgi.dist

depends_lib		port:rrdtool \
			port:p5-cgi-speedycgi \
			port:p5-cgi.pm \
			port:p5-net-snmp \
			port:p5-socket6 \
			port:p5-net-telnet \
			port:p5-net-dns \
			port:p5-perl-ldap \
			port:p5-io-socket-ssl \
			port:fping \
			port:echoping \
			port:curl
#			port:p5-net-radius

set smokeroot ${prefix}/lib/smokeping
set smokedata ${prefix}/var/smokeping
set smokeetc ${prefix}/etc/smokeping
set smokedoc ${prefix}/share/doc/smokeping

	startupitem.create	yes
	startupitem.name	smokeping
	startupitem.executable	${prefix}/bin/smokeping

use_configure		no
build {}

post-patch {
	eval reinplace "s|__PREFIX__|${prefix}|g" \
		[glob ${worksrcpath}/bin/*.dist] \
		[glob ${worksrcpath}/etc/*.dist] \
		[glob ${worksrcpath}/htdocs/*.dist]

	eval reinplace "s|/usr/bin/perl|${prefix}/bin/perl|g" \
                [glob ${worksrcpath}/bin/*.dist] \
                [glob ${worksrcpath}/etc/*.dist] \
                [glob ${worksrcpath}/htdocs/*.dist]

	reinplace "s|/usr/bin/|${prefix}|g" \
		${worksrcpath}/lib/Smokeping.pm \
		${worksrcpath}/lib/Smokeping/Examples.pm \
		${worksrcpath}/lib/Smokeping/probes/Curl.pm \
		${worksrcpath}/lib/Smokeping/probes/IOSPing.pm \
		${worksrcpath}/lib/Smokeping/probes/DNS.pm \
		${worksrcpath}/lib/Smokeping/probes/RemoteFPing.pm \
		${worksrcpath}/lib/Smokeping/probes/SSH.pm \
		${worksrcpath}/lib/Smokeping/probes/FPing6.pm \
		${worksrcpath}/lib/Smokeping/probes/EchoPing.pm \
		${worksrcpath}/lib/Smokeping/probes/FPing.pm

	reinplace "s|/usr/share/smokeping/etc/|${prefix}/etc/smokeping|g" \
		${worksrcpath}/lib/Smokeping/probes/passwordchecker.pm
}

destroot {
# bin
	xinstall -m 755 -d ${destroot}${prefix}/bin
	xinstall -m 755 ${worksrcpath}/bin/smokeping.dist ${destroot}${prefix}/bin/smokeping
	xinstall -m 755 ${worksrcpath}/bin/tSmoke.dist ${destroot}${prefix}/bin/tSmoke

# doc
	xinstall -m 755 -d ${destroot}${smokedoc}
	system "cp -R ${worksrcpath}/doc/ ${destroot}${smokedoc}"
	file copy ${worksrcpath}/README ${destroot}${smokedoc}
	file copy ${worksrcpath}/TODO ${destroot}${smokedoc}

# etc
	xinstall -m 755 -d ${destroot}${smokeetc}
	file copy ${worksrcpath}/etc/basepage.html.dist ${destroot}${smokeetc}/basepage.html
	file copy ${worksrcpath}/etc/config.dist ${destroot}${smokeetc}/config
	file copy ${worksrcpath}/etc/smokemail.dist ${destroot}${smokeetc}/smokemail
	file copy ${worksrcpath}/etc/tmail.dist ${destroot}${smokeetc}/tmail

# lib
	system "cp -R ${worksrcpath}/lib/ ${destroot}${smokeroot}"

# Smokeping data directory that needs to be symlinked to Apache docroot
	xinstall -m 755 -d ${destroot}${smokedata}/img

# Smokeping log directory
	xinstall -m 755 -d ${destroot}${smokedata}/log

# htdocs (smokeping.cgi)
        xinstall -m 755 ${worksrcpath}/htdocs/smokeping.cgi.dist \
                ${destroot}${smokedata}/smokeping.cgi

# Retain these empty directories
	destroot.keepdirs ${destroot}${smokedata}/img \
		destroot.keepdirs ${destroot}${smokedata}/log
}

post-activate {
ui_msg "\n  #### To complete the Smokeping installation ####

1) Enable SpeedyCGI (installed as a dependency of Smokeping) for Apache.

   -For MacPorts Apache 2, add the line below to ${prefix}/apache2/conf/httpd.conf.

	LoadModule speedycgi_module modules/mod_speedycgi.so

   -For Apple's Apache 1, manually copy mod_speedycgi.so and smokeping.cgi into place ...

	sudo cp ${prefix}/share/doc/speedycgi/mod_speedycgi.so /usr/libexec/httpd
	sudo cp ${prefix}${smokedata}/smokeping.cgi /<apache-docroot>/cgi-bin

   ... and add the lines below to /etc/httpd/httpd.conf

	LoadModule speedycgi_module libexec/mod_speedycgi.so
        AddModule mod_speedycgi.c


2) Now set Apache for Smokeping by making a symlink and then adding a directive to httpd.conf.

	sudo ln -s ${prefix}/var/smokeping  /<apache-docroot>/smokeping

   <Directory ${prefix}/apache2/htdocs/smokeping> 
       Options ExecCGI
   </Directory>


3) Set Smokeping permissions.

	sudo chown -R www:www ${prefix}/var/smokeping/


4) Edit ${prefix}/etc/smokeping/config.

   -Paths are set by MacPorts, leave them alone.

   -Customize variables
     * General * - owner, contact, and mailhost
     * Alerts  * - to, from addresses

   -Then clear the examples \(they have a leading '+'\) in the *** Targets *** section
    and set your own.

	+ My Web Server
	   menu = MyWebServer
	   title = My Web Server
	   host = mywebserver.mydomain.com
	   alerts = bigloss,someloss,startloss

    -See sample configurations and  examples in ${prefix}/share/doc/smokeping/


5) Setup Smokeping logging.

   -Add this statement to /etc/syslog.conf.

   local1.*	${prefix}/var/smokeping/smokeping.log

   -Create a logfile to receive the log messages.

	sudo touch ${smokedata}/log/smokeping.log
	sudo chmod 600 ${smokedata}/log/smokeping.log
	sudo chown root:admin ${smokedata}/log/smokeping.log

   -Then restart the syslog facility.

	sudo kill -HUP `cat /var/run/syslog.pid`


5) Start Smokeping and verify it is running.  (Give it a minute to start)

	sudo launchctl load -w /Library/LaunchDaemons/org.macports.smokeping.plist
	ps -ax |grep smoke

 1713  ??  Ss     0:00.16 ${prefix}/bin/smokeping \[FPing\]
 1753  ??  Ss     0:00.18 ${prefix}/bin/speedy_backend -w ${prefix}/apache2/htdocs/smokeping/smokeping.cgi
 1754  ??  S      0:01.56 ${prefix}/bin/speedy_backend -w ${prefix}/apache2/htdocs/smokeping/smokeping.cgi


6) Check the Smokeping graphs with a web browser.

   Go to http://localhost/smokeping/smokeping.cgi
\n"
}
