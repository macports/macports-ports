# $Id$

PortSystem 1.0

name		xorg-server
version		1.4.2-apple27
categories	x11 devel
maintainers	jeremyhu
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.
master_sites	http://xquartz.macosforge.org/downloads/src/:xq \
		http://downloads.sourceforge.net/mesa3d/:mesa

set mesavers	"7.0.4"

distfiles	xorg-server-$version.tar.bz2:xq \
		MesaLib-${mesavers}.tar.bz2:mesa

checksums           xorg-server-1.4.2-apple27.tar.bz2 \
                    md5     59b7968cdd2e1c62324a56f8b166ea6e \
                    sha1    1922c4ac0bd8e349fa5232673cf5d7f0db9fbb7a \
                    rmd160  cd54f041b6ac67354ea704cb0176f97085041a1f \
                    MesaLib-7.0.4.tar.bz2 \
                    md5     8d7bacbe0234742a5d08c8088c4619e9 \
                    sha1    7e2ecbe89d245510d2681d04e959aee6adc205c5 \
                    rmd160  0394bb9e00ea13f2399bc5895d4264221bbc03ac

use_bzip2	yes
use_parallel_build yes

depends_build   port:pkgconfig \
                port:xorg-applewmproto \
                port:xorg-fixesproto \
                port:xorg-glproto \
                port:xorg-inputproto \
                port:xorg-randrproto \
                port:xorg-renderproto \
                port:xorg-xcmiscproto \
                port:xorg-xproto \
                port:xorg-xextproto \
                port:xorg-xtrans

# This xinit dependency needs to be port: not bin: because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run     port:xinit

# I'd prefer to keep pixman a port: dependency here for building the server
depends_lib     port:libpixman \
                lib:libAppleWM.7:xorg-libAppleWM \
                lib:libXfixes.3:xorg-libXfixes

# Otherwise glcore.h will be pulled in from glproto in /opt/local/include/GL/internal
configure.cppflags -I${worksrcpath}/../Mesa-${mesavers}/include -I${prefix}/include

# Can be removed once MacPorts 1.7.0 is released
if {![info exists applications_dir]} {
    set applications_dir /Applications/MacPorts
}

configure.args	--with-mesa-source=${worksrcpath}/../Mesa-${mesavers} --with-apple-applications-dir=${applications_dir} --with-fontdir=${x11prefix}/lib/X11/fonts

post-patch {
	reinplace "s|org.x.X11|org.macports.X11|" ${worksrcpath}/hw/xquartz/bundle/Info.plist \
	                                          ${worksrcpath}/hw/xquartz/mach-startup/bundle-main.c \
	                                          ${worksrcpath}/hw/xquartz/mach-startup/stub.c

	reinplace "s|/usr/X11|${prefix}|" ${worksrcpath}/hw/xquartz/mach-startup/bundle-main.c \
	                                  ${worksrcpath}/hw/xquartz/X11Application.m
}

post-destroot {
	system "ln -s Xquartz ${prefix}/bin/X"
}
