# $Id$

PortSystem 1.0

name		xorg-server
version		1.4.2-apple30
categories	x11 devel
maintainers	jeremyhu openmaintainer
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.
master_sites	http://xquartz.macosforge.org/downloads/src/:xq \
		http://downloads.sourceforge.net/mesa3d/:mesa

set mesavers	"7.0.4"

distfiles	xorg-server-$version.tar.bz2:xq \
		MesaLib-${mesavers}.tar.bz2:mesa

checksums           xorg-server-1.4.2-apple30.tar.bz2 \
                    md5     9ce0d24fc932527f361d06979c092a4b \
                    sha1    e2841b3bd8b51463e76f0610bc6eb1f81d36dfb6 \
                    rmd160  d079fb31648b2c1251c5164262a8e25faefb7113 \
                    MesaLib-7.0.4.tar.bz2 \
                    md5     8d7bacbe0234742a5d08c8088c4619e9 \
                    sha1    7e2ecbe89d245510d2681d04e959aee6adc205c5 \
                    rmd160  0394bb9e00ea13f2399bc5895d4264221bbc03ac

use_bzip2	yes
use_parallel_build yes

patchfiles vnc-workaround.patch

depends_build \
	port:pkgconfig \
	port:xorg-applewmproto \
	port:xorg-damageproto \
	port:xorg-evieproto \
	port:xorg-fixesproto \
	port:xorg-fontsproto \
	port:xorg-glproto \
	port:xorg-inputproto \
	port:xorg-randrproto \
	port:xorg-recordproto \
	port:xorg-renderproto \
	port:xorg-resourceproto \
	port:xorg-trapproto \
	port:xorg-scrnsaverproto \
	port:xorg-videoproto \
	port:xorg-xcmiscproto \
	port:xorg-xproto \
	port:xorg-xextproto \
	port:xorg-xineramaproto \
	port:xorg-xtrans

# This xinit dependency needs to be port: not bin: because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run \
	port:xinit

# I'd prefer to keep pixman a port: dependency here for building the server
depends_lib \
	port:libpixman \
	port:xorg-libxkbfile \
	port:xorg-libXfont \
	port:xorg-libXt \
	port:xorg-libAppleWM \
	port:xorg-libXfixes

post-patch {
	reinplace "s|ensure_path(X11BINDIR);|ensure_path(X11BINDIR); ensure_path(\"${x11prefix}/bin\");|" ${worksrcpath}/hw/xquartz/mach-startup/bundle-main.c

	# Yeah, there's probably a better way to do this...
	system "cd ${worksrcpath}/.. && patch -p0 < ${filespath}/mesa-7.0-multisample.patch"
}

configure.args	--with-mesa-source=${worksrcpath}/../Mesa-${mesavers} --with-apple-applications-dir=${applications_dir} --with-fontdir=${x11prefix}/lib/X11/fonts --with-apple-application-id=org.macports.X11

# Otherwise glcore.h will be pulled in from glproto in /opt/local/include/GL/internal
configure.cppflags-delete -I${prefix}/include
configure.cppflags-append -I${worksrcpath}/../Mesa-${mesavers}/include -I${prefix}/include -I${x11prefix}/include

post-destroot {
	ln -s Xquartz ${destroot}${prefix}/bin/X
}

platform macosx {
	if { ![file exists /usr/include/Xplugin.h] } {
		# Xplugin.h is missing on Tiger
		configure.cppflags-append -I${filespath}/include
	}

	if {${os.major} < 9} {
		configure.args-append --disable-glx
		post-install {
			ui_msg "This server has not been thoroughly tested on Tiger.  Your feedback would be welcomed on x11-users@macosforge.org."
		}
	}
}
