# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                mesa
version             7.4
revision            0
set ASGLX_version   56
categories          x11 graphics
maintainers         jeremyhu andrea.damore openmaintainer
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2:mesa \
                    MesaGLUT-${version}.tar.bz2:mesa \
                    AppleSGLX-${ASGLX_version}.tar.bz2:xq

# The Mesa glut versions of glxgears and glxinfo aren't Tiger friendly
#                    MesaDemos-${version}.tar.bz2:mesa \

worksrcdir          Mesa-${version}
platforms           macosx darwin
use_bzip2           yes
master_sites        sourceforge:mesa3d:mesa \
                    http://xquartz.macosforge.org/downloads/src/:xq

checksums           MesaLib-7.4.tar.bz2 \
                    md5     7ecddb341a2691e0dfdb02f697109834 \
                    sha1    66b5fe185e63706ee2a76e247fd982fdf13972e2 \
                    rmd160  a3e601a5fbb482b4d9668d88a33592ea180170d5 \
                    MesaGLUT-7.4.tar.bz2 \
                    md5     04ec01caebde44f5b0d619f00716b368 \
                    sha1    91a405b23b0b848325cc11fbffc0f62008d2a9a7 \
                    rmd160  b02194f4a2049c40eb4d7e15b87bed20f5a45269 \
                    AppleSGLX-56.tar.bz2 \
                    md5     343e62843ff03f8b55a8102abd4e59ee \
                    sha1    3740d230fc06333107aa7aa5141f059b62200d74 \
                    rmd160  f2d991b3b5c5dba0c1621e6e9ed93c7456653c96

# glut port is here to "clean out" the glut port if it's installed to avoid conflict
depends_build \
	port:xorg-glproto \
	bin:makedepend:makedepend \
	port:glut \
	bin:tclsh8.5:tcl

depends_lib \
	port:xorg-libXi \
	port:xorg-libXmu

use_configure  no
use_parallel_build yes

patch.pre_args -p1
patchfiles \
	mesa-7.2-drm_headers.patch \
	mesa-7.4-x11dir.patch \
	mesa-7.4-byte_order.patch \
	mesa-7.4-indirect.patch 

build.target default
# PROGS="glxgears glxinfo"
build.args-append INSTALL_DIR=${prefix}
destroot.args-append INSTALL_DIR=${prefix}

variant universal {
	if {![info exists universal_archs]} {
		set universal_archs {i386 ppc}
	}
	build.args-append RC_ARCHS="${universal_archs}"
	build.args-append RC_CFLAGS="${configure.universal_cflags}"
}

if { ![file exists /usr/include/Xplugin.h] } {
        # Xplugin.h is missing on Tiger
        configure.cppflags-append -I${filespath}/include
}

if {! [variant_isset system_x11]} {
	default_variants +hw_render

	post-patch {
		reinplace "s:-fno-strict-aliasing:-fno-strict-aliasing -fno-common:g" ${worksrcpath}/configs/darwin
		reinplace "s:osmesa::g" ${worksrcpath}/configs/darwin
	}

	post-extract {
		if {! [file exists "${worksrcpath}/configs/current"]} {
			ln -s darwin ${worksrcpath}/configs/current
		}
	}

	# This next hunk supports building -system_x11 mesa on a system that is otherwise +system_x11
	pre-build {
		if {! [file exists ${prefix}/lib/libX11.dylib]} {
			build.args-append X11_DIR=${x11prefix}
			destroot.args-append X11_DIR=${x11prefix}
		}
	}

# Do this if you want to install the mesa-provided glxinfo and glxgears... doesn't work on Tiger
#	post-destroot {
#		xinstall -m 755 -W "${worksrcpath}/progs/xdemos" glxgears glxinfo "${destroot}${prefix}/bin"
#	}

}

variant hw_render conflicts system_x11 description {Install a libGL.dylib that uses OpenGL.framework to allow rendering on your graphics hardware} {
	post-patch {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && cat ${filespath}/asglx-*.patch | patch -p0"
	}

	post-build {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} builds/libGL.1.2.dylib ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} programs ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
	}

	post-destroot {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} ${destroot.target} ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} install_programs ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
	}
}

platform darwin 8 {
	post-activate {
		if {[variant_isset hw_render]} {
			ui_msg "In order to use OpenGL on Tiger, you need to use MacPorts' X11 server (xorg-server) rather than Apple's."
		}
	}
}

variant system_x11 conflicts hw_render description {Install a stub package to use the system X11 libraries rather than MacPorts} {
	if { [file exists ${x11prefix}/lib/libGLU.dylib] && ! [string equal ${prefix} ${x11prefix}] } {
		depends_build
		depends_lib
		depends_run
		distfiles
		fetch           { }
		checksum        { }
		extract         { }
		patch           { }
		build           { }
		destroot        {
			xinstall -d ${destroot}${prefix}/share/doc/${name}
			system "echo ${long_description} > ${destroot}${prefix}/share/doc/${name}/README.txt"
		}
		use_configure no
	}
}

livecheck.regex "<title>MesaLib (.*) released.*</title>"
