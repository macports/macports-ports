# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                mesa
version             7.6
set ASGLX_version   58
categories          x11 graphics
maintainers         jeremyhu openmaintainer
revision            1
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2:mesa \
                    MesaGLUT-${version}.tar.bz2:mesa \
                    AppleSGLX-${ASGLX_version}.tar.bz2:xq

# The Mesa glut versions of glxgears and glxinfo aren't Tiger friendly
#                    MesaDemos-${version}.tar.bz2:mesa \

worksrcdir          Mesa-${version}
set ASGLX_path      ${workpath}/AppleSGLX-${ASGLX_version}
platforms           macosx darwin
use_bzip2           yes
master_sites        ftp://ftp.freedesktop.org/pub/mesa/current/:mesa \
                    http://xquartz.macosforge.org/downloads/src/:xq
checksums           MesaLib-7.6.tar.bz2 \
                    md5     8c75f90cd0303cfac9e4b6d54f6759ca \
                    sha1    4bb10d98afa2585bf60cffb6861b511e86b7b240 \
                    rmd160  9d37e916199ca27b14eb01baa3a15ce37f8f4e84 \
                    MesaGLUT-7.6.tar.bz2 \
                    md5     b8b59706f827d18d1b784a0ff98b4dc2 \
                    sha1    8f6b9947973a3c90f32b3234f7a5969b09057cc1 \
                    rmd160  c0237a36fc8d865b035db9c4851517a57cba148e \
                    AppleSGLX-58.tar.bz2 \
                    md5     bd69be44d141fb07dfc6656b869db222 \
                    sha1    555736e8c7bfed3a4dc776ef9f51c3716fa4079e \
                    rmd160  39e3d57acaa191eb0b86c4a91cf3bc8302e23fd7

# glut port is here to "clean out" the glut port if it's installed to avoid conflict
depends_build \
	bin:makedepend:makedepend \
	port:glut \
	bin:tclsh8.5:tcl

depends_lib \
	port:xorg-glproto \
	port:xorg-dri2proto \
	port:xorg-libXfixes \
	port:xorg-libXi \
	port:xorg-libXmu

use_configure  no
use_parallel_build yes

patch.pre_args -p1
patchfiles \
	patch-gen_gl_h.sh.diff \
	mesa-7.2-drm_headers.patch

build.target default
# PROGS="glxgears glxinfo"
build.args-append INSTALL_DIR=${prefix}
destroot.args-append INSTALL_DIR=${prefix}

# Ensure correct compilers are used in Makefiles.
build.args-append \
    CC=${configure.cc} \
    CXX=${configure.cxx}

variant universal {}
if {[variant_isset universal]} {
    set extra_cflags ${configure.universal_cflags}
    set extra_ldflags ${configure.universal_ldflags}
} else {
    set extra_cflags ${configure.cc_archflags}
    set extra_ldflags ${configure.cc_archflags}
}

build.args-append RC_CFLAGS="${extra_cflags}"
eval configure.cflags-append ${extra_cflags}
eval configure.ldflags-append ${extra_ldflags}

if { ![file exists /usr/include/Xplugin.h] } {
        # Xplugin.h is missing on Tiger
        configure.cppflags-append -I${filespath}/include
}

default_variants +hw_render

post-patch {
	reinplace "s:-fno-strict-aliasing:-fno-strict-aliasing -fno-common:g" ${worksrcpath}/configs/darwin
	reinplace "s:osmesa::g" ${worksrcpath}/configs/darwin

	# Ensure correct compilers are used in mklib.
	reinplace "s:LINK=\"g++\":LINK=\"${configure.cxx}\":"  ${worksrcpath}/bin/mklib
	reinplace "s:LINK=\"cc\":LINK=\"${configure.cc}\":"    ${worksrcpath}/bin/mklib

	# Ensure test programs glxgears and glxinfo are built for the right architectures.
	reinplace "s|(CC) tests|(CC) ${extra_cflags} ${extra_ldflags} tests|" \
		${ASGLX_path}/Makefile
}

post-extract {
	if {! [file exists "${worksrcpath}/configs/current"]} {
		ln -s darwin ${worksrcpath}/configs/current
	}
}

# Do this if you want to install the mesa-provided glxinfo and glxgears... doesn't work on Tiger
#post-destroot {
#	xinstall -m 755 -W "${worksrcpath}/progs/xdemos" glxgears glxinfo "${destroot}${prefix}/bin"
#}

variant hw_render description {Install a libGL.dylib that uses OpenGL.framework to allow rendering on your graphics hardware} {
#	post-patch {
#		system "cd ${ASGLX_path} && cat ${filespath}/asglx-*.patch | patch -p0"
#	}

	post-build {
		system "cd ${ASGLX_path} && ${build.cmd} builds/libGL.1.2.dylib ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
		system "cd ${ASGLX_path} && ${build.cmd} programs ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
	}

	post-destroot {
		system "cd ${ASGLX_path} && ${destroot.cmd} ${destroot.target} ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
		system "cd ${ASGLX_path} && ${destroot.cmd} install_programs ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
	}
}

platform darwin 8 {
    patchfiles-append patch-Mesa_7.6-src-glu-sgi-glu.exports.darwin.diff
	post-activate {
		if {[variant_isset hw_render]} {
			ui_msg "In order to use OpenGL on Tiger, you need to use MacPorts' X11 server (xorg-server) rather than Apple's."
		}
	}
}

livecheck.regex "<title>MesaLib (.*) released.*</title>"
