# $Id: Portfile,v 1.30 2005/09/04 14:09:17 ben Exp $

PortSystem 1.0
name		kdebase3
version		3.4.1
revision	3
categories	x11
maintainers	ben@opendarwin.org
description	Base KDE programs -- e.g. kicker (taskbar). \
		NB No KDE sound support.
platforms	darwin
master_sites	kde:stable/${version}/src \
		http://ranger.befunk.com/fink/:admin
extract.suffix	.tar.bz2
use_bzip2	yes
distname	kdebase-${version}
distfiles	${distname}.tar.bz2 kde-admindir-3.4.0-6.tar.bz2:admin
depends_lib	lib:libkdecore.4.2.0:kdelibs3 \
		lib:libXm:lesstif \
		lib:libsmbclient:samba3

checksums	kdebase-${version}.tar.bz2 md5 8fbe0b943721b79f2549064b580acdde \
		kde-admindir-3.4.0-6.tar.bz2 md5 5d0274369eba8c862178ba8e26639cc3 \
		detect-autoconf.tar.bz2 md5 1f511627496be40174169dbab4d6d78a

set env(PATH) "/usr/X11R6/bin:$env(PATH):${prefix}/bin"

platform darwin 6 {
		depends_lib-append	lib:libdl:dlcompat
}

patchfiles	kdebase3.patch
patch.args 	-p1

post-patch      {
		system "cd '${worksrcpath}' && if test -d ../admin; then cp -Rf ../admin/ admin; fi"
		system "cd '${worksrcpath}' && if test -d ../libltdl; then cp -Rf ../libltdl/ libltdl; fi"
		system "cd '${worksrcpath}' && make -f admin/Makefile.common cvs"
		foreach file [glob admin/*] {
		    reinplace "s|-O2|-Os|g" $file
		    reinplace "s|doc/HTML|doc/kde|g" $file
		    reinplace "s|/usr/share/doc/packages/qt3/html|${prefix}/share/doc/qt3/html|g" $file
		    reinplace "s|HAVE_GCC_VISIBILITY=1|HAVE_GCC_VISIBILITY=0|g" $file
		    reinplace "s|-fvisibility=hidden -fvisibility-inlines-hidden||g" $file
		}
	    	reinplace "s|@FINKPREFIX@|${prefix}|g" ${worksrcpath}/kioslave/info/kde-info2html.conf
		reinplace "s|@FINKPREFIX@|${prefix}|g" ${worksrcpath}/kioslave/man/kio_man.cpp
}

configure.env	CC=gcc-3.3 CXX=g++-3.3 \
		CFLAGS='-Os' CXXFLAGS='-Os' \
		CPPFLAGS='-I/usr/X11R6/include -I/usr/X11R6/include/freetype2 -I/usr/X11R6/include/freetype2/freetype -I${prefix}/include -I${prefix}/include/qt3 -I/usr/include/gssapi -no-cpp-precomp -fno-common -UHAVE_REALTIME_SCHED' \
		LDFLAGS='-L/usr/X11R6/lib -L${prefix}/lib' \
		LIBS='-L${prefix}/lib' \
		lt_cv_sys_max_cmd_len=65536

configure.args	--prefix='${prefix}' --includedir='${prefix}/include' --libdir='${prefix}/lib' \
		--with-extra-includes='${prefix}/include:/usr/include/gssapi' \
		--with-extra-libs='${prefix}/lib' \
		--with-qt-dir='${prefix}' --with-qt-includes='${prefix}/include/qt3' \
		--with-plugins='${prefix}/lib/qt3-plugins' \
		--enable-rpath --with-pic --enable-shared=yes --enable-static=no --enable-mt \
		--libexecdir='${prefix}/lib' --with-xinerama --with-pam --disable-final \
		--disable-dependency-tracking --enable-cups --with-ldap \
		--mandir=${prefix}/share/man --with-pam --with-distribution='DarwinPorts/Mac OS X' \
		--with-ssl-dir=/usr --with-ssl --with-gssapi=framework --disable-dependency-tracking \
		--without-arts

build.env	${configure.env}
build.target	all all_libraries="-L${prefix}/lib -L/usr/X11R6/lib -L/usr/lib" KDM_FLAGS="-UHAVE_UTMPX -DBSD_UTMP=1"

destroot.args   -j1
destroot.target install

variant apidox {
depends_lib-append port:doxygen
build.target	   all apidox all_libraries="-L${prefix}/lib -L/usr/X11R6/lib -L/usr/lib" KDM_FLAGS="-UHAVE_UTMPX -DBSD_UTMP=1"
}

post-destroot   {
		xinstall -d -m 755 ${destroot}${prefix}/etc/pam.d
		xinstall -c -m 444 /etc/pam.d/login ${destroot}${prefix}/etc/pam.d/kde
		xinstall -c -m 444 /etc/pam.d/login ${destroot}${prefix}/etc/pam.d/kdm
		xinstall -c -m 444 /etc/pam.d/login ${destroot}${prefix}/etc/pam.d/kcheckpass
		xinstall -c -m 444 /etc/pam.d/login ${destroot}${prefix}/etc/pam.d/kscreensaver
		system "rm -rf ${destroot}${prefix}/share/fonts || true"
#		system "rm -rf ${destroot}${prefix}/share/icons/crystalsvg/scalable/apps/artsbuilder.*"
}
