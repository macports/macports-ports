diff -u -ruN kdebase-3.4.1.orig/drkonqi/Makefile.am kdebase-3.4.1/drkonqi/Makefile.am
--- kdebase-3.4.1.orig/drkonqi/Makefile.am	2005-09-01 16:58:26.000000000 -0700
+++ kdebase-3.4.1/drkonqi/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -8,15 +8,17 @@
 
 EXTRA_DIST = LICENSE
 
-bin_PROGRAMS = drkonqi
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = drkonqi.la
 
 # Libraries:
-AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-LDADD  = $(LIB_KDEUI) $(LIB_KIO)
+drkonqi_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+drkonqi_la_LIBADD  = $(LIB_KDEUI) $(LIB_KIO)
 
 # toplevel.cpp must be last in row due to X-headers being included. (--enable-final)
 # Did I mention already that X header files really suck?
-drkonqi_SOURCES = krashdcopinterface.skel main.cpp debugger.cpp krashconf.cpp drbugreport.cpp backtrace.cpp toplevel.cpp
+drkonqi_la_SOURCES = krashdcopinterface.skel main.cpp debugger.cpp krashconf.cpp drbugreport.cpp backtrace.cpp toplevel.cpp
 
 
 check_PROGRAMS = crashtest
diff -u -ruN kdebase-3.4.1.orig/drkonqi/main.cpp kdebase-3.4.1/drkonqi/main.cpp
--- kdebase-3.4.1.orig/drkonqi/main.cpp	2005-09-01 16:58:26.000000000 -0700
+++ kdebase-3.4.1/drkonqi/main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -57,7 +57,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char* argv[] )
+extern "C" int kdemain( int argc, char* argv[] )
 {
   // Drop privs.
   setgid(getgid());
diff -u -ruN kdebase-3.4.1.orig/drkonqi/main.cpp.orig kdebase-3.4.1/drkonqi/main.cpp.orig
--- kdebase-3.4.1.orig/drkonqi/main.cpp.orig	1969-12-31 16:00:00.000000000 -0800
+++ kdebase-3.4.1/drkonqi/main.cpp.orig	2005-05-23 05:14:51.000000000 -0700
@@ -0,0 +1,90 @@
+/*****************************************************************
+ * drkonqi - The KDE Crash Handler
+ *
+ * Copyright (C) 2000-2003 Hans Petter Bieker <bieker@kde.org>
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+ * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
+ * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ *****************************************************************/
+
+#include <config.h>
+
+#include <stdlib.h>
+#include <unistd.h>
+
+#include <kapplication.h>
+#include <kcmdlineargs.h>
+#include <kaboutdata.h>
+#include <klocale.h>
+#include <dcopclient.h>
+
+#include "krashconf.h"
+#include "toplevel.h"
+
+static const char version[] = "1.0";
+static const char description[] = I18N_NOOP( "KDE crash handler gives the user feedback if a program crashed" );
+
+static const KCmdLineOptions options[] =
+{
+  {"signal <number>", I18N_NOOP("The signal number that was caught"), 0},
+  {"appname <name>",  I18N_NOOP("Name of the program"), 0},
+  {"apppath <path>",  I18N_NOOP("Path to the executable"), 0},
+  {"appversion <version>", I18N_NOOP("The version of the program"), 0},
+  {"bugaddress <address>", I18N_NOOP("The bug address to use"), 0},
+  {"programname <name>", I18N_NOOP("Translated name of the program"), 0},
+  {"pid <pid>", I18N_NOOP("The PID of the program"), 0},
+  {"startupid <id>", I18N_NOOP("Startup ID of the program"), 0},
+  {"kdeinit", I18N_NOOP("The program was started by kdeinit"), 0},
+  {"safer", I18N_NOOP("Disable arbitrary disk access"), 0},
+  KCmdLineLastOption
+};
+
+int main( int argc, char* argv[] )
+{
+  // Drop privs.
+  setgid(getgid());
+  setuid(getuid());
+
+  // Make sure that DrKonqi doesn't start DrKonqi when it crashes :-]
+  setenv("KDE_DEBUG", "true", 1);
+  unsetenv("SESSION_MANAGER");
+
+  KAboutData aboutData( "drkonqi",
+                        I18N_NOOP("The KDE Crash Handler"),
+                        version,
+                        description,
+                        KAboutData::License_BSD,
+                        "(C) 2000-2003, Hans Petter Bieker");
+  aboutData.addAuthor("Hans Petter Bieker", 0, "bieker@kde.org");
+
+  KCmdLineArgs::init(argc, argv, &aboutData);
+  KCmdLineArgs::addCmdLineOptions( options );
+
+  KApplication::disableAutoDcopRegistration();
+
+  KApplication a;
+
+  KrashConfig krashconf;
+
+  Toplevel w(&krashconf);
+
+  return w.exec();
+}
diff -u -ruN kdebase-3.4.1.orig/kappfinder/Makefile.am kdebase-3.4.1/kappfinder/Makefile.am
--- kdebase-3.4.1.orig/kappfinder/Makefile.am	2005-09-01 16:58:28.000000000 -0700
+++ kdebase-3.4.1/kappfinder/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,9 +1,17 @@
 SUBDIRS = apps
 
-bin_PROGRAMS = kappfinder
-kappfinder_SOURCES = main.cpp toplevel.cpp common.cpp
-kappfinder_LDADD = $(LIB_KDEUI) $(LIB_KIO)
-kappfinder_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kappfinder.la
+
+kappfinder_la_SOURCES = main.cpp toplevel.cpp kacommon.cpp
+kappfinder_la_LIBADD = $(LIB_KDEUI) $(LIB_KIO)
+kappfinder_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+
+$(srcdir)/kacommon.cpp: $(srcdir)/common.cpp
+	cat $(srcdir)/common.cpp > $(srcdir)/kacommon.cpp
+
+DISTCLEANFILES = kacommon.cpp
 
 noinst_PROGRAMS = kappfinder_install
 kappfinder_install_SOURCES = main_install.cpp common.cpp
diff -u -ruN kdebase-3.4.1.orig/kappfinder/main.cpp kdebase-3.4.1/kappfinder/main.cpp
--- kdebase-3.4.1.orig/kappfinder/main.cpp	2005-09-01 16:58:28.000000000 -0700
+++ kdebase-3.4.1/kappfinder/main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -31,7 +31,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" int kdemain( int argc, char *argv[] )
 {
   KAboutData aboutData( "kappfinder", I18N_NOOP( "KAppfinder" ),
                         "1.0", description, KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/kcontrol/filetypes/Makefile.am kdebase-3.4.1/kcontrol/filetypes/Makefile.am
--- kdebase-3.4.1.orig/kcontrol/filetypes/Makefile.am	2005-09-01 16:58:39.000000000 -0700
+++ kdebase-3.4.1/kcontrol/filetypes/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -12,16 +12,18 @@
 	kservicelistwidget.h typeslistitem.h newtypedlg.h \
 	kserviceselectdlg.h
 
-bin_PROGRAMS = keditfiletype
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = keditfiletype.la
 
 noinst_LTLIBRARIES = libfiletypes.la
 libfiletypes_la_SOURCES = filetypesview.cpp filetypedetails.cpp filegroupdetails.cpp \
 		 kservicelistwidget.cpp typeslistitem.cpp newtypedlg.cpp \
 		 kserviceselectdlg.cpp
 
-keditfiletype_SOURCES = keditfiletype.cpp
-keditfiletype_LDADD = libfiletypes.la $(LIB_KIO)
-keditfiletype_LDFLAGS = $(KDE_RPATH) $(all_libraries)
+keditfiletype_la_SOURCES = keditfiletype.cpp
+keditfiletype_la_LIBADD = libfiletypes.la $(LIB_KIO)
+keditfiletype_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/filetypes.pot
diff -u -ruN kdebase-3.4.1.orig/kcontrol/filetypes/keditfiletype.cpp kdebase-3.4.1/kcontrol/filetypes/keditfiletype.cpp
--- kdebase-3.4.1.orig/kcontrol/filetypes/keditfiletype.cpp	2005-09-01 16:58:39.000000000 -0700
+++ kdebase-3.4.1/kcontrol/filetypes/keditfiletype.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -93,7 +93,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char ** argv)
+extern "C" int kdemain(int argc, char ** argv)
 {
   KServiceTypeProfile::setConfigurationMode();
   KLocale::setMainCatalogue("filetypes");
diff -u -ruN kdebase-3.4.1.orig/kcontrol/kfontinst/configure.in.in kdebase-3.4.1/kcontrol/kfontinst/configure.in.in
--- kdebase-3.4.1.orig/kcontrol/kfontinst/configure.in.in	2005-09-01 16:58:37.000000000 -0700
+++ kdebase-3.4.1/kcontrol/kfontinst/configure.in.in	2005-09-01 17:03:14.000000000 -0700
@@ -56,7 +56,7 @@
             done
             LIBFONTCONFIG_RPATH=`echo $LIBFONTCONFIG_RPATH | sed -e "s/-L/-R/g"`
             LIBFONTCONFIG_CFLAGS="`$PKGCONFIG fontconfig --cflags`"
-            KFI_FOUND_FONTCONFIG=1
+            KFI_FOUND_FONTCONFIG=0
         fi
     fi
 
@@ -74,7 +74,7 @@
             done
             LIBFONTCONFIG_RPATH=`echo $LIBFONTCONFIG_RPATH | sed -e "s/-L/-R/g"`
             LIBFONTCONFIG_CFLAGS="`$FONTCONFIG_CONFIG --cflags`"
-            KFI_FOUND_FONTCONFIG=1
+            KFI_FOUND_FONTCONFIG=0
         fi
     fi
 
diff -u -ruN kdebase-3.4.1.orig/kcontrol/kfontinst/kfontinst/Main.cpp kdebase-3.4.1/kcontrol/kfontinst/kfontinst/Main.cpp
--- kdebase-3.4.1.orig/kcontrol/kfontinst/kfontinst/Main.cpp	2005-09-01 16:58:37.000000000 -0700
+++ kdebase-3.4.1/kcontrol/kfontinst/kfontinst/Main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -190,7 +190,7 @@
         KFI::CXConfig::refreshPaths(true);
 }
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 #ifdef HAVE_GETOPT_H
     static struct option options[]=
diff -u -ruN kdebase-3.4.1.orig/kcontrol/kfontinst/kfontinst/Makefile.am kdebase-3.4.1/kcontrol/kfontinst/kfontinst/Makefile.am
--- kdebase-3.4.1.orig/kcontrol/kfontinst/kfontinst/Makefile.am	2005-09-01 16:58:37.000000000 -0700
+++ kdebase-3.4.1/kcontrol/kfontinst/kfontinst/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,5 +1,8 @@
-bin_PROGRAMS = kfontinst
-kfontinst_SOURCES = \
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfontinst.la
+
+kfontinst_la_SOURCES = \
 CompressedFile.cpp \
 Main.cpp \
 Encodings.cpp \
@@ -15,6 +18,6 @@
 Fontmap.h \
 XConfig.h
 
-kfontinst_LDADD = ../../fonts/libkxftconfig.la $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_FONT_ENC) $(LIBZ) $(LIB_KIO) ../lib/libkfontinst.la
-kfontinst_LDFLAGS = $(all_libraries) $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(KDE_RPATH)
+kfontinst_la_LIBADD = ../../fonts/libkxftconfig.la $(LIBFONTCONFIG_LIBS) $(LIBFREETYPE_LIBS) $(LIB_FONT_ENC) $(LIBZ) $(LIB_KIO) ../lib/libkfontinst.la
+kfontinst_la_LDFLAGS = $(all_libraries) $(LIBFONTCONFIG_RPATH) $(LIBFREETYPE_RPATH) $(KDE_PLUGIN) -module
 AM_CPPFLAGS= -DOS_$(UNAME) -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS)
diff -u -ruN kdebase-3.4.1.orig/kcontrol/kfontinst/viewpart/FontViewerApp.cpp kdebase-3.4.1/kcontrol/kfontinst/viewpart/FontViewerApp.cpp
--- kdebase-3.4.1.orig/kcontrol/kfontinst/viewpart/FontViewerApp.cpp	2005-09-01 16:58:37.000000000 -0700
+++ kdebase-3.4.1/kcontrol/kfontinst/viewpart/FontViewerApp.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -116,7 +116,7 @@
                             KAboutData::License_GPL,
                             I18N_NOOP("(c) Craig Drummond, 2004"));
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KCmdLineArgs::init(argc, argv, &aboutData);
     KCmdLineArgs::addCmdLineOptions(options);
diff -u -ruN kdebase-3.4.1.orig/kcontrol/kfontinst/viewpart/Makefile.am kdebase-3.4.1/kcontrol/kfontinst/viewpart/Makefile.am
--- kdebase-3.4.1.orig/kcontrol/kfontinst/viewpart/Makefile.am	2005-09-01 16:58:37.000000000 -0700
+++ kdebase-3.4.1/kcontrol/kfontinst/viewpart/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -11,15 +11,18 @@
 AM_CPPFLAGS = -I$(srcdir)/../lib -I$(srcdir)/../../fonts $(all_includes) $(LIBFREETYPE_CFLAGS) $(LIBFONTCONFIG_CFLAGS)
 METASOURCES = AUTO
 
-kfontview_LDADD = $(LIB_KPARTS)
-kfontview_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kfontview_la_LIBADD = $(LIB_KPARTS)
+kfontview_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfontview.la
 
-bin_PROGRAMS = kfontview
 xdg_apps_DATA = kfontview.desktop
 
 appdata_DATA = kfontviewpart.rc kfontviewui.rc
 appdatadir = $(kde_datadir)/kfontview
 
-kfontview_SOURCES = FontViewerApp.cpp
+kfontview_la_SOURCES = FontViewerApp.cpp
 
 
diff -u -ruN kdebase-3.4.1.orig/kdcop/Makefile.am kdebase-3.4.1/kdcop/Makefile.am
--- kdebase-3.4.1.orig/kdcop/Makefile.am	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdcop/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -7,10 +7,13 @@
 
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kdcop
-
-kdcop_SOURCES = kdcop.cpp kdcopwindow.cpp kdcoplistview.cpp kdcopview.ui
-kdcop_LDFLAGS = $(all_libraries) $(KDE_RPATH) $(LIB_KDEUI) $(LIB_KDECORE) $(LIB_KIO) -lDCOP $(LIB_QT)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdcop.la
+
+kdcop_la_SOURCES = kdcop.cpp kdcopwindow.cpp kdcoplistview.cpp kdcopview.ui
+kdcop_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdcop_la_LIBADD  = $(LIB_KDEUI) $(LIB_KDECORE) $(LIB_KIO) -lDCOP $(LIB_QT)
 
 noinst_HEADERS = kdcopwindow.h
 METASOURCES =	AUTO
diff -u -ruN kdebase-3.4.1.orig/kdcop/kdcop.cpp kdebase-3.4.1/kdcop/kdcop.cpp
--- kdebase-3.4.1.orig/kdcop/kdcop.cpp	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdcop/kdcop.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -15,7 +15,7 @@
     KCmdLineLastOption
 };
 
-int main( int argc, char ** argv )
+extern "C" int kdemain( int argc, char ** argv )
 {
   KAboutData aboutData( "kdcop", I18N_NOOP("KDCOP"),
 			"0.1", I18N_NOOP( "A graphical DCOP browser/client" ),
diff -u -ruN kdebase-3.4.1.orig/kdebugdialog/Makefile.am kdebase-3.4.1/kdebugdialog/Makefile.am
--- kdebase-3.4.1.orig/kdebugdialog/Makefile.am	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdebugdialog/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -4,12 +4,14 @@
 
 ####### Files
 
-bin_PROGRAMS = kdebugdialog
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdebugdialog.la
 
-kdebugdialog_SOURCES = main.cpp kabstractdebugdialog.cpp kdebugdialog.cpp klistdebugdialog.cpp
-kdebugdialog_METASOURCES = AUTO
-kdebugdialog_LDFLAGS =       $(all_libraries) $(KDE_RPATH)
-kdebugdialog_LDADD   =       $(LIB_KDEUI)
+kdebugdialog_la_SOURCES = main.cpp kabstractdebugdialog.cpp kdebugdialog.cpp klistdebugdialog.cpp
+kdebugdialog_la_METASOURCES = AUTO
+kdebugdialog_la_LDFLAGS =       $(all_libraries) $(KDE_PLUGIN) -module
+kdebugdialog_la_LIBADD   =       $(LIB_KDEUI)
 
 messages:
 	$(XGETTEXT) *.cpp -o $(podir)/kdebugdialog.pot	
diff -u -ruN kdebase-3.4.1.orig/kdebugdialog/main.cpp kdebase-3.4.1/kdebugdialog/main.cpp
--- kdebase-3.4.1.orig/kdebugdialog/main.cpp	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdebugdialog/main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -75,7 +75,7 @@
   KCmdLineLastOption
 };
 
-int main(int argc, char ** argv)
+extern "C" int kdemain(int argc, char ** argv)
 {
   KAboutData data( "kdebugdialog", I18N_NOOP( "KDebugDialog"),
     "1.0", I18N_NOOP("A dialog box for setting preferences for debug output"),
diff -u -ruN kdebase-3.4.1.orig/kdepasswd/Makefile.am kdebase-3.4.1/kdepasswd/Makefile.am
--- kdebase-3.4.1.orig/kdepasswd/Makefile.am	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdepasswd/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,10 +1,13 @@
 
 SUBDIRS = kcm
 
-bin_PROGRAMS = kdepasswd
-kdepasswd_SOURCES = kdepasswd.cpp passwd.cpp passwddlg.cpp
-kdepasswd_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdepasswd_LDADD = $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdepasswd.la
+
+kdepasswd_la_SOURCES = kdepasswd.cpp passwd.cpp passwddlg.cpp
+kdepasswd_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdepasswd_la_LIBADD = $(LIB_KIO)
 
 METASOURCES =  AUTO
 AM_CPPFLAGS= -I$(top_srcdir)/libkonq $(all_includes)
diff -u -ruN kdebase-3.4.1.orig/kdepasswd/kdepasswd.cpp kdebase-3.4.1/kdepasswd/kdepasswd.cpp
--- kdebase-3.4.1.orig/kdepasswd/kdepasswd.cpp	2005-09-01 16:58:50.000000000 -0700
+++ kdebase-3.4.1/kdepasswd/kdepasswd.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -26,7 +26,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData aboutData("kdepasswd", I18N_NOOP("KDE passwd"),
             VERSION, I18N_NOOP("Changes a UNIX password."),
diff -u -ruN kdebase-3.4.1.orig/kdeprint/kdeprintfax/Makefile.am kdebase-3.4.1/kdeprint/kdeprintfax/Makefile.am
--- kdebase-3.4.1.orig/kdeprint/kdeprintfax/Makefile.am	2005-09-01 16:58:53.000000000 -0700
+++ kdebase-3.4.1/kdeprint/kdeprintfax/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,11 +1,14 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = kdeprintfax
-kdeprintfax_SOURCES = main.cpp kdeprintfax.cpp faxab.cpp faxctrl.cpp confgeneral.cpp configdlg.cpp \
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdeprintfax.la
+
+kdeprintfax_la_SOURCES = main.cpp kdeprintfax.cpp faxab.cpp faxctrl.cpp confgeneral.cpp configdlg.cpp \
 		      conffax.cpp confsystem.cpp conffilters.cpp filterdlg.cpp defcmds.cpp
-kdeprintfax_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdeprintfax_LDADD   = $(LIB_KDEUI) $(LIB_KIO) $(LIB_KDEPRINT) -lkabc
-kdeprintfax_METASOURCES = AUTO
+kdeprintfax_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdeprintfax_la_LIBADD  = $(LIB_KDEUI) $(LIB_KIO) $(LIB_KDEPRINT) -lkabc
+kdeprintfax_la_METASOURCES = AUTO
 
 xdg_apps_DATA = kdeprintfax.desktop
 
diff -u -ruN kdebase-3.4.1.orig/kdeprint/kdeprintfax/main.cpp kdebase-3.4.1/kdeprint/kdeprintfax/main.cpp
--- kdebase-3.4.1.orig/kdeprint/kdeprintfax/main.cpp	2005-09-01 16:58:53.000000000 -0700
+++ kdebase-3.4.1/kdeprint/kdeprintfax/main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -44,7 +44,7 @@
   // INSERT YOUR COMMANDLINE OPTIONS HERE
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 
   KAboutData aboutData( "kdeprintfax", I18N_NOOP("KdeprintFax"),
diff -u -ruN kdebase-3.4.1.orig/kdeprint/kprinter/printwrapper.cpp kdebase-3.4.1/kdeprint/kprinter/printwrapper.cpp
--- kdebase-3.4.1.orig/kdeprint/kprinter/printwrapper.cpp	2005-09-01 16:58:53.000000000 -0700
+++ kdebase-3.4.1/kdeprint/kprinter/printwrapper.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -137,10 +137,6 @@
 {
 	KCmdLineArgs	*args = KCmdLineArgs::parsedArgs();
 
-#if defined(HAVE_SIGACTION) && !defined(HAVE_SIGSET)
-	struct sigaction action;
-#endif /* HAVE_SIGACTION && !HAVE_SIGSET*/
-
 	// read variables from command line
 	QString	printer = args->getOption("d");
 	QString	title = args->getOption("t");
@@ -325,6 +321,10 @@
 
 		// print from stdin
 
+#if defined(HAVE_SIGACTION) && !defined(HAVE_SIGSET)
+	struct sigaction action;
+#endif /* HAVE_SIGACTION && !HAVE_SIGSET*/
+
 #  if defined(HAVE_SIGSET)
 		sigset(SIGHUP, signal_handler);
 		sigset(SIGINT, signal_handler);
diff -u -ruN kdebase-3.4.1.orig/kdesktop/Makefile.am kdebase-3.4.1/kdesktop/Makefile.am
--- kdebase-3.4.1.orig/kdesktop/Makefile.am	2005-09-01 16:58:55.000000000 -0700
+++ kdebase-3.4.1/kdesktop/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -8,10 +8,10 @@
 
 ####### Files
 
-bin_PROGRAMS = kcheckrunning
+bin_PROGRAMS = 
 lib_LTLIBRARIES =
 bin_SCRIPTS = kdeeject
-kdeinit_LTLIBRARIES = kdesktop.la
+kdeinit_LTLIBRARIES = kdesktop.la kcheckrunning.la
 noinst_LTLIBRARIES = libkdesktopsettings.la
 
 libkdesktopsettings_la_LDFLAGS = $(all_libraries) -no-undefined
@@ -32,9 +32,9 @@
 	xautolock.h lockeng.h init.h minicli.h \
 	pixmapserver.h startupid.h xautolock_c.h
 
-kcheckrunning_SOURCES = kcheckrunning.cpp
-kcheckrunning_LDFLAGS = $(all_libraries)
-kcheckrunning_LDADD = $(LIB_X11)
+kcheckrunning_la_SOURCES = kcheckrunning.cpp
+kcheckrunning_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kcheckrunning_la_LIBADD = $(LIB_X11)
 
 METASOURCES = AUTO
 
diff -u -ruN kdebase-3.4.1.orig/kdesktop/init.h kdebase-3.4.1/kdesktop/init.h
--- kdebase-3.4.1.orig/kdesktop/init.h	2005-09-01 16:58:55.000000000 -0700
+++ kdebase-3.4.1/kdesktop/init.h	2005-09-01 17:03:14.000000000 -0700
@@ -27,4 +27,18 @@
  */
 void testLocalInstallation();
 
+typedef struct fileinfobuf {
+   u_int32_t info_length;
+   union {
+     struct {
+       u_int32_t type;
+       u_int32_t creator;
+       u_int16_t fdFlags;
+       u_int16_t location;
+       u_int32_t padding[4];
+     } finder;
+     off_t rsrcForkSize;
+   } data;
+} fileinfobuf;
+
 #endif
diff -u -ruN kdebase-3.4.1.orig/kdesktop/kcheckrunning.cpp kdebase-3.4.1/kdesktop/kcheckrunning.cpp
--- kdebase-3.4.1.orig/kdesktop/kcheckrunning.cpp	2005-09-01 16:58:55.000000000 -0700
+++ kdebase-3.4.1/kdesktop/kcheckrunning.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -19,7 +19,7 @@
 
 #include <X11/Xlib.h>
 
-int main()
+extern "C" int kdemain()
     {
     Display* dpy = XOpenDisplay( NULL );
     if( dpy == NULL )
diff -u -ruN kdebase-3.4.1.orig/kdesktop/kwebdesktop/Makefile.am kdebase-3.4.1/kdesktop/kwebdesktop/Makefile.am
--- kdebase-3.4.1.orig/kdesktop/kwebdesktop/Makefile.am	2005-09-01 16:58:55.000000000 -0700
+++ kdebase-3.4.1/kdesktop/kwebdesktop/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -2,12 +2,15 @@
 INCLUDES= $(all_includes)
 LDADD = $(LIB_KHTML)
 
-bin_PROGRAMS = 	kwebdesktop
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kwebdesktop.la
 
 METASOURCES = AUTO
 
-kwebdesktop_SOURCES = kwebdesktop.cpp kwebdesktopsettings.kcfgc 
-kwebdesktop_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwebdesktop_la_SOURCES = kwebdesktop.cpp kwebdesktopsettings.kcfgc 
+kwebdesktop_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kwebdesktop_la_LIBADD  = $(LIB_KHTML)
 
 kdesktop_kwebdesktop_data_DATA = kwebdesktop.desktop
 kdesktop_kwebdesktop_datadir = $(kde_datadir)/kdesktop/programs
diff -u -ruN kdebase-3.4.1.orig/kdesktop/kwebdesktop/kwebdesktop.cpp kdebase-3.4.1/kdesktop/kwebdesktop/kwebdesktop.cpp
--- kdebase-3.4.1.orig/kdesktop/kwebdesktop/kwebdesktop.cpp	2005-09-01 16:58:55.000000000 -0700
+++ kdebase-3.4.1/kdesktop/kwebdesktop/kwebdesktop.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -84,7 +84,7 @@
 }
 
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     KAboutData data( "kwebdesktop", I18N_NOOP("KDE Web Desktop"),
                      VERSION,
diff -u -ruN kdebase-3.4.1.orig/kdesktop/lock/Makefile.am kdebase-3.4.1/kdesktop/lock/Makefile.am
--- kdebase-3.4.1.orig/kdesktop/lock/Makefile.am	2005-09-01 16:58:54.000000000 -0700
+++ kdebase-3.4.1/kdesktop/lock/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,14 +1,16 @@
 ## Makefile.am of kdebase/kdesktop/lock
 
 INCLUDES = -I.. -I$(top_srcdir)/kcheckpass -I$(top_srcdir)/kdmlib $(all_includes)
-kdesktop_lock_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kdesktop_lock_LDADD    = ../libkdesktopsettings.la ../../kdmlib/libdmctl.la $(LIB_KIO) $(LIB_XF86MISC)
+kdesktop_lock_la_LDFLAGS  = $(all_libraries) $(KDE_PLUGIN) -module
+kdesktop_lock_la_LIBADD   = ../libkdesktopsettings.la ../../kdmlib/libdmctl.la $(LIB_KIO) $(LIB_XF86MISC)
 
 ####### Files
 
-bin_PROGRAMS = kdesktop_lock
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdesktop_lock.la
 
-kdesktop_lock_SOURCES = lockprocess.cc lockdlg.cc autologout.cc main.cc
+kdesktop_lock_la_SOURCES = lockprocess.cc lockdlg.cc autologout.cc main.cc
 
 noinst_HEADERS = lockprocess.h lockdlg.h autologout.h main.h
 
diff -u -ruN kdebase-3.4.1.orig/kdesktop/lock/main.cc kdebase-3.4.1/kdesktop/lock/main.cc
--- kdebase-3.4.1.orig/kdesktop/lock/main.cc	2005-09-01 16:58:54.000000000 -0700
+++ kdebase-3.4.1/kdesktop/lock/main.cc	2005-09-01 17:03:14.000000000 -0700
@@ -58,7 +58,7 @@
 
 // -----------------------------------------------------------------------------
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     KLocale::setMainCatalogue("kdesktop");
 
diff -u -ruN kdebase-3.4.1.orig/kdesu/kdesu/Makefile.am kdebase-3.4.1/kdesu/kdesu/Makefile.am
--- kdebase-3.4.1.orig/kdesu/kdesu/Makefile.am	2005-09-01 16:58:56.000000000 -0700
+++ kdebase-3.4.1/kdesu/kdesu/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -3,11 +3,14 @@
 INCLUDES= $(all_includes)
 
 ## kdesu
-bin_PROGRAMS = 	kdesu
-kdesu_SOURCES = kdesu.cpp sudlg.cpp
-kdesu_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdesu_LDADD   = $(LIB_KIO) -lkdesu
-kdesu_METASOURCES =  AUTO
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdesu.la
+
+kdesu_la_SOURCES = kdesu.cpp sudlg.cpp
+kdesu_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdesu_la_LIBADD  = $(LIB_KIO) -lkdesu
+kdesu_la_METASOURCES =  AUTO
 noinst_HEADERS = sudlg.h
 
 ## Messages
diff -u -ruN kdebase-3.4.1.orig/kdesu/kdesu/kdesu.cpp kdebase-3.4.1/kdesu/kdesu/kdesu.cpp
--- kdebase-3.4.1.orig/kdesu/kdesu/kdesu.cpp	2005-09-01 16:58:56.000000000 -0700
+++ kdebase-3.4.1/kdesu/kdesu/kdesu.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -85,7 +85,7 @@
 
 static int startApp();
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
     // FIXME: this can be considered a poor man's solution, as it's not
     // directly obvious to a gui user. :)
diff -u -ruN kdebase-3.4.1.orig/kdesu/kdesud/Makefile.am kdebase-3.4.1/kdesu/kdesud/Makefile.am
--- kdebase-3.4.1.orig/kdesu/kdesud/Makefile.am	2005-09-01 16:58:56.000000000 -0700
+++ kdebase-3.4.1/kdesu/kdesud/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -2,10 +2,13 @@
 
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kdesud
-kdesud_SOURCES = kdesud.cpp repo.cpp lexer.cpp handler.cpp secure.cpp 
-kdesud_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kdesud_LDADD = $(LIB_KDECORE) -lkdesu $(LIBSOCKET)
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdesud.la
+
+kdesud_la_SOURCES = kdesud.cpp repo.cpp lexer.cpp handler.cpp secure.cpp 
+kdesud_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kdesud_la_LIBADD = $(LIB_KDECORE) -lkdesu $(LIBSOCKET)
 noinst_HEADERS = repo.h handler.h lexer.h secure.h
 
 ## kdesud needs to be suid or sgid something
diff -u -ruN kdebase-3.4.1.orig/kdesu/kdesud/kdesud.cpp kdebase-3.4.1/kdesu/kdesud/kdesud.cpp
--- kdebase-3.4.1.orig/kdesu/kdesud/kdesud.cpp	2005-09-01 16:58:56.000000000 -0700
+++ kdebase-3.4.1/kdesu/kdesud/kdesud.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -245,7 +245,7 @@
  * Main program
  */
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
     KAboutData aboutData("kdesud", I18N_NOOP("KDE su daemon"),
             Version, I18N_NOOP("Daemon used by kdesu"),
diff -u -ruN kdebase-3.4.1.orig/kdialog/Makefile.am kdebase-3.4.1/kdialog/Makefile.am
--- kdebase-3.4.1.orig/kdialog/Makefile.am	2005-09-01 16:58:57.000000000 -0700
+++ kdebase-3.4.1/kdialog/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,11 +1,13 @@
 KDE_CXXFLAGS = -DQT_NO_CAST_ASCII -DQT_NO_ASCII_CAST
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kdialog
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kdialog.la
 
-kdialog_SOURCES = kdialog.cpp widgets.cpp klistboxdialog.cpp progressdialog.cpp progressdialogiface.skel
-kdialog_LDADD = $(LIB_KIO)
-kdialog_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kdialog_la_SOURCES = kdialog.cpp widgets.cpp klistboxdialog.cpp progressdialog.cpp progressdialogiface.skel
+kdialog_la_LIBADD = $(LIB_KIO)
+kdialog_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
 
diff -u -ruN kdebase-3.4.1.orig/kdialog/kdialog.cpp kdebase-3.4.1/kdialog/kdialog.cpp
--- kdebase-3.4.1.orig/kdialog/kdialog.cpp	2005-09-01 16:58:57.000000000 -0700
+++ kdebase-3.4.1/kdialog/kdialog.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -570,7 +570,7 @@
 }
 
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
   KAboutData aboutData( "kdialog", I18N_NOOP("KDialog"),
                         "1.0", I18N_NOOP( "KDialog can be used to show nice dialog boxes from shell scripts" ),
diff -u -ruN kdebase-3.4.1.orig/kfind/Makefile.am kdebase-3.4.1/kfind/Makefile.am
--- kdebase-3.4.1.orig/kfind/Makefile.am	2005-09-01 16:58:58.000000000 -0700
+++ kdebase-3.4.1/kfind/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -28,9 +28,12 @@
 
 #And this is for kfind
 
-bin_PROGRAMS = kfind
-kfind_SOURCES = kfwin.cpp kfinddlg.cpp main.cpp 
-kfind_LDADD   =  libkfind_common.la $(LIB_KPARTS)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kfind.la
+
+kfind_la_SOURCES = kfwin.cpp kfinddlg.cpp main.cpp 
+kfind_la_LIBADD  =  libkfind_common.la $(LIB_KPARTS)
 
 # the library search path.
-kfind_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kfind_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
diff -u -ruN kdebase-3.4.1.orig/kfind/main.cpp kdebase-3.4.1/kfind/main.cpp
--- kdebase-3.4.1.orig/kfind/main.cpp	2005-09-01 16:58:58.000000000 -0700
+++ kdebase-3.4.1/kfind/main.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -19,7 +19,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char ** argv )
+extern "C" int kdemain( int argc, char ** argv )
 {
   KLocale::setMainCatalogue("kfindpart");
   KAboutData aboutData( "kfind", I18N_NOOP("KFind"),
diff -u -ruN kdebase-3.4.1.orig/khelpcenter/Makefile.am kdebase-3.4.1/khelpcenter/Makefile.am
--- kdebase-3.4.1.orig/khelpcenter/Makefile.am	2005-09-01 16:58:59.000000000 -0700
+++ kdebase-3.4.1/khelpcenter/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -3,14 +3,14 @@
 INCLUDES = $(all_includes)
 METASOURCES = AUTO
 
-bin_PROGRAMS = khc_indexbuilder
+bin_PROGRAMS = 
 lib_LTLIBRARIES = 
 
-khc_indexbuilder_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-khc_indexbuilder_LDADD = $(LIB_KDECORE)
-khc_indexbuilder_SOURCES = khc_indexbuilder.cpp
+khc_indexbuilder_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+khc_indexbuilder_la_LIBADD = $(LIB_KDECORE)
+khc_indexbuilder_la_SOURCES = khc_indexbuilder.cpp
 
-kdeinit_LTLIBRARIES = khelpcenter.la
+kdeinit_LTLIBRARIES = khelpcenter.la khc_indexbuilder.la
 
 khelpcenter_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN)
 khelpcenter_la_LIBADD = $(LIB_KHTML)
diff -u -ruN kdebase-3.4.1.orig/khelpcenter/htmlsearch/Makefile.am kdebase-3.4.1/khelpcenter/htmlsearch/Makefile.am
--- kdebase-3.4.1.orig/khelpcenter/htmlsearch/Makefile.am	2005-09-01 16:58:58.000000000 -0700
+++ kdebase-3.4.1/khelpcenter/htmlsearch/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -21,14 +21,15 @@
 
 xdg_apps_DATA = htmlsearch.desktop
 
-bin_PROGRAMS = khtmlindex
+bin_PROGRAMS = 
+kdeinit_LTLIBRARIES = khtmlindex.la
 
 wrapperdir = $(kde_datadir)/khelpcenter/
 wrapper_SCRIPTS = meinproc_wrapper
 
-khtmlindex_SOURCES = index.cpp
-khtmlindex_LDFLAGS = $(KDE_RPATH) $(all_libraries)
-khtmlindex_LDADD = libhtmlsearch.la $(LIB_KDEUI)
+khtmlindex_la_SOURCES = index.cpp
+khtmlindex_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
+khtmlindex_la_LIBADD = libhtmlsearch.la $(LIB_KDEUI)
 
 xpm_DATA = unchecked.xpm checked.xpm
 xpmdir = $(kde_datadir)/khelpcenter/pics
diff -u -ruN kdebase-3.4.1.orig/khelpcenter/htmlsearch/index.cpp kdebase-3.4.1/khelpcenter/htmlsearch/index.cpp
--- kdebase-3.4.1.orig/khelpcenter/htmlsearch/index.cpp	2005-09-01 16:58:58.000000000 -0700
+++ kdebase-3.4.1/khelpcenter/htmlsearch/index.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -13,7 +13,7 @@
 };
 
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
   KAboutData aboutData( "khtmlindex", I18N_NOOP("KHtmlIndex"),
 	"",
diff -u -ruN kdebase-3.4.1.orig/khelpcenter/khc_indexbuilder.cpp kdebase-3.4.1/khelpcenter/khc_indexbuilder.cpp
--- kdebase-3.4.1.orig/khelpcenter/khc_indexbuilder.cpp	2005-09-01 16:58:59.000000000 -0700
+++ kdebase-3.4.1/khelpcenter/khc_indexbuilder.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -163,7 +163,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
   KAboutData aboutData( "khc_indexbuilder",
                         I18N_NOOP("KHelpCenter Index Builder"),
diff -u -ruN kdebase-3.4.1.orig/kicker/extensions/kasbar/Makefile.am kdebase-3.4.1/kicker/extensions/kasbar/Makefile.am
--- kdebase-3.4.1.orig/kicker/extensions/kasbar/Makefile.am	2005-09-01 16:59:04.000000000 -0700
+++ kdebase-3.4.1/kicker/extensions/kasbar/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -35,10 +35,12 @@
 
 EXTRA_DIST = $(lnk_DATA)
 
-bin_PROGRAMS = kasbar
-kasbar_SOURCES = kasbarapp.cpp
-kasbar_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kasbar_LDADD = 	libkasbar.la \
+bin_PROGRAMS = 
+kdeinit_LTLIBRARIES = kasbar.la
+
+kasbar_la_SOURCES = kasbarapp.cpp
+kasbar_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kasbar_la_LIBADD = 	libkasbar.la \
 		$(LIB_QT) $(LIB_KDECORE) $(LIB_KDEUI)
 
 
diff -u -ruN kdebase-3.4.1.orig/kicker/extensions/kasbar/kasbarapp.cpp kdebase-3.4.1/kicker/extensions/kasbar/kasbarapp.cpp
--- kdebase-3.4.1.orig/kicker/extensions/kasbar/kasbarapp.cpp	2005-09-01 16:59:04.000000000 -0700
+++ kdebase-3.4.1/kicker/extensions/kasbar/kasbarapp.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -73,7 +73,7 @@
    KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
   KCmdLineArgs::init( argc, argv, "kasbar", "KasBar", I18N_NOOP( "An alternative task manager" ), VERSION_STRING );
   KCmdLineArgs::addCmdLineOptions( options );
diff -u -ruN kdebase-3.4.1.orig/kioslave/info/kde-info2html.conf kdebase-3.4.1/kioslave/info/kde-info2html.conf
--- kdebase-3.4.1.orig/kioslave/info/kde-info2html.conf	2005-09-01 16:59:05.000000000 -0700
+++ kdebase-3.4.1/kioslave/info/kde-info2html.conf	2005-09-01 17:03:14.000000000 -0700
@@ -25,6 +25,7 @@
 
 #-- location of info files.
 our @INFODIR = (
+	    "@FINKPREFIX@/share/info",
 	    "/usr/share/info",
 	    "/usr/info",
 	    "/usr/lib/info",
diff -u -ruN kdebase-3.4.1.orig/kioslave/man/kio_man.cpp kdebase-3.4.1/kioslave/man/kio_man.cpp
--- kdebase-3.4.1.orig/kioslave/man/kio_man.cpp	2005-09-01 16:59:06.000000000 -0700
+++ kdebase-3.4.1/kioslave/man/kio_man.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -50,7 +50,7 @@
 
 MANProtocol *MANProtocol::_self = 0;
 
-#define SGML2ROFF_DIRS "/usr/lib/sgml"
+#define SGML2ROFF_DIRS "@FINKPREFIX@/share/sgml"
 
 /*
  * Drop trailing ".section[.gz]" from name
@@ -862,6 +862,7 @@
                         "/usr/sunpc/man",
                         "/usr/ncd/man",
                         "/usr/newsprint/man",
+                        "@FINKPREFIX@/share/man",
                         NULL };
 
 
diff -u -ruN kdebase-3.4.1.orig/kioslave/media/mounthelper/Makefile.am kdebase-3.4.1/kioslave/media/mounthelper/Makefile.am
--- kdebase-3.4.1.orig/kioslave/media/mounthelper/Makefile.am	2005-09-01 16:59:06.000000000 -0700
+++ kdebase-3.4.1/kioslave/media/mounthelper/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,12 +1,14 @@
-bin_PROGRAMS = kio_media_mounthelper
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kio_media_mounthelper.la
 
 INCLUDES = $(all_includes) -I$(srcdir)/../libmediacommon
 AM_LDFLAGS = $(all_libraries)
 
-kio_media_mounthelper_SOURCES = kio_media_mounthelper.cpp
+kio_media_mounthelper_la_SOURCES = kio_media_mounthelper.cpp
 
-kio_media_mounthelper_LDFLAGS = $(KDE_RPATH) $(LIB_KDECORE) $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_KIO) $(all_libraries)
-kio_media_mounthelper_LDADD = ../libmediacommon/libmediacommon.la
+kio_media_mounthelper_la_LDFLAGS = $(KDE_PLUGIN) $(all_libraries) -module
+kio_media_mounthelper_la_LIBADD = ../libmediacommon/libmediacommon.la $(LIB_KDECORE) $(LIB_KDEUI) $(LIB_KSYCOCA) $(LIB_KIO)
 
 METASOURCES = AUTO
 
diff -u -ruN kdebase-3.4.1.orig/kioslave/media/mounthelper/kio_media_mounthelper.cpp kdebase-3.4.1/kioslave/media/mounthelper/kio_media_mounthelper.cpp
--- kdebase-3.4.1.orig/kioslave/media/mounthelper/kio_media_mounthelper.cpp	2005-09-01 16:59:06.000000000 -0700
+++ kdebase-3.4.1/kioslave/media/mounthelper/kio_media_mounthelper.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -170,7 +170,7 @@
 };
 
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
 	KCmdLineArgs::init(argc, argv, "kio_media_mounthelper",
 	                   "kio_media_mounthelper", "kio_media_mounthelper",
diff -u -ruN kdebase-3.4.1.orig/kioslave/trash/Makefile.am kdebase-3.4.1/kioslave/trash/Makefile.am
--- kdebase-3.4.1.orig/kioslave/trash/Makefile.am	2005-09-01 16:59:07.000000000 -0700
+++ kdebase-3.4.1/kioslave/trash/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -9,10 +9,13 @@
 kio_trash_la_LIBADD  = libtrashcommon.la $(LIB_KIO)
 kio_trash_la_LDFLAGS = $(all_libraries) -module $(KDE_PLUGIN) -no-undefined
 
-bin_PROGRAMS = ktrash
-ktrash_SOURCES = ktrash.cpp
-ktrash_LDADD = $(LIB_KIO)
-ktrash_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ktrash.la
+
+ktrash_la_SOURCES = ktrash.cpp
+ktrash_la_LIBADD = $(LIB_KIO)
+ktrash_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 kde_services_DATA = trash.protocol
 
diff -u -ruN kdebase-3.4.1.orig/kioslave/trash/ktrash.cpp kdebase-3.4.1/kioslave/trash/ktrash.cpp
--- kdebase-3.4.1.orig/kioslave/trash/ktrash.cpp	2005-09-01 16:59:07.000000000 -0700
+++ kdebase-3.4.1/kioslave/trash/ktrash.cpp	2005-09-01 17:03:14.000000000 -0700
@@ -35,7 +35,7 @@
     KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
     KApplication::disableAutoDcopRegistration();
     KCmdLineArgs::init( argc, argv, "ktrash",
diff -u -ruN kdebase-3.4.1.orig/knetattach/Makefile.am kdebase-3.4.1/knetattach/Makefile.am
--- kdebase-3.4.1.orig/knetattach/Makefile.am	2005-09-01 16:59:08.000000000 -0700
+++ kdebase-3.4.1/knetattach/Makefile.am	2005-09-01 17:03:14.000000000 -0700
@@ -1,9 +1,12 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = knetattach
-knetattach_SOURCES = knetattach.ui main.cpp
-knetattach_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-knetattach_LDADD   = $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = knetattach.la
+
+knetattach_la_SOURCES = knetattach.ui main.cpp
+knetattach_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+knetattach_la_LIBADD  = $(LIB_KIO)
 METASOURCES = AUTO
 xdg_apps_DATA = knetattach.desktop
 KDE_ICON = AUTO
diff -u -ruN kdebase-3.4.1.orig/knetattach/main.cpp kdebase-3.4.1/knetattach/main.cpp
--- kdebase-3.4.1.orig/knetattach/main.cpp	2005-09-01 16:59:08.000000000 -0700
+++ kdebase-3.4.1/knetattach/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -25,7 +25,7 @@
 
 #include "knetattach.h"
 
-int main(int argc, char **argv) {
+extern "C" int kdemain(int argc, char **argv) {
 	KAboutData about("knetattach", I18N_NOOP("KDE Network Wizard"), "1.0",
 		I18N_NOOP("KDE Network Wizard"),
 		KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/konqueror/keditbookmarks/Makefile.am kdebase-3.4.1/konqueror/keditbookmarks/Makefile.am
--- kdebase-3.4.1.orig/konqueror/keditbookmarks/Makefile.am	2005-09-01 16:59:08.000000000 -0700
+++ kdebase-3.4.1/konqueror/keditbookmarks/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -2,13 +2,13 @@
 
 METASOURCES = AUTO
 
-bin_PROGRAMS = kbookmarkmerger
+bin_PROGRAMS = 
 lib_LTLIBRARIES =
-kdeinit_LTLIBRARIES = keditbookmarks.la
+kdeinit_LTLIBRARIES = keditbookmarks.la kbookmarkmerger.la
 
-kbookmarkmerger_SOURCES = kbookmarkmerger.cpp
-kbookmarkmerger_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-kbookmarkmerger_LDADD = $(LIB_KIO)
+kbookmarkmerger_la_SOURCES = kbookmarkmerger.cpp
+kbookmarkmerger_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kbookmarkmerger_la_LIBADD = $(LIB_KIO)
 
 dcop_DCOPIDLNG = true
 keditbookmarks_la_SOURCES = main.cpp listview.cpp toplevel.cpp actionsimpl.cpp commands.cpp importers.cpp dcop.skel dcop.cpp bookmarkiterator.cpp  \
diff -u -ruN kdebase-3.4.1.orig/konqueror/keditbookmarks/kbookmarkmerger.cpp kdebase-3.4.1/konqueror/keditbookmarks/kbookmarkmerger.cpp
--- kdebase-3.4.1.orig/konqueror/keditbookmarks/kbookmarkmerger.cpp	2005-09-01 16:59:08.000000000 -0700
+++ kdebase-3.4.1/konqueror/keditbookmarks/kbookmarkmerger.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -55,7 +55,7 @@
 	return XGetSelectionOwner( dpy, atom ) != None;
 }
 
-int main( int argc, char**argv )
+extern "C" int kdemain( int argc, char**argv )
 {
 	const bool kdeRunning = kdeIsRunning();
 
diff -u -ruN kdebase-3.4.1.orig/kpager/Makefile.am kdebase-3.4.1/kpager/Makefile.am
--- kdebase-3.4.1.orig/kpager/Makefile.am	2005-09-01 16:59:12.000000000 -0700
+++ kdebase-3.4.1/kpager/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,14 +1,16 @@
 INCLUDES= $(all_includes)
 
-bin_PROGRAMS = kpager
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kpager.la
 
-kpager_SOURCES = desktop.cpp kpager.cpp config.cpp windowdrag.cpp \
+kpager_la_SOURCES = desktop.cpp kpager.cpp config.cpp windowdrag.cpp \
 	kpagerIface.skel main.cpp  
 
-kpager_METASOURCES = AUTO
-kpager_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kpager_la_METASOURCES = AUTO
+kpager_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
-kpager_LDADD = $(LIB_KDEUI)
+kpager_la_LIBADD = $(LIB_KDEUI)
 
 KDE_ICON = kpager
 
diff -u -ruN kdebase-3.4.1.orig/kpager/main.cpp kdebase-3.4.1/kpager/main.cpp
--- kdebase-3.4.1.orig/kpager/main.cpp	2005-09-01 16:59:12.000000000 -0700
+++ kdebase-3.4.1/kpager/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -62,7 +62,7 @@
 
 };
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KAboutData *aboutdata = new KAboutData("kpager", "KPager", "1.5",
 					   I18N_NOOP("Desktop Overview"), KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/kpersonalizer/Makefile.am kdebase-3.4.1/kpersonalizer/Makefile.am
--- kdebase-3.4.1.orig/kpersonalizer/Makefile.am	2005-09-01 16:59:13.000000000 -0700
+++ kdebase-3.4.1/kpersonalizer/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,11 +1,14 @@
-bin_PROGRAMS = kpersonalizer
-kpersonalizer_SOURCES = stylepreview.ui krefinepage.cpp \
+bin_PROGRAMS =
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kpersonalizer.la
+
+kpersonalizer_la_SOURCES = stylepreview.ui krefinepage.cpp \
       kstylepage.cpp keyecandypage.cpp kospage.cpp kcountrypage.cpp kpersonalizer.cpp \
       main.cpp kfindlanguage.cpp \
       kcountrypagedlg.ui kospagedlg.ui keyecandypagedlg.ui kstylepagedlg.ui \
       krefinepagedlg.ui  ksysinfo.cpp
 
-kpersonalizer_LDADD   = $(LIB_KIO) 
+kpersonalizer_la_LIBADD  = $(LIB_KIO) 
 
 EXTRA_DIST = main.cpp kpersonalizer.cpp kpersonalizer.h kpersonalizer.desktop kcountrypage.cpp kcountrypage.h kospage.cpp kospage.h keyecandypage.cpp keyecandypage.h kstylepage.cpp kstylepage.h krefinepage.cpp krefinepage.h cr16-app-kpersonalizer.png cr32-app-kpersonalizer.png README kcountrypagedlg.ui kospage.ui keyecandypagedlg.ui kstylepagedlg.ui krefinepagedlg.ui kfindlanguage.cpp kfindlanguage.h
 
@@ -38,7 +41,7 @@
 
 KDE_ICON= AUTO
 # the library search path. 
-kpersonalizer_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kpersonalizer_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # Uncomment the following two lines if you add a ui.rc file for your application to make use of
 # KDE´s XML GUI builing
diff -u -ruN kdebase-3.4.1.orig/kpersonalizer/main.cpp kdebase-3.4.1/kpersonalizer/main.cpp
--- kdebase-3.4.1.orig/kpersonalizer/main.cpp	2005-09-01 16:59:13.000000000 -0700
+++ kdebase-3.4.1/kpersonalizer/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -33,7 +33,7 @@
         KCmdLineLastOption
 };
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 	KAboutData aboutData( "kpersonalizer", I18N_NOOP("KPersonalizer"),
 		VERSION, description, KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/kreadconfig/Makefile.am kdebase-3.4.1/kreadconfig/Makefile.am
--- kdebase-3.4.1.orig/kreadconfig/Makefile.am	2005-09-01 16:59:13.000000000 -0700
+++ kdebase-3.4.1/kreadconfig/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,12 +1,17 @@
 AM_CPPFLAGS = -DQT_NO_CAST_ASCII 
 
 INCLUDES = $(all_includes)
-AM_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-LDADD   =       $(LIB_KDECORE)
 
-bin_PROGRAMS	= kreadconfig kwriteconfig
-kreadconfig_SOURCES	= kreadconfig.cpp
-kwriteconfig_SOURCES	= kwriteconfig.cpp
+bin_PROGRAMS	= 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kreadconfig.la kwriteconfig.la
+kreadconfig_la_SOURCES = kreadconfig.cpp
+kreadconfig_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kreadconfig_la_LIBADD  = $(LIB_KDECORE)
+
+kwriteconfig_la_SOURCES	= kwriteconfig.cpp
+kwriteconfig_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+kwriteconfig_la_LIBADD  = $(LIB_KDECORE)
 
 messages:
 	$(XGETTEXT) $(kreadconfig_SOURCES) -o $(podir)/kreadconfig.pot
diff -u -ruN kdebase-3.4.1.orig/kreadconfig/kreadconfig.cpp kdebase-3.4.1/kreadconfig/kreadconfig.cpp
--- kdebase-3.4.1.orig/kreadconfig/kreadconfig.cpp	2005-09-01 16:59:13.000000000 -0700
+++ kdebase-3.4.1/kreadconfig/kreadconfig.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -41,7 +41,7 @@
 	{ "type <type>", I18N_NOOP("Type of variable"), 0 },
         KCmdLineLastOption
 };
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
 	KAboutData aboutData("kreadconfig", I18N_NOOP("KReadConfig"),
 		"1.0.1",
diff -u -ruN kdebase-3.4.1.orig/kreadconfig/kwriteconfig.cpp kdebase-3.4.1/kreadconfig/kwriteconfig.cpp
--- kdebase-3.4.1.orig/kreadconfig/kwriteconfig.cpp	2005-09-01 16:59:13.000000000 -0700
+++ kdebase-3.4.1/kreadconfig/kwriteconfig.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -23,7 +23,7 @@
 	{ "+value", I18N_NOOP( "The value to write. Mandatory, on a shell use '' for empty" ), 0 },
         KCmdLineLastOption
 };
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
 	KAboutData aboutData("kwriteconfig", I18N_NOOP("KWriteConfig"),
 		"1.0.0",
diff -u -ruN kdebase-3.4.1.orig/ksplashml/Makefile.am kdebase-3.4.1/ksplashml/Makefile.am
--- kdebase-3.4.1.orig/ksplashml/Makefile.am	2005-09-01 16:58:18.000000000 -0700
+++ kdebase-3.4.1/ksplashml/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -4,10 +4,13 @@
 
 METASOURCES=AUTO
 
-bin_PROGRAMS = ksplash
-ksplash_SOURCES = wndmain.cpp ksplashiface.skel main.cpp
-ksplash_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksplash_LDADD = $(LIB_KDEUI) themeengine/default/libthemedefault.la themeengine/libksplashthemes.la $(LIB_KIO)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksplash.la
+
+ksplash_la_SOURCES = wndmain.cpp ksplashiface.skel main.cpp
+ksplash_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksplash_la_LIBADD = $(LIB_KDEUI) themeengine/default/libthemedefault.la themeengine/libksplashthemes.la $(LIB_KIO)
 
 noinst_HEADERS = ksplashiface.h wndmain.h
 
diff -u -ruN kdebase-3.4.1.orig/ksplashml/main.cpp kdebase-3.4.1/ksplashml/main.cpp
--- kdebase-3.4.1.orig/ksplashml/main.cpp	2005-09-01 16:58:18.000000000 -0700
+++ kdebase-3.4.1/ksplashml/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -37,7 +37,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
   KAboutData about(
     "ksplash",
diff -u -ruN kdebase-3.4.1.orig/ksplashml/themeengine/simple/Makefile.am kdebase-3.4.1/ksplashml/themeengine/simple/Makefile.am
--- kdebase-3.4.1.orig/ksplashml/themeengine/simple/Makefile.am	2005-09-01 16:58:17.000000000 -0700
+++ kdebase-3.4.1/ksplashml/themeengine/simple/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,7 +1,10 @@
 
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = ksplashsimple
-ksplashsimple_SOURCES = main.cpp
-ksplashsimple_LDFLAGS = $(all_libraries) $(KDE_RPATH)
-ksplashsimple_LDADD = $(LIB_XINERAMA) $(LIB_X11)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksplashsimple.la
+
+ksplashsimple_la_SOURCES = main.cpp
+ksplashsimple_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksplashsimple_la_LIBADD = $(LIB_XINERAMA) $(LIB_X11)
diff -u -ruN kdebase-3.4.1.orig/ksplashml/themeengine/simple/main.cpp kdebase-3.4.1/ksplashml/themeengine/simple/main.cpp
--- kdebase-3.4.1.orig/ksplashml/themeengine/simple/main.cpp	2005-09-01 16:58:17.000000000 -0700
+++ kdebase-3.4.1/ksplashml/themeengine/simple/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -34,7 +34,7 @@
 
 //#define DEBUG
 
-int main( int argc, char* argv[])
+extern "C" int kdemain( int argc, char* argv[])
     {
     if( fork() != 0 )
         return 0;
diff -u -ruN kdebase-3.4.1.orig/kstart/Makefile.am kdebase-3.4.1/kstart/Makefile.am
--- kdebase-3.4.1.orig/kstart/Makefile.am	2005-09-01 16:58:18.000000000 -0700
+++ kdebase-3.4.1/kstart/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -6,10 +6,13 @@
 
 #######	Files
 
-bin_PROGRAMS	= kstart
-kstart_SOURCES	= kstart.cpp
-kstart_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
-kstart_LDADD    = $(LIB_KDECORE)
+bin_PROGRAMS	= 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kstart.la
+
+kstart_la_SOURCES	= kstart.cpp
+kstart_la_LDFLAGS  = $(all_libraries) $(KDE_PLUGIN) -module
+kstart_la_LIBADD   = $(LIB_KDECORE)
 METASOURCES =	kstart.moc 
 
 noinst_HEADERS = kstart.h version.h
diff -u -ruN kdebase-3.4.1.orig/kstart/kstart.cpp kdebase-3.4.1/kstart/kstart.cpp
--- kdebase-3.4.1.orig/kstart/kstart.cpp	2005-09-01 16:58:18.000000000 -0700
+++ kdebase-3.4.1/kstart/kstart.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -283,7 +283,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" int kdemain( int argc, char *argv[] )
 {
   // David, 05/03/2000
   KAboutData aboutData( "kstart", I18N_NOOP("KStart"), KSTART_VERSION,
diff -u -ruN kdebase-3.4.1.orig/ksysguard/gui/Makefile.am kdebase-3.4.1/ksysguard/gui/Makefile.am
--- kdebase-3.4.1.orig/ksysguard/gui/Makefile.am	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ksysguard/gui/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -18,21 +18,23 @@
  
 ####### This part is very ksysguard specific
 # you can add here more. This one gets installed 
-bin_PROGRAMS = ksysguard kpm
+bin_PROGRAMS = kpm
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksysguard.la
 
 # Which sources should be compiled for ksysguard.
-ksysguard_SOURCES = \
+ksysguard_la_SOURCES = \
 	SensorBrowser.cc \
 	WorkSheet.cc \
 	WorkSheetSettings.cc \
 	Workspace.cc \
 	ksysguard.cc ksysguard.skel
 
-ksysguard_LDADD = \
+ksysguard_la_LIBADD = \
 	ksgrd/libksgrd.la \
 	SensorDisplayLib/libsensordisplays.la \
 	$(LIB_KDEUI) $(LIB_KIO)
-ksysguard_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+ksysguard_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 kpm_SOURCES = kpm.c
 
diff -u -ruN kdebase-3.4.1.orig/ksysguard/gui/ksysguard.cc kdebase-3.4.1/ksysguard/gui/ksysguard.cc
--- kdebase-3.4.1.orig/ksysguard/gui/ksysguard.cc	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ksysguard/gui/ksysguard.cc	2005-09-01 17:03:15.000000000 -0700
@@ -498,7 +498,7 @@
 /*
  * Once upon a time...
  */
-int main( int argc, char** argv )
+extern "C" int kdemain( int argc, char** argv )
 {
   // initpipe is used to keep the parent process around till the child
   // has registered with dcop.
diff -u -ruN kdebase-3.4.1.orig/ksystraycmd/Makefile.am kdebase-3.4.1/ksystraycmd/Makefile.am
--- kdebase-3.4.1.orig/ksystraycmd/Makefile.am	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ksystraycmd/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,16 +1,19 @@
 ####### Fiddle here
 
 INCLUDES = $(all_includes)
-LDADD    = $(LIB_KDEUI)
 
 #######	Files
 
-bin_PROGRAMS	= ksystraycmd
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ksystraycmd.la
+
 METASOURCES	= ksystraycmd.moc
 noinst_HEADERS  = ksystraycmd.h
 
-ksystraycmd_SOURCES = ksystraycmd.cpp main.cpp
-ksystraycmd_LDFLAGS  = $(all_libraries) $(KDE_RPATH)
+ksystraycmd_la_SOURCES = ksystraycmd.cpp main.cpp
+ksystraycmd_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
+ksystraycmd_la_LIBADD  = $(LIB_KDEUI)
 
 messages:
 	$(XGETTEXT) $(ksystraycmd_SOURCES) -o $(podir)/ksystraycmd.pot
diff -u -ruN kdebase-3.4.1.orig/ksystraycmd/main.cpp kdebase-3.4.1/ksystraycmd/main.cpp
--- kdebase-3.4.1.orig/ksystraycmd/main.cpp	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ksystraycmd/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -42,7 +42,7 @@
   KCmdLineLastOption
 };
 
-int main( int argc, char *argv[] )
+extern "C" int kdemain( int argc, char *argv[] )
 {
   KAboutData aboutData( "ksystraycmd", I18N_NOOP( "KSysTrayCmd" ),
 			"KSysTrayCmd 0.1",
diff -u -ruN kdebase-3.4.1.orig/ktip/Makefile.am kdebase-3.4.1/ktip/Makefile.am
--- kdebase-3.4.1.orig/ktip/Makefile.am	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ktip/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -2,10 +2,13 @@
 
 SUBDIRS = pics
 
-bin_PROGRAMS = ktip
-ktip_SOURCES = ktipwindow.cpp
-ktip_LDADD = $(LIB_KDEUI)
-ktip_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = ktip.la
+
+ktip_la_SOURCES = ktipwindow.cpp
+ktip_la_LIBADD = $(LIB_KDEUI)
+ktip_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
 KDE_ICON = AUTO
diff -u -ruN kdebase-3.4.1.orig/ktip/ktipwindow.cpp kdebase-3.4.1/ktip/ktipwindow.cpp
--- kdebase-3.4.1.orig/ktip/ktipwindow.cpp	2005-09-01 16:58:19.000000000 -0700
+++ kdebase-3.4.1/ktip/ktipwindow.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -31,7 +31,7 @@
 
 static const char description[] = I18N_NOOP("Useful tips");
 
-int main(int argc, char *argv[])
+extern "C" int kdemain(int argc, char *argv[])
 {
 	KAboutData aboutData("ktip", I18N_NOOP("KTip"),
 				"0.3", description, KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/kwin/clients/kwmtheme/cli_installer/Makefile.am kdebase-3.4.1/kwin/clients/kwmtheme/cli_installer/Makefile.am
--- kdebase-3.4.1.orig/kwin/clients/kwmtheme/cli_installer/Makefile.am	2005-09-01 16:58:20.000000000 -0700
+++ kdebase-3.4.1/kwin/clients/kwmtheme/cli_installer/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -4,15 +4,17 @@
 
 ####### This part is very kwmtheme specific
 # you can add here more. This one gets installed 
-bin_PROGRAMS = 	kwmtheme
+bin_PROGRAMS = 	
+lib_LTLIBRARIES = 
+kdeinit_LTLIBRARIES = kwmtheme.la
 
 # Which sources should be compiled for kwmtheme.
-kwmtheme_SOURCES = main.cpp 
+kwmtheme_la_SOURCES = main.cpp 
 
 # the library search path. 
-kwmtheme_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwmtheme_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 # the libraries to link against. Be aware of the order. First the libraries,
 # that depend on the following ones.
-kwmtheme_LDADD   = $(LIB_KDECORE)
+kwmtheme_la_LIBADD   = $(LIB_KDECORE)
 
diff -u -ruN kdebase-3.4.1.orig/kwin/clients/kwmtheme/cli_installer/main.cpp kdebase-3.4.1/kwin/clients/kwmtheme/cli_installer/main.cpp
--- kdebase-3.4.1.orig/kwin/clients/kwmtheme/cli_installer/main.cpp	2005-09-01 16:58:20.000000000 -0700
+++ kdebase-3.4.1/kwin/clients/kwmtheme/cli_installer/main.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -37,7 +37,7 @@
     copyOutput.close();
 }
 
-int main(int argc, char **argv)
+extern "C" int kdemain(int argc, char **argv)
 {
     KCmdLineArgs::init(argc, argv, "kwmtheme", description, "0.1");
     KCmdLineArgs::addCmdLineOptions( options );
diff -u -ruN kdebase-3.4.1.orig/kwin/killer/Makefile.am kdebase-3.4.1/kwin/killer/Makefile.am
--- kdebase-3.4.1.orig/kwin/killer/Makefile.am	2005-09-01 16:58:21.000000000 -0700
+++ kdebase-3.4.1/kwin/killer/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,9 +1,11 @@
 INCLUDES = $(all_includes)
 
-bin_PROGRAMS = kwin_killer_helper
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = kwin_killer_helper.la
 
-kwin_killer_helper_SOURCES = killer.cpp
-kwin_killer_helper_LDADD = $(LIB_KDEUI)
-kwin_killer_helper_LDFLAGS = $(all_libraries) $(KDE_RPATH)
+kwin_killer_helper_la_SOURCES = killer.cpp
+kwin_killer_helper_la_LIBADD = $(LIB_KDEUI)
+kwin_killer_helper_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -module
 
 METASOURCES = AUTO
diff -u -ruN kdebase-3.4.1.orig/kwin/killer/killer.cpp kdebase-3.4.1/kwin/killer/killer.cpp
--- kdebase-3.4.1.orig/kwin/killer/killer.cpp	2005-09-01 16:58:21.000000000 -0700
+++ kdebase-3.4.1/kwin/killer/killer.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -43,7 +43,7 @@
         KCmdLineLastOption
     };
 
-int main( int argc, char* argv[] )
+extern "C" int kdemain( int argc, char* argv[] )
     {
     KLocale::setMainCatalogue( "kwin" ); // the messages are in kwin's .po file
     KCmdLineArgs::init( argc, argv, "kwin_killer_helper", I18N_NOOP( "KWin" ),
diff -u -ruN kdebase-3.4.1.orig/libkonq/Makefile.am kdebase-3.4.1/libkonq/Makefile.am
--- kdebase-3.4.1.orig/libkonq/Makefile.am	2005-09-01 16:58:26.000000000 -0700
+++ kdebase-3.4.1/libkonq/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -21,7 +21,7 @@
 
 lib_LTLIBRARIES = libkonq.la
 libkonq_la_LDFLAGS = $(all_libraries) -version-info 6:0:2 -no-undefined
-libkonq_la_LIBADD = $(LIB_KPARTS)
+libkonq_la_LIBADD = $(LIB_KPARTS) $(LIBZ)
 
 libkonq_la_SOURCES = konq_popupmenu.cc knewmenu.cc \
    konq_xmlguiclient.cc\
diff -u -ruN kdebase-3.4.1.orig/nsplugins/Makefile.am kdebase-3.4.1/nsplugins/Makefile.am
--- kdebase-3.4.1.orig/nsplugins/Makefile.am	2005-09-01 16:58:30.000000000 -0700
+++ kdebase-3.4.1/nsplugins/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -13,10 +13,13 @@
 libnsplugin_la_LDFLAGS = $(all_libraries) -avoid-version -module $(KDE_PLUGIN) -no-undefined
 libnsplugin_la_LIBADD  = -lkparts
 
-bin_PROGRAMS = nspluginscan
-nspluginscan_SOURCES = pluginscan.cpp
-nspluginscan_LDFLAGS =  $(KDE_RPATH) $(all_libraries) -export-dynamic
-nspluginscan_LDADD = $(LIB_KDEUI) $(LIB_KSYCOCA) -lXt
+bin_PROGRAMS = 
+lib_LTLIBRARIES =
+kdeinit_LTLIBRARIES = nspluginscan.la
+
+nspluginscan_la_SOURCES = pluginscan.cpp
+nspluginscan_la_LDFLAGS =  $(KDE_PLUGIN) $(all_libraries) -export-dynamic -module
+nspluginscan_la_LIBADD = $(LIB_KDEUI) $(LIB_KSYCOCA) -lXt
 
 kcm_nsplugins_la_SOURCES = kcm_nsplugins.cpp
 kcm_nsplugins_la_LDFLAGS = $(all_libraries) -module -avoid-version -no-undefined
diff -u -ruN kdebase-3.4.1.orig/nsplugins/pluginscan.cpp kdebase-3.4.1/nsplugins/pluginscan.cpp
--- kdebase-3.4.1.orig/nsplugins/pluginscan.cpp	2005-09-01 16:58:30.000000000 -0700
+++ kdebase-3.4.1/nsplugins/pluginscan.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -547,7 +547,7 @@
 };
 
 
-int main( int argc, char **argv )
+extern "C" int kdemain( int argc, char **argv )
 {
     KAboutData aboutData( "nspluginscan", I18N_NOOP("nspluginscan"),
                           "0.3", "nspluginscan", KAboutData::License_GPL,
diff -u -ruN kdebase-3.4.1.orig/nsplugins/pluginscan.cpp.orig kdebase-3.4.1/nsplugins/pluginscan.cpp.orig
--- kdebase-3.4.1.orig/nsplugins/pluginscan.cpp.orig	1969-12-31 16:00:00.000000000 -0800
+++ kdebase-3.4.1/nsplugins/pluginscan.cpp.orig	2005-05-23 05:14:25.000000000 -0700
@@ -0,0 +1,684 @@
+/*
+
+  This application scans for Netscape plugins and create a cache and
+  the necessary mimelnk and service files.
+
+
+  Copyright (c) 2000 Matthias Hoelzer-Kluepfel <hoelzer@kde.org>
+                     Stefan Schimanski <1Stein@gmx.de>
+
+  This program is free software; you can redistribute it and/or modify
+  it under the terms of the GNU General Public License as published by
+  the Free Software Foundation; either version 2 of the License, or
+  (at your option) any later version.
+
+  This program is distributed in the hope that it will be useful,
+  but WITHOUT ANY WARRANTY; without even the implied warranty of
+  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+  GNU General Public License for more details.
+
+  You should have received a copy of the GNU General Public License
+  along with this program; if not, write to the Free Software
+  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
+
+*/
+
+#include <config.h>
+
+#include <sys/types.h>
+#include <sys/wait.h>
+
+#include <errno.h>
+#include <signal.h>
+#include <unistd.h>
+
+#include <qdir.h>
+#include <qfile.h>
+#include <qtextstream.h>
+#include <qregexp.h>
+#include <qbuffer.h>
+
+#include <dcopclient.h>
+
+#include <kapplication.h>
+#include <kdebug.h>
+#include <kglobal.h>
+#include <kstandarddirs.h>
+#include <klibloader.h>
+#include <kconfig.h>
+#include <kdesktopfile.h>
+#include <kservicetype.h>
+#include <kmimetype.h>
+#include <kcmdlineargs.h>
+#include <kaboutdata.h>
+#include <klocale.h>
+
+#include "sdk/npupp.h"
+
+static int showProgress=0;
+
+// provide these symbols when compiling with gcc 3.x
+
+#if defined(__GNUC__) && defined(__GNUC_MINOR__)
+#define KDE_GNUC_PREREQ(maj,min) \
+  ((__GNUC__ << 16) + __GNUC_MINOR__ >= ((maj) << 16) + (min))
+#else
+#define KDE_GNUC_PREREQ(maj,min) 0
+#endif
+
+#if defined(__GNUC__) && KDE_GNUC_PREREQ(3,0)
+extern "C" void* __builtin_new(size_t s)
+{
+   return operator new(s);
+}
+
+extern "C" void __builtin_delete(void* p)
+{
+   operator delete(p);
+}
+
+extern "C" void* __builtin_vec_new(size_t s)
+{
+   return operator new[](s);
+}
+
+extern "C" void __builtin_vec_delete(void* p)
+{
+   operator delete[](p);
+}
+
+extern "C" void __pure_virtual()
+{
+   abort();
+}
+#endif
+
+KConfig *infoConfig = 0;
+
+
+bool isPluginMimeType( QString fname )
+{
+    KDesktopFile cfg( fname, true );
+    cfg.setDesktopGroup();
+    return cfg.hasKey( "X-KDE-nsplugin" );
+}
+
+
+void deletePluginMimeTypes()
+{
+    // iterate through local mime type directories
+    QString dir = KGlobal::dirs()->saveLocation( "mime" );
+    kdDebug(1433) << "Removing nsplugin MIME types in " << dir << endl;
+    QDir dirs( dir, QString::null, QDir::Name|QDir::IgnoreCase, QDir::Dirs );
+    if ( !dirs.exists() ) {
+        kdDebug(1433) << "Directory not found" << endl;
+        return;
+    }
+
+    for ( unsigned int i=0; i<dirs.count(); i++ ) {
+        if ( !dirs[i].contains(".") ) {
+
+            // check all mime types for X-KDE-nsplugin flag
+            kdDebug(1433) << " - Looking in " << dirs[i] << endl;
+            QDir files( dirs.absFilePath(dirs[i]), QString::null,
+                        QDir::Name|QDir::IgnoreCase, QDir::Files );
+            if ( files.exists( dir ) ) {
+
+                for (unsigned int i=0; i<files.count(); i++) {
+
+                    // check .desktop file
+                    kdDebug(1433) << "   - Checking " << files[i] << endl;
+                    if ( isPluginMimeType(files.absFilePath(files[i])) ) {
+                        kdDebug(1433) << "     - Removing " << files[i] << endl;
+                        files.remove( files[i] );
+                    }
+
+                }
+            }
+
+        }
+    }
+}
+
+
+void generateMimeType( QString mime, QString extensions, QString pluginName, QString description )
+{
+    kdDebug(1433) << "-> generateMimeType mime=" << mime << " ext="<< extensions << endl;
+
+    // get directory from mime string
+    QString dir;
+    QString name;
+    int pos = mime.findRev('/');
+    if ( pos<0 ) {
+        kdDebug(1433) << "Invalid MIME type " << mime << endl;
+        kdDebug(1433) << "<- generateMimeType" << endl;
+        return;
+    }
+    dir = KGlobal::dirs()->saveLocation( "mime", mime.left(pos) );
+    name = mime.mid(pos);
+
+    // create mimelnk file
+    QFile f( dir + name + ".desktop" );
+    if ( f.open(IO_WriteOnly) ) {
+
+        // write .desktop file
+        QTextStream ts(&f);
+
+        ts << "[Desktop Entry]" << endl;
+        ts << "Type=MimeType" << endl;
+        ts << "MimeType=" << mime << endl;
+        ts << "Icon=netscape_doc" << endl;
+        ts << "Comment=Netscape " << pluginName << endl;
+        ts << "X-KDE-AutoEmbed=true" << endl;
+        ts << "X-KDE-nsplugin=true" << endl;
+
+        if (!extensions.isEmpty()) {
+            QStringList exts = QStringList::split(",", extensions);
+            QStringList patterns;
+            for (QStringList::Iterator it=exts.begin(); it != exts.end(); ++it)
+                patterns.append( "*." + (*it).stripWhiteSpace() );
+
+            ts << "Patterns=" << patterns.join( ";" ) << endl;
+        }
+
+        if (!description.isEmpty())
+            ts << "Name=" << description << endl;
+        else
+            ts << "Name=" << i18n("Netscape plugin mimeinfo") << endl;
+
+        f.close();
+    }
+
+    kdDebug(1433) << "<- generateMimeType" << endl;
+}
+
+
+void registerPlugin( const QString &name, const QString &description,
+                     const QString &file, const QString &mimeInfo )
+{
+    // global stuff
+    infoConfig->setGroup( QString::null );
+    int num = infoConfig->readNumEntry( "number", 0 );
+    infoConfig->writeEntry( "number", num+1 );
+
+    // create plugin info
+    infoConfig->setGroup( QString::number(num) );
+    infoConfig->writeEntry( "name", name );
+    infoConfig->writeEntry( "description", description );
+    infoConfig->writeEntry( "file", file );
+    infoConfig->writeEntry( "mime", mimeInfo );
+}
+
+int tryCheck(int write_fd, const QString &absFile)
+{
+    KLibrary *_handle = KLibLoader::self()->library( QFile::encodeName(absFile) );
+    if (!_handle) {
+        kdDebug(1433) << " - open failed with message " << 
+		         KLibLoader::self()->lastErrorMessage() << ", skipping " << endl;
+        return 1;
+    }
+
+    // ask for name and description
+    QString name = i18n("Unnamed plugin");
+    QString description;
+
+    NPError (*func_GetValue)(void *, NPPVariable, void *) =
+        (NPError(*)(void *, NPPVariable, void *))
+        _handle->symbol("NP_GetValue");
+    if ( func_GetValue ) {
+
+        // get name
+        char *buf = 0;
+        NPError err = func_GetValue( 0, NPPVpluginNameString,
+                                     (void*)&buf );
+        if ( err==NPERR_NO_ERROR )
+            name = QString::fromLatin1( buf );
+        kdDebug() << "name = " << name << endl;
+
+        // get name
+        NPError nperr = func_GetValue( 0, NPPVpluginDescriptionString,
+                                     (void*)&buf );
+        if ( nperr==NPERR_NO_ERROR )
+            description = QString::fromLatin1( buf );
+        kdDebug() << "description = " << description << endl;
+    }
+    else
+        kdWarning() << "Plugin doesn't implement NP_GetValue"  << endl;
+
+    // get mime description function pointer
+    char* (*func_GetMIMEDescription)() =
+        (char *(*)())_handle->symbol("NP_GetMIMEDescription");
+    if ( !func_GetMIMEDescription ) {
+        kdDebug(1433) << " - no GetMIMEDescription, skipping" << endl;
+        KLibLoader::self()->unloadLibrary( QFile::encodeName(absFile) );
+        return 1;
+    }
+
+    // ask for mime information
+    QString mimeInfo = func_GetMIMEDescription();
+    if ( mimeInfo.isEmpty() ) {
+        kdDebug(1433) << " - no mime info returned, skipping" << endl;
+        KLibLoader::self()->unloadLibrary( QFile::encodeName(absFile) );
+        return 1;
+    }
+
+    // remove version info, as it is not used at the moment
+    QRegExp versionRegExp(";version=[^:]*:");
+    mimeInfo.replace( versionRegExp, ":");
+
+    // unload plugin lib
+    kdDebug(1433) << " - unloading plugin" << endl;
+    KLibLoader::self()->unloadLibrary( QFile::encodeName(absFile) );
+
+    // create a QDataStream for our IPC pipe (to send plugin info back to the parent)
+    FILE *write_pipe = fdopen(write_fd, "w");
+    QFile stream_file;
+    stream_file.open(IO_WriteOnly, write_pipe);
+    QDataStream stream(&stream_file);
+
+    // return the gathered info to the parent
+    stream << name;
+    stream << description;
+    stream << mimeInfo;
+
+    return 0;
+}
+
+void scanDirectory( QString dir, QStringList &mimeInfoList,
+                    QTextStream &cache )
+{
+    kdDebug(1433) << "-> scanDirectory dir=" << dir << endl;
+
+    // iterate over all files
+    QDir files( dir, QString::null, QDir::Name|QDir::IgnoreCase, QDir::Files );
+    if ( !files.exists( dir ) ) {
+        kdDebug(1433) << "No files found" << endl;
+        kdDebug(1433) << "<- scanDirectory dir=" << dir << endl;
+        return;
+    }
+
+    for (unsigned int i=0; i<files.count(); i++) {
+        QString extension;
+        int j = files[i].findRev('.');
+        if (j > 0)
+           extension = files[i].mid(j+1);
+
+        // ignore crashing libs
+        if ( files[i]=="librvplayer.so" ||      // RealPlayer 5
+             files[i]=="libnullplugin.so" ||    // Netscape Default Plugin
+             files[i]=="cult3dplugin.so" ||     // Cult 3d plugin
+             extension == "jar" ||              // Java archive
+             extension == "zip" ||              // Zip file (for classes)
+             extension == "class" ||            // Java class
+             extension == "png" ||              // PNG Image
+             extension == "jpg" ||              // JPEG image
+             extension == "gif" ||              // GIF image
+             extension == "bak" ||              // .so.bak-up files
+             extension == "tmp" ||              // tmp files
+             extension == "xpt" ||              // XPConnect
+             extension.startsWith("htm")        // HTML
+            )
+            continue;
+
+        // get absolute file path
+        QString absFile = files.absFilePath( files[i] );
+        kdDebug(1433) << "Checking library " << absFile << endl;
+
+        // open the library and ask for the mimetype
+        kdDebug(1433) << " - opening " << absFile << endl;
+
+        cache.device()->flush();
+        // fork, so that a crash in the plugin won't stop the scanning of other plugins
+        int pipes[2];
+        if (pipe(pipes) != 0) continue;
+        int loader_pid = fork();
+
+        if (loader_pid == -1) {
+            // unable to fork
+            continue;
+        } else if (loader_pid == 0) {
+           // inside the child
+           close(pipes[0]);
+           _exit(tryCheck(pipes[1], absFile));
+        } else {
+           close(pipes[1]);
+
+           QBuffer m_buffer;
+           m_buffer.open(IO_WriteOnly);
+
+           FILE *read_pipe = fdopen(pipes[0], "r");
+           QFile q_read_pipe;
+           q_read_pipe.open(IO_ReadOnly, read_pipe);
+
+           char *data = (char *)malloc(4096);
+           if (!data) continue;
+
+           // when the child closes, we'll get an EOF (size == 0)
+           while (int size = q_read_pipe.readBlock(data, 4096)) {
+               if (size > 0)
+                   m_buffer.writeBlock(data, size);
+           }
+           free(data);
+
+           close(pipes[0]); // we no longer need the pipe's reading end
+
+           // close the buffer and open for reading (from the start)
+           m_buffer.close();
+           m_buffer.open(IO_ReadOnly);
+
+           // create a QDataStream for our buffer
+           QDataStream stream(&m_buffer);
+
+           if (stream.atEnd()) continue;
+
+           QString name, description, mimeInfo;
+           stream >> name;
+           stream >> description;
+           stream >> mimeInfo;
+
+           bool actuallyUsing = false;
+
+           // get mime types from string
+           QStringList types = QStringList::split( ';', mimeInfo );
+           QStringList::Iterator type;
+           for ( type=types.begin(); type!=types.end(); ++type ) {
+
+              kdDebug(1433) << " - type=" << *type << endl;
+              name = name.replace( ':', "%3A" );
+
+              QString entry = name + ":" + *type;
+              if ( !mimeInfoList.contains( entry ) ) {
+                  if (!actuallyUsing) {
+                      // note the plugin name
+                      cache << "[" << absFile << "]" << endl;
+                      actuallyUsing = true;
+                  }
+
+                  // write into type cache
+                  QStringList tokens = QStringList::split(':', *type, TRUE);
+                  QStringList::Iterator token;
+                  token = tokens.begin();
+                  cache << (*token).lower();
+                  ++token;
+                  for ( ; token!=tokens.end(); ++token )
+                      cache << ":" << *token;
+                  cache << endl;
+
+                  // append type to MIME type list
+                  mimeInfoList.append( entry );
+              }
+           }
+
+           // register plugin for javascript
+           registerPlugin( name, description, files[i], mimeInfo );
+        }
+    }
+
+    // iterate over all sub directories
+    // NOTE: Mozilla doesn't iterate over subdirectories of the plugin dir.
+    // We still do (as Netscape 4 did).
+    QDir dirs( dir, QString::null, QDir::Name|QDir::IgnoreCase, QDir::Dirs );
+    if ( !dirs.exists() )
+      return;
+
+    static int depth = 0; // avoid recursion because of symlink circles
+    depth++;
+    for ( unsigned int i=0; i<dirs.count(); i++ ) {
+        if ( depth<8 && !dirs[i].contains(".") )
+            scanDirectory( dirs.absFilePath(dirs[i]), mimeInfoList, cache );
+    }
+    depth--;
+
+    kdDebug() << "<- scanDirectory dir=" << dir << endl;
+}
+
+
+QStringList getSearchPaths()
+{
+    QStringList searchPaths;
+
+    KConfig *config = new KConfig("kcmnspluginrc", false);
+    config->setGroup("Misc");
+
+    // setup default paths
+    if ( !config->hasKey("scanPaths") ) {
+        QStringList paths;
+        paths.append("$HOME/.mozilla/plugins");
+        paths.append("$HOME/.netscape/plugins");
+        paths.append("/usr/lib64/browser-plugins");
+        paths.append("/usr/lib/browser-plugins");
+        paths.append("/usr/local/netscape/plugins");
+        paths.append("/opt/mozilla/plugins");
+	paths.append("/opt/mozilla/lib/plugins");
+        paths.append("/opt/netscape/plugins");
+        paths.append("/opt/netscape/communicator/plugins");
+        paths.append("/usr/lib/netscape/plugins");
+        paths.append("/usr/lib/netscape/plugins-libc5");
+        paths.append("/usr/lib/netscape/plugins-libc6");
+        paths.append("/usr/lib/mozilla/plugins");
+	paths.append("/usr/lib64/netscape/plugins");
+	paths.append("/usr/lib64/mozilla/plugins");
+        paths.append("$MOZILLA_HOME/plugins");
+        config->writeEntry( "scanPaths", paths );
+    }
+
+    // read paths
+    config->setDollarExpansion( true );
+    searchPaths = config->readListEntry( "scanPaths" );
+    delete config;
+
+    // append environment variable NPX_PLUGIN_PATH
+    QStringList envs = QStringList::split(':', getenv("NPX_PLUGIN_PATH"));
+    QStringList::Iterator it;
+    for (it = envs.begin(); it != envs.end(); ++it)
+        searchPaths.append(*it);
+
+    return searchPaths;
+}
+
+
+void writeServicesFile( QStringList mimeTypes )
+{
+    QString fname = KGlobal::dirs()->saveLocation("services", "")
+                    + "/nsplugin.desktop";
+    kdDebug(1433) << "Creating services file " << fname << endl;
+
+    QFile f(fname);
+    if ( f.open(IO_WriteOnly) ) {
+
+        QTextStream ts(&f);
+
+        ts << "[Desktop Entry]" << endl;
+        ts << "Name=" << i18n("Netscape plugin viewer") << endl;
+        ts << "Type=Service" << endl;
+        ts << "Icon=netscape" << endl;
+        ts << "Comment=" << i18n("Netscape plugin viewer") << endl;
+        ts << "X-KDE-Library=libnsplugin" << endl;
+        ts << "InitialPreference=0" << endl;
+        ts << "ServiceTypes=KParts/ReadOnlyPart,Browser/View" << endl;
+        ts << "X-KDE-BrowserView-PluginsInfo=nsplugins/pluginsinfo" << endl;
+
+        if (mimeTypes.count() > 0)
+            ts << "MimeType=" << mimeTypes.join(";") << endl;
+
+        f.close();
+    } else
+        kdDebug(1433) << "Failed to open file " << fname << endl;
+}
+
+
+void removeExistingExtensions( QString &extension )
+{
+    QStringList filtered;
+    QStringList exts = QStringList::split( ",", extension );
+    for ( QStringList::Iterator it=exts.begin(); it!=exts.end(); ++it ) {
+        QString ext = (*it).stripWhiteSpace();
+        if ( ext == "*" ) // some plugins have that, but we don't want to associate a mimetype with *.*!
+            continue;
+
+        KMimeType::Ptr mime = KMimeType::findByURL( KURL("file:///foo."+ext ),
+                                                    0, true, true );
+        if( mime->name()=="application/octet-stream" ||
+            mime->comment().left(8)=="Netscape" ) {
+            kdDebug() << "accepted" << endl;
+            filtered.append( ext );
+        }
+    }
+
+    extension = filtered.join( "," );
+}
+
+void sigChildHandler(int)
+{
+   // since waitpid and write change errno, we have to save it and restore it
+   // (Richard Stevens, Advanced programming in the Unix Environment)
+   int saved_errno = errno;
+
+   while (waitpid(-1, 0, WNOHANG) == 0)
+   	;
+
+   errno = saved_errno;
+}
+
+static KCmdLineOptions options[] =
+{
+   { "verbose",     I18N_NOOP("Show progress output for GUI"), 0 },
+   KCmdLineLastOption
+};
+
+
+int main( int argc, char **argv )
+{
+    KAboutData aboutData( "nspluginscan", I18N_NOOP("nspluginscan"),
+                          "0.3", "nspluginscan", KAboutData::License_GPL,
+                          "(c) 2000,2001 by Stefan Schimanski" );
+
+    KLocale::setMainCatalogue("nsplugin");
+    KCmdLineArgs::init( argc, argv, &aboutData );
+    KCmdLineArgs::addCmdLineOptions( options );
+    KCmdLineArgs *args = KCmdLineArgs::parsedArgs();
+
+    showProgress = args->isSet("verbose");
+    if (showProgress) {
+      printf("10\n"); fflush(stdout);
+    }
+
+    KApplication app(false, false);
+
+    // Set up SIGCHLD handler
+    struct sigaction act;
+    act.sa_handler=sigChildHandler;
+    sigemptyset(&(act.sa_mask));
+    sigaddset(&(act.sa_mask), SIGCHLD);
+    // Make sure we don't block this signal. gdb tends to do that :-(
+    sigprocmask(SIG_UNBLOCK, &(act.sa_mask), 0);
+
+    act.sa_flags = SA_NOCLDSTOP;
+
+    // CC: take care of SunOS which automatically restarts interrupted system
+    // calls (and thus does not have SA_RESTART)
+
+#ifdef SA_RESTART
+    act.sa_flags |= SA_RESTART;
+#endif
+
+    sigaction( SIGCHLD, &act, 0 );
+
+
+    // set up the paths used to look for plugins
+    QStringList searchPaths = getSearchPaths();
+    QStringList mimeInfoList;
+
+    infoConfig = new KConfig( KGlobal::dirs()->saveLocation("data", "nsplugins") +
+                              "/pluginsinfo" );
+    infoConfig->writeEntry( "number", 0 );
+
+    // open the cache file for the mime information
+    QString cacheName = KGlobal::dirs()->saveLocation("data", "nsplugins")+"/cache";
+    kdDebug(1433) << "Creating MIME cache file " << cacheName << endl;
+    QFile cachef(cacheName);
+    if (!cachef.open(IO_WriteOnly))
+        return -1;
+    QTextStream cache(&cachef);
+    if (showProgress) {
+      printf("20\n"); fflush(stdout);
+    }
+
+    // read in the plugins mime information
+    kdDebug(1433) << "Scanning directories" << endl;
+    int count = searchPaths.count();
+    int i = 0;
+    for ( QStringList::Iterator it = searchPaths.begin();
+          it != searchPaths.end(); ++it, ++i)
+    {
+        scanDirectory( *it, mimeInfoList, cache );
+        if (showProgress) {
+          printf("%d\n", 25 + (50*i) / count ); fflush(stdout);
+        }
+    }
+
+    if (showProgress) {
+      printf("75\n"); fflush(stdout);
+    }
+    // delete old mime types
+    kdDebug(1433) << "Removing old mimetypes" << endl;
+    deletePluginMimeTypes();
+    if (showProgress) {
+      printf("80\n");  fflush(stdout);
+    }
+
+    // write mimetype files
+    kdDebug(1433) << "Creating MIME type descriptions" << endl;
+    QStringList mimeTypes;
+    for ( QStringList::Iterator it=mimeInfoList.begin();
+          it!=mimeInfoList.end(); ++it) {
+
+      kdDebug(1433) << "Handling MIME type " << *it << endl;
+
+      QStringList info = QStringList::split(":", *it, true);
+      if ( info.count()==4 ) {
+          QString pluginName = info[0];
+          QString type = info[1].lower();
+          QString extension = info[2];
+          QString desc = info[3];
+
+          // append to global mime type list
+          if ( !mimeTypes.contains(type) ) {
+              kdDebug(1433) << " - mimeType=" << type << endl;
+              mimeTypes.append( type );
+
+              // check mimelnk file
+              QString fname = KGlobal::dirs()->findResource("mime", type+".desktop");
+              if ( fname.isEmpty() || isPluginMimeType(fname) ) {
+                  kdDebug(1433) << " - creating MIME type description" << endl;
+                  removeExistingExtensions( extension );
+                  generateMimeType( type, extension, pluginName, desc );
+              } else {
+                  kdDebug(1433) << " - already existant" << endl;
+              }
+          }
+        }
+    }
+    if (showProgress) {
+      printf("85\n"); fflush(stdout);
+    }
+
+    // close files
+    kdDebug(1433) << "Closing cache file" << endl;
+    cachef.close();
+
+    infoConfig->sync();
+    delete infoConfig;
+
+    // write plugin lib service file
+    writeServicesFile( mimeTypes );
+    if (showProgress) {
+      printf("90\n"); fflush(stdout);
+    }
+
+    DCOPClient *dcc = kapp->dcopClient();
+    if ( !dcc->isAttached() )
+        dcc->attach();
+    // Tel kded to update sycoca database.
+    dcc->send("kded", "kbuildsycoca", "recreate()", QByteArray());
+}
diff -u -ruN kdebase-3.4.1.orig/nsplugins/viewer/Makefile.am kdebase-3.4.1/nsplugins/viewer/Makefile.am
--- kdebase-3.4.1.orig/nsplugins/viewer/Makefile.am	2005-09-01 16:58:29.000000000 -0700
+++ kdebase-3.4.1/nsplugins/viewer/Makefile.am	2005-09-01 17:03:15.000000000 -0700
@@ -1,12 +1,14 @@
 INCLUDES = -I$(top_srcdir)/nsplugins -I$(top_builddir)/nsplugins $(all_includes)
 METASOURCES = AUTO
 
-bin_PROGRAMS = nspluginviewer 
+bin_PROGRAMS = 
+lib_LTLIBRARIES = 
+kdeinit_LTLIBRARIES = nspluginviewer.la
 
-nspluginviewer_SOURCES = NSPluginCallbackIface.stub NSPluginClassIface.skel \
+nspluginviewer_la_SOURCES = NSPluginCallbackIface.stub NSPluginClassIface.skel \
 	nsplugin.cpp viewer.cpp kxt.cpp qxteventloop.cpp
-nspluginviewer_LDFLAGS = $(all_libraries) $(KDE_RPATH) -export-dynamic
-nspluginviewer_LDADD = $(LIB_KIO) $(LIB_KPARTS) -lXt
+nspluginviewer_la_LDFLAGS = $(all_libraries) $(KDE_PLUGIN) -export-dynamic -module
+nspluginviewer_la_LIBADD = $(LIB_KIO) $(LIB_KPARTS) -lXt
 
 NSPluginCallbackIface_DIR = $(srcdir)/..
 
diff -u -ruN kdebase-3.4.1.orig/nsplugins/viewer/viewer.cpp kdebase-3.4.1/nsplugins/viewer/viewer.cpp
--- kdebase-3.4.1.orig/nsplugins/viewer/viewer.cpp	2005-09-01 16:58:29.000000000 -0700
+++ kdebase-3.4.1/nsplugins/viewer/viewer.cpp	2005-09-01 17:03:15.000000000 -0700
@@ -204,7 +204,7 @@
 #endif
 
 
-int main(int argc, char** argv)
+extern "C" int kdemain(int argc, char** argv)
 {
     // nspluginviewer is a helper app, it shouldn't do session management at all
    setenv( "SESSION_MANAGER", "", 1 );
diff -u -ruN kdebase-3.4.1.orig/startkde kdebase-3.4.1/startkde
--- kdebase-3.4.1.orig/startkde	2005-09-01 16:59:14.000000000 -0700
+++ kdebase-3.4.1/startkde	2005-09-01 17:03:15.000000000 -0700
@@ -3,6 +3,11 @@
 #  DEFAULT KDE STARTUP SCRIPT ( KDE-3.4.1 )
 #
 
+#source "@FINKPREFIX@/bin/init.sh"
+
+#[ -x @FINKPREFIX@/bin/remap-bad-apple-keys.pl ] && @FINKPREFIX@/bin/remap-bad-apple-keys.pl
+
+
 # When the X server dies we get a HUP signal from xinit. We must ignore it
 # because we still need to do some cleanup.
 trap 'echo GOT SIGHUP' HUP
@@ -179,20 +184,23 @@
 
 echo 'startkde: Starting up...'  1>&2
 
-# run KPersonalizer before the session, if this is the first login
-if kreadconfig --file kpersonalizerrc --group General --key FirstLogin --default true --type bool; then
-    # start only dcopserver, don't start whole kdeinit (takes too long)
-    echo 'startkde: Running kpersonalizer...'  1>&2
-    dcopserver
-    kwin --lock &
-    kpersonalizer --before-session
-    # handle kpersonalizer restarts (language change)
-    while test $? -eq 1; do
-        kpersonalizer --r --before-session
-    done
-    dcopquit kwin
-    dcopserver_shutdown --wait
-fi
+# on osx we skip this, the defaults are sane and most people
+# do bad things like "mac os menus" which makes it worse
+
+## run KPersonalizer before the session, if this is the first login
+#if kreadconfig --file kpersonalizerrc --group General --key FirstLogin --default true --type bool; then
+#    # start only dcopserver, don't start whole kdeinit (takes too long)
+#    echo 'startkde: Running kpersonalizer...'  1>&2
+#    dcopserver
+#    kwin --lock &
+#    kpersonalizer --before-session
+#    # handle kpersonalizer restarts (language change)
+#    while test $? -eq 1; do
+#        kpersonalizer --r --before-session
+#    done
+#    dcopquit kwin
+#    dcopserver_shutdown --wait
+#fi
 
 # the splashscreen and progress indicator
 splash=`kreadconfig --file ksplashrc --group KSplash --key Theme`
@@ -226,7 +234,29 @@
 # We only check for 255 which means that the ksmserver process could not be 
 # started, any problems thereafter, e.g. ksmserver failing to initialize, 
 # will remain undetected.
-test -n "$KDEWM" && KDEWM="--windowmanager $KDEWM"
+
+USE_PROXY=0
+if test -n "$KDEWM"; then
+  if test -z `expr "$KDEWM" : '\(.*quartz-wm.*\)'`; then
+    USE_PROXY=1
+  fi
+  KDEWM="--windowmanager $KDEWM"
+else
+  KDEWM="--windowmanager kwin"
+  USE_PROXY=1
+fi
+
+if test "$USE_PROXY" = "1"; then
+  if test -x /usr/X11R6/bin/quartz-wm; then
+    /usr/X11R6/bin/quartz-wm --only-proxy >/dev/null 2>&1 &
+  else
+    AUTOCUTSEL=`which autocutsel 2>/dev/null`
+    if test -n "$AUTOCUTSEL" && test -x "$AUTOCUTSEL"; then
+      $AUTOCUTSEL >/dev/null 2>&1 &
+    fi
+  fi
+fi
+
 kwrapper ksmserver $KDEWM 
 if test $? -eq 255; then
   # Startup error
diff -u -ruN kdebase-3.4.1.orig/startkde.orig kdebase-3.4.1/startkde.orig
--- kdebase-3.4.1.orig/startkde.orig	1969-12-31 16:00:00.000000000 -0800
+++ kdebase-3.4.1/startkde.orig	2005-05-23 05:15:10.000000000 -0700
@@ -0,0 +1,258 @@
+#!/bin/sh
+#
+#  DEFAULT KDE STARTUP SCRIPT ( KDE-3.4.1 )
+#
+
+# When the X server dies we get a HUP signal from xinit. We must ignore it
+# because we still need to do some cleanup.
+trap 'echo GOT SIGHUP' HUP
+
+# Check if a KDE session already is running
+if kcheckrunning >/dev/null 2>&1; then
+	echo "KDE seems to be already running on this display."
+	xmessage -geometry 500x100 "KDE seems to be already running on this display." > /dev/null 2>/dev/null
+	exit 1
+fi
+
+# Set the background to plain grey.
+# The standard X background is nasty, causing moire effects and exploding
+# people's heads. We use colours from the standard KDE palette for those with
+# palettised displays.
+if test -z "$XDM_MANAGED" || echo "$XDM_MANAGED" | grep ",auto" > /dev/null; then
+  xsetroot -solid "#C0C0C0"
+fi
+
+# we have to unset this for Darwin since it will screw up KDE's dynamic-loading
+unset DYLD_FORCE_FLAT_NAMESPACE
+
+# in case we have been started with full pathname spec without being in PATH
+bindir=`echo "$0" | sed -n 's,^\(/.*\)/[^/][^/]*$,\1,p'`
+if [ -n "$bindir" ]; then
+  case $PATH in
+    $bindir|$bindir:*|*:$bindir|*:$bindir:*) ;;
+    *) PATH=$bindir:$PATH; export PATH;;
+  esac
+fi
+
+# Boot sequence:
+#
+# kdeinit is used to fork off processes which improves memory usage
+# and startup time.
+#
+# * kdeinit starts the dcopserver and klauncher first.
+# * Then kded is started. kded is responsible for keeping the sycoca
+#   database up to date. When an up to date database is present it goes
+#   into the background and the startup continues.
+# * Then kdeinit starts kcminit. kcminit performs initialisation of
+#   certain devices according to the user's settings
+#
+# * Then ksmserver is started which in turn starts
+#   1) the window manager (kwin)
+#   2) everything in $KDEDIR/share/autostart (kdesktop, kicker, etc.)
+#   3) the rest of the session.
+
+# The user's personal KDE directory is usually ~/.kde, but this setting
+# may be overridden by setting KDEHOME.
+
+kdehome=$HOME/.kde
+test -n "$KDEHOME" && kdehome=`echo "$KDEHOME"|sed "s,^~/,$HOME/,"`
+
+# Source scripts found in <localprefix>/env/*.sh and <prefixes>/env/*.sh
+# (where <localprefix> is $KDEHOME or ~/.kde, and <prefixes> is where KDE is installed)
+#
+# This is where you can define environment variables that will be available to
+# all KDE programs, so this is where you can run agents using e.g. eval `ssh-agent`
+# or eval `gpg-agent --daemon`.
+# Note: if you do that, you should also put "ssh-agent -k" as a shutdown script
+#
+# (see end of this file).
+# For anything else (that doesn't set env vars, or that needs a window manager),
+# better use the Autostart folder.
+
+exepath=`kde-config --path exe`
+
+for prefix in `echo "$exepath" | sed -e 's^/bin/^/env/^g;s^:^ ^g'`; do
+  for file in "$prefix"*.sh; do
+    test -r "$file" && . "$file"
+  done
+done
+
+# Activate the kde font directories.
+#
+# There are 4 directories that may be used for supplying fonts for KDE.
+#
+# There are two system directories. These belong to the administrator.
+# There are two user directories, where the user may add her own fonts.
+#
+# The 'override' versions are for fonts that should come first in the list,
+# i.e. if you have a font in your 'override' directory, it will be used in
+# preference to any other.
+#
+# The preference order looks like this:
+# user override, system override, X, user, system
+#
+# Where X is the original font database that was set up before this script
+# runs.
+
+usr_odir=$HOME/.fonts/kde-override
+usr_fdir=$HOME/.fonts
+
+# Add any user-installed font directories to the X font path
+kde_fontpaths=$usr_fdir/fontpaths
+do_usr_fdir=1
+do_usr_odir=1
+if test -r "$kde_fontpaths" ; then
+    savifs=$IFS
+    IFS="
+"
+    for fpath in `grep -v '^[ 	]*#' < "$kde_fontpaths"` ; do
+        rfpath=`echo $fpath | sed "s:^~:$HOME:g"`
+        if test -s "$rfpath"/fonts.dir; then
+            xset fp+ "$rfpath"
+            if test "$rfpath" = "$usr_fdir"; then
+                do_usr_fdir=0
+            fi
+            if test "$rfpath" = "$usr_odir"; then
+                do_usr_odir=0
+            fi
+        fi
+    done
+    IFS=$savifs
+fi
+
+if test -n "$KDEDIRS"; then
+  kdedirs_first=`echo "$KDEDIRS"|sed -e 's/:.*//'`
+  sys_odir=$kdedirs_first/share/fonts/override
+  sys_fdir=$kdedirs_first/share/fonts
+else
+  sys_odir=$KDEDIR/share/fonts/override
+  sys_fdir=$KDEDIR/share/fonts
+fi
+
+# We run mkfontdir on the user's font dirs (if we have permission) to pick
+# up any new fonts they may have installed. If mkfontdir fails, we still
+# add the user's dirs to the font path, as they might simply have been made
+# read-only by the administrator, for whatever reason.
+
+# Only do usr_fdir and usr_odir if they are *not* listed in fontpaths
+test -d "$sys_odir" && xset +fp "$sys_odir"
+test $do_usr_odir -eq 1 && test -d "$usr_odir" && (mkfontdir "$usr_odir" ; xset +fp "$usr_odir")
+test $do_usr_fdir -eq 1 && test -d "$usr_fdir" && (mkfontdir "$usr_fdir" ; xset fp+ "$usr_fdir")
+test -d "$sys_fdir" && xset fp+ "$sys_fdir"
+
+# Ask X11 to rebuild its font list.
+xset fp rehash
+
+# Set a left cursor instead of the standard X11 "X" cursor, since I've heard
+# from some users that they're confused and don't know what to do. This is
+# especially necessary on slow machines, where starting KDE takes one or two
+# minutes until anything appears on the screen.
+#
+# If the user has overwritten fonts, the cursor font may be different now
+# so don't move this up.
+#
+xsetroot -cursor_name left_ptr
+
+# Get Ghostscript to look into user's KDE fonts dir for additional Fontmap
+if test -n "$GS_LIB" ; then
+    GS_LIB=$usr_fdir:$GS_LIB
+    export GS_LIB
+else
+    GS_LIB=$usr_fdir
+    export GS_LIB
+fi
+
+# Link "tmp" resource to directory in /tmp
+# Creates a directory /tmp/kde-$USER and links $KDEHOME/tmp-$HOSTNAME to it.
+lnusertemp tmp >/dev/null
+
+# Link "socket" resource to directory in /tmp
+# Creates a directory /tmp/ksocket-$USER and links $KDEHOME/socket-$HOSTNAME to it.
+lnusertemp socket >/dev/null
+
+# Link "cache" resource to directory in /var/tmp
+# Creates a directory /var/tmp/kdecache-$USER and links $KDEHOME/cache-$HOSTNAME to it.
+lnusertemp cache >/dev/null
+
+# In case of dcop sockets left by a previous session, cleanup
+dcopserver_shutdown
+
+echo 'startkde: Starting up...'  1>&2
+
+# run KPersonalizer before the session, if this is the first login
+if kreadconfig --file kpersonalizerrc --group General --key FirstLogin --default true --type bool; then
+    # start only dcopserver, don't start whole kdeinit (takes too long)
+    echo 'startkde: Running kpersonalizer...'  1>&2
+    dcopserver
+    kwin --lock &
+    kpersonalizer --before-session
+    # handle kpersonalizer restarts (language change)
+    while test $? -eq 1; do
+        kpersonalizer --r --before-session
+    done
+    dcopquit kwin
+    dcopserver_shutdown --wait
+fi
+
+# the splashscreen and progress indicator
+splash=`kreadconfig --file ksplashrc --group KSplash --key Theme`
+if test "$splash" = "None"; then
+    echo >/dev/null #nothing
+elif test "$splash" = "Simple"; then
+    ksplashsimple
+else
+    ksplash --nodcop
+fi
+
+# certain features such as Konqueror preloading work only with full KDE running
+KDE_FULL_SESSION=true
+export KDE_FULL_SESSION
+
+# We set LD_BIND_NOW to increase the efficiency of kdeinit.
+# kdeinit unsets this variable before loading applications.
+LD_BIND_NOW=true kdeinit +kcminit
+if test $? -ne 0; then
+  # Startup error
+  echo 'startkde: Could not start kdeinit. Check your installation.'  1>&2
+  xmessage -geometry 500x100 "Could not start kdeinit. Check your installation."
+fi
+
+# finally, give the session control to the session manager
+# if the KDEWM environment variable has been set, then it will be used as KDE's
+# window manager instead of kwin.
+# if KDEWM is not set, ksmserver will ensure kwin is started.
+# kwrapper is used to reduce startup time and memory usage
+# kwrapper does not return usefull error codes such as the exit code of ksmserver.
+# We only check for 255 which means that the ksmserver process could not be 
+# started, any problems thereafter, e.g. ksmserver failing to initialize, 
+# will remain undetected.
+test -n "$KDEWM" && KDEWM="--windowmanager $KDEWM"
+kwrapper ksmserver $KDEWM 
+if test $? -eq 255; then
+  # Startup error
+  echo 'startkde: Could not start ksmserver. Check your installation.'  1>&2
+  xmessage -geometry 500x100 "Could not start ksmserver. Check your installation."
+fi
+
+# wait if there's any crashhandler shown
+while dcop | grep -q ^drkonqi- ; do
+    sleep 5
+done
+
+echo 'startkde: Shutting down...'  1>&2
+
+# Clean up
+kdeinit_shutdown
+dcopserver_shutdown --wait
+artsshell -q terminate
+
+echo 'startkde: Running shutdown scripts...'  1>&2
+
+# Run scripts found in $KDEDIRS/shutdown
+for prefix in `echo "$exepath" | sed -e 's^/bin/^/shutdown/^g;s^:^ ^g'`; do
+  for file in `ls "$prefix" 2> /dev/null | egrep -v '(~|\.bak)$'`; do
+    test -x "$prefix$file" && "$prefix$file"
+  done
+done
+
+echo 'startkde: Done.'  1>&2
