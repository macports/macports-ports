# -*- coding: utf-8; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0

name                VLC
version             2.1.5
revision            8
categories          multimedia

maintainers         gmail.com:rjvbertin openmaintainer
description         VLC is a cross-platform media player and streaming server
long_description    VLC media player is a highly portable multimedia player for \
                    various audio and video formats (MPEG-1, MPEG-2, MPEG-4, DivX, \
                    mp3, ogg, ...) as well as DVDs, VCDs, and various streaming protocols. \
                    It can also be used as a server to stream in unicast or multicast \
                    in IPv4 or IPv6 on a high-bandwidth network.
license             GPL

platforms           darwin
conflicts           VLC-devel

homepage            http://www.videolan.org

# http://git.videolan.org/?p=vlc.git
# http://git.videolan.org/?p=vlc.git;a=forks
#fetch.type          git
#git.url             git://git.videolan.org/vlc/vlc-2.1.git
#git.url             git://git.videolan.org/vlc.git
#git.branch          edd88358218f273fddde646a172a2104796d46c2

master_sites        http://download.videolan.org/pub/videolan/vlc/${version}/
distname            vlc-${version}
use_xz              yes

checksums           md5     3941b561f590cc95ca5e795213cba2f2 \
                    sha1    7f1cb6324a04cf393896bbb5976ca9febd7b3efc \
                    rmd160  4a18210f0f01ac8dfaf166926ab10eea6d97fbae

depends_build       port:pkgconfig

depends_lib         \
                    port:jpeg \
                    port:lame \
                    port:libcdio \
                    port:libebml \
                    port:libgcrypt \
                    port:libid3tag \
                    port:libmatroska \
                    port:libmpeg2 \
                    port:libxml2 \
                    port:nettle \
                    port:openjpeg15 \
                    port:taglib \
                    port:tiff \

# TODO: live555 opencv FreeRDP

# VLC-2.1 and later are x86_64-only: https://trac.videolan.org/vlc/ticket/8161
universal_variant   no
supported_archs     x86_64

compiler.blacklist  gcc-4.2 llvm-gcc-4.2 {clang < 300}

pre-fetch {
    if {${os.platform} eq "darwin" && ${os.major} < 10} {
        ui_error "${name} ${version} requires Mac OS X 10.6 or greater."
        return -code error "incompatible Mac OS X version"
    }
}

patchfiles          buildfix-package.mak.patch \
                    configure.ac-no-arch.patch \
                    PR-34741-no__clang_version__.patch \
                    class_struct.patch \
                    qtkit.patch \
                    static_assert.patch \
                    no-sparkle.patch \
                    patch-ffmpeg-2.4.diff

# upgrade of lua from 5.2 to 5.3 introduced API deprecations that broke build
# apply upstream 5.3 compatibility patch (#49405)

patchfiles-append   patch-lua-5.3.diff

# Xcode 7.0+ introduces C11 native atomics that break the bluray module
# patch to disable native atomics for this module and fall back to VLC's backup implementation (#49178)

patchfiles-append   patch-bluray-no-atomics.diff

post-patch {
    reinplace "s:librsvg-2/librsvg:librsvg:" \
        ${worksrcpath}/modules/text_renderer/svg.c

    if {[string match *clang* ${configure.cxx}] && ${configure.cxx_stdlib} == "libc++"} {
        reinplace "s:-lstdc\+\+:-lc++:" \
            ${worksrcpath}/configure.ac \
            ${worksrcpath}/modules/access/Makefile.am
    }
}

use_autoreconf      yes
autoreconf.cmd      ./bootstrap
autoreconf.pre_args
autoreconf.args
depends_build-append port:libtool port:autoconf port:automake

configure.env-append CXXCPP="${configure.cxx} -E"
build.args-append    DESTDIR=${worksrcpath}/dest_ignore V=1

# gl.c:121:3: error: Platform not recognized.
configure.cppflags-append -D__unix__=1

build.target        all
destroot.target     install

livecheck.url       http://download.videolan.org/pub/videolan/vlc/
livecheck.regex     <a href=\"(\\d\[\\d|\.|\\w\]+).*/\">

# Other

depends_lib-append  port:gnutls \
                    port:lua

configure.args-append \
                    --with-contrib=${worksrcpath}/contrib \
                    --enable-shared \
                    --disable-debug \
                    --disable-update-check \
                    --disable-dbus \
                    --disable-growl \
                    --disable-macosx-vlc-app \
                    --disable-notify \
                    --enable-gnutls \
                    --enable-lua

# Input Plugins
# build fails when FreeRDP is installed
# build fails when opencv is installed

depends_lib-append  \
                    port:libbluray \
                    port:libcddb \
                    port:libdc1394 \
                    port:libdvdnav \
                    port:libdvdread \
                    port:libssh2

configure.args-append \
                    --disable-decklink \
                    --disable-dv1394 \
                    --disable-gnomevfs \
                    --disable-libfreerdp \
                    --disable-libvnc \
                    --disable-linsys \
                    --disable-macosx-eyetv \
                    --disable-macosx-qtkit \
                    --disable-macosx-avfoundation \
                    --disable-opencv \
                    --disable-realrtsp \
                    --disable-smbclient \
                    --disable-v4l2 \
                    --disable-vcdx \
                    --enable-bluray \
                    --enable-dc1394 \
                    --enable-dvdnav \
                    --enable-dvdread \
                    --enable-libcddb \
                    --enable-sftp \
                    --enable-vcd

# Mux/Demux Plugins
depends_lib-append \
                    port:libogg

configure.args-append \
                    --disable-dvbpsi \
                    --disable-gme \
                    --disable-mod \
                    --disable-mpc \
                    --disable-sid \
                    --disable-shout \
                    --enable-mkv \
                    --enable-mux_ogg \
                    --enable-ogg

# Codec Plugins

depends_lib-append  \
                    port:a52dec \
                    path:lib/libavcodec.dylib:ffmpeg \
                    port:libdca \
                    port:dirac \
                    port:faad2 \
                    port:flac \
                    port:fluidsynth \
                    port:libmad \
                    port:libopus \
                    port:libpng \
                    port:libvpx \
                    port:schroedinger \
                    port:libtheora \
                    port:twolame \
                    port:libvorbis \
                    port:x264


configure.args-append \
                    --disable-crystalhd \
                    --disable-dxva2 \
                    --disable-fdkaac \
                    --disable-kate \
                    --disable-libass \
                    --disable-libva \
                    --disable-live555 \
                    --disable-omxil \
                    --disable-omxil-vout \
                    --disable-quicksync \
                    --disable-quicktime \
                    --disable-rpi-omxil \
                    --disable-speex \
                    --disable-tiger \
                    --disable-wma-fixed \
                    --disable-shine \
                    --disable-zvbi \
                    --enable-a52 \
                    --enable-avcodec \
                    --enable-avformat \
                    --enable-dca \
                    --enable-dirac \
                    --enable-faad \
                    --enable-flac \
                    --enable-fluidsynth \
                    --enable-mad \
                    --enable-opus \
                    --enable-png \
                    --enable-postproc \
                    --enable-schroedinger \
                    --enable-swscale \
                    --enable-telx \
                    --enable-theora \
                    --enable-twolame \
                    --enable-vorbis \
                    --enable-x264

# Video Plugins

configure.args-append \
                    --without-x \
                    --disable-aa \
                    --disable-caca \
                    --disable-egl \
                    --disable-fontconfig \
                    --disable-freetype \
                    --disable-fribidi \
                    --disable-gles1 \
                    --disable-gles2 \
                    --disable-glx \
                    --disable-macosx-vout \
                    --disable-sdl \
                    --disable-sdl-image \
                    --disable-svg \
                    --disable-vdpau \
                    --disable-xcb \
                    --disable-xvideo

# Audio Plugins
depends_lib-append  \
                    port:libsamplerate

configure.args-append \
                    --disable-chromaprint  \
                    --disable-macosx-audio \
                    --enable-samplerate \
                    --disable-jack \
                    --disable-pulse

# Interface Plugins
depends_lib-append  \
                    port:ncurses

configure.args-append \
                    --disable-macosx \
                    --disable-macosx-dialog-provider \
                    --disable-qt \
                    --disable-skins2 \
                    --enable-ncurses

# Visualisations and Video Filter Plugins
configure.args-append \
                    --disable-goom \
                    --disable-projectm \
                    --disable-vsxu

# Service Discovery Plugins
depends_lib-append  \
                    port:avahi \
                    port:libupnp

configure.args-append \
                    --disable-mtp \
                    --disable-udev \
                    --enable-bonjour \
                    --enable-upnp

variant dbus description {Enable DBus support} {
    depends_lib-append      port:dbus
    configure.args-delete   --disable-dbus
    configure.args-append   --enable-dbus
}

variant pulse description {Enable PulseAudio support} {
    depends_lib-append      port:pulseaudio
    configure.args-delete   --disable-pulse
    configure.args-append   --enable-pulse
}

variant eyetv description {Enable eyetv plugin} {
    configure.args-delete --disable-macosx-eyetv
    configure.args-append --enable-macosx-eyetv
}

variant dvb description {enable DVB Program Specific Information support} {
    depends_lib-append      port:libdvbpsi
    configure.args-delete   --disable-dvbpsi
    configure.args-append   --enable-dvbpsi
}

variant fribidi requires osd description {Enable FriBidi Unicode support} {
    depends_lib-append      port:fribidi
    configure.args-delete   --disable-fribidi
    configure.args-append   --enable-fribidi
}

variant jack description {Enable jack plugin for audio output} {
    depends_lib-append      port:jack
    configure.args-delete   --disable-jack
    configure.args-append   --enable-jack
}

variant mod description {Enable MOD demuxer support} {
    depends_lib-append      port:libmodplug
    configure.args-delete   --disable-mod
    configure.args-append   --enable-mod
}

variant mpc description {enable Musepack Decoder library support} {
    depends_lib-append      port:libmpcdec
    configure.args-delete   --disable-mpc
    configure.args-append   --enable-mpc
}

variant osd description {Enable onscreen display and TrueType font support} {
    depends_lib-append      port:fontconfig port:freetype
    configure.args-delete   --disable-freetype --disable-fontconfig
    configure.args-append   --enable-freetype --enable-fontconfig
}

variant qtkit description {Enable qtcapture and qtaudio} {
    configure.args-delete   --disable-macosx-qtkit
    configure.args-append   --enable-macosx-qtkit
}

variant sdl description {Enable SDL/SDL-Image support} {
    depends_lib-append      port:libsdl port:libsdl_image
    configure.args-delete   --disable-sdl
    configure.args-append   --enable-sdl
}

variant shout description {Enable Shoutcast support} {
    depends_lib-append      port:libshout2
    configure.args-delete   --disable-shout
    configure.args-append   --enable-shout
}

variant smb description {Enable Samba 3 support} {
    depends_lib-append      port:samba3
    configure.args-delete   --disable-smbclient
    configure.args-append   --enable-smbclient
    configure.ldflags-append    -L${prefix}/lib/samba3
}

variant speex description {Enable Speex decoder support} {
    depends_lib-append      path:lib/libspeex.dylib:speex
    configure.args-delete   --disable-speex
    configure.args-append   --enable-speex
}

variant svg description {Enable SVG support} {
    depends_lib-append      port:librsvg
    configure.args-delete   --disable-svg
    configure.args-append   --enable-svg
}

variant vcd description {Enable VCD support} {
    depends_lib-append      port:vcdimager
    configure.args-delete   --disable-vcdx
    configure.args-append   --enable-vcdx
}

variant x11 {
    depends_lib-append \
        port:mesa \
        port:xorg-libXinerama \
        port:xorg-libXv \
        port:xorg-libXxf86vm \
        port:xorg-xcb-util \
        port:xorg-xcb-util-keysyms

    configure.args-delete   --without-x \
                            --disable-glx \
                            --disable-xcb \
                            --disable-xvideo
    configure.args-append   --with-x \
                            --x-include=${prefix}/include \
                            --x-lib=${prefix}/lib \
                            --enable-glx \
                            --enable-xcb \
                            --enable-xvideo
}

variant qt4 description {Build using QT4 UI. This will use qt4-mac} {
    configure.args-delete   --disable-qt
    configure.args-append   --enable-qt
    patchfiles-append       patch-vlc-qt4mac.diff

    PortGroup qt4 1.0

    post-activate {
        if {![variant_isset quartz]} {
            ui_info "The qt4 interface module for VLC is not very stable.  If you encounter bugs with it, please file them with VLC and not MacPorts."
        }
    }
}

variant quartz {
    patchfiles-append       patch-vlc-for-macports.diff

    depends_lib-append      port:BGHUDAppKit
    depends_lib-delete      port:libsamplerate
    configure.args-delete   --disable-macosx \
                            --disable-macosx-avfoundation \
                            --enable-samplerate
                            
    configure.args-append   --enable-macosx \
                            --enable-macosx-avfoundation
    # taken from VLC's own configure.sh script for OS X:
    configure.args-append   --disable-samplerate \
                            --enable-merge-ffmpeg \
                            --enable-realrtsp \
                            --enable-libass
}

default_variants +mod +mpc +osd +quartz

variant huge \
    requires dvb eyetv fribidi jack mod mpc osd sdl shout speex svg vcd pulse \
        description {Enable all variants except quartz, qt4, smb, and x11} {}

variant full \
    requires huge qt4 quartz smb x11 \
        description {Enable all variants} {}

platform macosx {
    default_variants-append +qtkit

    configure.args-delete \
        --disable-macosx-vout --disable-macosx-audio \

    configure.args-append \
        --enable-macosx-vout --enable-macosx-audio \
        --with-macosx-sdk=/

    if {[variant_isset qt4] || [variant_isset quartz]} {
        configure.args-delete --disable-macosx-vlc-app
        configure.args-append --enable-macosx-vlc-app
    }

    post-patch {
        reinplace "s/Appkit/AppKit/" ${worksrcpath}/configure.ac
        reinplace "/Sparkle.framework/d" \
            ${worksrcpath}/extras/package/macosx/vlc.xcodeproj/project.pbxproj
        reinplace "/SDKROOT/d" \
            ${worksrcpath}/extras/package/macosx/vlc.xcodeproj/project.pbxproj
        reinplace "/Growl.framework/d" \
            ${worksrcpath}/extras/package/macosx/package.mak

        reinplace "s:LD_LIBRARY_PATH:DYLD_LIBRARY_PATH:g" \
            ${worksrcpath}/Makefile.am

        reinplace "/argv/s/environ/*_NSGetEnviron()/" \
            ${worksrcpath}/modules/misc/inhibit/xdg.c \
            ${worksrcpath}/modules/stream_filter/decomp.c

        reinplace "s/extern char \\*\\*environ;/#include <crt_externs.h>/" \
            ${worksrcpath}/modules/misc/inhibit/xdg.c \
            ${worksrcpath}/modules/stream_filter/decomp.c

        ln -s ${frameworks_dir}/BGHUDAppKit.framework ${worksrcpath}/contrib/BGHUDAppKit.framework

        # To trick configure
        file mkdir "${worksrcpath}/contrib/lib"
    }

    post-destroot {
        eval file delete [glob ${destroot}${prefix}/lib/vlc/plugins/*/*.la]

        if {[variant_isset qt4] || [variant_isset quartz]} {
            file rename ${worksrcpath}/VLC.app ${destroot}${applications_dir}/VLC.app

            # These are already in ${prefix}, so we don't need to bundle them as well
            file delete -force ${destroot}${applications_dir}/VLC.app/Contents/Frameworks
            file delete -force ${destroot}${applications_dir}/VLC.app/Contents/lib

            # There's no need to install these into the bundle and the prefix
            file delete -force ${destroot}${applications_dir}/VLC.app/Contents/MacOS/include
            file delete -force ${destroot}${applications_dir}/VLC.app/Contents/MacOS/lib
            file delete -force ${destroot}${applications_dir}/VLC.app/Contents/MacOS/plugins

            # http://trac.macports.org/ticket/35131
            ln -s ${prefix}/lib ${destroot}${applications_dir}/VLC.app/Contents/MacOS/lib
            ln -s ${prefix}/lib/vlc/plugins ${destroot}${applications_dir}/VLC.app/Contents/MacOS/plugins
            # the vlc executable needs to be started with a full path to the app bundle executable
            # or else the Mac OS X interface will hang beyond even a ^C or ^\ :
            file delete ${destroot}${prefix}/bin/vlc
            set vlc [open "${workpath}/vlc" "w"]
            puts ${vlc} "#!/bin/sh"
            puts ${vlc} ""
            puts ${vlc} "exec ${applications_dir}/VLC.app/Contents/MacOS/VLC \"$@\""
            close ${vlc}
            xinstall -m 755 ${workpath}/vlc ${destroot}${prefix}/bin
        }
    }
}
