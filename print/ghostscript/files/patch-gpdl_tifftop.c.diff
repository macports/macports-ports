--- gpdl/tifftop.c.orig	2020-02-24 12:57.000000000 +0000
+++ gpdl/tifftop.c	2020-06-06 20:16:09.000000000 -0700
@@ -26,9 +26,12 @@
 #include "gspaint.h"
 #include "plmain.h"
 #include "tiffio.h"
-#include "jmemcust.h"
 #include "gsmchunk.h"
 
+#if defined(SHARE_JPEG) && SHARE_JPEG==0
+#include "jmemcust.h"
+#endif
+
 /* Forward decls */
 
 /************************************************************/
@@ -90,7 +93,10 @@
 
     byte              *samples;
     byte              *proc_samples;
+
+#if defined(SHARE_JPEG) && SHARE_JPEG==0
     jpeg_cust_mem_data jmem;
+#endif
 } tiff_interp_instance_t;
 
 static int
@@ -421,7 +427,8 @@
     return tiff->buffer_full;
 }
 
-#if defined(SHARE_LIBTIFF) && SHARE_LIBTIFF==0
+#if defined(SHARE_LIBTIFF) && SHARE_LIBTIFF==0 \
+    && defined(SHARE_JPEG) && SHARE_JPEG==0
 static void *gs_j_mem_alloc(j_common_ptr cinfo, size_t size)
 {
     gs_memory_t *mem = (gs_memory_t *)(GET_CUST_MEM_DATA(cinfo)->priv);
@@ -472,7 +479,7 @@
 
     return &tiff->jmem;
 }
-#endif /* SHARE_LIBTIFF == 0 */
+#endif /* SHARE_LIBTIFF == 0 && SHARE_JPEG == 0 */
 
 static int
 guess_pal_depth(int n, uint16_t *rmap, uint16_t *gmap, uint16_t *bmap)
@@ -619,7 +626,8 @@
                 tiff->photometric == PHOTOMETRIC_LOGLUV) {
                 TIFFSetField(tiff->handle, TIFFTAG_SGILOGDATAFMT, SGILOGDATAFMT_8BIT);
             }
-#if defined(SHARE_LIBTIFF) && SHARE_LIBTIFF==0
+#if defined(SHARE_LIBTIFF) && SHARE_LIBTIFF==0 \
+    && defined(SHARE_JPEG) && SHARE_JPEG==0
             TIFFSetJpegMemFunction(tiff->handle,
                                    &tiff_jpeg_mem_callback);
 #endif
