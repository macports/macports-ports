# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                claude-code
version             2.1.50
revision            0

categories          llm
maintainers         {breun @breun} openmaintainer
license             Restrictive NoMirror
supported_archs     x86_64 arm64

description         Claude Code -- Anthropic's agentic coding tool that lives in your terminal
long_description    Claude Code is an agentic coding tool that lives in your \
                    terminal, understands your codebase, and helps you code \
                    faster by executing routine tasks, explaining complex \
                    code, and handling git workflows - all through natural \
                    language commands.

homepage            https://claude.com/product/claude-code

# https://code.claude.com/docs/en/setup
# Operating Systems: macOS 13.0+
platforms           {darwin >= 22}

if {${configure.build_arch} eq "x86_64"} {
    set arch_classifier x64
    checksums    rmd160  ff6d52f57f16a30d6f7c9fb9a1b6dd916f44f6e5 \
                 sha256  2215818c6e2a4fa0497ee88a19f8d84b91f0bb29cc4150a30aa775f75ba2133c \
                 size    190259936
} elseif {${configure.build_arch} eq "arm64"} {
    set arch_classifier arm64
    checksums    rmd160  741256c022b76f511ff5ee0980fd3a6c7381d94a \
                 sha256  4b6c1cb5e02428dbf600d08f88c28f9ea06619001c3efebf8890365e5b79d1b7 \
                 size    185138720
} else {
    set arch_classifier unsupported_arch
    distfiles
}

# GCS bucket URL from https://claude.ai/install.sh
set claude_code_releases https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases

master_sites        ${claude_code_releases}/${version}/darwin-${arch_classifier}/

distname            claude
dist_subdir         ${name}/${version}-${os.platform}-${arch_classifier}

extract.suffix
extract {
    # There is nothing to extract, just copy the downloaded distfiles to worksrcpath
    xinstall -d ${worksrcpath}
    xinstall -m 755 ${distpath}/${distfiles} ${worksrcpath}
}

use_configure       no
build {}

test.run    yes
test.cmd    ./claude
test.target
test.args   --version

destroot {
    set binary_dir ${prefix}/share/${name}
    set binary ${binary_dir}/claude

    # Install binary
    xinstall -d ${destroot}${binary_dir}
    xinstall -m 755 ${worksrcpath}/claude ${destroot}${binary}

    # Create launch script
    set launch_script [open ${destroot}${prefix}/bin/claude w 0755]
    puts $launch_script "#!/bin/sh"
    puts $launch_script "DISABLE_AUTOUPDATER=1 DISABLE_TELEMETRY=1 ${binary} $@"
    close $launch_script
}

livecheck.type      regex
livecheck.url       ${claude_code_releases}/latest
livecheck.regex     ^(\[\\d.\]+)$
