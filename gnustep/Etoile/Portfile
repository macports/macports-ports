# $Id$

PortSystem  1.0
PortGroup   gnustep 1.0

name            Etoile
version         0.1.9
revision        2
platforms       darwin
maintainers     yves@macports.org
homepage        http://www.etoile-project.org/

description     GNUstep based user environnement
long_description \
    Etoile intends to be an innovative GNUstep-based user environment \
    built from the ground up on highly modular and light components \
    with project and document orientation in mind.
    
fetch.type      svn
svn.tag         1993
svn.url         http://svn.gna.org/svn/etoile/stable/Etoile

####################### DEVELOPMENT FETCH ##############################
#fetch {
#    file copy ${portpath}/Etoile ${workpath}
#}
########################################################################

depends_build       bin:svn:subversion
depends_lib         port:SQLClient \
                    port:dbus \
                    port:oniguruma5 \
                    port:poppler

worksrcdir          ${name}

patchfiles          patch-etoile.make \
                    patch-PopplerKit-GNUmakefile \
                    patch-PopplerKit-config.sh \
                    patch-xmpp-GNUmakefile \
                    patch-AddressManager-GNUmakefile

array set gnustep.post_flags {
    Frameworks/AddressesKit/Frameworks/AddressView  -lAddresses
    Frameworks/BookmarkKit                          -lCollectionKit
    Frameworks/SystemConfig                         -lX11
}

post-patch {
    reinplace "s|SCSound.m||" \
        ${worksrcpath}/Frameworks/SystemConfig/Source/GNUmakefile
    reinplace "s|/usr|${prefix}|g" \
        ${worksrcpath}/Services/Private/System/GNUmakefile
    reinplace "s|\$(GNUSTEP_INSTALLATION_DIR)|${destroot}${prefix}/GNUstep/Local|g" \
		Services/User/Grr/Components/ArticleOperations/GNUmakefile \
		Services/User/Grr/Components/ArticleTable/GNUmakefile \
		Services/User/Grr/Components/ArticleView/GNUmakefile \
		Services/User/Grr/Components/DatabaseOperations/GNUmakefile \
		Services/User/Grr/Components/DatabaseTreeView/GNUmakefile \
		Services/User/Grr/Components/Fonts/GNUmakefile \
		Services/User/Grr/Components/Proxy/GNUmakefile \
		Services/User/Grr/Components/Searching/GNUmakefile \
		Services/User/Grr/Components/SubscriptionPanel/GNUmakefile \
		Services/User/Grr/Components/TreeDatabase/GNUmakefile \
		Services/User/Grr/Components/URLOpening/GNUmakefile \
		Services/User/Grr/Development/Deprecated/ArticleDatabase/GNUmakefile \
		Services/User/Grr/Development/Deprecated/FeedTable/GNUmakefile
}

build.args      azalea=no background=no dock=no login=no corner=no idle=no azswitch=no \
                jabber=no outerspace=no sketch=no
destroot.args   azalea=no background=no dock=no login=no corner=no idle=no azswitch=no \
                jabber=no outerspace=no sketch=no

post-destroot {
    cd ${destroot}${prefix}
    xinstall -d GNUstep/Local/Library/Themes
    copy ${worksrcpath}/Bundles/Camaelon/Nesedah.theme \
        GNUstep/Local/Library/Themes
    copy ${worksrcpath}/Services/User/Calc/Calc.app \
        GNUstep/Local/Applications
    cd GNUstep/Local/Tools
    ln -s ../Applications/Calc.app/Calc
    cd ../Library/Headers
    delete AddressBook
    ln -s Addresses AddressBook
}

variant enable_unstable_services {
    # We don't build corner because StepTalk is not available yet in MP
    build.args-delete       azalea=no background=no dock=no login=no idle=no azswitch=no \
                            jabber=no outerspace=no sketch=no
    destroot.args-delete    azalea=no background=no dock=no login=no idle=no azswitch=no \
                            jabber=no outerspace=no sketch=no
    build.args-append       debug=yes
    destroot.args-append    debug=yes

    post-destroot {
        cd ${destroot}${prefix}
        xinstall -d GNUstep/System/Library/Etoile
        xinstall -m 644 ${worksrcpath}/Services/Private/System/SystemTaskList.plist \
            GNUstep/System/Library/Etoile
        xinstall -d share/xsessions
        xinstall -m 644 ${worksrcpath}/Services/Private/System/etoile.desktop \
            share/xsessions
        set chan [open bin/etoile w]
		puts $chan ". ${prefix}/GNUstep/System/Library/Makefiles/GNUstep.sh; etoile_system"
		close $chan
		file attributes bin/etoile -permissions 0755
    }
}

