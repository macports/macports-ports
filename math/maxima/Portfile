# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem 1.0

name            maxima
categories      math
maintainers     {mareimbrium.org:kuba @KubaO} openmaintainer
platforms       darwin
license         GPL-2+
description     The Maxima computer algebra system
long_description \
        Maxima is a system for the manipulation of symbolic \
        and numerical expressions, including differentiation, \
        integration, Taylor series, Laplace transforms, ordinary \
        differential equations, systems of linear equations, \
        polynomials, and sets, lists, vectors, matrices, and \
        tensors. Maxima yields high precision numeric results \
        by using exact fractions, arbitrary precision integers, \
        and variable precision floating point numbers. Maxima \
        can plot functions and data in two and three dimensions. \
        Maxima includes the following commands: \
        * \"rmaxima\" is a front end which provides advanced line-editing \
        facilities via rlwrap. \
        * \"xmaxima\" is a graphical interface for maxima, written in Tcl/Tk.

homepage        http://maxima.sourceforge.net/

depends_lib     port:sbcl
depends_build   port:texinfo
depends_run     port:rlwrap \
                port:recode \
                port:gnuplot

subport maxima-devel {
    conflicts   maxima

    # git describe --tags : branch-xxx???
    # Date:  Fri 17 Jan 2020 23:17:31 CET
    # commit 1a9e53f9fe5489763a7a8129229f44eed5bb3d81
    version     5.43-dev-20200117
    revision    0
    fetch.type  git
    git.url     https://git.code.sf.net/p/maxima/code
    git.branch  1a9e53f9fe5489763a7a8129229f44eed5bb3d81

    use_autoreconf  yes

    livecheck.type  none
}

if {${subport} eq ${name}} {
    conflicts   maxima-devel

    version     5.43.0
    revision    0
    # get the source tarball from sourceforge.
    master_sites    sourceforge:project/maxima/Maxima-source/${version}-source

    checksums   rmd160  d9c8a36f9449397653ec198bae3b4738dd895b38 \
                sha256  dcfda54511035276fd074ac736e97d41905171e43a5802bb820914c3c885ca77 \
                size    34605709

    livecheck.regex     {<title>.*/Maxima-source/(.*)-source/maxima.*</title>}
}

patchfiles      src_maxima.in.patch build_html.sh.in.patch

configure.args  --infodir=${prefix}/share/info \
                --mandir=${prefix}/share/man \
                --enable-sbcl-exec

if {${os.platform} ne "darwin" && ${os.arch} ne "i386"} {
variant clisp description {Use CLISP instead of SBCL for Lisp} {
    depends_lib-delete  port:sbcl
    depends_lib-append  port:clisp
    configure.args-delete --enable-sbcl-exec
    configure.args-append --enable-clisp
}
}

variant xmaxima description {build xmaxima} {
    depends_run-append  port:tk
}
default_variants +xmaxima
if {![variant_isset xmaxima]} {
    patchfiles-append   no-xmaxima.patch
}

variant abcl description {Use ABCL instead of SBCL for Lisp} {
    depends_lib-delete  port:sbcl
    depends_lib-append  port:abcl
    configure.args-delete --enable-sbcl-exec
    configure.args-append --enable-abcl --with-abcl-jar=${prefix}/share/java/abcl/abcl.jar
}

test.run    yes
test.target check

variant printable_doc description {Build printable documentation} {
    # Try to use the ystem TeX if possible
    # Check if cm-super fonts available
    set maxima.cmsuper ""
    if {[auto_execok kpsewhich] ne ""} {
        if {![catch {exec kpsewhich ecrm1000.tfm} result]} {
            set maxima.cmsuper ${result}
        }
    }
    if {${maxima.cmsuper} eq ""} {
        depends_build-append port:texlive-fonts-recommended
    }

    depends_build-append    bin:makeinfo:texinfo \
                            bin:dvips:texlive-basic \
                            bin:pdflatex:texlive-latex \
                            bin:tex:texlive-plain-generic 

    build.target            all pdf

    pre-destroot {
        xinstall -d -m 755 ${destroot}${prefix}/share/${name}/${version}/doc/pdf
        xinstall -m 644 ${worksrcpath}/doc/info/maxima.pdf \
                        ${destroot}${prefix}/share/${name}/${version}/doc/pdf
    }
}
