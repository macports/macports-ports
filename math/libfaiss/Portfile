# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           compilers 1.0
PortGroup           github 1.0

github.setup        facebookresearch faiss 1.5.3 v
name                libfaiss

categories          math
license             MIT
platforms           darwin
maintainers         {@beauby fb.com:hoss} {@mdouze fb.com:matthijs} \
                    openmaintainer

description         A library for efficient similarity search and clustering of dense vectors.

long_description    Faiss is a library for efficient similarity search\
                    and clustering of dense vectors. It contains\
                    algorithms that search in sets of vectors of any\
                    size, up to ones that possibly do not fit in\
                    RAM. It also contains supporting code for\
                    evaluation and parameter tuning. Faiss is written\
                    in C++ with complete wrappers for\
                    Python/numpy. Some of the most useful algorithms\
                    are implemented on the GPU. It is developed by\
                    Facebook AI Research.

checksums           rmd160  3b1180dc7ceadc484bb86cfe32fb5cd1c4a694b9 \
                    sha256  6962641a9183e12d394aa2f9c443593734a373d60c61fd0633edda5029d2fa78 \
                    size    2762193

depends_lib-append  port:libomp

post-extract {
    # fix destroot commands like `$(PYTHON) setup.py install`
    reinplace -E \
        "s|^(\[\[:space:]]+\\\$\\(PYTHON\\)\[\[:space:]]+setup\.py\[\[:space:]]+)(install)|\\1 --no-user-cfg \\2 ${destroot.destdir}|" \
        ${worksrcpath}/python/Makefile
}

compilers.choose    cxx
# The Apple native llvm compiler does not support OpenMP
compiler.blacklist  llvm-gcc-4.2
compiler.fallback   macports-gcc-9
compilers.setup

configure.args-append \
                    --without-cuda
configure.cppflags-append \
                    -I${prefix}/include/libomp
configure.cflags-append \
                    -fPIC -m64 -Wall -g -O3 -msse4 -mpopcnt -fopenmp \
                    -Wno-sign-compare -std=c++11
configure.ldflags-append \
                    -g -fPIC -fopenmp -L${prefix}/lib/libomp
configure.cxx_stdlib libstdc++

build.env-append    SHAREDEXT=dylib \
                    "SHAREDFLAGS=-Wl,-F. -bundle -undefined dynamic_lookup" \
                    FAISSSHAREDFLAGS=-dynamiclib \
                    BLASCFLAGS=-DFINTEGER=int \
                    "BLASLDFLAGS=-framework Accelerate"

build.target        libfaiss.a libfaiss.dylib

variant openblas description {Use OpenBLAS instead of Apple's Accelerate framework} {
    depends_lib-append  port:openblas
    build.env-delete    "BLASLDFLAGS=-framework Accelerate"
    build.env-append    BLASLDFLAGS=${prefix}/lib/libopenblas.dylib
}

default_variants +openblas

test.run            yes
test.target         all
test.pre_args       -C tests ${test.target}
