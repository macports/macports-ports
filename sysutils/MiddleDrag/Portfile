# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           xcode 1.0
PortGroup           xcodeversion 1.0

github.setup        nullpointerdepressivedisorder MiddleDrag 1.3.8.6 v
github.tarball_from archive
revision            0
categories          sysutils
maintainers         {@nullpointerdepressivedisorder eagereverest.com:fear.silver7589} \
                    openmaintainer
license             MIT
homepage            https://middledrag.app
description         Three-finger trackpad gestures for middle-click and middle-drag on macOS
long_description    Mac trackpads don't have a middle mouse button. Many apps expect one. \
                    MiddleDrag fixes this. Three-finger tap for middle-click. Three-finger \
                    drag for middle-drag. Works alongside Mission Control and other system \
                    gestures.

platforms           {darwin >= 24}
supported_archs     x86_64 arm64

use_configure       no
use_xcode           yes

minimum_xcodeversions {24 16.4 25 16.4 26 16.4}

checksums           rmd160 5c9b5d63500281659c1bd923b7ca4125f1e2dae3 \
                    sha256 8a86bcb1751e529e1f096c9dd73f75ba3c7074447705dfb3c8d8d3308b4c7c20 \
                    size 7907617

xcode.scheme        MiddleDrag
xcode.configuration Release
xcode.destroot.type none

# Set SPM package cache directories to avoid sandbox issues
# Use work directory for package cache so it's accessible
set spm_cache_dir    ${workpath}/spm-cache
set spm_clone_dir    ${workpath}/spm-cloned

# Use build.pre_args for xcodebuild command-line flags (SPM cache paths)
build.pre_args      -skipPackageUpdates \
                    -packageCachePath ${spm_cache_dir} \
                    -clonedSourcePackagesDirPath ${spm_clone_dir}

xcode.build.settings \
                    OTHER_LDFLAGS='-F/System/Library/PrivateFrameworks -framework MultitouchSupport -framework CoreFoundation -framework CoreGraphics' \
                    FRAMEWORK_SEARCH_PATHS='/System/Library/PrivateFrameworks' \
                    CODE_SIGN_IDENTITY=- \
                    CODE_SIGNING_REQUIRED=NO \
                    ENABLE_USER_SCRIPT_SANDBOXING=NO \
                    OTHER_SWIFT_FLAGS=-disable-sandbox \
                    XCODEFLAGS="CACHE_ROOT=${workpath}/caches"

pre-build {
    # Create cache directories for xcodebuild and SPM to avoid sandbox issues
    file mkdir ${workpath}/caches
    file mkdir ${spm_cache_dir}
    file mkdir ${spm_clone_dir}
    
    # Try to resolve Swift Package Manager dependencies before build using cache directories
    catch {
        system "cd ${worksrcpath} && /usr/bin/xcodebuild -scheme MiddleDrag -resolvePackageDependencies -skipPackageUpdates -packageCachePath ${spm_cache_dir} -clonedSourcePackagesDirPath ${spm_clone_dir} 2>/dev/null || true"
    }
}

post-build {
    # Clean up temporary directories created by xcodebuild/SPM that may have wrong permissions
    catch {
        if {[file exists ${worksrcpath}/.tmp]} {
            file delete -force ${worksrcpath}/.tmp
        }
    }
}

destroot {
    copy ${worksrcpath}/build/Release/MiddleDrag.app \
        ${destroot}${applications_dir}/MiddleDrag.app
}

notes "
MiddleDrag requires Accessibility permissions to function.
After launching, grant permission in:
System Settings > Privacy & Security > Accessibility
"

