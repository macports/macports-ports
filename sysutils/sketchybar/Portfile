# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               makefile 1.0
PortGroup               xcodeversion 1.0

github.setup            FelixKratz SketchyBar 2.11.1 v

categories              sysutils
maintainers             {@bashu gmail.com:bashu.was.here} openmaintainer
license                 GPL-3
name                    sketchybar
description             Custom macOS statusbar with shell plugin, interaction and graph support
long_description        This bar project aims to create a highly flexible, \
                        customizable, fast and powerful status bar replacement \
                        for people that like playing with shell scripts.

checksums               rmd160  5a56e186bf8343f3ece20b10ba06f296531134ba \
                        sha256  66f3c02ca82cdc1659188cbe72695a8a9c2ea94fb22dcbc77c55f02bea2ae59c \
                        size    2907648

set sketchybar.plist    ${workpath}/org.macports.sketchybar.plist

post-patch {
    # Fill in startup plist template
    copy -- ${filespath}/org.macports.sketchybar.plist.in ${sketchybar.plist}
    reinplace "s|@PREFIX@|${prefix}|g" ${sketchybar.plist}
}

destroot {
    # Copy binary
    xinstall -m 755 ${worksrcpath}/bin/sketchybar ${destroot}${prefix}/bin/sketchybar

    # Copy example files
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/examples
    copy ${worksrcpath}/plugins ${destroot}${prefix}/share/doc/${name}/examples
    copy ${worksrcpath}/sketchybarrc ${destroot}${prefix}/share/doc/${name}/examples

    # Install our custom plist
    set launchd_dir ${prefix}/etc/${startupitem.location}/${startupitem.uniquename}
    xinstall -m 755 -d ${destroot}/${launchd_dir}
    xinstall -m 644 ${sketchybar.plist} ${destroot}/${launchd_dir}/${startupitem.plist}

    if {[getuid] == 0 && ${startupitem.install} ne "no"} {
        file mkdir ${destroot}/Library/${startupitem.location}
        ln -sf ${launchd_dir}/${startupitem.plist} ${destroot}/Library/${startupitem.location}
    } else {
        ln -sf ${launchd_dir}/${startupitem.plist} ${destroot}${prefix}/etc/${startupitem.location}
    }
}

set minxcodever 8.0
if {([vercmp $xcodeversion ${minxcodever}] < 0)} {
    known_fail yes
    pre-fetch {
        ui_error "${name} ${version} requires Xcode ${minxcodever} or greater to build."
        return -code error "incompatible Xcode version"
    }
}

notes "
Copy the example configuration into your home directory and make the scripts executable:

     mkdir ~/.config/${name}
     cp ${prefix}/share/doc/${name}/examples/sketchybarrc ~/.config/${name}/sketchybarrc

     mkdir ~/.config/${name}/plugins
     cp -r ${prefix}/share/doc/${name}/examples/plugins/ ~/.config/${name}/plugins/

     chmod +x ~/.config/${name}/plugins/*
"

startupitem.create      no
startupitem.autostart   no
startupitem.location    LaunchAgents
startupitem.executable  ${prefix}/bin/sketchybar
