# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                chrony
version             3.2
categories          sysutils net
license             GPL-2
platforms           darwin
maintainers         @ldldr openmaintainer

description         Chrony is a versatile implementation of the \
                    Network Time Protocol (NTP)
long_description    Chrony can synchronize the system clock with NTP \
    servers, reference clocks, and manual input. It can also operate \
    as an NTPv4 (RFC 5905) server and peer to provide a time service \
    to other computers in the network. \
    It is designed to perform well in a wide range of conditions, \
    including intermittent network connections, heavily congested \
    networks, changing temperatures (ordinary computer clocks are \
    sensitive to temperature), and systems that do not run \
    continuosly, or run on a virtual machine.

homepage            https://chrony.tuxfamily.org/
master_sites        http://download.tuxfamily.org/chrony/
checksums           rmd160  c25f7e84cd82940631bc0a1c7abfb71e7a797e21 \
                    sha256  329f6718dd8c3ece3eee78be1f4821cbbeb62608e7d23f25da293cfa433c4116 \
                    size    433882

depends_lib         port:readline

configure.args      --sysconfdir=${prefix}/etc \
                    --localstatedir=${prefix}/var \
                    --with-sendmail=/usr/sbin/sendmail \
                    --with-pidfile=${prefix}/var/run/${name}/chronyd.pid

post-build {
    # This creates the helper application, chrony-netchanged, which monitors
    # the network state and switches chronyd on when an internet link comes up
    # and off when it goes down.
    system -W ${worksrcpath} "${configure.cc} ${configure.cflags} [get_canonical_archflags cc] \
        -DPREFIX=\\\"${prefix}\\\" -framework CoreFoundation -framework SystemConfiguration \
        -o chrony-netchanged ${filespath}/chrony-netchanged.c"
}

post-destroot {
    xinstall -m 755 ${worksrcpath}/chrony-netchanged ${destroot}${prefix}/sbin/chrony-netchanged

    xinstall -m 755 -d ${destroot}${prefix}/etc/${name}
    xinstall -m 0644 ${filespath}/${name}.conf.in \
            ${destroot}${prefix}/etc/${name}/${name}.conf-dist
    reinplace "s|@PREFIX@|${prefix}|" ${destroot}${prefix}/etc/${name}/${name}.conf-dist
    xinstall -m 0755 ${filespath}/${name}-netchange.in \
            ${destroot}${prefix}/etc/${name}/${name}-netchange
    reinplace "s|@PREFIX@|${prefix}|" ${destroot}${prefix}/etc/${name}/${name}-netchange

    xinstall -m 770 -g wheel -d ${destroot}${prefix}/var/run/${name}
}

destroot.keepdirs   ${destroot}${prefix}/var/run/${name}

post-activate {
    if {![file exists ${prefix}/etc/${name}/${name}.conf]} {
        file copy ${prefix}/etc/${name}/${name}.conf-dist ${prefix}/etc/${name}/${name}.conf
    }
}

startupitem.create  yes
startupitem.pidfile auto ${prefix}/var/run/${name}/chronyd.pid

# Start chronyd and chrony-netchanged and monitor the reachability
# of the first NTP server found in chrony.conf:
startupitem.start   \
	"${prefix}/sbin/chronyd -r -s -f ${prefix}/etc/${name}/${name}.conf
	sleep 2
	target=\$(test -f ${prefix}/etc/${name}/${name}.conf && awk '/^\s*(pool|server)/ {print \$2; exit}' ${prefix}/etc/${name}/${name}.conf)
	if ! ( \[ -e ${prefix}/var/run/chrony-netchanged.pid \] && kill -0 \$(cat ${prefix}/var/run/chrony-netchanged.pid) 2>/dev/null ) ; then
		${prefix}/sbin/chrony-netchanged \$target &
		/bin/echo -n \$! > ${prefix}/var/run/${name}/chrony-netchanged.pid
	fi"

startupitem.stop    \
	"/bin/kill \$(cat ${prefix}/var/run/${name}/chronyd.pid)
	/bin/kill \$(cat ${prefix}/var/run/${name}/chrony-netchanged.pid)
	/bin/rm -f ${prefix}/var/run/${name}/chrony-netchanged.pid"

livecheck.type      regex
livecheck.url       ${homepage}download.html
livecheck.regex     {chrony-(\d+\.\d+(\.\d+)?)}
