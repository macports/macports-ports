# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           select 1.0

name                opentofu
categories          sysutils
maintainers         {@graywolf wolfsden.cz:~+macports} openmaintainer
license             MPL-2

homepage            https://opentofu.org/

installs_libs       no

# Shamelessly inspired by terraform's Portfile
proc opentofuBaseVersion {} {
    global subport
    return [lindex [split ${subport} "-"] 1]
}

proc opentofuVersion {} {
    global patchNumber
    return [opentofuBaseVersion].${patchNumber}
}

proc opentofuDistBase {} {
    global name
    return tofu_[opentofuVersion]_darwin
}

# *NOTE* Remember to update `latestVersion` on a version upgrade.
set latestVersion       opentofu-1.9

subport opentofu-1.9 {
    set patchNumber 0
    revision        0

    checksums       [opentofuDistBase]_amd64.tar.gz \
                    rmd160  7c3446f9f1148ff48f9366076f8500319c8c47b5 \
                    sha256  164e340b78e2799965022d28525be253d1e0ce9b91a020cbb2468bbdaebb68d0 \
                    size    26079736 \
                    [opentofuDistBase]_arm64.tar.gz \
                    rmd160  86ff99cf82bb71956b91fcd6abbb1043eea595f0 \
                    sha256  c1d3c0a5c9151bac8af48492ee735fcde2a6d27c5a3da056be2d2f3c242f07a6 \
                    size    24617378
}

subport opentofu-1.8 {
    set patchNumber 8
    revision        0

    checksums       [opentofuDistBase]_amd64.tar.gz \
                    rmd160  574f8be74cd6a9d252ceb4172daa9b7b133f74be \
                    sha256  9dd27362eb247abe181b6825ae72af37bc0b9e4dc74df2392dc681761fef520f \
                    size    26008291 \
                    [opentofuDistBase]_arm64.tar.gz \
                    rmd160  7bf8f69f8527032dacbc44c0fbea24d98faf69e0 \
                    sha256  dab912199ff7703c8ce8e7679dcac57a18f9bfc2f60a12454c82e74a3e24ca78 \
                    size    24556716
}

subport opentofu-1.7 {
    set patchNumber 7
    revision        0

    checksums       [opentofuDistBase]_amd64.tar.gz \
                    rmd160  799695b039d6a9108bcd86553b3d580a66992e48 \
                    sha256  94fdd023c38ee2f1765fec43eff59ed1a91b24e10a517b31de128eccc0b8fd24 \
                    size    25922637 \
                    [opentofuDistBase]_arm64.tar.gz \
                    rmd160  cb6d471cdcc681a0cea84bb21e6706595d8c7fbe \
                    sha256  7253fbb4fd2448e0480d6f3f567c569b108507ddfc6fc1c6c2e956eddaba11d7 \
                    size    24471570
}
subport opentofu_select {}

if {${subport} eq ${name}} {
    PortGroup           obsolete 1.0

    replaced_by         ${latestVersion}
    version             1.9.0
    revision            0

} elseif {${subport} eq "opentofu_select"} {
    version         0.0.0
    revision        0
    supported_archs noarch
    platforms       any

    description     Common files for selecting the default opentofu \
                    version
    long_description \
        This port installs files that allow 'port select' \
        to create links to the preferred default version of opentofu.
    homepage        https://www.macports.org/

    conflicts       tenv

    distfiles
    use_configure   no
    build {}

    destroot {
        select::install opentofu ${filespath}/base
        select::install opentofu ${filespath}/none
    }

    livecheck.type  none
} else {
    set baseVersion [opentofuBaseVersion]
    set baseName    opentofu-${baseVersion}

    version         [opentofuVersion]

    supported_archs x86_64 arm64

    distname        [opentofuDistBase]_amd64
    if {${build_arch} eq "arm64"} {
        distname    [opentofuDistBase]_arm64
    }

    depends_run     port:opentofu_select

    description     A tool for building, changing, and versioning \
                    infrastructure safely and efficiently.
    long_description \
                    OpenTofu is an open source fork of Terraform.  It      \
                    allows users to define a datacenter infrastructure in  \
                    a high-level configuration language, from which it can \
                    create an execution plan to build the infrastructure   \
                    in a service provider such as AWS.

    master_sites    https://github.com/${name}/${name}/releases/download/v${version}

    use_configure   no
    extract.mkdir   yes

    select.group    opentofu
    select.file     ${workpath}/${baseName}

    build {
        file copy ${filespath}/opentofu-XX.template ${workpath}/${baseName}
        reinplace "s|@@BASE_VERSION@@|${baseVersion}|g" ${workpath}/${baseName}
    }

    destroot {
        xinstall ${worksrcpath}/tofu \
            ${destroot}${prefix}/bin/tofu-${baseVersion}
    }

    set regexVersionPart [string map {. {\.}} $baseVersion]
    livecheck.type  regex
    livecheck.url   https://github.com/opentofu/opentofu/tags.atom
    livecheck.regex title>v(${regexVersionPart}\\.\\d+)</title

    notes "
    To make this the default opentofu run:
        sudo port select --set opentofu ${baseName}
    "
}
