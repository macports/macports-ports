# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

set my_name         gnupg
name                ${my_name}2
version             2.2.12
revision            1
categories          mail security
maintainers         {jann @roederja} {ionic @Ionic} openmaintainer
license             GPL-3+
installs_libs       no

description         GNU Privacy Guard
long_description    GnuPG is a complete and free replacement for PGP. Because       \
                    it does not use the patented IDEA algorithm, it can be used     \
                    without any restrictions. GnuPG is a RFC4880 (OpenPGP)          \
                    compliant application.
homepage            https://www.gnupg.org
platforms           darwin freebsd sunos
conflicts           ${my_name}1
distname            ${my_name}-${version}
master_sites        ${my_name}:${my_name}

use_bzip2           yes

checksums           rmd160  4da4303a12a55111de9cd100ab0fdb30b28a4e00 \
                    sha256  db030f8b4c98640e91300d36d516f1f4f8fe09514a94ea9fc7411ee1a34082cb \
                    size    6682303

platform darwin {
    if {![variant_isset pinentry] && ![variant_isset pinentry_mac]} {
        # Automatically switch between pinentry and pinentry-mac, with pinentry-mac being
        # preferred.
        # 10.7 and below are not supported by pinentry-mac, though, and will default to
        # pinentry. Just like pure darwin without OS X will.
        if {${os.subplatform} ne "macosx" ||
            ${xcodeversion} eq "none" ||
            [vercmp ${xcodeversion} {5.0}] < 0 ||
            ${os.major} < 12 || (![catch {registry_active pinentry}] &&
                                 [catch {registry_active pinentry-mac}])} {
            default_variants-append +pinentry
        } else {
            default_variants-append +pinentry_mac
        }
    }

    if {${os.major} < 9} {
        patchfiles-append   patch-common_sysutils.c-fix-unsetenv-usage-on-10.4.diff
    }
}

depends_build       port:pkgconfig

depends_lib         port:libiconv           \
                    port:gettext            \
                    port:zlib               \
                    port:bzip2              \
                    port:libassuan          \
                    port:libksba            \
                    port:libgcrypt          \
                    port:libgpg-error       \
                    port:readline           \
                    port:gnutls             \
                    port:libusb-compat      \
                    port:npth               \
                    port:sqlite3

post-destroot {
    ln -s ${prefix}/bin/gpg ${destroot}${prefix}/bin/gpg2
}

variant pinentry conflicts pinentry_mac description {Handle user input via pinentry.} {
    depends_lib-append      port:pinentry
    configure.args-append   --with-pinentry-pgm=${prefix}/bin/pinentry
}

variant pinentry_mac conflicts pinentry description {Handle user input via pinentry-mac. Only compatible with OS X 10.8+.} {
    depends_lib-append      port:pinentry-mac
    configure.args-append   --with-pinentry-pgm=${applications_dir}/pinentry-mac.app/Contents/MacOS/pinentry-mac
}

configure.args-append --disable-openldap
variant openldap description {Support openldap} {
    depends_lib-append      port:openldap
    configure.args-replace  --disable-openldap --enable-openldap
}

default_variants    +openldap

test.run            yes
test.dir            ${worksrcpath}/tests
test.target         check

livecheck.type      regex
livecheck.url       https://gnupg.org/ftp/gcrypt/${my_name}/
livecheck.regex     ${my_name}-(\\d+(?:\\.\\d+)*)
