# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.0

name                rspamd
version             1.9.2
revision            0
categories          mail
license             BSD
maintainers         nomaintainer
platforms           darwin
description         Rspamd filtering system is created as a replacement of popular spamassassin \
    spamd and is designed to be fast, modular and easily extendable system.
long_description    ${description}  Rspamd core is written in C language using event driven \
    paradigma. Plugins for rspamd can be written in lua. Rspamd is designed to \
    process connections completely asynchronous and do not block anywhere in code.
homepage            http://rspamd.com

platforms           darwin
supported_archs     noarch
license             Apache-2

master_sites        https://github.com/rspamd/rspamd/archive
distname            ${version}
extract.suffix      .tar.gz
worksrcdir          rspamd-${version}

# wget https://github.com/rspamd/rspamd/archive/1.9.2.tar.gz
# openssl dgst -rmd160 1.9.2.tar.gz
# openssl dgst -sha256 1.9.2.tar.gz

checksums           rmd160  0343495b976a97275e015256ddfc307b8ace176a \
    sha256  69a39cb83a4d28da2fc2fc2dc7c8e07435557e50e19cfdf73bd1ebd964da80f9

## Add ragel dependence after this issue resolved https://trac.macports.org/ticket/58321#comment:6
## In the meantime, roll back to 6.10
## git clone --single-branch https://github.com/macports/macports-ports.git
## cd macports-ports/
## git checkout 4b72f12e19e746d94db029eb72d78169e1bf7649
## cd lang/ragel
## sudo port install
# depends_build-append port:pkgconfig port:ragel
depends_build-append port:pkgconfig port:luajit
depends_lib         port:libevent \
    path:lib/pkgconfig/glib-2.0.pc:glib2 \
    port:gmime \
    port:lua \
    port:pcre \
    port:perl5 \
    port:hiredis

set rspamd_user     _rspamd
set rspamd_group    ${rspamd_user}
add_users ${rspamd_user} group=${rspamd_group} realname=Rspamd

libpath             ${prefix}/var/lib/${name}

configure.args-append \
    -DRSPAMD_USER=${rspamd_user} \
    -DRSPAMD_GROUP=${rspamd_group} \
    -DCMAKE_INSTALL_PREFIX=${prefix} \
    -DCONFDIR=${prefix}/etc/${name} \
    -DMANDIR=${prefix}/share/man \
    -DRUNDIR=${prefix}/var/run/${name} \
    -DDBDIR=${prefix}/var/lib/${name} \
    -DLOGDIR=${prefix}/var/log/${name} \
    -DLIBDIR=${prefix}/lib \
    -DBUILD_PORT:BOOL=ON \
# Cannot enable torch without luajit
#                    -DENABLE_LUAJIT:BOOL=OFF \
    -DCMAKE_INSTALL_RPATH_USE_LINK_PATH:BOOL=ON \
    -DNO_SHARED=ON \
    -DINSTALL_EXAMPLES=ON \
    -DENABLE_HYPERSCAN=ON \
    -DENABLE_FANN=ON \
    -DENABLE_PCRE2=ON \
    -DENABLE_GD=ON

test.run            yes
test.target         run-test

post-destroot {
    # create default directories
    xinstall -o ${rspamd_user} -g ${rspamd_group} -m 0755 -d ${destroot}${prefix}/var/lib/${name}
    xinstall -m 0755 -d ${destroot}${prefix}/share/doc/${name}
    xinstall -o ${rspamd_user} -g ${rspamd_group} -m 0755 -d ${destroot}${prefix}/etc/${name}
    xinstall -o ${rspamd_user} -g ${rspamd_group} -m 0755 -d ${destroot}${prefix}/var/run/${name}
    xinstall -o ${rspamd_user} -g ${rspamd_group} -m 0755 -d ${destroot}${prefix}/var/log/${name}

    set docdir ${prefix}/share/doc/${name}
    xinstall -m 0755 -d ${destroot}${docdir}
    xinstall -m 0444 -W ${worksrcpath} ChangeLog LICENSE.md README.md ${destroot}${docdir}

    # install the man pages
    xinstall -m 0644 -W ${worksrcpath}/doc rspamadm.1 rspamc.1 ${destroot}${prefix}/share/man/man1
    xinstall -m 0644 -W ${worksrcpath}/doc rspamd.8 ${destroot}${prefix}/share/man/man8
}

startupitem.create  yes
startupitem.executable \
                    ${prefix}/bin/rspamd \
                    -u ${rspamd_user} \
                    -g ${rspamd_group} \
                    -f \
                    -c ${prefix}/etc/rspamd/rspamd.conf

destroot.keepdirs   ${destroot}${prefix}/etc/${name} \
     ${destroot}${prefix}/var/run/${name} \
     ${destroot}${prefix}/var/lib/${name} \
     ${destroot}${prefix}/var/log/${name} \
     ${destroot}${prefix}/share/doc/${name}

livecheck.type      regex
livecheck.url       https://github.com/rspamd/rspamd/archive
livecheck.regex     (\[0-9.\]+.\[0-9.\]+)\/
