# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github  1.0
PortGroup           cxx11   1.1

github.setup        dovecot core 2.3.7.2

name                dovecot2
set base_name       dovecot
# Please revbump port:dovecot2-sieve
# on port:dovecot2 version changes.
categories          mail
maintainers         nomaintainer
platforms           darwin
license             LGPL-2.1
homepage            https://www.dovecot.org

description         Secure, fast imap and pop3 server
long_description    Dovecot is an IMAP and POP3 server for Linux/UNIX-like \
                    systems, written with security primarily in mind. Although \
                    it is written in C, it uses several coding techniques to \
                    avoid most of the common pitfalls.

depends_build-append \
                    port:gettext \
                    port:pandoc \
                    port:pkgconfig \
                    port:wget

depends_lib-append  port:bzip2 \
                    port:libiconv \
                    path:lib/libssl.dylib:openssl \
                    port:xz \
                    port:zlib

set default_internal_user   _dovecot
set default_login_user      _dovenull
add_users ${default_internal_user} group=${default_internal_user} realname=Dovecot
add_users ${default_login_user}    group=${default_login_user}    realname=Dovenull

patch.pre_args      -p1
patchfiles          patch-doc-example-config-conf.d-10-master.conf.diff \
                    patch-src-master-master-settings.c.diff

checksums           patch-doc-example-config-conf.d-10-master.conf.diff \
                    rmd160  d8968a93871950264e7e43de6da8635d69676137 \
                    sha256  8dbf8d13224df2f562f6010bad0f6c947d2cbf8988ff74e0134159cfc465e1d2 \
                    size    3653398 \
                    patch-src-master-master-settings.c.diff \
                    rmd160  d8968a93871950264e7e43de6da8635d69676137 \
                    sha256  8dbf8d13224df2f562f6010bad0f6c947d2cbf8988ff74e0134159cfc465e1d2 \
                    size    3653398 \
                    core-${version}.tar.gz \
                    rmd160  d8968a93871950264e7e43de6da8635d69676137 \
                    sha256  8dbf8d13224df2f562f6010bad0f6c947d2cbf8988ff74e0134159cfc465e1d2 \
                    size    3653398

post-patch {
    reinplace "s|@@default_internal_user@@|${default_internal_user}|g" \
        ${worksrcpath}/doc/example-config/conf.d/10-master.conf
    reinplace "s|@@default_login_user@@|${default_login_user}|g" \
        ${worksrcpath}/doc/example-config/conf.d/10-master.conf
}

# Note: https://trac.macports.org/ticket/58544#comment:11 for this build logic
use_autoreconf      yes
autoreconf.cmd      ./autogen.sh
depends_build-append \
                    port:autoconf \
                    port:automake \
                    port:libtool

pre-configure {
    # the line `dummy < /dev/tty` breaks this; just copy the necessary file
    # system -W ${worksrcpath} "gettextize -f"
    xinstall -W ${worksrcpath} ${prefix}/share/gettext/config.rpath .
}

configure.args      --sysconfdir=${prefix}/etc \
                    --localstatedir=${prefix}/var \
                    --with-ssl=openssl \
                    --with-zlib \
                    --with-bzlib \
                    --with-ssldir=${prefix}/etc/openssl \
                    --with-shared-libs \
                    --with-pam

configure.cppflags  -I${prefix}/include/openssl

variant gssapi \
    description "Enable GSSAPI authentication" {
    configure.args-append       --with-gssapi=yes
}

variant ldap description {Enable LDAP support} {
    depends_lib-append          port:openldap
    configure.args-append       --with-ldap=yes
}

variant solr description {Enable apache-solr support} {
    depends_lib-append          port:clucene port:curl port:expat
    depends_run-append          port:apache-solr8
    configure.args-append       --with-solr --with-lucene
}

variant lucene description {Enable lucene support} {
    depends_lib-append          port:clucene
    configure.args-append       --with-lucene
}

variant libstemmer description {Use libstemmer for full-text search} {
    depends_lib-append          port:libstemmer
    configure.args-append       --with-libstemmer
}

variant postgresql84 \
    conflicts postgresql96 postgresql10 postgresql11 postgresql12 \
    description "Enable PostgreSQL 8.4 support" {
    depends_lib-append          port:postgresql84
    configure.env-append        PG_CONFIG=${prefix}/lib/postgresql84/bin/pg_config
    configure.args-append       --with-pgsql
}

variant postgresql96 \
    conflicts postgresql84  postgresql10 postgresql11 postgresql12 \
    description "Enable PostgreSQL 9.6 support" {
    depends_lib-append          port:postgresql96
    configure.env-append        PG_CONFIG=${prefix}/lib/postgresql96/bin/pg_config
    configure.args-append       --with-pgsql
}

variant postgresql10 \
    conflicts postgresql84 postgresql96 postgresql11 postgresql12 \
    description "Enable PostgreSQL 10 support" {
    depends_lib-append          port:postgresql10
    configure.env-append        PG_CONFIG=${prefix}/lib/postgresql10/bin/pg_config
    configure.args-append       --with-pgsql
}

variant postgresql11 \
    conflicts postgresql84 postgresql96 postgresql10 postgresql12 \
    description "Enable PostgreSQL 11 support" {
    depends_lib-append          port:postgresql11
    configure.env-append        PG_CONFIG=${prefix}/lib/postgresql11/bin/pg_config
    configure.args-append       --with-pgsql
}

variant postgresql12 \
    conflicts postgresql84 postgresql96 postgresql10 postgresql11 \
    description "Enable PostgreSQL 12 support" {
    depends_lib-append          port:postgresql12
    configure.env-append        PG_CONFIG=${prefix}/lib/postgresql12/bin/pg_config
    configure.args-append       --with-pgsql
}

variant percona \
    conflicts mysql57 mysql8 mariadb mariadb10.1 mariadb10.2 \
    description "Enable Percona (MySQL) support" {
        depends_lib-append          port:percona
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/percona/bin/mysql_config
        configure.args-append       --with-mysql
}

variant mysql57 \
    conflicts mysql8 mariadb mariadb10.1 mariadb10.2 percona \
    description "Enable MySQL 5.7 (MySQL) support" {
        depends_lib-append          port:mysql57
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/mysql57/bin/mysql_config
        configure.args-append       --with-mysql
}

variant mysql8 \
    conflicts mysql57  mariadb mariadb10.1 mariadb10.2 percona \
    description "Enable Mysql 8 (MySQL) support" {
        depends_lib-append          port:mysql8
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/mysql8/bin/mysql_config
        configure.args-append       --with-mysql
}

variant mariadb \
    conflicts mysql57 mysql8  mariadb10.1 mariadb10.2 percona \
    description "Enable MariaDB 5 (MySQL) support" {
        depends_lib-append          port:mariadb
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/mariadb/bin/mysql_config
        configure.args-append       --with-mysql
}

variant mariadb10.1 \
    conflicts mysql57 mysql8 mariadb  mariadb10.2 percona \
    description "Enable MariaDB 10.1 (MySQL) support" {
        depends_lib-append          port:mariadb-10.1
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/mariadb-10.1/bin/mysql_config
        configure.args-append       --with-mysql
}

variant mariadb10.2 \
    conflicts mysql57 mysql8 mariadb mariadb10.1 percona \
    description "Enable MariaDB 10.2 (MySQL) support" {
        depends_lib-append          port:mariadb-10.2
        configure.env-append        MYSQL_CONFIG=${prefix}/lib/mariadb-10.2/bin/mysql_config
        configure.args-append       --with-mysql
}


variant no_startupitem description {Do not install a launchd plist} {}

if {![variant_isset "no_startupitem"]} {
    startupitem.create      yes
    startupitem.executable  ${prefix}/sbin/${base_name}
    startupitem.pidfile     auto ${prefix}/var/run/${base_name}/master.pid
}

destroot.keepdirs \
    ${destroot}${prefix}/etc/${base_name}
