# $Id: Portfile,v 1.12 2003/08/04 15:07:07 fkr Exp $

PortSystem	1.0
name	        postfix
version	        2.0.13
categories	mail
maintainers	darwinports@opendarwin.org
description	Fast and robust mail transfer agent
long_description	Postfix attempts to be fast, easy to administer, and \
			secure, while at the same time being \
			sendmail-compatible enough to not upset existing \
			users. It also offers QMQP and VERP support to let \
			Postfix act as delivery daemon for ezmlm-idx.
homepage        http://www.postfix.org/
platforms	darwin
checksums       md5 f4f2b4b930a7a32b1df475d87143269f
master_sites	ftp://ftp.tau.ac.il/pub/unix/mail/postfix/official/ \
                http://postfix.problemlos.ch/release/official/ \
                ftp://ftp.matrix.com.br/pub/postfix/official/ \
                ftp://ftp.its.cz/MIRRORS/ftp.porcupine.org/mirrors/postfix-release/official/ \
                ftp://ftp.club-internet.fr/pub/mirrors/ftp.porcupine.org/postfix-release/official/ \
                ftp://ftp.doc.cs.univ-paris8.fr/mirrors/ftp.porcupine.org/postfix-release/official/
patchfiles      patch-access.5 patch-flush.8 patch-master.8 \
		patch-regexp_table.5 patch-sys_defs.h patch-canonical.5 \
                patch-mail_params.h patch-pcre_table.5 patch-postdrop.1 \
                patch-postqueue.1 patch-relocated.5 patch-transport.5 \
                patch-cleanup.8 patch-main.cf patch-postfix-install \
                patch-proxymap.8 patch-sample-misc.cf patch-sendmail.1 \
                patch-virtual.5

configure {
	cd ${worksrcpath}
	reinplace "s|__PREFIX|${prefix}|g" src/util/sys_defs.h
	reinplace "s|__PREFIX|${prefix}|g" conf/main.cf
	reinplace "s|__PREFIX|${prefix}|g" src/global/mail_params.h
	reinplace "s|__PREFIX|${prefix}|g" conf/sample-misc.cf
	reinplace "s|__PREFIX|${prefix}|g" man/man1/postdrop.1
	reinplace "s|__PREFIX|${prefix}|g" man/man1/postqueue.1
	reinplace "s|__PREFIX|${prefix}|g" man/man1/sendmail.1
	reinplace "s|__PREFIX|${prefix}|g" man/man5/access.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/canonical.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/pcre_table.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/regexp_table.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/relocated.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/transport.5
	reinplace "s|__PREFIX|${prefix}|g" man/man5/virtual.5
	reinplace "s|__PREFIX|${prefix}|g" man/man8/cleanup.8
	reinplace "s|__PREFIX|${prefix}|g" man/man8/flush.8
	reinplace "s|__PREFIX|${prefix}|g" man/man8/master.8
	reinplace "s|__PREFIX|${prefix}|g" man/man8/proxymap.8
}

build.target

depends_run	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

install {
	adduser postfix realname=Postfix\ Server
	addgroup postdrop
	cd ${worksrcpath}
	system "install -d ${destroot}${prefix}/bin"
	system "install -d ${destroot}${prefix}/etc/postfix"
	system "install -d ${destroot}${prefix}/etc/rc.d"
	system "install -d ${destroot}${prefix}/libexec"
	system "install -d ${destroot}${prefix}/sbin"
	system "install -d ${destroot}${prefix}/man"
	system "install -d ${destroot}${prefix}/share/postfix"
	system "install -d -g postdrop ${destroot}${prefix}/var/spool/postfix/public"
	system "install -d -g postdrop ${destroot}${prefix}/var/spool/postfix/maildrop"
	system "/bin/sh postfix-install -non-interactive \
		install_root=${destroot} \
		config_directory=${prefix}/etc/postfix \
		daemon_directory=${prefix}/libexec \
		command_directory=${prefix}/sbin \
		queue_directory=${prefix}/var/spool/postfix \
		manpage_directory=${prefix}/man \
		sendmail_path=${prefix}/sbin/sendmail \
		newaliases_path=${prefix}/bin/newaliases \
		mailq_path=${prefix}/bin/mailq \
		sample_directory=${prefix}/share/postfix/sample \
		readme_directory=${prefix}/share/postfix/readme"
	system "install -o root -m 755 -d ${destroot}${prefix}/etc/rc.d"
	system "install -o root -m 755 -c \
		${portpath}/files/postfix.sh ${destroot}${prefix}/etc/rc.d"
	reinplace "s|__PREFIX|${prefix}|g" \
		${destroot}${prefix}/etc/rc.d/postfix.sh
}
