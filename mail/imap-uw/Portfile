# $Id: Portfile,v 1.19 2004/06/16 02:49:56 rshaw Exp $
PortSystem		1.0

name			imap-uw
version			2004
categories		mail
maintainers		mij@opendarwin.org rshaw@opendarwin.org
description		University of Washington IMAP daemon
long_description	IMAP (Internet Message Access Protocol) is a method \
					of accessing electronic messages kept on a (possibly \
					shared) mail server. This port provides the \
					University of Washington IMAP toolkit (IMAP \
					supporting software developed by the UW).
homepage		http://www.washington.edu/imap/
master_sites	ftp://ftp.cac.washington.edu/imap/ \
				opendarwin
platforms		darwin

distname		imap-${version}
extract.suffix	.tar.Z
checksums		md5 ec3dafeeae320457a1d098157e9bf969

use_configure	no

build.target	osx

# Patches for Darwin 7.x/Mac OS X 10.3.x support
platform darwin 7 {
	patchfiles		patch-src-osdep-unix-Makefile \
					patch-src-osdep-unix-ckp_osx.c
}

# Default is to enable SSL support and plaintext authentication
# permitted only in SSL/TLS sessions.

# Variant to enable SSL support and plaintext authentication
variant ssl_plain {
	patchfiles		patch-Makefile
	build.args		SSLTYPE=unix
}

# Variant to enable SSL with PAM support for Mac OS X
variant ssl_pam {
	depends_lib		lib:libssl.0.9:openssl

	patchfiles		patch-Makefile
	build.target	oxp
	build.args		SSLTYPE=unix

	post-destroot {
		xinstall -m 0644 ${filespath}/README-MACOSX \
			${filespath}/etc-pam.d-imap \
			${filespath}/etc-xinetd.d-imap \
			${filespath}/etc-xinetd.d-imaps \
			${destroot}${prefix}/share/doc/${name}/
		reinplace "s|__PREFIX|${prefix}|" \
			${filespath}/README-MACOSX \
			${destroot}${prefix}/share/doc/${name}/etc-xinetd.d-imap \
			${destroot}${prefix}/share/doc/${name}/etc-xinetd.d-imaps
		ui_msg "-----------------------------------------------------------"
		ui_msg "For use of IMAP-UW using SSL and PAM on Mac OS X 10.3,"
		ui_msg "please see the following:"
		ui_msg "\t${prefix}/share/doc/${name}/README-MACOSX"
		ui_msg "for further installation and setup details."
		ui_msg "-----------------------------------------------------------"
	}
}

# Variant to enable IPv6 support (default is IPv4)
variant ipv6 {
	build.args-append	IP=6
}

# Variant to set the default for creating new mailboxes to "mbx" format
variant mbx	{
	build.args-append	CREATEPROTO=mbxproto
}

# Variant to set the default mail subdirectory name to "Mail"
variant subdir {
	patchfiles-append	patch-env_unix.c
}

destroot {
	# Warn user if not running as root
	if {$env(USER) != "root"} {
		ui_msg "-----------------------------------------------------------"
		ui_msg "Note that you are not running as root, so files installed"
		ui_msg "by this port will not end up with proper ownership and"
		ui_msg "will likely not work correctly."
		ui_msg "-----------------------------------------------------------"
	}
	cd ${worksrcpath}
	xinstall -m 0755 -d ${destroot}${prefix}/libexec
	xinstall -m 0755 -d ${destroot}${prefix}/bin
	xinstall -m 0755 -d ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0755 -d ${destroot}${prefix}/share/man/man8
	xinstall -m 0755 -d ${destroot}${prefix}/share/man/man1
	xinstall -m 0755 imapd/imapd ${destroot}${prefix}/libexec
	xinstall -m 0755 ipopd/ipop2d ${destroot}${prefix}/libexec
	xinstall -m 0755 ipopd/ipop3d ${destroot}${prefix}/libexec
	xinstall -m 0755 mailutil/mailutil ${destroot}${prefix}/bin
	xinstall -m 0755 tmail/tmail ${destroot}${prefix}/bin
	xinstall -m 0755 dmail/dmail ${destroot}${prefix}/bin
	xinstall -m 0755 mtest/mtest ${destroot}${prefix}/bin/mboxtest
	if {$env(USER) == "root"} {
		xinstall -g mail -m 2711 mlock/mlock ${destroot}${prefix}/libexec
	} else {
		xinstall -m 0711 mlock/mlock ${destroot}${prefix}/libexec
	}
	if {[variant_isset devel]} {
		xinstall -m 0755 src/imapd/imapd.8 ${destroot}${prefix}/share/man/man8
		xinstall -m 0755 src/ipopd/ipopd.8 ${destroot}${prefix}/share/man/man8
	} else {
		xinstall -m 0755 src/imapd/imapd.8c ${destroot}${prefix}/share/man/man8/imapd.8
		xinstall -m 0755 src/ipopd/ipopd.8c ${destroot}${prefix}/share/man/man8/ipopd.8
	}
	xinstall -m 0755 src/mailutil/mailutil.1 ${destroot}${prefix}/share/man/man1
	xinstall -m 0755 src/tmail/tmail.1 ${destroot}${prefix}/share/man/man1
	xinstall -m 0755 src/dmail/dmail.1 ${destroot}${prefix}/share/man/man1
	xinstall -m 0644 docs/RELNOTES ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0644 docs/FAQ.html ${destroot}${prefix}/share/doc/${name}
	foreach file [glob docs/*.txt] {
		xinstall -m 0644 ${file} ${destroot}${prefix}/share/doc/${name}
	}
}

variant devel {
	version		2004a.DEV.SNAP-0405261606
	distname	imap-${version}
	checksums	md5 2aa85954a1c83ccebb97f2ee2992ec76
}

