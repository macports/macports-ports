# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           makefile 1.0

set realname        camlidl
set realversion     1.05
github.setup        xavierleroy ${realname} [join [split ${realversion} .] ""] ${realname}
name                ocaml-${realname}
version             ${realversion}
revision            2
categories          ocaml devel
platforms           darwin
license             {QPL LGPL}
maintainers         {takeshi @tenomoto} openmaintainer
description         stub code generator and COM binding for Objective Caml
long_description \
    CamlIDL comprises two parts: \
    * A stub code generator that generates the C stub code required for the Caml/C interface, \
      based on an MIDL specification. (MIDL stands for Microsoft's Interface Description Language \
      it looks like C header files with some extra annotations, plus a notion of object interfaces \
      that look like C++ classes without inheritance.) \
    * A (currently small) library of functions and tools to import COM components in Caml applications, \
      and export Caml code as COM components.

depends_build       port:ocaml

checksums           rmd160  91a3b03cbafee0d0799bc3e3f1d93334e1bdef59 \
                    sha256  5442ebef4541e49cae2bad1f64b5a244cd1a50c085aabfdaab70341fa0955523 \
                    size    124868

# disable warnings so that it build with OCaml 4.03
# Gentoo fix:
#    https://github.com/gentoo/gentoo/blob/master/dev-ml/camlidl/files/nowarn.patch
# upstream fix:
#    https://github.com/xavierleroy/camlidl/commit/b58227902eb69a5c38819f587fcb02c92d5627d4
patchfiles-append   patch-nowarn.diff

universal_variant   no

pre-build {
    file rename ${worksrcpath}/config/Makefile.unix ${worksrcpath}/config/Makefile
}

makefile.override-append CFLAGS

build.args          CPP=/usr/bin/cpp \
                    CAMLLIB=${prefix}/lib/ocaml \
                    OCAMLC="${prefix}/bin/ocamlc -g" \
                    OCAMLOPT=${prefix}/bin/ocamlopt \
                    OCAMLYACC="${prefix}/bin/ocamlyacc -v" \
                    OCAMLLEX=${prefix}/bin/ocamllex \
                    OCAMLDEP=${prefix}/bin/ocamldep

pre-destroot {
    xinstall -d -m 755 ${destroot}${prefix}/lib/ocaml
    xinstall -d -m 755 ${destroot}${prefix}/lib/ocaml/caml
}

destroot.args       BINDIR=${destroot}${prefix}/bin \
                    CAMLLIB=${prefix}/lib/ocaml \
                    OCAMLLIB=${destroot}${prefix}/lib/ocaml
