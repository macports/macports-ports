# $Id: Portfile,v 1.2 2004/02/17 06:15:29 rshaw Exp $
PortSystem 1.0

name			zope-plonewebmail
version			0.93
categories		www zope python
maintainers		rshaw@opendarwin.org
description		Plone web email product
long_description	PloneWebMail is an IMAP (POP3 support coming \
					soon) email client for Plone.  It's very simple \
					and the features are basic : \
					- Read IMAP messages with attachments \
					- Send & forward messages with attachments \
					  (plain text & HTML) \
					- IMAP folders management \
					- copy/move IMAP messages \
					- Basic addressbook \
					- i18n implementation
platforms		darwin freebsd
homepage		http://plonewebmail.1000asa.com/
master_sites	http://plonewebmail.1000asa.com/Members/lortymanager/
dist_subdir		zope/${name}
distname		PloneWebMail
distfiles		${distname}-${version}${extract.suffix}
checksums		md5 1230f3916221fcb4a50631896501dd43

# Use Python 2.3 from DarwinPorts explicitly 
set python		${prefix}/bin/python2.3

# Location to install Zope products and the Zope user                  
set zopehome	${prefix}/libexec/Zope
set zopeinst	${prefix}/www/Zope
set zopeprod	${zopehome}/lib/python/Products
set zopeuser	zope
set zopegroup	www

# Depends on Zope
depends_build	path:${zopehome}:zope

# Depends on these Zope products
depends_run		path:${zopeprod}/CMFPlone:zope-plone

platform freebsd {
	extract.post_args	| gtar -xf -
}

patchfiles		patch-top_bar.diff \
				patch-addressbook.diff
post-patch {
	file copy ${filespath}/addcontact.png ${worksrcpath}/skins/${distname}/img/
}

use_configure	no

pre-build {
	file copy ${zopehome}/bin/compilezpy.py ${workpath}
	reinplace "s|^.*sys.stdout|#&|" ${workpath}/compilezpy.py
	system "find ${worksrcpath} -name '*.py\[co\]' | xargs rm"
	system "find ${worksrcpath} -type f | xargs chmod a+r"
	system "find ${worksrcpath} -type d -name CVS | xargs rm -rf"
	system "rm -rf ${worksrcpath}/skins/${distname}/img/.xvpics"
}

build {
	system "cd ${worksrcpath} && ${python} ${workpath}/compilezpy.py"
}

destroot {
	if {$env(USER) != "root"} {
		ui_msg "------------------------------------------------------------"
		ui_msg "Note that you are not installing as root, so files installed"
		ui_msg "by this port will not end up with proper ownership and"
		ui_msg "likely not work correctly with Zope."
		ui_msg "------------------------------------------------------------"
	}

	# Install products
	xinstall -d -m 0755 ${destroot}${zopeprod}
	system "cp -R ${workpath}/${distname} ${destroot}${zopeprod}"
	if {$env(USER) == "root"} {
		system "chown -R ${zopeuser} ${destroot}${zopehome}"
		system "chgrp -R ${zopegroup} ${destroot}${zopehome}"
	}
}

