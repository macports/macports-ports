# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

# When updating gpg-agent, update gnupg2 also if applicable.
name                gpg-agent
version             2.0.27
revision            0
categories          security mail
maintainers         ionic openmaintainer
license             GPL-3+
installs_libs       no

description         GPG key agent
long_description    gpg-agent is a key management agent similar \
                    in function to ssh-agent.
homepage            http://www.gnupg.org
platforms           darwin freebsd sunos
distname            gnupg-${version}
dist_subdir         gnupg2
master_sites        gnupg:gnupg
conflicts           gnupg21

use_bzip2           yes

checksums           rmd160  52aaf841339713aef9e2e034b1e045bec31d6322 \
                    sha256  57646d3e4b919fa1e5c8f1c0cf5fe1215333041c493a5ebc4b8f2978dbe930f2

startupitem.location \
                    LaunchAgents

set launchd_dir     ${prefix}/etc/${startupitem.location}/${startupitem.uniquename}/

configure.args      --enable-agent-only

# glib fails to find the right stdint.h  It picks clang's internal one rather
# than the system header
configure.env       gl_cv_absolute_stdint_h=/usr/include/stdint.h

depends_lib         port:libiconv       \
                    port:gettext        \
                    port:zlib           \
                    port:bzip2          \
                    port:bison          \
                    port:libassuan      \
                    port:libksba        \
                    port:libgcrypt      \
                    port:libgpg-error   \
                    port:pth


patchfiles          patch-po_Makevars.diff

# DO NOT USE. Maintainer-only helper for debugging purposes. DO NOT USE.
#configure.cflags-append -g3 -ggdb3 -gdwarf-2 -O0

platform darwin {
    if {![variant_isset no_pinentry] &&
        ![variant_isset pinentry] && ![variant_isset pinentry_mac]} {
        # Automatically switch between pinentry and pinentry-mac, with pinentry-mac being
        # preferred.
        # 10.7 and below are not supported by pinentry-mac, though, and will default to
        # pinentry. Just like pure darwin without OS X will.
        if {${os.subplatform} ne "macosx" ||
            ${xcodeversion} eq "none" ||
            [vercmp ${xcodeversion} {5.0}] < 0 ||
            ${os.major} < 12 || (![catch {registry_active pinentry}] &&
                                 [catch {registry_active pinentry-mac}])} {
            default_variants-append +pinentry
        } else {
            default_variants-append +pinentry_mac
        }
    }


    patchfiles-append       patch-agent_gpg-agent.c-launchd.diff
    configure.cflags-append -F/System/Library/Frameworks/CoreFoundation.framework \
                            -D__APPLE_LAUNCHD__

    if {${os.major} < 11} {
        patchfiles-append   patch-agent_agent.h-strndup-compat-10.6.diff
    }

    if { [tbool startupitem.install] } {
        notes-append "
                       A startup item has been installed that will aid in
                       starting ${name} with launchd. It is disabled
                       by default. Execute the following command to launch
                       ${name} at user login:

                       launchctl load -w /Library/${startupitem.location}/${startupitem.plist}

                       To actually start ${name}, log out and back in.
                     "
    } else {
        notes-append "
                       A startup item was not installed for ${name}.
                       Some programs which depend on ${name} might not function properly,
                       most notably eMail clients.
                       Execute the following command to launch ${name} at user login:

                       launchctl load -w ${launchd_dir}/${startupitem.plist}

                       To actually start ${name}, log out and back in.
                     "
    }
}

post-extract {
    xinstall -m 644 -W ${filespath} gpg-agent.plist.default ${worksrcpath}
}

post-configure {
    reinplace -W "${worksrcpath}" "s|@PREFIX@|${prefix}|g" gpg-agent.plist.default
    reinplace -W "${worksrcpath}" "s|@LABEL@|${startupitem.uniquename}|g" gpg-agent.plist.default

    if {${os.platform} eq "darwin"} {
        reinplace -W "${worksrcpath}" "s|@SSH_SUPPORT@||g" gpg-agent.plist.default
    }
}

post-destroot {
    # Prevent conflict with gnupg2 port.
    delete ${destroot}${prefix}/share/doc/gnupg/README

    if {${os.platform} eq "darwin"} {
        xinstall -m 755 -d \
            ${destroot}${launchd_dir}
        xinstall -m 444 \
            ${worksrcpath}/gpg-agent.plist.default \
            ${destroot}${launchd_dir}${startupitem.plist}.default
    }
}

post-activate {
    if {${os.platform} eq "darwin"} {
        xinstall -m 644 \
            ${launchd_dir}${startupitem.plist}.default \
            ${launchd_dir}${startupitem.plist}

        # install the plist, if startupitem.install is set
        if {[tbool startupitem.install]} {
            ln -sf "${launchd_dir}${startupitem.plist}" "/Library/${startupitem.location}"
        }
    }
}

post-deactivate {
    if {${os.platform} eq "darwin"} {
        delete ${launchd_dir}${startupitem.plist}

        if { [tbool startupitem.install] } {
           delete "/Library/${startupitem.location}/${startupitem.plist}"
        }
    }
}

# Remove after 11-17-2015.
variant no_pinentry conflicts pinentry pinentry_mac description {Legacy compatibility variant for disabling pinentry. Will be removed soon.} {
}

variant pinentry conflicts pinentry_mac no_pinentry description {Handle user input via pinentry.} {
    depends_lib-append      port:pinentry
    configure.args-append   --with-pinentry-pgm=${prefix}/bin/pinentry
}

variant pinentry_mac conflicts pinentry no_pinentry description {Handle user input via pinentry-mac. Only compatible with OS X 10.8+.} {
    depends_lib-append      port:pinentry-mac
    configure.args-append   --with-pinentry-pgm=${applications_dir}/pinentry-mac.app/Contents/MacOS/pinentry-mac
}

livecheck.type      regex
livecheck.url       ftp://ftp.gnupg.org/gcrypt/gnupg/
livecheck.regex     gnupg-(2\\.0\\.\\d+)
