# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
PortSystem            1.0
PortGroup             xcode 1.0
PortGroup             github 1.0

github.setup          MacPass MacPassHTTP 0.3.2
revision              2
categories            security
platforms             darwin
license               GPL-3
maintainers           {@janosch mailbox.org:janosch1} openmaintainer
description           KeePassHTTP plugin for MacPass
long_description      With the ${name} plugin, MacPass can be used in conjunction with browser plugins \
                      which use MacPass as a password database.

checksums             rmd160  e2faa8194af40a7f123d25846184397dc5592067 \
                      sha256  acda68775831c5fba8a7026df957b725f3cfb92abcad61689770648b58774e99 \
                      size    321509

if {${os.platform} eq "darwin" && ${os.major} < 20} {
  known_fail yes
  pre-fetch {
      ui_error "${name} @${version} requires macOS 11 or greater"
      return -code error "incompatible OS X version"
  }
}

depends_lib           port:HNHUi \
                      port:KeePassHTTPKit \
                      port:MacPass

patchfiles            patch-fix-projectfile.diff

xcode.target          MacPassHTTP
xcode.scheme          MacPassHTTP
xcode.configuration   Release

#xcode.destroot.path   ${prefix}/Library/Application Support/MacPass

# Workaround for missing DerivedData path
destroot.pre_args-append  -derivedDataPath ./DerivedData

xcode.destroot.settings CODE_SIGN_IDENTITY=- \
                        CODE_SIGN_STYLE=Manual \
                        ENABLE_HARDENED_RUNTIME=NO \
                        FRAMEWORK_SEARCH_PATHS=${frameworks_dir} \
                        HEADER_SEARCH_PATHS=${prefix}/include/MacPass

post-patch {
    file mkdir "${destroot}${prefix}/Library/Application Support/MacPass/MacPassHTTP.mpplugin/Contents/Resources/Base.lproj"
}


# We skip the build phase because building will also be done in the destroot phase.
# See https://trac.macports.org/ticket/57137
build {}
