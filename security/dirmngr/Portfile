# $Id$

PortSystem  1.0

name        dirmngr
version     1.0.1
categories  security mail
maintainers boeyms openmaintainer
description X.509 certificate directory manager for GnuPG
long_description    \
    Dirmngr is a server for managing and downloading certificate \
    revocation lists (CRLs) for X.509 certificates and for downloading \
    the certificates themselves. Dirmngr also handles OCSP requests as \
    an alternative to CRLs. Dirmngr is either invoked internaly by \
    gpgsm (from gnupg 1.9) or when running as a system daemon through \
    the dirmngr-client tool.
homepage    http://www.gnupg.org
platforms   darwin
master_sites    gnupg

use_bzip2   yes
checksums   md5 3b969ee763fa9160319abe3f24b5959d \
            sha1 39eb62907e5c4ddc29da00b1291c24e5267f113e \
            rmd160 eca2e5622ffe7af7ddece1b76977e5f696465385

post-patch {
    reinplace "s|/var|${prefix}/var|" \
        ${worksrcpath}/src/dirmngr.c \
        ${worksrcpath}/src/dirmngr-client.c
}

# Need to define LDAP_DEPRECATED as dirmngr uses ldap_init(),
# ldap_simple_bind_s() and ldap_search_st(), which are deprecated at least as of
# OpenLDAP 2.3.35.
configure.cppflags  -DLDAP_DEPRECATED

depends_lib port:libiconv       \
            port:gettext        \
            port:libassuan      \
            port:libksba        \
            port:libgcrypt      \
            port:libgpg-error   \
            port:pth            \
            port:openldap

test.run    yes
test.dir    ${worksrcpath}/tests
test.target     check

platform darwin {
    configure.env-append    MACOSX_DEPLOYMENT_TARGET=10.3
    build.env-append        MACOSX_DEPLOYMENT_TARGET=10.3
#   Get around the fact that Darwin linker complains about multiply defined
#   symbols since DirMngr doesn't currently test for presence strcasecmp
    configure.cflags-append -DHAVE_STRCASECMP=1
#   Do something to fix the fact that, for some reason, -llber is required
    configure.env-append    LDAPLIBS="-lldap -llber"
}

platform darwin 7 {
    configure.ldflags-append    -framework IOKit
}

livecheck.check regex
livecheck.url   http://mirrors.rootmode.com/ftp.gnupg.org/gnupg/?O=D
livecheck.regex gnupg-(\\d+\\.\\d+\\.\\d+)
