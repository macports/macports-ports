# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                qt5-mac
version             5.3.1
set branch          [join [lrange [split ${version} .] 0 1] .]

categories          aqua
platforms           macosx
maintainers         mcalhoun openmaintainer
license             {LGPL-2.1 GPL-3}

homepage            http://qt-project.org
description         Qt Tool Kit
long_description    Qt Tool Kit: A cross-platform framework \
    (headers, data, and libraries) for writing \
    cross-platform GUI-based applications.

distname            qt-everywhere-opensource-src-${version}

master_sites        http://download.qt-project.org/official_releases/qt/${branch}/${version}/single/

checksums           rmd160  4cf6af424fe84223c5d9570848b4e21e251c5cdf \
                    sha256  ba898625ba525d90a54739d2e33e4701d0bcd22d45663737b8123cd9b17b35a1

if { ${os.major} < 10 } {
    pre-fetch {
        ui_error "OS X prior to 10.7 (Lion) is not a Reference Configuration for Qt."
        ui_error "OS X prior to 10.6 (Snow Leopard) is not even tested."
        ui_error "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
        return -code error "unsupported OS"
    }
} elseif { ${os.major} == 10 } {
    pre-fetch {
        ui_warn "OS X prior to 10.7 (Lion) is not a Reference Configuration for Qt."
        if { [variant_isset universal] } {
            ui_warn "OS X 10.6 (Snow Leopard) is \"occasionally tested\" but ONLY in 32-bit mode."
            ui_warn "OS X 10.6 (Snow Leopard) is deprecated and scheduled for removal in Qt 5.4."
        } else {
            if { ${build_arch} eq "i386" } {
                ui_warn "OS X 10.6 (Snow Leopard) is \"occasionally tested\"."
                ui_warn "OS X 10.6 (Snow Leopard) is deprecated and scheduled for removal in Qt 5.4."
            } else {
                ui_warn "OS X 10.6 (Snow Leopard) is \"occasionally tested\" but ONLY in 32-bit mode."
                ui_warn "OS X 10.6 (Snow Leopard) is deprecated and scheduled for removal in Qt 5.4."
            }
        }
        ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
    }
} elseif { ${os.major} > 13 } {
    pre-fetch {
        ui_warn "OS X subsequent to 10.9 (Mavericks) is not a Reference Configuration for Qt."
        ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
    }
} else {
    # 11 <= ${os.major} <= 13
    if { [variant_isset universal] } {
        pre-fetch {
            ui_warn "Multiple architectures is not a Reference Configuration for Qt."
            ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
        }
    } else {
        if { ${build_arch} eq "i386" } {
            pre-fetch {
                ui_warn "32-bit mode is not a Reference Configuration for Qt."
                ui_warn "See http://qt-project.org/doc/qt-5/supported-platforms.html#reference-configurations"
            }
        }
    }
}

if { ${subport} eq "${name}-docs"  } {
    universal_variant no
}

if { ${subport} eq ${name} || ${subport} eq "${name}-docs" } {
    # use the qt5 group; set 'building_qt5' so that the portgroup
    # does not include certain parts
    set building_qt5    1
    PortGroup           qt5 1.0
    PortGroup           xcodeversion 1.0

    conflicts           qt3 qt3-mac qt4-mac

    minimum_xcodeversions   {10 3.2}

    pre-configure {
        # See https://bugreports.qt-project.org/browse/QTBUG-34902
        if {![catch {set installed [lindex [registry_active qt4-mac] 0]}]} {
            ui_error "${name} fails if qt4-mac is active during configuration phase."
            ui_error "Please deactivate qt4-mac to continue"
            return -code error "conflicting port (qt4-mac)"
        }
    }

    # More testing is required to see if this is necessary.
    use_parallel_build no

    # header file QtCore/private/qmachparser_p.h is included only if "defined(QT_BUILD_INTERNAL) && defined(Q_OF_MACH_O)"
    #     code from header is used only "ifdef Q_OF_MACH_O"
    #     the two must be consistent
    #     assume the header include code is correct
    patchfiles-append patch-tst_qpluginloader.diff

    # When testing, ensure that a universal object file is not inadvertently created.
    patchfiles-append patch-machtest.diff

    # On testing of 32-bit systems,
    #  Pre-patch: QCOMPARE(unsigned long const&, unsigned int const&
    # Post-patch: QCOMPARE(unsigned int  const&, unsigned int const&
    # Function template is only instantiated for same first and second arguments.
    patchfiles-append patch-tst_qarraydata.diff

    # see http://stackoverflow.com/questions/14506151/invalid-symbol-redefinition-in-inline-asm-on-llvm
    patchfiles-append patch-tst_benchlibcallgrind.diff

    # During testing, NSStringFromRect requires NSRect.
    patchfiles-append patch-tst_qaccessibilitymac_helpers.diff

    # --prefix is not recognized.
    configure.pre_args-delete       --prefix=${prefix}

    # --disable-dependency-tracking is not recognized.
    configure.universal_args-delete --disable-dependency-tracking

    if {${configure.sdkroot} ne ""} {
        configure.args-append \
            -sdk [string tolower [join [lrange [split [lindex [split ${configure.sdkroot} "/"] end] "."] 0 end-1] "."]]
    }

    configure.args-append                      \
        -prefix         ${qt_dir}              \
        -docdir         ${qt_docs_dir}         \
        -headerdir      ${qt_includes_dir}     \
        -plugindir      ${qt_plugins_dir}      \
        -importdir      ${qt_imports_dir}      \
        -qmldir         ${qt_qml_dir}          \
        -datadir        ${qt_data_dir}         \
        -libdir         ${qt_frameworks_dir}   \
        -bindir         ${qt_bins_dir}         \
        -translationdir ${qt_translations_dir} \
        -sysconfdir     ${qt_sysconf_dir}      \
        -examplesdir    ${qt_examples_dir}     \
        -testsdir       ${qt_tests_dir}        \
        -hostdatadir    ${qt_host_data_dir}

    # Configure options:
    configure.args-append \
        -release          \
        -opensource       \
        -confirm-license  \
        -shared           \
        -process

    # Third Party Libraries:
    configure.args-append \
        -no-mtdev         \
        -no-harfbuzz      \
        -openssl-linked   \
        -no-xinput2       \
        -no-xcb-xlib

    # configure options that don't show up in configure --help
    configure.args-append \
        -no-libudev       \
        -no-egl

    # Additional options:
    configure.args-append    \
        {-make libs}         \
        {-make tools}        \
        {-nomake examples}   \
        {-nomake tests}      \
        -verbose             \
        -no-optimized-qmake  \
        -nis                 \
        -cups                \
        -iconv               \
        -no-evdev            \
        -icu                 \
        -fontconfig          \
        -strip               \
        -no-pch              \
        -dbus-linked         \
        -no-xcb              \
        -glib                \
        -directfb            \
        -no-linuxfb          \
        -no-kms              \
        -no-system-proxies   \
        -framework

    foreach driver { db2 ibase mysql oci odbc psql sqlite sqlite2 tds } {
        configure.args-append -no-sql-${driver}
    }

    if { ![variant_isset universal] } {
        configure.args-append "-platform ${qt_qmake_spec}"
    } else {
        set merger_configure_args(i386)   "-platform ${qt_qmake_spec_32}"
        set merger_configure_args(x86_64) "-platform ${qt_qmake_spec_64}"
    }

    # configure options that don't show up in configure --help
    configure.args-append \
        -no-openvg

    # Qt builds part of the system using environment provided my MacPorts.
    # It builds the rest using its own internal environment.
    # For consistency, clear MacPorts environment.
    configure.cxx_stdlib
    configure.sdkroot
    configure.cc_archflags
    configure.cxx_archflags
    configure.objc_archflags
    configure.objcxx_archflags
    configure.ld_archflags
    configure.cppflags
    configure.cflags
    configure.cxxflags
    configure.objcflags
    configure.objcxxflags
    configure.ldflags
    configure.pipe  no
    if { [variant_isset universal] } {
        set merger_arch_flag no
    }
    configure.march
    configure.mtune
    configure.universal_ldflags
    configure.universal_cflags
    configure.universal_cxxflags
    configure.universal_cppflags
}

if { ${subport} eq ${name} } {
    depends_lib                              \
        port:zlib                            \
        port:libpng                          \
        port:jpeg                            \
        port:freetype                        \
        path:bin/dbus-daemon:dbus            \
        port:openssl                         \
        port:tiff                            \
        port:libmng                          \
        path:lib/pkgconfig/glib-2.0.pc:glib2 \
        port:icu                             \
        port:pcre                            \
        port:libiconv

    # see https://bugreports.qt-project.org/browse/QTBUG-35514
    build.target

    if { [variant_isset universal] } {
        merger-post-destroot {
            foreach arch ${universal_archs_to_use} {
                set dir ${destroot}-${arch}

                reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${dir}${qt_frameworks_dir}/pkgconfig/Qt5WebKit.pc

                foreach prlfl [glob ${dir}${qt_frameworks_dir}/*.framework/*.prl] {
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${prlfl}
                }

                foreach prlfl [glob ${dir}${qt_frameworks_dir}/*.prl] {
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${prlfl}
                }

                foreach prlfl [glob ${dir}${qt_frameworks_dir}/*.framework/*.prl] {
                    reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${prlfl}
                }

                reinplace "s|${worksrcpath}-${arch}|${worksrcpath}|g" ${dir}${qt_mkspecs_dir}/modules/qt_lib_bootstrap_private.pri

                reinplace \
                    "s|^set(_qt5_corelib_extra_includes \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang.*\")$|set(_qt5_corelib_extra_includes \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang-32\" \"\${_qt5Core_install_prefix}/share/qt5//mkspecs/macx-clang\")|" \
                    ${dir}${qt_frameworks_dir}/cmake/Qt5Core/Qt5CoreConfigExtrasMkspecDir.cmake
            }
        }

        post-destroot {
            # delete preprocessor comments surrounding QT_CPU_FEATURES.i386 and QT_CPU_FEATURES.x86_64
            reinplace "/^#ifndef.*$/d" ${destroot}${qt_mkspecs_dir}/qmodule.pri
            reinplace "/^#else.*$/d"   ${destroot}${qt_mkspecs_dir}/qmodule.pri
            reinplace "/^#endif.*$/d"  ${destroot}${qt_mkspecs_dir}/qmodule.pri
        }

        # The file ${prefix}/share/qt5/mkspecs/qconfig.pri is still not properly merged
        # The solution is ???.
    }

    post-destroot {
        # move items out of the Frameworks directory that are more appropriate to lib directory
        xinstall -m 775 -d ${destroot}${qt_cmake_module_dir}
        foreach d [glob -tails -nocomplain -directory ${destroot}${qt_frameworks_dir}/cmake *] {
            xinstall -m 775 -d ${destroot}${qt_cmake_module_dir}/${d}
            foreach f [glob -nocomplain -directory ${destroot}${qt_frameworks_dir}/cmake/${d} *.cmake] {
                # ${qt_frameworks_dir} is  ${qt_dir}/Library/Frameworks while
                # ${qt_libs_dir}       is  ${qt_dir}/lib
                # unless modified, cmake files will point to a directory that is too high in the directory hierarchy
                reinplace "s|/../../../../|/../../../|g" ${f}
                file rename ${f} ${destroot}${qt_cmake_module_dir}/${d}/
            }
        }
        xinstall -m 775 -d ${destroot}${qt_pkg_config_dir}
        foreach f [glob -nocomplain -directory ${destroot}${qt_frameworks_dir}/pkgconfig *.pc] {
            file rename ${f} ${destroot}${qt_pkg_config_dir}
        }
        xinstall -m 775 -d ${destroot}${qt_libs_dir}/
        foreach f [glob -nocomplain -directory ${destroot}${qt_frameworks_dir} *.{a,prl,la}] {
            file rename ${f} ${destroot}${qt_libs_dir}/
        }

        # move items out of the bin directory that are more appropriate to the Applications directory
        xinstall -m 775 -d ${destroot}${qt_apps_dir}
        foreach f [glob -nocomplain -directory ${destroot}${qt_bins_dir} *.app] {
            file rename ${f} ${destroot}${qt_apps_dir}/
        }
    }

    variant harfbuzz description {(experimental) Use HarfBuzz-NG to do text shaping} {
        depends_lib-append port:harfbuzz
        configure.args-replace \
            -no-harfbuzz       \
            -system-harfbuzz
    }

    variant tests description {Enable tests} {
        configure.args-replace {-nomake tests} {-make tests}
    }

    variant examples description {Build examples} {
        configure.args-replace {-nomake examples} {-make examples}
    }

    variant debug description {Build both release and debug library} {
        configure.args-replace -release -debug-and-release
    }
}

subport ${name}-docs {
    depends_lib-append \
        path:${prefix}/bin/qdoc:${name} \
        path:${qt_plugins_dir}/sqldrivers/libqsqlite.dylib:${name}-sqlite3-plugin

    supported_archs   noarch

    build.target      docs
    destroot.target   install_docs

    post-extract {
        # For the most part, generated makefiles use ${prefix}/bin/qdoc.
        # There are a couple of places that look in ${worksrcpath}/qtbase/src/tools/qdoc/.
        ln -s ${prefix}/bin/qdoc ${worksrcpath}/qtbase/src/tools/qdoc/
        ln -s ${prefix}/bin/qdoc ${worksrcpath}/qtbase/bin

        # Similarly, location of qhelpgenerator is expected in ${worksrcpath}
        xinstall -d -m 755 ${worksrcpath}/qttools/bin/
        ln -s ${prefix}/bin/qhelpgenerator ${worksrcpath}/qttools/bin/

        # Without this file, the makefile ${worksrcpath}/qtwebkit/Source/WebCore/Makefile.WebCore.Target
        #    keeps generating itself over and over again.
        # This file is only created when the library is being built, however.
        xinstall -d -m 755 ${worksrcpath}/qtwebkit/Source/WebCore/generated
        touch ${worksrcpath}/qtwebkit/Source/WebCore/generated/InspectorBackendCommands.qrc
    }
}

# See http://qt-project.org/doc/qt-5/sql-driver.html for info on building SQL Database Drivers

subport ${name}-sqlite3-plugin {
    PortGroup           qmake5 1.0

    depends_lib-append port:sqlite3

    # for single architecture, easier to use
    #    worksrcdir ${worksrcdir}/qtbase/src/plugins/sqldrivers/sqlite,
    #    but doesn't work for universal build
    configure.dir ${worksrcpath}/qtbase/src/plugins/sqldrivers/sqlite
    build.dir     ${configure.dir}
    destroot.dir  ${configure.dir}

    configure.args-append "INCLUDEPATH+=${prefix}/include" "LIBS+=\"-L${prefix}/lib -lsqlite3\""
}

subport ${name}-psql84-plugin {
    PortGroup           qmake5 1.0

    depends_lib-append port:postgresql84

    # for single architecture, easier to use
    #    worksrcdir ${worksrcdir}/qtbase/src/plugins/sqldrivers/psql,
    #    but doesn't work for universal build
    configure.dir ${worksrcpath}/qtbase/src/plugins/sqldrivers/psql
    build.dir     ${configure.dir}
    destroot.dir  ${configure.dir}

    configure.args-append "INCLUDEPATH+=${prefix}/include/postgresql84" "LIBS+=\"-L${prefix}/lib/postgresql84 -lpq\""
}

subport ${name}-mysql56-plugin {
    PortGroup           qmake5 1.0

    depends_lib-append port:mysql56

    # for single architecture, easier to use
    #    worksrcdir ${worksrcdir}/qtbase/src/plugins/sqldrivers/mysql,
    #    but doesn't work for universal build
    configure.dir ${worksrcpath}/qtbase/src/plugins/sqldrivers/mysql
    build.dir     ${configure.dir}
    destroot.dir  ${configure.dir}

    configure.args-append "INCLUDEPATH+=${prefix}/include/mysql56/mysql" "LIBS+=\"-L${prefix}/lib/mysql56/mysql -lmysqlclient_r\""
}

livecheck.type      regex
livecheck.url       http://qt-project.org/downloads
livecheck.regex     "Qt (5(?:\\.\\d+)*) for Mac"
