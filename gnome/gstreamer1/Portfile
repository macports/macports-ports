# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           conflicts_build 1.0
PortGroup           meson 1.0

# https://bugzilla.gnome.org/show_bug.cgi?id=636134
PortGroup           muniversal 1.0

name                gstreamer1
set my_name         gstreamer
# please only commit stable updates (even numbered releases)
version             1.22.5
revision            0
description         GStreamer is a library for constructing graphs of media-handling components.
long_description    The applications it supports range from simple Ogg/Vorbis playback, audio/video \
                    streaming to complex audio (mixing) and video (non-linear editing) processing.
maintainers         nomaintainer
categories          gnome
license             LGPL-2+
homepage            https://${my_name}.freedesktop.org/
master_sites        https://gstreamer.freedesktop.org/src/${my_name}/
distname            ${my_name}-${version}
use_xz              yes

checksums           rmd160  d8f9baf1ea46b510c5425c0eec36a1619bce2f2b \
                    sha256  4408d7930f381809e85917acc19712f173261ba85bdf20c5567b2a21b1193b61 \
                    size    1790096

set py_ver          3.11
set py_ver_nodot    [string map {. {}} ${py_ver}]
set python.bin      ${prefix}/bin/python${py_ver}

depends_build-append \
                    port:gettext \
                    port:gtk-doc \
                    port:gzip \
                    path:bin/perl:perl5 \
                    port:pkgconfig \
                    port:python${py_ver_nodot}

depends_lib-append  port:bison \
                    port:flex \
                    port:gettext-runtime \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    path:lib/pkgconfig/gobject-introspection-1.0.pc:gobject-introspection \
                    port:libxml2

conflicts_build     check

patchfiles          patch-gstreamer1-darwin-numcpufix-sysctl.diff \
                    patch-gst-gst-c-tiger-no-procpidpath.diff

post-patch {
    reinplace "s|/usr/bin/env python3|${python.bin}|" \
        ${worksrcpath}/scripts/extract-release-date-from-doap-file.py \
        ${worksrcpath}/scripts/dist-translations.py \
        ${worksrcpath}/gst/parse/get_flex_version.py \
        ${worksrcpath}/gst/parse/gen_lex.py.in \
        ${worksrcpath}/gst/parse/gen_grammar.py.in \
        ${worksrcpath}/docs/gst-plugins-doc-cache-generator.py
}

configure.env-append    PERL_PATH=${prefix}/bin/perl
configure.cflags-append -funroll-loops -fstrict-aliasing -fno-common

if {[string match "*gcc-4.2" ${configure.compiler}]} {
    configure.cflags-append -std=c99
}

configure.args-append \
                    -Dexamples=disabled \
                    -Dintrospection=enabled \
                    -Dlibdw=disabled \
                    -Dlibunwind=disabled \
                    -Dbash-completion=disabled

test.run            yes
test.target         check

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     "${my_name}-(\\d+\\\.\\d*\[02468\](?:\\.\\d+)*)${extract.suffix}"
