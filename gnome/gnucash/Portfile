# $Id$

PortSystem        1.0

name              gnucash
version           2.2.5
categories        gnome x11
maintainers       nomaintainer
platforms	darwin
description       a personal and small-business financial-accounting software
long_description  GnuCash is a personal and small-business \
		  financial-accounting software, freely licensed under the \
		  GNU GPL.  Designed to be easy to use, yet powerful and \
		  flexible, GnuCash allows you to track bank accounts, \
		  stocks, income and expenses. As quick and intuitive to \
		  use as a checkbook register, it is based on professional \
		  accounting principles to ensure balanced books and \
		  accurate reports.

homepage          http://www.gnucash.org/
master_sites      sourceforge \
		  http://www.gnucash.org/pub/gnucash/sources/stable/
use_bzip2	  yes
checksums     md5 81d8d115e27db96ab2b47727010ccdc4 \
              sha1 32acf9c980000fd851b543ac541a786ac36cf721

depends_lib	  lib:XML/Parser.pm:p5-xml-parser \
		  port:glib2 \
		  port:gconf \
		  port:guile16 \
		  port:slib \
		  port:slib-guile16 \
		  lib:libpopt:popt \
		  lib:libgnomeui:libgnomeui \
		  lib:libgnomeprintui:libgnomeprintui \
		  lib:libgtkhtml-3:libgtkhtml3 \
		  lib:libgsf:libgsf \
		  lib:libgoffice-0.6:goffice \
		  lib:aqbanking:aqbanking \
		  lib:libofx:libofx \
		  lib:Finance/Quote.pm:p5-finance-quote

depends_build	  bin:glibtoolize:libtool
depends_run	  port:evince

configure.args	  --disable-glibtest \
		  --disable-dependency-tracking --enable-hbci --enable-ofx

patchfiles	patch-configure.diff

post-patch {
	reinplace "/^DYLD_LIBRARY_PATH/s|=\"|=\"/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/Resources@-PATH_SEPARATOR-@|" ${worksrcpath}/src/bin/gnucash.in
	reinplace "/^DYLD_LIBRARY_PATH/s|=\"|=\"/System/Library/Frameworks/ApplicationServices.framework/Versions/A/Frameworks/ImageIO.framework/Versions/A/Resources@-PATH_SEPARATOR-@|" ${worksrcpath}/src/bin/overrides/gnucash-env.in
	fs-traverse src_file ${worksrcpath}/src {
		if { [ file isfile ${src_file} ] } {
			reinplace "s|\\<guile\\/|\<guile16\\/|g"   ${src_file}
			reinplace "s|libguile\\.h|libguile16\\.h|g" ${src_file}
			reinplace "s|exec\\ guile|exec\\ guile16|g" ${src_file}
		}
	}
}

variant without_quotes description {Does not depend on building p5-finance-quote} {
	depends_lib-delete	lib:Finance/Quote.pm:p5-finance-quote
}

variant without_hbci description {Disables HBCI support} {
	depends_lib-delete	lib:aqbanking:aqbanking
	configure.args-delete	--enable-hbci
	configure.args-append	--disable-hbci
}

variant without_ofx description {Disables ofx support} {
	depends_lib-delete	lib:libofx:libofx
	configure.args-delete	--enable-ofx
	configure.args-append	--disable-ofx
}

set storagedir  ${prefix}/etc/macports/gconf
set storagefile $storagedir/${name}

post-destroot {
	# We need to register some stuff to gconf. Just putting the
	# schema files to the right place is not enough.
	# For now we store the files in
	# ${prefix}/etc/macports/gconf/${name} and use that file
	# in post-activate. Until there is no better solution
	# this will make it into the gnomeportgroup

	fs-traverse schema ${destroot}${prefix}/etc/gconf/schemas {
		if { [ file isfile $schema ] } {
			lappend schemafiles $schema
		}
	}

	if { [ llength $schemafiles ] > 0 } {
		file mkdir ${destroot}${storagedir}
		set fh [open ${destroot}${storagefile} w]
		foreach file $schemafiles {
			puts $fh [exec basename $file]
		}
		close $fh
	}
}

post-activate {
	if { [file exists ${storagefile} ] } {
		set fh [open ${storagefile} r]
		while { ! [eof $fh] } {
			lappend schemafiles [gets $fh]
		}
		close $fh
	}

	set schemastring [join $schemafiles " "]

        system "cd ${prefix}/etc/gconf/schemas && \
        GCONF_CONFIG_SOURCE=`${prefix}/bin/gconftool-2 --get-default-source` ${prefix}/bin/gconftool-2 --makefile-install-rule $schemastring"
}
