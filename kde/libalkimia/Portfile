# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4

PortSystem          1.0

PortGroup           kde4   1.1
PortGroup           github 1.0

github.setup KDE alkimia 8.0.3
name                libalkimia

categories          kde finance
maintainers         {nicos @NicosPavlov} openmaintainer
description         Common Alkimia classes.
long_description    Alkimia is the infrastructure for common storage and business \
                    logic that will be used by all financial applications in KDE. \
                    The target is to share financial related information over application \
                    boundaries. The libalkimia library contains some common classes.
platforms           darwin
license             {LGPL-2.1 LGPL-3+}

checksums           rmd160  a7d4ce95f2304049d59b8cf751501fd91c598151 \
                    sha256  9146a57af99ec0e642f6430a25014f5d4ce2470dc80f0369244c9a6019a67a53 \
                    size    290463

depends_build       port:kde-extra-cmake-modules \
                    port:cmake \
                    port:automoc

depends_lib-append  port:kdelibs4 \
                    port:mpir

# need Qt4 for KDE4
configure.args-append -DBUILD_QT4=1

# fix wrong linking
post-destroot {

    system -W ${destroot}/${prefix}/lib "\
    install_name_tool -id ${prefix}/lib/libalkimia.8.dylib libalkimia.8.dylib "

    set defective [ list \
        /Applications/MacPorts/KDE4/onlinequoteseditor.app/Contents/MacOS/onlinequoteseditor \
        ${prefix}/lib/qt4/plugins/imports/org/kde/alkimia/libqmlalkimia.dylib \
        ${prefix}/lib/kde4/plasma_applet_onlinequote.so \
    ]

    foreach f ${defective} {
        system -W ${destroot} "\
            install_name_tool -change \
            lib/libalkimia.8.dylib \
            ${prefix}/lib/libalkimia.8.dylib ${destroot}/${f} "
        }

    reinplace "s|lib/libalkimia.8.dylib|${prefix}/lib/libalkimia.8.dylib|" \
        ${destroot}/${prefix}/lib/cmake/LibAlkimia-8.0/LibAlkimiaTargets-release.cmake

    reinplace "s|\$\{_IMPORT_PREFIX\}/lib/libalkimia.8.0.3.dylib|${prefix}/lib/libalkimia.8.dylib|" \
        ${destroot}/${prefix}/lib/cmake/LibAlkimia-8.0/LibAlkimiaTargets-release.cmake
}

# darwin17 (and later?) does not export visible symbols
# https://trac.macports.org/ticket/55090
if { ${os.platform} eq "darwin" && ${os.major} >= 17 } {
    configure.cxxflags-append -D__KDE_HAVE_GCC_VISIBILITY
}
