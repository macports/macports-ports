# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           cmake   1.0
PortGroup           qt4     1.0

name                qgis
version             2.12.0
revision            1
categories          gis
maintainers         vince
description         QGIS is a user-friendly GIS based on Qt 4
long_description    QGIS is a GIS. It can visualize, inject data into\
                    PostGres/PostGIS, or serve as a Qt front-end to\
                    Grass. Extended with Python plugins, it can become\
                    a quite powerful GIS on its own.

platforms           darwin
license             GPL

use_parallel_build  no
homepage            http://www.qgis.org/

distname            ${name}-${version}
master_sites        http://qgis.org/downloads/
use_bzip2           yes

checksums           rmd160  87b234216c2dbd02ea2b5413b4787cea4e083638 \
                    sha256  b8e58ef85e6686349993acf2cb83060135f2794f03475f7a3da788c458b81b1d

patchfiles          patch-app_info_plist_in.diff

worksrcdir          ${name}-${version}

depends_lib-append  port:libiconv \
                    port:expat \
                    path:lib/libssl.dylib:openssl \
                    port:proj \
                    port:geos \
                    port:gdal \
                    port:sqlite3 \
                    port:gsl \
                    port:qwt52 \
                    port:fcgi \
                    port:spatialindex \
                    port:postgis2 \
                    port:python27 \
                    port:py27-pyqt4 \
                    port:py27-qscintilla \
                    port:py27-gdal \
                    port:qca \
                    port:qca-ossl

depends_build-append \
                    port:bison \
                    port:ld64 \
                    port:py27-sip

depends_run-append  port:py27-psycopg2 \
                    port:py27-spatialite

post-extract {
    system -W ${worksrcpath} "mkdir build"
}


post-patch {
    reinplace -E "s|@@@|${prefix}|g" \
        ${worksrcpath}/mac/app.info.plist.in
}

# Overrides default

if {![variant_isset postgresql93] && ![variant_isset postgresql94]} {

    default_variants    +postgresql94
}

# Python related stuff

set Py_FRM              ${frameworks_dir}/Python.framework/Versions/2.7

configure.args-append  "-DPYTHON_EXECUTABLE=${prefix}/bin/python2.7"
configure.args-append  "-DPYUIC4_PROGRAM=${prefix}/bin/pyuic4-2.7"
configure.args-append  "-DPYRCC4_PROGRAM=${prefix}/bin/pyrcc4-2.7"
configure.args-append  "-DPYTHON_CUSTOM_FRAMEWORK=${Py_FRM}"
configure.args-append  "-DSIP_BINARY_PATH=${prefix}/bin/sip-2.7"
configure.args-append  "-DWITH_GRASS=OFF"
configure.args-append  "-DWITH_GRASS7=OFF"
configure.args-append  "-DWITH_SERVER=TRUE"
configure.args-append  "-DWITH_SERVER_PLUGINS=TRUE"
configure.args-append  "-DGIT_MARKER=GIT_MARKER-NOTFOUND"

pre-configure {
    reinplace -E "s|Versions/Current|Versions/2.7|" \
        ${worksrcpath}/cmake/FindPythonLibrary.cmake
}

variant postgresql93    conflicts postgresql94 \
                        description "Use postgresql 9.3" {

    depends_lib-append      port:postgresql93
    set PGSQL_DIR           ${prefix}/lib/postgresql93
    configure.args-append   \
                "-DPOSTGRES_CONFIG=${PGSQL_DIR}/bin/pg_config"
}

variant postgresql94    conflicts postgresql93 \
                        description "Use postgresql 9.4" {

    depends_lib-append      port:postgresql94
    set PGSQL_DIR           ${prefix}/lib/postgresql94
    configure.args-append   \
                "-DPOSTGRES_CONFIG=${PGSQL_DIR}/bin/pg_config"
}

variant grass               description "Build Grass 7 plugin" {

    #depends_lib-append      port:grass
    configure.args-delete  "-DWITH_GRASS7=OFF"
    configure.args-append  "-DWITH_GRASS7=ON"
    configure.args-append   \
                "-DGRASS_PREFIX7=${prefix}/share/grass-7.0.2"
}

configure.dir               ${worksrcpath}/build
configure.cmd               cmake ..

configure.args-append  "-DCMAKE_CXX_COMPILER=${configure.cxx}"
configure.args-append  "-DCMAKE_C_COMPILER=${configure.cc}"
configure.args-append  "-DEXPAT_INCLUDE_DIR=${prefix}/include"
configure.args-append  "-DEXPAT_LIBRARY=${prefix}/lib/libexpat.dylib"
configure.args-append  "-DCMAKE_INSTALL_PREFIX=${applications_dir}"
configure.args-append  "-DQGIS_MACAPP_BUNDLE=0"
configure.args-append  "-DGDAL_CONFIG=${prefix}/bin/gdal-config"
configure.args-append  "-DGDAL_INCLUDE_DIR=${prefix}/include"
configure.args-append  "-DGDAL_LIBRARY=${prefix}/lib/libgdal.dylib"
configure.args-append  "-DGEOS_CONFIG=${prefix}/bin/geos-config"
configure.args-append  "-DGEOS_INCLUDE_DIR=${prefix}/include"
configure.args-append  "-DGEOS_LIBRARY=${prefix}/lib/libgeos_c.dylib"
configure.args-append  "-DGSL_CONFIG=${prefix}/bin/gsl-config"
configure.args-append  "-DPROJ_INCLUDE_DIR=${prefix}/include"
configure.args-append  "-DPROJ_LIBRARY=${prefix}/lib/libproj.dylib"
configure.args-append  \
        "-DSPATIALINDEX_LIBRARY=${prefix}/lib/libspatialindex.dylib"
configure.args-append  "-DCMAKE_BUILD_TYPE=Release"

use_parallel_build          yes
build.dir                   ${worksrcpath}/build
destroot.target             install
