# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

# TODO: Improve atomics by using libkern/OSAtomics.h
#       https://bugs.freedesktop.org/show_bug.cgi?id=67795

PortSystem          1.0

name                pulseaudio
version             6.0
revision            3
license             LGPL-2.1
categories          audio
maintainers         ionic openmaintainer
platforms           darwin
description         A sound server for POSIX OSes

long_description    PulseAudio is a sound server for POSIX OSes, meaning that it is a proxy \
                    for your sound applications. It allows you to do advanced operations \
                    on your sound data as it passes between your application and your hardware. \
                    Things like transferring the audio to a different machine, changing the \
                    sample format or channel count and mixing several sounds into one are \
                    easily achieved using a sound server.

homepage            http://www.freedesktop.org/wiki/Software/PulseAudio/
master_sites        http://freedesktop.org/software/${name}/releases/

use_xz              yes

checksums           rmd160  a3f96cabc2872646c34ba581d6044dc4a6513fd9 \
                    sha256  b50640e0b80b1607600accfad2e45aabb79d379bf6354c9671efa2065477f6f6

depends_build       port:pkgconfig \
                    port:intltool \
                    port:autoconf \
                    port:automake \
                    port:libtool \
                    port:p5.16-xml-parser

depends_lib         port:libiconv \
                    port:json-c \
                    port:libsndfile \
                    port:libsamplerate \
                    port:libtool \
                    port:gdbm \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:gtk3 \
                    port:dbus \
                    port:fftw-3-single \
                    path:lib/libspeex.dylib:speex \
                    port:orc

# configure falls back to libatomic_ops as last resort
# if no linux kernel support and inline asm snippet fails to build
# likely to fail on Leopard and older
# https://trac.macports.org/ticket/42052

platform darwin {
    if {${os.major} < 10} {
        depends_lib-append  port:libatomic_ops
    }
}

# DO NOT USE! Maintainer-only helper. DO NOT USE!
#configure.cflags-append -g3 -ggdb3 -gdwarf-4 -O0
#configure.cxxflags-append -g3 -ggdb3 -gdwarf-4 -O0

# The last three patches make PulseAudio startup correctly.
# Will hopefully be merged upstream soon.
# All work has been sent upstream.
# C.f. https://bugs.freedesktop.org/show_bug.cgi?id=62987
# and posts on the mailing list.
patchfiles          patch-man-Makefile.am.diff \
                    i386.patch \
                    patch-configure.ac-add-HAVE_COREAUDIO.diff \
                    patch-src_daemon_default.pa.in-load-module-coreaudio-detect.diff \
                    patch-src_daemon_system.pa.in-load-module-coreaudio-detect.diff \
                    patch-src_daemon_default.pa.in-skip-consolekit-and-systemdlogin.diff \
                    patch-src_modules_macosx_module_coreaudio_device.c-fix-device-names.diff \
                    patch-src_modules_macosx_module_coreaudio_device.c-fix-channels.diff \
                    patch-src_modules_macosx_module_coreaudio_device.c-respect-PA_NAME_MAX.diff

# reconfigure using upstream autogen.sh for intltool 0.51 compatibility

post-patch {
    xinstall -m 755 ${filespath}/autogen.sh ${worksrcpath}
    reinplace "s|@@MP_PERL@@|${prefix}/bin/perl5.16|" ${worksrcpath}/man/Makefile.am
}

configure.cmd       ./autogen.sh

configure.args      --with-mac-sysroot=/ \
                    --with-mac-version-min=$macosx_deployment_target \
                    --without-caps \
                    --disable-silent-rules \
                    --disable-tests \
                    --disable-x11 \
                    --disable-oss-output \
                    --disable-alsa \
                    --disable-esound \
                    --disable-solaris \
                    --disable-waveout \
                    --disable-avahi \
                    --disable-gconf \
                    --disable-jack \
                    --disable-asyncns \
                    --disable-tcpwrap \
                    --disable-lirc \
                    --disable-bluez4 \
                    --disable-bluez5 \
                    --disable-udev \
                    --disable-hal-compat \
                    --disable-openssl \
                    --disable-xen \
                    --disable-systemd \
                    --enable-neon-opt=no \
                    --enable-orc

add_users           pulse group=pulse realname=Pulse\ Audio

variant x11 {
    configure.args-delete   --disable-x11
    depends_lib-append      port:xorg-libX11 \
                            port:xorg-libxcb \
                            port:xorg-libice \
                            port:xorg-libsm \
                            port:xorg-libXtst
}

variant jack description {Enable Jack support} {
    configure.args-delete   --disable-jack
    depends_lib-append      port:jack
}

variant _internal_valgrind description {DO NOT USE! Enable valgrind support. DO NOT USE!} {
    depends_lib-append      path:bin/valgrind:valgrind-devel
    patchfiles-append       patch-src_daemon_caps.c-enable-root.diff
}

default_variants    +x11

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     "${name}-(\\d+(?:\\.\\d+)*)${extract.suffix}"
