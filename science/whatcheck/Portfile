# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                whatcheck
version             8.0
categories          science
maintainers         bromo.med.uc.edu:howarth

description         Protein verification tools from WhatIf
long_description    ${description}

homepage            http://swift.cmbi.ru.nl/gv/whatcheck/
platforms           darwin
master_sites        ${homepage}:whatcheck \
                    ftp://ftp.cmbi.kun.nl/pub/molbio/software/:dsspcmbi
distfiles           whatcheck.tar.bz2:whatcheck \
                    dsspcmbi.zip:dsspcmbi
checksums           whatcheck.tar.bz2 md5 66f4398ac459a1742128209c5285de03 \
                                      sha1 dee7eeb6fba60749607eadda46cf89766096098d \
                                      rmd160 ac21b18829cd33557eec641610d8e9795e769561 \
                    dsspcmbi.zip      md5 718779c6c5469429994a2ca284777050 \
                                      sha1 de348eea9be2d67ec33f9dc6346fd966e4bb538a \
                                      rmd160 f65caa60735b2996b6f2ea80108ade8e88f60458
dist_subdir         ${name}/${version}
worksrcdir          ${name}
depends_lib         port:gcc44 port:xfig
patchfiles          whatcheck.patch
use_configure       no
use_bzip2           yes
extract.only        whatcheck.tar.bz2

post-patch {
     reinplace  "s|@PREFIX@|${prefix}|g" ${worksrcpath}/Makefile_whatcheck \
                                         ${worksrcpath}/WHATIF.FIG \
                                         ${worksrcpath}/DO_WHATCHECK.COM
     reinplace  "s|-O0|-O3|g" ${worksrcpath}/Makefile_whatcheck
     system "cd ${worksrcpath} && rm -fr *.o dbdata/fonts/.svn"
     system "cd ${worksrcpath} && rm -fr dssp && unzip ${distpath}/dsspcmbi.zip"
     reinplace  "s|-static||g" ${worksrcpath}/dssp/DsspCompileGCC
     reinplace  "s|-O|-O3|g" ${worksrcpath}/dssp/DsspCompileGCC
     if {"little" != ${os.endian}} {
        reinplace  "s|gfortran-mp-4.4|gfortran-mp-4.4 -fconvert=little-endian|g"  ${worksrcpath}/Makefile_whatcheck
     }
}

build {
     system "cd ${worksrcpath} && touch * && make -f Makefile_whatcheck"
     system "cd ${worksrcpath}/scatter && export FC=gfortran-mp-4.4 && make clean && make"
     system "cd ${worksrcpath}/dssp && ./DsspCompileGCC"
}

destroot {
     file mkdir ${destroot}${prefix}/share/whatcheck/dssp
     copy ${worksrcpath}/dssp/dsspcmbi ${destroot}${prefix}/share/whatcheck/dssp/DSSP.EXE

     foreach d {whatcheck WHATIF.FIG supertab.sty DO_WHATCHECK.COM ascdata bindata dbdata nqual qualty} {
        copy ${worksrcpath}/${d} ${destroot}${prefix}/share/whatcheck
     }

     file mkdir ${destroot}${prefix}/share/whatcheck/scatter
     foreach d {scatter SCATTER.fig scatter.html} {
        copy ${worksrcpath}/scatter/${d} ${destroot}${prefix}/share/whatcheck/scatter
     }

     ln -s ${prefix}/bin/fig2dev ${destroot}${prefix}/share/whatcheck/scatter/fig2dev
     ln -s ${prefix}/share/whatcheck/DO_WHATCHECK.COM  ${destroot}${prefix}/bin/whatcheck
     ln -s ${prefix}/share/whatcheck/dssp/DSSP.EXE ${destroot}${prefix}/bin/dssp
}

livecheck.type      regex
livecheck.url       ${homepage}WCHECK_misc.html
livecheck.regex     {Version ([0-9.]+) \(stable\)}
