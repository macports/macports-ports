# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0

name                mpich
version             3.0.1
revision            0

license             BSD
categories          science parallel net
platforms           darwin
maintainers         eborisch \
                    openmaintainer

description         Message Passing Interface (MPI) Library

long_description    MPICH is a high-performance and widely portable\
                    implementation of the Message Passing Interface (MPI) \
                    standard (MPI-1, MPI-2 and MPI-3). The goals of MPICH are:\
                    (1) to provide an MPI implementation that efficiently\
                    supports different computation and communication platforms\
                    including commodity clusters (desktop systems,\
                    shared-memory systems, multicore architectures), high-speed\
                    networks (10 Gigabit Ethernet, InfiniBand, Myrinet,\
                    Quadrics) and proprietary high-end computing systems (Blue\
                    Gene, Cray) and (2) to enable cutting-edge research in MPI\
                    through an easy-to-extend modular framework for other\
                    derived implementations. \n\
                    \n\
                    The mpich port follows the latest mpich 3.x line, and is \
                    the successor to the mpich2 port. Starting with the major \
                    release in November 2012, the project is renamed back to \
                    MPICH (from MPICH2) with a version number of 3.0. 
homepage            http://www.mpich.org/

checksums \
    rmd160  a30aa14f9360b9cf2e88f9cd4f06b24b8800c55d \
    sha256  8e93e4426bbf10fcde7d2422d78032010f73dd3bb59ab39a17c25d95223e87d8

configure.args      --disable-dependency-tracking \
                    --disable-f77 \
                    --disable-fc \
                    --disable-silent-rules \
                    --enable-base-cache \
                    --enable-cache \
                    --enable-cxx \
                    --enable-fast=O2 \
                    --enable-shared \
                    --enable-smpcoll \
                    --with-device=ch3:nemesis \
                    --with-pm=hydra \
                    --with-thread-package=posix \
                    "F90FLAGS='' F90=''"

subport mpich-devel {
    conflicts           mpich
#    version             3.0
}

if {${subport} == ${name}} {
    conflicts           mpich-devel
}

master_sites        ${homepage}static/tarballs/${version}/

conflicts-append    mpich2 \
                    mpich2-devel \
                    lammpi \
                    openmpi

universal_variant   no

depends_lib-append  port:libxml2

platform darwin {
    configure.args-append   --enable-timer-type=mach_absolute_time
}

# We're making compiler wrappers here... don't default to -O2 for wrappers.
# Actual library code is compiled with -O2 via --enable-fast=O2 configure arg
configure.cflags-delete     -O2
configure.cxxflags-delete   -O2
configure.fflags-delete     -O2
configure.fcflags-delete    -O2
configure.cppflags-delete   -I${prefix}/include

# As MPICH creates compiler wrappers, there are lots of
# variants for what compiler the user would like to wrap.

variant gcc47 description {
    Enable Fortran 77 and Fortran 90 bindings using gfortran from gcc47 port
} conflicts gcc43 gcc44 gcc45 gcc46 llvm clang clang31 clang32 {
    depends_lib-append      port:gcc47
    configure.compiler      macports-gcc-4.7
}

variant gcc46 description {
    Enable Fortran 77 and Fortran 90 bindings using gfortran from gcc46 port
} conflicts gcc43 gcc44 gcc45 gcc47 llvm clang clang31 clang32 {
    depends_lib-append      port:gcc46
    configure.compiler      macports-gcc-4.6
}

variant gcc45 description {
    Enable Fortran 77 and Fortran 90 bindings using gfortran from gcc45 port
} conflicts gcc43 gcc44 gcc46 gcc47 llvm clang clang31 clang32 {
    depends_lib-append      port:gcc45
    configure.compiler      macports-gcc-4.5
}

variant gcc44 description {
    Enable Fortran 77 and Fortran 90 bindings using gfortran from gcc44 port
} conflicts gcc43 gcc45 gcc46 gcc47 llvm clang clang31 clang32 {
    depends_lib-append      port:gcc44
    configure.compiler      macports-gcc-4.4
}

variant gcc43 description {
    Enable Fortran 77 and Fortran 90 bindings using gfortran from gcc43 port
} conflicts gcc44 gcc45 gcc46 gcc47 llvm clang clang31 clang32 {
    depends_lib-append      port:gcc43
    configure.compiler      macports-gcc-4.3
}

if {[ variant_isset gcc43 ] ||
    [ variant_isset gcc44 ] ||
    [ variant_isset gcc45 ] ||
    [ variant_isset gcc46 ] ||
    [ variant_isset gcc47 ]} {
    configure.args-append   --enable-f77 --enable-fc
    configure.args-delete   --disable-f77 --disable-fc
}

variant llvm description {
    Use Apple-supplied llvm-gcc
} conflicts gcc43 gcc44 gcc45 gcc46 gcc47 clang clang31 clang32 {
    configure.compiler      llvm-gcc-4.2
}

variant clang description {
    Use Apple-supplied clang
} conflicts gcc43 gcc44 gcc45 gcc46 gcc47 llvm clang31 clang32 {
    configure.compiler      clang
}

variant clang31 description {
    Use clang 3.1 from MacPorts
} conflicts gcc43 gcc44 gcc45 gcc46 gcc47 llvm clang clang32 {
    depends_lib-append      port:clang-3.1
    configure.compiler      macports-clang-3.1
}

variant clang32 description {
    Use clang 3.2 from MacPorts
} conflicts gcc43 gcc44 gcc45 gcc46 gcc47 llvm clang clang31 {
    depends_lib-append      port:clang-3.2
    configure.compiler      macports-clang-3.2
}

variant gforker description {
    Use gforker process manager instead of the default hydra
} {
    configure.args-append   --with-pm=gforker
    configure.args-delete   --with-pm=hydra
}

variant tuned description {Build with more optimizations} {
    configure.args-delete       --enable-fast=O2
    configure.args-append       --enable-fast=all \
                                MPICHLIB_CFLAGS='-fomit-frame-pointer -O2'
}

if {${configure.compiler} == "clang"} {
    configure.env-append    ac_cv_tls=none
}

livecheck.type      regex
livecheck.regex     ${name}-(\[0-9.pbrc\]+)${extract.suffix}
livecheck.url       ${homepage}downloads/index.php?s=downloads
