# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0

github.setup            SAOImageDS9 SAOImageDS9 8.3 v
name                    ds9
revision                0

categories              science graphics
maintainers             {aronnax @lpsinger}
license                 GPL-3+
description             SAOImage DS9 astronomical imaging and visualization application
long_description \
    SAOImage DS9 is an astronomical imaging and data visualization \
    application. DS9 supports FITS images and binary tables, multiple frame \
    buffers, region manipulation, and many scale algorithms and colormaps. It \
    provides for easy communication with external analysis tasks and is highly \
    configurable and extensible via XPA and SAMP.

# The GPL and OpenSSL licenses conflict with each other, and our build
# dependency on cmake results in an indirect dependency on OpenSSL.
# However, there is no real conflict in the case of LALSuite because OpenSSL
# is only used to run cmake.
license_noconflict      openssl

homepage                https://sites.google.com/cfa.harvard.edu/saoimageds9

checksums               rmd160  a544bb983328667af065afd81489c56d55584012 \
                        sha256  7e6c60b72b009f0765ad7e5c522a8172d5dd75107c70ef85a40ad510649a1e8b \
                        size    73001857

depends_build-append    port:autoconf

depends_lib-append      port:ast \
                        port:fontconfig \
                        port:freetype \
                        port:libxml2 \
                        port:libiconv \
                        port:openssl10 \
                        port:zlib \
                        port:libzip

universal_variant       no

worksrcdir              SAOImageDS9

patchfiles              use-MacPorts-share-directory-instead-of-zipfs.patch \
                        use-openssl-1.0-from-MacPorts-instead-of-bundled-version.patch \
                        use-ast-from-MacPorts.patch

post-patch {
    # FIXME: Prefix has to be embedded in source and Makefiles in some places.
    reinplace "s|@macports_prefix@|${prefix}|g" \
        ${worksrcpath}/ds9/macos/Makefile.in \
        ${worksrcpath}/ds9/unix/Makefile.in \
        ${worksrcpath}/ds9/library/ds9.tcl \
        ${worksrcpath}/tls/aclocal.m4
}

variant x11 conflicts aqua description {Enable X11 GUI} {
    depends_lib-append  port:xorg-libX11 \
                        port:xorg-libXext \
                        port:xorg-libXt \
                        port:Xft2 \
                        port:xrender \
                        port:xorg-libXScrnSaver

    configure.cmd       unix/configure

    destroot {
        xinstall -W ${worksrcpath}/bin ds9 ds9.zip ${destroot}${prefix}/bin
        copy ${worksrcpath}/ds9/unix/mntpt ${destroot}${prefix}/share/ds9
    }
}

variant aqua conflicts x11 description {Enable Mac OS X GUI} {
    configure.cmd       macos/configure

    destroot {
        copy ${worksrcpath}/bin/SAOImageDS9.app ${destroot}${applications_dir}/SAOImage\ DS9.app
    }
}

if {![variant_isset x11] && ![variant_isset aqua]} {
    default_variants    +x11
}

pre-configure {
    # Regenerate build system for these subdirectories because we patched configure.ac.
    foreach subdir {tksao tls} {
        system -W ${worksrcpath}/${subdir} "autoreconf"
    }
}

compiler.cxx_standard   2011
configure.cxxflags-append -std=c++11
configure.cmd           unix/configure

build.args-append       JOBS=${build.jobs} \
                        CC=${configure.cc} \
                        CXX=${configure.cxx} \
                        CXXFLAGS="${configure.cxxflags}" \
                        XINCLUDES=-I${prefix}/include \
                        XML_INCLUDEDIR=${prefix}/include/libxml2

github.livecheck.regex  {([0-9.]+)}
