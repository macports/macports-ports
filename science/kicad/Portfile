# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           gitlab 1.0
PortGroup           boost 1.0
PortGroup           legacysupport 1.1

name                kicad
version             8.0.1
description         KiCad is an electronic design automation software suite
long_description    KiCad is an EDA software suite for the creation of professional schematics \
                    and printed circuit boards up to 32 copper layers with additional technical layers.
categories          science
license             GPL-3
maintainers         {ra1nb0w @ra1nb0w} openmaintainer
homepage            https://www.kicad.org/

set python_version  3.11
set py_ver_no_dot   [join [split ${python_version} "."] ""]
set python_framework_dir ${frameworks_dir}/Python.framework/Versions/${python_version}

compiler.cxx_standard 2017

# It requires c++17 <filesystem> and abs
legacysupport.newest_darwin_requires_legacy 19
legacysupport.use_mp_libcxx yes

if {${name} eq ${subport}} {

    gitlab.setup        kicad/code kicad ${version}

    checksums           rmd160  86f6fec4eaabe36ea65c9403d183c3e4bcc9fd6d \
                        sha256  7ea3f18650ce1b5359c685d10245efd95f87fa42ee52a1585bbc22d957617928 \
                        size    72453098
    revision            0

    patchfiles-append \
        macports_prefix.patch \
        common-paths.cpp.patch \
        0001-cmake-adding-KICAD_MACOSX_APP_BUNDLE-option.patch \
        0002-disable-codesigning.patch \
        revert-upstream-wx-fix.patch

    depends_build-append \
        path:bin/doxygen:doxygen \
        port:pkgconfig \
        port:swig \
        port:swig-python

    depends_lib-append \
        port:python${py_ver_no_dot} \
        port:glew \
        port:glm \
        port:libgit2 \
        port:curl \
        port:ngspice \
        port:opencascade \
        port:py${py_ver_no_dot}-wxpython-4.0 \
        port:zlib \
        path:lib/pkgconfig/cairo.pc:cairo \
        port:py${py_ver_no_dot}-pybind11 \
        path:lib/pkgconfig/pixman-1.pc:libpixman \
        port:unixODBC \
        port:harfbuzz \
        port:kicad-docs \
        port:kicad-symbols \
        port:kicad-footprints \
        port:kicad-packages3D \
        port:kicad-templates

    cmake.build_type Release

    configure.args-append \
        -DKICAD_MACOSX_APP_BUNDLE=OFF \
        -DKICAD_USE_OCC=ON \
        -DwxWidgets_CONFIG_EXECUTABLE=${python_framework_dir}/bin/wx-config \
        -DKICAD_BUILD_QA_TESTS=OFF \
        -DKICAD_SCRIPTING_MODULES=ON \
        -DKICAD_SCRIPTING=ON \
        -DKICAD_SCRIPTING_WXPYTHON=ON \
        -DPYTHON_SITE_PACKAGE_PATH=${python_framework_dir}/lib/python${python_version}/site-packages \
        -DPYTHON_EXECUTABLE=${python_framework_dir}/bin/python${python_version} \
        -DPYTHON_INCLUDE_DIR=${python_framework_dir}/Headers \
        -DPYTHON_LIBRARY=${python_framework_dir}/Python \
        -DDOXYGEN_DOT_EXECUTABLE=${prefix}/bin/dot \
        -DDOXYGEN_EXECUTABLE=${prefix}/bin/doxygen \
        -DNGSPICE_LIB_NAME=libngspice.0.dylib \
        -DOCC_INCLUDE_DIR=${prefix}/libexec/opencascade/include/opencascade \
        -DOCC_LIBRARY_DIR=${prefix}/libexec/opencascade/lib \
        -Wno-dev

    post-patch {
        reinplace "s|@PREFIX_BIN@|${prefix}/bin|g" ${worksrcpath}/common/gestfich.cpp
        reinplace "s|@PREFIX_DIR@|${prefix}|g" ${worksrcpath}/eeschema/sim/ngspice.cpp
    }

    post-destroot {
        foreach app_name {bitmap2component eeschema gerbview kicad pcb_calculator pcbnew} {
            set app_dir ${destroot}${applications_dir}/KiCad/${app_name}.app/Contents
            xinstall -d ${app_dir}/MacOS \
                ${app_dir}/Resources
            xinstall -m 0644 ${worksrcpath}/${app_name}/${app_name}.icns \
                ${app_dir}/Resources/${app_name}.icns
            if {[file exists ${worksrcpath}/${app_name}/${app_name}_doc.icns]} {
                xinstall -m 0644 ${worksrcpath}/${app_name}/${app_name}_doc.icns \
                    ${app_dir}/Resources/${app_name}_doc.icns
            }
            xinstall -m 0644 ${build.dir}/${app_name}/Info.plist \
                ${app_dir}/Info.plist

            ln -s ${prefix}/bin/${app_name} ${app_dir}/MacOS/${app_name}
            foreach kiface [glob ${destroot}${prefix}/bin/*.kiface] {
                set filename  [file tail $kiface]
                ln -s ${prefix}/bin/$filename ${app_dir}/MacOS/${filename}
            }
        }
    }

    gitlab.livecheck.regex {([0-9]+\.[0-8]+\.[0-9]+)}

} else {
    livecheck.type      none
}

subport kicad-docs {
    version             8.0.0-rc3
    supported_archs     noarch
    platforms           any
    description         KiCad documentation
    long_description    {*}${description}

    # we use pre-compiled binary since it is very long to compile
    # and requires many big dependencies
    master_sites        https://kicad-downloads.s3.cern.ch/docs
    distname            ${name}-doc-${version}

    checksums           rmd160  5f16c1bbb194b3085fca7f64d8ebab82f8906cf1 \
                        sha256  accc555691321a20185c01f37af55d5ede8f46b5662762c47d53a0f496094e48 \
                        size    394345740

    use_configure       no

    build {}

    destroot {
        xinstall -d ${destroot}${prefix}/share/doc
        file copy ${worksrcpath}/share/doc/kicad ${destroot}${prefix}/share/doc
    }
}

subport kicad-symbols {
    supported_archs     noarch
    platforms           any
    description         Kicad symbols
    long_description    {*}${description}

    gitlab.setup        kicad/libraries kicad-symbols ${version}

    checksums           rmd160  a9bbdcc2b01915170fed4acfceb07fd1bee42bb1 \
                        sha256  f6cad087b889285aeebdc80cb6ab1b1fe65cc08e653663d4aab5f3d749816796 \
                        size    3639516

    patchfiles-append   kicad_libraries_cmakelists.txt.patch
}

subport kicad-footprints {
    supported_archs     noarch
    platforms           any
    description         Kicad footprints
    long_description    {*}${description}

    gitlab.setup        kicad/libraries kicad-footprints ${version}

    checksums           rmd160  712d13dfbbbfaded11d03e86f8e9f38dc6f3aa42 \
                        sha256  2457dccca2bd97971be1dcc1045f20ca2804c938dc523905d4eaa15d75cd4228 \
                        size    26591094

    patchfiles-append   kicad_libraries_cmakelists.txt.patch
}

subport kicad-packages3D {
    supported_archs     noarch
    platforms           any
    description         Kicad package 3D
    long_description    {*}${description}

    gitlab.setup        kicad/libraries kicad-packages3D ${version}

    checksums           rmd160  f7b49fe393b276e1dd88d14a04a1bb0580172678 \
                        sha256  b980d86904ec386638ad8e12fa9ba1fd0e72a431d7fc92d4bccf2f6f82a7a097 \
                        size    773486331

    patchfiles-append   kicad_libraries_cmakelists.txt.patch
}

subport kicad-templates {
    supported_archs     noarch
    platforms           any
    description         Kicad templates
    long_description    {*}${description}

    gitlab.setup        kicad/libraries kicad-templates ${version}

    checksums           rmd160  b503f8ac071e2feff4421c3255e9b4b0649916ee \
                        sha256  23df1665ccdd9b9a753313d93e2e1088da2e53fc97fb7210bf7f551973b01efe \
                        size    1347686

    patchfiles-append   kicad_libraries_cmakelists.txt.patch
}
