PortSystem          1.0
PortGroup           cmake 1.1


name                xyce
version             7.9
categories          science

maintainers     {gmail.com:degnan.68k @bpdegnan} \
                openmaintainer
                
license             GPL-2
description         Parallel SPICE-compatible analog circuit simulator
long_description    \
    Xyce is a SPICE-compatible, high-performance analog circuit simulator \
    capable of solving extremely large circuit problems using massively \
    parallel computing platforms.

homepage            https://xyce.sandia.gov
master_sites        https://xyce.sandia.gov/files/xyce/
distname            Xyce-${version}
extract.suffix      .tar.gz

checksums           rmd160 298d502e49427e39a96ebcbb1f193833c9c905ec \
                    sha256 de2a7227b09a83d5abad36ea9b27a834e2bd2d6547417f27e6576418c80d4f8b


depends_lib-append  port:fftw-3 \
                    port:trilinos16 \
                    port:SuiteSparse \
                    port:bison \
                    port:flex \
                    port:OpenBLAS \
                    port:lapack 



set trilinos_component_paths [list \
    ${prefix}/lib/cmake/Epetra \
    ${prefix}/lib/cmake/EpetraExt \
    ${prefix}/lib/cmake/TrilinosCouplings \
    ${prefix}/lib/cmake/AztecOO \
    ${prefix}/lib/cmake/Ifpack \
    ${prefix}/lib/cmake/Teuchos \
    ${prefix}/lib/cmake/Sacado \
    ${prefix}/lib/cmake/NOX \
    ${prefix}/lib/cmake/Belos \
    ${prefix}/lib/cmake/Amesos \
]


configure.args-append \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=${prefix} \
    -DCMAKE_C_COMPILER=${configure.cc} \
    -DCMAKE_CXX_COMPILER=${configure.cxx} \
    -DCMAKE_INSTALL_DOCDIR=${prefix}/share/doc/${name} \
    -DCMAKE_Fortran_COMPILER=${prefix}/bin/gfortran-mp-13 \
    -DCMAKE_CXX_STANDARD=17 \
    -DTrilinos_DIR=${prefix} \
    -DCMAKE_PREFIX_PATH="${prefix}/lib/cmake" \
    -DTrilinos_DIR=${prefix}/lib/cmake/Trilinos \
    -DCMAKE_PREFIX_PATH="[join $trilinos_component_paths {;}]"    


#there's something weird in cmake that is making things to ${prefix}/doc
post-destroot {
    set bad_doc_path ${destroot}${prefix}/doc
    if {[file exists ${bad_doc_path}]} {
        set good_doc_path ${destroot}${prefix}/share/doc/${name}
        xinstall -m 755 -d ${good_doc_path}

        # Move known files to correct place
        foreach f [glob -nocomplain ${bad_doc_path}/*] {
            file rename $f $good_doc_path/
        }

        # Remove empty /opt/local/doc
        file delete -force ${bad_doc_path}
    }
}

