# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               compiler_blacklist_versions 1.0
PortGroup               cmake 1.1
PortGroup               github 1.0

name                    apbs

categories              science
license                 BSD
maintainers             nomaintainer

description             Adaptive Poisson-Boltzmann Solver
long_description        APBS is a software package for the numerical \
                        solution of the Poisson-Boltzmann equation, \
                        a popular continuum model for describing \
                        electrostatic interactions between molecular \
                        solutes over a wide range of length scales.

version                 3.4.1
homepage                https://www.poissonboltzmann.org
revision                0

set apbs_commit         9d52516947684568c95525f0f41b7869712751a3
set apbs_distfile       apbs-${apbs_commit}.tar.gz
set FETK_commit         57195e55351e04ce6ee0ef56a143c996a9aee7e2
set FETK_distfile       FETK-${FETK_commit}.tar.gz
set FETK_version        1.9.3

extract.mkdir           no
master_sites            https://github.com/Electrostatics/apbs/archive/${apbs_commit}:apbs \
                        https://github.com/Electrostatics/FETK/archive/${FETK_commit}:FETK

distfiles               ${apbs_distfile}:apbs ${FETK_distfile}:FETK
checksums               apbs-${apbs_commit}.tar.gz \
                        rmd160  69a2490d02186c18a09c323878b413dd0cedacbd \
                        sha256  5a418078204045ca5922db3c396792bed10a42a15d6f7efdfef0eae47d5d9491 \
                        size    85811156 \
                        FETK-${FETK_commit}.tar.gz  \
                        rmd160  e96c430c9b1223babce03d99790c36ed3ccc948f \
                        sha256  d9affc573b1f5410a7d2dd550a6d9a05a349d3c52e2c5615084e850ed684e6f6 \
                        size    27763972

worksrcdir              ${workpath}/apbs-${apbs_commit}

# Test support requires python3 but the
# building the apbs python module with swig
# is unnecessary for apbs's use in pymol.
platform darwin {
    if {${os.major} < 19} {
        depends_test port:python312
        set python ${prefix}/bin/python3.12
    } else {
        set python /usr/bin/python3
    }
}

depends_lib             port:maloc \
                        port:superlu \
                        port:SuiteSparse

configure.optflags      -O3 -ffast-math
configure.cppflags-append -I${worksrcpath}/include -Wno-error=implicit-int -Wno-error=incompatible-function-pointer-types
# Follow Debian's approach of not building those
# features like BEM, GEOFLOW or PBAM that only
# exist in apbs's github without tagged releases yet.
configure.args-append   -DAPBS_STATIC_BUILD=ON \
                        -DBUILD_SHARED_LIBS=OFF \
                        -DBUILD_TOOLS=ON \
                        -DENABLE_OPENMP:BOOL=OFF \
                        -DENABLE_BEM=OFF \
                        -DENABLE_GEOFLOW=OFF \
                        -DENABLE_PBAM=OFF \
                        -DBUILD_MALOC=OFF \
                        -DBUILD_SUPERLU=OFF \
                        -DBUILD_SHARED_LIBS=ON \
                        -DFETCHCONTENT_SOURCE_DIR_FETK=${worksrcpath}/FETK-${FETK_version} \
                        -DCMAKE_C_COMPILER_ARG1:STRING="${configure.cflags}" \
                        -DCMAKE_CXX_COMPILER_ARG1:STRING="${configure.cxxflags}" \
                        -DSUPERLU_INCLUDES=${prefix}/include -DSUPERLU_LIBRARIES=${prefix}/lib

patchfiles              cmake-maloc.patch disable_python_cmake_check.patch patch-testfiles.patch open-U-obsolete.patch python3.patch wrong-path-for-interpreter.patch
test.run  yes
test {
    ln ${worksrcpath}/tools/manip/inputgen.py ${worksrcpath}/tests/
    ln ${worksrcpath}/tools/manip/psize.py    ${worksrcpath}/tests/

    platform darwin {
        system -W ${worksrcpath}/tests "PATH=${destroot}${prefix}/bin:/usr/bin:/bin:${prefix}/bin ${python} apbs_tester.py -c test_cases.cfg || exit 0"
    }
    system -W ${worksrcpath}/tests "cat test.log"
    system -W ${worksrcpath}/tests "if grep FAILED test.log; then echo \"FAIL\"; exit 1; fi"
}

post-extract {
    move ${worksrcdir}/../FETK-${FETK_commit} ${worksrcdir}/FETK-${FETK_version}
}

post-patch {
    reinplace "s|EXACT REQUIRED|REQUIRED|" ${worksrcpath}/CMakeLists.txt ${worksrcpath}/tests/CMakeLists.txt ${worksrcpath}/tools/python/CMakeLists.txt
    platform darwin {
        if {${os.major} < 19} {
            reinplace "s|env python3|env ${prefix}/bin/python3.12|" ${worksrcpath}/tools/manip/psize.py
            reinplace "s|/usr/bin/python3|${prefix}/bin/python3.12|" ${worksrcpath}/tools/python/vgrid/mergedx.py
        }
    }
}

post-destroot {
    set tools ${destroot}${prefix}/share/${subport}/tools
    
    move ${tools}/manip/psize.py ${destroot}${prefix}/bin/apbs-psize.py
    file attributes ${destroot}${prefix}/bin/apbs-psize.py \
        -permissions 0755

    foreach {bin} [glob -tails -dir ${tools}/bin *] {
        move ${tools}/bin/${bin} ${destroot}${prefix}/bin/apbs-${bin}
        file attributes ${destroot}${prefix}/bin/apbs-${bin} \
            -permissions 0755
    }
}

github.livecheck.regex  {([0-9.]+)}
