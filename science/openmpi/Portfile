# $Id$

PortSystem 1.0

name			openmpi
version			1.2.5
categories		science parallel net
platforms		darwin
maintainers		mww
description		A High Performance Message Passing Library
long_description	Open MPI is a project combining technologies and resources \
			from several other projects (FT-MPI, LA-MPI, LAM/MPI, and \
			PACX-MPI) in order to build the best MPI library available. A \
			completely new MPI-2 compliant implementation, Open MPI offers \
			advantages for system and software vendors, application developers \
			and computer science researchers.

homepage		http://www.open-mpi.org/
set subdir		ompi/v1.2/downloads/
master_sites		http://www.open-mpi.org/software/${subdir} \
			http://www.open-mpi.de/software/${subdir} \
			http://icl.cs.utk.edu/open-mpi/${subdir} \
			freebsd
checksums		md5 c6e82aab6cdcd425bf29217e8317d7dc \
			sha1 c217798453782cb9e25d58daf845aa6fdc62fcbf
use_bzip2		yes

pre-extract { file mkdir ${workpath}/build }

configure.dir	${workpath}/build
configure.cmd	${worksrcpath}/configure
configure.args	--disable-f77 --disable-f90 \
		--enable-static \
		--sysconfdir=${prefix}/etc/${name} \
		--includedir=${prefix}/include/${name} \
		--bindir=${prefix}/lib/${name}/bin \
		--mandir=${prefix}/share/man

build.dir	${configure.dir}

destroot.dir	${build.dir}
set wrappers	{mpicc mpicxx mpic++}
post-destroot {
	foreach bin {mpirun mpiexec} {
		system "cd ${destroot}${prefix}/bin \
			&& ln -sf ${prefix}/lib/${name}/bin/orterun open${bin}" 
	}
	foreach bin ${wrappers} {
		system "cd ${destroot}${prefix}/bin \
			&& ln -sf ${prefix}/lib/${name}/bin/opal_wrapper open${bin}" 
		system "cd ${destroot}${prefix}/share/${name} \
		&& ln -sf ${prefix}/share/${name}/${bin}-wrapper-data.txt \
			open${bin}-wrapper-data.txt"
	}
}

variant fortran {
        configure.args-delete --disable-f77 --disable-f90
        configure.args-append --enable-f77 --enable-f90
        configure.f77	${prefix}/bin/gfortran-mp-4.2
	configure.fc	${prefix}/bin/gfortran-mp-4.2
        # We need gfortran. Gcc41 doesn't seem to compile on Intel Mac, so we'll take  
        # gcc42. Too bad that the actual gfortran binary in gcc42 is called
        # gfortran-mp-4.2, otherwise we could just say bin:gfortran:gcc42.
        depends_build port:gcc42
	lappend wrappers mpif77 mpif90
}

variant g95 {
	configure.args-delete --disable-f77 --disable-f90
	configure.args-append --enable-f77 --enable-f90
	configure.f77	${prefix}/bin/g95
	configure.fc	${prefix}/bin/g95
	depends_build	port:g95
	lappend wrappers mpif77 mpif90
}

livecheck.check	regex
livecheck.url	http://www.open-mpi.org/software/
livecheck.regex	openmpi-(\[0-9\.\]+).tar.bz2

