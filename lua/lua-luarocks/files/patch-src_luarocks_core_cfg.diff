--- src/luarocks/core/cfg.lua.orig	2021-04-13 21:53:35.000000000 +0000
+++ src/luarocks/core/cfg.lua	2021-05-28 14:15:08.000000000 +0000 
@@ -365,7 +365,7 @@
       defaults.static_lib_extension = "a"
       defaults.external_lib_extension = "so"
       defaults.obj_extension = "o"
-      defaults.external_deps_dirs = { "/usr/local", "/usr", "/" }
+      defaults.external_deps_dirs = { "%PREFIX%" }
 
       defaults.variables.CFLAGS = os.getenv("CFLAGS") or "-O2"
       -- we pass -fPIC via CFLAGS because of old Makefile-based Lua projects
@@ -377,10 +377,10 @@
       defaults.variables.LDFLAGS = os.getenv("LDFLAGS")
 
       defaults.cmake_generator = "Unix Makefiles"
-      defaults.variables.CC = os.getenv("CC") or "gcc"
-      defaults.variables.LD = os.getenv("CC") or "gcc"
+      defaults.variables.CC = os.getenv("CC") or "%CC%"
+      defaults.variables.LD = defaults.variables.CC
       defaults.gcc_rpath = true
-      defaults.variables.LIBFLAG = "-shared"
+      defaults.variables.LIBFLAG = (os.getenv("LDFLAGS") or "").." -shared"
       defaults.variables.TEST = "test"
 
       defaults.external_deps_patterns = {
@@ -465,7 +465,7 @@
       defaults.variables.MAKE = os.getenv("MAKE") or "make"
       defaults.external_lib_extension = "dylib"
       defaults.arch = "macosx-"..target_cpu
-      defaults.variables.LIBFLAG = "-bundle -undefined dynamic_lookup -all_load"
+      defaults.variables.LIBFLAG = (os.getenv("LDFLAGS") or "").." -bundle -undefined dynamic_lookup -all_load"
       local version = util.popen_read("sw_vers -productVersion")
       if not (version:match("^%d+%.%d+%.%d+$") or version:match("^%d+%.%d+$")) then
          version = "10.3"
@@ -480,8 +480,8 @@
       else
          defaults.gcc_rpath = false
       end
-      defaults.variables.CC = "env MACOSX_DEPLOYMENT_TARGET="..tostring(version).." gcc"
-      defaults.variables.LD = "env MACOSX_DEPLOYMENT_TARGET="..tostring(version).." gcc"
+      defaults.variables.CC = "env MACOSX_DEPLOYMENT_TARGET="..tostring(version).." "..defaults.variables.CC
+      defaults.variables.LD = defaults.variables.CC
       defaults.web_browser = "open"
 
       -- XCode SDK
