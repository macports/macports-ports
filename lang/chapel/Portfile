# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                chapel
version             1.3.0 
revision            1
categories          lang parallel science
platforms           darwin
maintainers         takeshi openmaintainer
description         parallel programming language
long_description \
    Chapel is a new parallel programming language \
    being developed by Cray Inc. as part of the DARPA-led \
    High Productivity Computing Systems program (HPCS).
license             BSD
homepage            http://chapel.cray.com/
master_sites        sourceforge

checksums           md5     f98186898161ce61e7518b83938b9e96 \
                    sha1    4ee8cfe3bb2c32ba1ecbd133987503ed1d2d4e97 \
                    rmd160  94e0bbd99b291b681adddbd574529eaed952ffda

worksrcdir          ${distname}/${name}

use_configure       no
use_parallel_build  no

# chapel builds with llvm-gcc by removing -use-gold-plugin
# in ${worksrcpath}/make/compiler/Makefile.llvm-gcc and
# chpl can be made to work by setting CHPL_TARGET_COMPILER
# but gives warnings on linking different triples.
#
# chapel does not build with clang.
if {![string match *-gcc-* ${configure.compiler}]} {
    pre-configure {
        ui_error "${name} requires configure.compiler=*-gcc-*."
        return -code error
    }
}
configure.compiler  gcc-4.2

configure.optflags  -O3
if {[variant_isset universal]} {
    set archflags "${configure.universal_ldflags}"
} else {
    set archflags "${configure.cc_archflags}"
}
build.env           CHPL_HOST_COMPILER=gnu \
                    CHPL_TARGET_COMPILER=gnu \
                    LDFLAGS="${archflags}"
post-configure {
    reinplace "s|CXX = g++|CXX = ${configure.cxx}|" ${worksrcpath}/make/compiler/Makefile.gnu
    reinplace "s|CC = gcc|CC = ${configure.cc}|" ${worksrcpath}/make/compiler/Makefile.gnu
    reinplace "s|-O3|${configure.optflags} ${archflags}|" ${worksrcpath}/make/compiler/Makefile.gnu
    reinplace "s|\$(ARCH)|${archflags}|g" ${worksrcpath}/make/compiler/Makefile.gnu
}

destroot {
    xinstall -m 755 ${worksrcpath}/bin/darwin/chpl ${destroot}${prefix}/bin
    xinstall -m 644 ${worksrcpath}/man/man1/chpl.1 ${destroot}${prefix}/share/man/man1
    xinstall -d ${destroot}${prefix}/lib/${name}
    foreach d "lib examples make modules util runtime" {
      file copy ${worksrcpath}/${d} ${destroot}${prefix}/lib/${name}
    }
}

variant universal {}

notes \
    " set CHPL_HOME to ${prefix}/lib/${name}\n\
     set CHPL_HOST_PLATFORM to darwin"
