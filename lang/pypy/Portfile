# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           select 1.0
PortGroup           openssl 1.0

# Define PyPy versions for each Python branch - update these pairs together
array set pypy_versions {
    2.7   7.3.20
    3.8   7.3.11
    3.9   7.3.16
    3.10  7.3.19
    3.11  7.3.20
}

# Set default to latest offered Python version: 3.11
set python.branch   3.11
version             $pypy_versions(${python.branch})

# Use github.setup to configure the portgroup for livecheck,
# then override the variables it sets for fetching.
github.setup        pypy pypy ${version} release-pypy${python.branch}-v

# Override distname and master_sites to match the actual release asset URL
distname            ${github.tag_prefix}${version}
master_sites        https://github.com/pypy/pypy/archive/refs/tags/
extract.suffix      .tar.gz
revision            0

categories          lang python devel
license             MIT PSF
maintainers         {danchr @danchr} openmaintainer

platforms           darwin macosx

homepage            https://www.pypy.org/

depends_build       port:pkgconfig \
                    port:py311-docutils
depends_lib         port:libffi \
                    port:sqlite3 \
                    port:bzip2 \
                    port:gettext \
                    port:gdbm \
                    port:expat \
                    port:ncurses
depends_run         port:python_select
select.entries      [list python python-$subport $subport]

# removed make_output.diff \
patchfiles          patch-no-cffi-at-build.diff \
                    ffiplatform.py.diff \
                    paths.diff

# deprecated.eol_version no
use_configure       no

# no effort has been made to get the JIT working anywhere but x86-64,
# and without that, PyPy has little or no benefit over CPython; if
# you're looking for support for Apple Silicon - or ARM64 - see
# https://morepypy.blogspot.com/2020/12/mac-meets-arm64.html and
# https://trac.macports.org/ticket/63486#comment:3
supported_archs     x86_64

# a simple mapping from scripts to modules -- ideally, upstream
# provided these
array set module_scripts {
    pydoc pydoc
    2to3 lib2to3
    smtpd.py smtpd
}

worksrcdir          pypy-${github.tag_prefix}${version}

subport pypy38 {
    set python.branch 3.8
    version $pypy_versions(3.8)
    github.tag_prefix release-pypy3.8-v

    set module_scripts(venv) venv
    set module_scripts(idle) idlelib

    depends_lib-append port:xz

    depends_run-append port:python3_select
    select.entries-append [list python3 python3-$subport $subport]
}

subport pypy39 {
    set python.branch 3.9
    version $pypy_versions(3.9)
    github.tag_prefix release-pypy3.9-v

    set module_scripts(venv) venv
    set module_scripts(idle) idlelib

    depends_lib-append port:xz

    depends_run-append port:python3_select
    select.entries-append [list python3 python3-$subport $subport]
}

subport pypy310 {
    set python.branch 3.10
    version $pypy_versions(3.10)
    github.tag_prefix release-pypy3.10-v

    set module_scripts(venv) venv
    set module_scripts(idle) idlelib

    depends_lib-append port:xz

    depends_run-append port:python3_select
    select.entries-append [list python3 python3-$subport $subport]
}

subport pypy311 {
    set python.branch 3.11
    version $pypy_versions(3.11)
    github.tag_prefix release-pypy3.11-v

    set module_scripts(venv) venv
    set module_scripts(idle) idlelib

    depends_lib-append port:xz

    depends_run-append port:python3_select
    select.entries-append [list python3 python3-$subport $subport]
}

subport pypy-tkinter {
    set python.branch   3.11
    version $pypy_versions(3.11)
    github.tag_prefix   release-pypy3.11-v
}

subport pypy38-tkinter {
    set python.branch   3.8
    version $pypy_versions(3.8)
    github.tag_prefix   release-pypy3.8-v
}

subport pypy39-tkinter {
    set python.branch   3.9
    version $pypy_versions(3.9)
    github.tag_prefix   release-pypy3.9-v
}

subport pypy310-tkinter {
    set python.branch   3.10
    version $pypy_versions(3.10)
    github.tag_prefix   release-pypy3.10-v
}

subport pypy311-tkinter {
    set python.branch   3.11
    version $pypy_versions(3.11)
    github.tag_prefix   release-pypy3.11-v
}

if {$subport == ${name}} {
    set python.branch 3.11

    depends_run-append port:python3_select
    select.entries-append [list python3 python3-$subport $subport]
}

if {${python.branch} == 2.7} {
    patchfiles-append   pypy2-darwin.py.diff

    checksums           rmd160  962c6d7a898769a78907af9f4044b3be9e246339 \
                        sha256  39b0972956f6548ce5828019dbae12503c32d6cbe91a2becf88d3e42cc52197b \
                        size    23328628

    set use_prefix no
} elseif {${python.branch} == 3.8} {
    patchfiles-append   pypy3-darwin.py.diff

    checksums           rmd160  e0724177307c1d21e4fe4e2977c3f72be1a9642f \
                        sha256  5b5d9d9256f12a129af8384e2f581bdfab3bc0fbbe3a0a480d9c1d2e95490eb1 \
                        size    26642176

    set use_prefix yes
} elseif {${python.branch} == 3.9} {
    patchfiles-append   pypy3-darwin.py.diff

    checksums           rmd160  a977b07ac5ae199054563eb0cfbb9f5ed8acd11d \
      sha256  a77340a91e81aedf02e78e6e2ea96806f76b50256c6338067f5ff540edbae072 \
                          size    28200000
    set use_prefix yes
} elseif {${python.branch} == 3.10} {
      patchfiles-append   pypy3-darwin.py.diff

      checksums           rmd160  962c6d7a898769a78907af9f4044b3be9e246339 \
                          sha256  48648aa0a63f4e5fa30315e06b27999ea7157da68a8d4503ebc4a7ee308b5f66 \
                          size    27700000

      set use_prefix yes
  } elseif {${python.branch} == 3.11} {
        patchfiles-append   pypy3-darwin.py.diff

        checksums           rmd160  4ca85835a4a689e27c6ef0960e2abb54b576c1e2 \
                            sha256  a77340a91e81aedf02e78e6e2ea96806f76b50256c6338067f5ff540edbae072 \
                            size    29626380

        set use_prefix yes
    }

description         A fast interpreter for Python ${python.branch}
long_description \
    PyPy is a replacement for CPython ${python.branch}. The main reason to use it \
    instead of CPython is speed, as it generally runs faster.

openssl.configure   build_flags

build.env           PYPY_USESSION_DIR=${workpath} PYPY_LOCALBASE=${prefix} \
                    PYPY_NO_EMBED_DEPENDENCIES=1 \
                    "CFLAGS=${configure.cc_archflags} ${configure.cppflags}" \
                    "LDFLAGS=${configure.ld_archflags} ${configure.ldflags}"

build.dir           ${worksrcpath}/pypy/goal
build.args          --batch --verbose \
                    --cc=${configure.cc} --opt=jit --lto --compile \
                    --make-jobs=${build.jobs}
build.target        ../../rpython/bin/rpython
build.post_args     targetpypystandalone

destroot.env        {*}${build.env}
destroot.env-append CC=${configure.cc} \
                    "LDSHARED=${configure.cc} -pthread -shared -undefined dynamic_lookup"

destroot.dir        ${worksrcpath}/pypy/tool/release
destroot.args       --builddir ${workpath} \
                    --archive-name ${subport} \
                    --without-_tkinter --no-embedded-dependencies
destroot.target     package.py
destroot.post_args

post-patch {
    # sanity check, useful when upgrading, as upstream tends to move these around
    if { ![catch {exec grep --exclude "*.orig" -Ilwre /sw -e ${prefix} ${worksrcpath}} result] } {
        ui_warn "patching potentially didn't catch all references to /sw and ${prefix}:\n$result"
    }

    # reinplace "s|__PREFIX__|${prefix}|" \
    #    ${worksrcpath}/extra_tests/ctypes_tests/conftest.py \
    #    ${worksrcpath}/pypy/tool/cpyext/extbuild.py \
    #    ${worksrcpath}/lib_pypy/cffi/ffiplatform.py \
    #    ${worksrcpath}/lib_pypy/_tkinter/tklib_build.py

    if {${python.branch} == "2.7"} {
        reinplace "/MACOSX_DEPLOYMENT_TARGET/s/10\\.\\(\[0-9\]*\\)/${macosx_deployment_target}/" \
            lib-python/2.7/distutils/sysconfig_pypy.py
    }

    # sanity check, likewise
    if { ![catch {exec grep --exclude "*.orig" -lIwre __PREFIX__ ${worksrcpath}} result] } {
        ui_warn "patching potentially didn't catch all references to __PREFIX__:\n$result"
    }
}

# Which Python binary should we use? Building PyPy is _very_ resource
# intensive, and one of the best cases for using PyPy itself over
# CPython.
if {$subport ne $name} {
    # just use our own pypy3.x for building other pypy3.x subports
    depends_build-append port:pypy
    build.cmd       ${prefix}/lib/pypy/bin/pypy-${python.branch}
} else {
    # use a binary distribution of pypy itself
    checksums-prepend       ${distname}${extract.suffix}

    if {${os.major} >= 20} {
        # older versions cannot import C extensions on macOS 11 and later
        set bootstrapper        "pypy2.7-v7.3.20-macos_arm64"
        distfiles-append        ${bootstrapper}.tar.bz2:bootstrap
        master_sites-append     https://downloads.python.org/pypy/:bootstrap
        checksums-append \
            ${bootstrapper}.tar.bz2 \
            rmd160  5740304e39d54cad6150379213a60ec694cefb62 \
            sha256  be3ffbb243316b1ffbf63ac60d72e099d5b64702e4429eeeb18a0608fb3b8dcc \
            size    18400252
    } else {
        # for compatibility, don't bump this needlessly
        set bootstrapper        "pypy-5.1.0-osx64"
        distfiles-append        ${bootstrapper}.tar.bz2:bootstrap
        checksums-append \
            ${bootstrapper}${extract.suffix} \
            rmd160  fb209f68f77de56037faed5920678887608cdb0a \
            sha256  7e270c66347158dd794c101c4817f742f760ed805aa0d10abe19ba4a78a75118 \
            size    19466885
    }

    build.cmd       ${workpath}/${bootstrapper}/bin/pypy
}

# a lot of memory is used before the C compiler even runs, so limit build.jobs
# according to available memory more tightly than the default
if {![catch {sysctl hw.memsize} memsize]} {
    incr memsize -4000000000
    if {$memsize <= 0} {
        build.jobs 1
    } elseif {${build.jobs} > $memsize / 1000000000 + 1} {
        build.jobs [expr {$memsize / 1000000000 + 1}]
    }
}


platform darwin {
    # use arch -foo if available
    if {${os.major} >= 9} {
        build.cmd arch -${build_arch} ${build.cmd}
    }

    # LTO causes the the buildbots to time out on older releases
    if {${os.major} < 15} {
        build.args-delete --lto
    } else {
        # speed up the build by using thin LTO
        patchfiles-append patch-lto-thin.diff
    }
}

# Install support files, but only if not in a proper subport
if {![regexp \- $subport]} {
    post-destroot {
        if {${use_prefix} == yes} {
            system -W "${workpath}" "tar -xjvf ${subport}.tar.bz2 -C ${destroot}${prefix} -s ,${subport}/,,"

            # first, relocate the binaries we want to keep
            xinstall -d ${destroot}${prefix}/bin~
            file rename ${destroot}${prefix}/bin/pypy3 ${destroot}${prefix}/bin~/${subport}
            ln -s ${subport} ${destroot}${prefix}/bin~/${name}-${python.branch}

            file rename ${destroot}${prefix}/bin/libpypy3-c.dylib ${destroot}${prefix}/lib

            delete -force ${destroot}${prefix}/bin
            file rename ${destroot}${prefix}/bin~ ${destroot}${prefix}/bin

            system "install_name_tool -rpath @executable_path/ @executable_path/../lib ${destroot}${prefix}/bin/${subport}"

            xinstall -d ${destroot}${prefix}/share/doc/${subport}
            file rename ${destroot}${prefix}/LICENSE ${destroot}${prefix}/share/doc/${subport}
            file rename ${destroot}${prefix}/README.rst ${destroot}${prefix}/share/doc/${subport}
        } else {
            xinstall -d ${destroot}${prefix}/lib/${subport}

            system -W "${workpath}" "tar -xjvf ${subport}.tar.bz2 -C ${destroot}${prefix}/lib"

            file delete ${destroot}${prefix}/lib/${subport}.tar.bz2
            ln -s ../lib/${subport}/bin/${name} ${destroot}${prefix}/bin/${subport}
            ln -s ../lib/${subport}/bin/${name} ${destroot}${prefix}/bin/${name}-${python.branch}
        }

        xinstall -d ${destroot}${prefix}/share/man/man1
        system -W ${worksrcpath}/pypy/doc/man \
            "rst2man-${python.branch}.py pypy.1.rst ${destroot}${prefix}/share/man/man1/${subport}.1"
        system -W ${worksrcpath}/pypy/doc/man \
            "rst2man-${python.branch}.py pypy.1.rst ${destroot}${prefix}/share/man/man1/${name}-${python.branch}.1"

        foreach script [array names module_scripts] {
            set module $module_scripts($script)
            set scriptdirpath "${destroot}${prefix}/lib/${subport}/bin"
            set scriptpath "${scriptdirpath}/${script}"

            xinstall -d "${scriptdirpath}"
            xinstall -m 755 ${filespath}/module-script.sh $scriptpath
            reinplace "s+__PYPY__+${prefix}/bin/${subport}+" $scriptpath
            reinplace "s+__MODULE__+${module}+" $scriptpath
        }
    }
}

# Factor Tk into a separate subport, like CPython
if {[string match "pypy*-tkinter" ${subport}]} {
    set pypy_version    [string range ${subport} 0 [string first "-" ${subport}]-1]
    set pypy_root       ${prefix}/lib/${pypy_version}

    description         PyPy bindings for Python ${python.branch} to the Tk widget set
    long_description    ${description}
    categories          lang python graphics

    depends_build       port:pkgconfig \
                        port:tcl
    depends_lib         port:${pypy_version} \
                        port:tk

    openssl.branch      no_version

    build.dir           ${worksrcpath}
    build.cmd           ${prefix}/bin/${pypy_version}
    build.args          lib_pypy/_tkinter/tklib_build.py
    build.target
    build.post_args
    build.env-append    CC=${configure.cc} \
                        "LDSHARED=${configure.cc} -pthread -shared -undefined dynamic_lookup"

    select.entries

    destroot {
        xinstall -m 755 -d ${destroot}${pypy_root}/lib_pypy/_tkinter
        xinstall -m 755 \
            [glob -directory ${worksrcpath}/lib_pypy/_tkinter tklib_cffi.*.so] \
            ${destroot}${pypy_root}/lib_pypy/_tkinter
    }

    post-destroot { }
}

if {${os.major} < 11 && ${os.platform} eq "darwin"} {
    known_fail yes

    # https://trac.macports.org/ticket/59191
    pre-fetch {
        ui_error "${name} ${version} requires macOS 10.7 or newer."
        return -code error "incompatible macOS version"
    }
}

# Use GitHub livecheck since we're now using GitHub
github.livecheck.regex {release-pypy\d+\.\d+-v([0-9.]+)}

if {[regexp \- $subport]} {
    # don't check the tkinter subports
    livecheck.type none
}
