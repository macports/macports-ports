--- pypy/translator/platform/darwin.py.orig	2010-11-27 01:38:08.000000000 +1100
+++ pypy/translator/platform/darwin.py	2010-11-30 07:25:07.000000000 +1100
@@ -5,8 +5,8 @@
 class Darwin(posix.BasePosix):
     name = "darwin"
 
-    link_flags = ('-mmacosx-version-min=10.4',)
-    cflags = ('-O3', '-fomit-frame-pointer', '-mmacosx-version-min=10.4')
+    link_flags = ('-mmacosx-version-min=__MDT__',)
+    cflags = ('-O3', '-fomit-frame-pointer', '-mmacosx-version-min=__MDT__')
     standalone_only = ('-mdynamic-no-pic',)
     shared_only = ()
 
@@ -31,21 +31,19 @@
     
     def _preprocess_include_dirs(self, include_dirs):
         res_incl_dirs = list(include_dirs)
-        res_incl_dirs.append('/usr/local/include') # Homebrew
-        res_incl_dirs.append('/opt/local/include') # MacPorts
         return res_incl_dirs
 
     def _preprocess_library_dirs(self, library_dirs):
         res_lib_dirs = list(library_dirs) 
-        res_lib_dirs.append('/usr/local/lib') # Homebrew
-        res_lib_dirs.append('/opt/local/lib') # MacPorts
         return res_lib_dirs
 
     def include_dirs_for_libffi(self):
-        return ['/usr/include/ffi']
+        return self._pkg_config("libffi", "--cflags-only-I",
+                                ['/usr/include/ffi'])
 
     def library_dirs_for_libffi(self):
-        return ['/usr/lib']
+        return self._pkg_config("libffi", "--libs-only-L",
+                                ['/usr/lib'])
 
     def check___thread(self):
         # currently __thread is not supported by Darwin gccs
@@ -80,12 +78,12 @@
 
 class Darwin_i386(Darwin):
     name = "darwin_i386"
-    link_flags = ('-arch', 'i386', '-mmacosx-version-min=10.4')
+    link_flags = ('-arch', 'i386', '-mmacosx-version-min=__MDT__')
     cflags = ('-arch', 'i386', '-O3', '-fomit-frame-pointer',
-              '-mmacosx-version-min=10.4')
+              '-mmacosx-version-min=__MDT__')
 
 class Darwin_x86_64(Darwin):
     name = "darwin_x86_64"
-    link_flags = ('-arch', 'x86_64', '-mmacosx-version-min=10.4')
+    link_flags = ('-arch', 'x86_64', '-mmacosx-version-min=__MDT__')
     cflags = ('-arch', 'x86_64', '-O3', '-fomit-frame-pointer',
-              '-mmacosx-version-min=10.4')
+              '-mmacosx-version-min=__MDT__')
