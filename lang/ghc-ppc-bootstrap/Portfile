# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0

name                ghc-ppc-bootstrap
set canonicalname   ghc
version             7.0.4
revision            0
categories          lang haskell
maintainers         @barracuda156
license             BSD
platforms           darwin
supported_archs     ppc
universal_variant   no
installs_libs       no

description         The Glorious Glasgow Haskell Compilation System
long_description    This is a package that installs a binary bootstrap ghc compiler.

homepage            http://haskell.org/${canonicalname}
master_sites        https://downloads.haskell.org/ghc/7.0.4/krabby/
distname            GHC-${version}-powerpc
distfiles			${distname}.pkg

checksums           rmd160  38cc042793d2b4f4a6b901c6bb7f6a1f6959cce8 \
                    sha256  81cc84e18d30d35d4103b21d146b264abd7f00879ae64ef492bc83d67231fb7c \
                    size    171783399

depends_extract     port:xar

worksrcdir          ${canonicalname}-${version}

extract {
    system -W ${workpath} "mkdir -p ${worksrcpath}/pkg"
    system -W ${workpath} "mkdir -p ${worksrcpath}/files"
    system -W ${distpath} "cp ${distpath}/${distfiles} ${worksrcpath}/pkg"
    system -W ${worksrcpath}/pkg "${prefix}/bin/xar -xf ${worksrcpath}/pkg/GHC-${version}-powerpc.pkg -C ${worksrcpath}/files"
    system -W ${worksrcpath}/files/ghc.pkg "cat Payload | gunzip -dc | cpio -i"
    
if {![variant_isset framework]} {
    system -W ${worksrcpath}/files/ghc.pkg "mv GHC.framework/Versions/7.0.4-powerpc/usr ${worksrcpath}/${name}"
    system -W ${worksrcpath}/files/ghc.pkg "cp -R GHC.framework/Versions/7.0.4-powerpc/Tools ${worksrcpath}/${name}/share"
    }
}

use_configure     no

build {}

if {![variant_isset framework]} {
	destroot.destdir prefix=${destroot}/share
	set path ${prefix}/share
	destroot {
		copy ${worksrcpath}/${name} ${destroot}${path}
	}
	
	post-destroot {
		# Delete dylibs; they aren ºt used by the bootstrap ghc and are incorrectly linked against /usr/local, causing rev-upgrade to complain.
		fs-traverse f ${destroot}${path}/${name}/lib {
			if {[file isfile ${f}]} {
				if {[file extension ${f}] == ".dylib"} {
					delete ${f}
				}
			}
		}
	}
}

variant framework description {Install as a Framework} {
    destroot.destdir prefix=${destroot}${frameworks_dir}
	destroot {
		copy ${worksrcpath}/files/ghc.pkg/GHC.framework ${destroot}${frameworks_dir}
	}
}

livecheck.type      none
