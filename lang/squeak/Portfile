# $Id$

PortSystem		1.0
name			squeak
version			3.9
categories		lang squeak
maintainers		bfulgham@opendarwin.org
description		Full, portable, Smalltalk-80 system
long_description	\
 	Squeak is a full-featured implementation of the Smalltalk programming \
	language and environment based on (and largely compatible with) the \
	original Smalltalk-80 system.  Squeak has very powerful 2- and 3-D \
	graphics, sound, video, MIDI, animation and other multimedia \
	capabilities -- and one of the most impressive development \
	environments ever created.  It also includes a customisable framework \
	for creating dynamic HTTP servers and interactively extensible Web \
	sites.  The entire Squeak system is open source software, distributed \
	freely with a liberal license. 
platforms		darwin
homepage		ftp://ftp.squeak.org

set squeak_vm_version	3.7-7
set squeak_img_version	3.9
set squeak_short_vrsn	39
set squeak_patch_no	7067
set squeak_vm_src	Squeak-${squeak_vm_version}.src.tar
set squeak_img_name	Squeak${squeak_img_version}-final-${squeak_patch_no}
set squeak_img		${squeak_img_name}.image
set squeak_img_changes	${squeak_img_name}.changes
set squeak_img_src	${squeak_img_name}.zip

master_sites		ftp://ftp.squeak.org/3.8/unix-linux \
                        ftp://ftp.squeak.org/${squeak_img_version}/


distname		Squeak-${squeak_img_version}
distfiles		${squeak_vm_src}.gz ${squeak_img_src}

checksums		${squeak_vm_src}.gz md5 c6b051b745080516c550cab0db1882fc \
			${squeak_img_src} md5 30d991c418be1cd9c5d05fb87dea2f19

default_variants	+quartz

extract.only		${squeak_vm_src}.gz
post-extract		{
	system "cd ${workpath} && mv Squeak-${squeak_vm_version} Squeak-${squeak_img_version}"
	file mkdir ${worksrcpath}/build
}

configure.cmd		../platforms/unix/config/configure
configure.dir		${worksrcpath}/build
configure.args		--libdir=${prefix}/share --without-quartz --without-x

build.dir		${worksrcpath}/build
build.type		gnu

destroot.destdir	 ROOT=${destroot}

post-destroot {
	set unzip	"[binaryInPath "unzip"] -o"
	set gzip	"[binaryInPath "gzip"] -f"
	
	# Have inisqueak look for a specific version image
	reinplace	"s|IMAGE=squeak|IMAGE=squeak.${squeak_img_version}-${squeak_patch_no}|g" ${worksrcpath}/build/inisqueak
	reinplace	"s|CHANGES=squeak|CHANGES=squeak.${squeak_img_version}-${squeak_patch_no}|g" ${worksrcpath}/build/inisqueak

	# Install it
	xinstall	-m 755 ${worksrcpath}/build/inisqueak \
				${destroot}${prefix}/bin/
	
	# Now extract the image
	file		copy ${distpath}/${squeak_img_src} ${worksrcpath}
	file		copy ${distpath}/${squeak_vm_src}.gz ${worksrcpath}
	system 		"cd ${worksrcpath} && ${unzip} ${squeak_img_src}"
	system 		"cd ${worksrcpath} && ${gzip} -d ${squeak_vm_src}.gz"

	# And install the image
	xinstall 	-d ${destroot}${prefix}/share/squeak
	xinstall 	-m 644 ${worksrcpath}/${squeak_img_name}/${squeak_img} \
				${destroot}${prefix}/share/squeak/
	xinstall 	-m 644 ${worksrcpath}/${squeak_img_name}/${squeak_img_changes} \
				${destroot}${prefix}/share/squeak/
	xinstall	-m 644 ${worksrcpath}/${squeak_img_name}/WelcomeSqueak${squeak_short_vrsn} \
				${destroot}${prefix}/share/squeak/
	xinstall	-m 644 ${worksrcpath}/${squeak_img_name}/SqueakV${squeak_short_vrsn}.sources \
				${destroot}${prefix}/share/squeak/

	# And compress the image
	system		"cd ${destroot}${prefix}/share/squeak && ${gzip} ${squeak_img}"
	system		"cd ${destroot}${prefix}/share/squeak && ${gzip} ${squeak_img_changes}"

}

variant quartz	{ 
	configure.args-delete	--without-quartz 
	configure.args-append	--with-quartz
}

variant x11 	{ 
	depends_lib-append	lib:libX11:XFree86
	configure.args-delete	--without-x
	configure.args-append	--with-x 
}

