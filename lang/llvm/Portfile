# $Id$

PortSystem 1.0

name                    llvm
version                 2.1
categories              lang
platforms               darwin
maintainers             erickt@macports.org
description             llvm is a next generation compiler infrastructure
long_description        llvm brings tools to work on the llvm intermediate \
                        language incl. a C and C++ frontend.

homepage                http://llvm.org/
master_sites            http://llvm.org/releases/${version}/

checksums               md5 b930e7213b37acc934d0d163cf13af18 \
                        sha1 e57081e1bc7c2cb168859f534c08b579276c3398 \
                        rmd160 df28ee93be79b8d436deb7c0e1cff1c21e1328be

depends_build           bin:flex:flex \
                        bin:bison:bison

worksrcdir              build

pre-configure {
    file mkdir ${workpath}/build
}

configure.cmd           ../llvm-${version}/configure --enable-optimized

build.target            tools-only

destroot.destdir        PROJ_prefix=${destroot}${prefix} \
                        PROJ_bindir=${destroot}${prefix}/bin \
                        PROJ_libdir=${destroot}${prefix}/lib \
                        PROJ_datadir=${destroot}${prefix}/share/llvm \
                        PROJ_docsdir=${destroot}${prefix}/share/llvm/docs \
                        PROJ_etcdir=${destroot}${prefix}/etc/llvm \
                        PROJ_includedir=${destroot}${prefix}/include \
                        PROJ_infodir=${destroot}${prefix}/share/info \
                        PROJ_mandir=${destroot}${prefix}/share/man 

post-destroot {
    file mkdir ${destroot}${prefix}/lib/llvm
    file mkdir ${destroot}${prefix}/lib/llvm/src
    file mkdir ${destroot}${prefix}/lib/llvm/obj

    file copy ${workpath}/llvm-${version}/include ${destroot}${prefix}/lib/llvm/src
    file copy ${workpath}/build/include ${destroot}${prefix}/lib/llvm/obj
    file copy ${workpath}/build/Release ${destroot}${prefix}/lib/llvm/obj

    reinplace "s|${workpath}/build/\.\./llvm-${version}|${prefix}/lib/llvm/src|g" ${destroot}${prefix}/bin/llvm-config
    reinplace "s|${workpath}/build|${prefix}/lib/llvm/obj|g"                      ${destroot}${prefix}/bin/llvm-config

    reinplace "s|${workpath}/build/\.\./llvm-${version}|${prefix}/lib/llvm/src|g" ${destroot}${prefix}/lib/llvm/obj/Release/bin/llvm-config
    reinplace "s|${workpath}/build|${prefix}/lib/llvm/obj|g"                      ${destroot}${prefix}/lib/llvm/obj/Release/bin/llvm-config
}
