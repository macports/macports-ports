# $Id: Portfile,v 1.19 2004/10/27 16:37:44 gwright Exp $

PortSystem 1.0
name		ghc
version		6.2.2
revision	6
categories	lang
maintainers	gwright@comcast.net
platforms	darwin
description	The Glorious Glasgow Haskell Compilation System
long_description	\
		The Glasgow Haskell Compiler is a robust,		\
		fully-featured, optimising compiler and interactive	\
		environment for Haskell 98, GHC compiles Haskell to	\
		either native code or C.  It implements numerous	\
		experimental language extensions to Haskell 98,		\
		for example: concurrency, a foreign language interface,	\
		multi-parameter type classes, scoped type variables,	\
		existential and universal quantification, unboxed	\
		types, exceptions, weak pointers, and so on.		\
		GHC comes with a generational garbage collector,	\
		and a space and time profiler. 

homepage	http://www.haskell.org/ghc/
master_sites	${homepage}/dist/${version}/:source \
#		opendarwin::bootstrap
# The line above is temporarily commented out until the distfiles.opendarwin.org
# site is resynchronized with the latest bootstrap compiler


use_bzip2	yes

distfiles	${name}-${version}-src.tar.bz2:source

checksums	ghc-${version}-src.tar.bz2 md5 42088bff4de30e7c3a277cfa55d5589e

patchfiles	patch-configure.ac 

depends_lib	lib:libreadline.5:readline	\
		lib:libgmp.3:gmp

platform darwin 6 {
		  master_sites-append	${homepage}/dist/6.0.1/MacOSX/:bootstrap

		  distfiles-append	${name}-6.0.1-darwin-bootstrap.tar.bz2:bootstrap

		  checksums-append	ghc-6.0.1-darwin-bootstrap.tar.bz2 md5 280afe385405fa437ae274bfab2c3250

		  depends_lib-append	lib:libreadline.4.3:readline-4	\
					lib:libdl.1:dlcompat

		  pre-configure	{ set cfg [open "${worksrcpath}/mk/build.mk" w]
		  		  puts $cfg "#"
		  		  puts $cfg "# Local configuration overrides for DarwinPorts"
		  		  puts $cfg "#"
		  		  puts $cfg "ReadlineIncludePath=${prefix}/include"
		  		  puts $cfg "SRC_CC_OPTS += -I${prefix}/include"
		  		  puts $cfg "SRC_HC_OPTS += -I${prefix}/include -L${prefix}/lib"
		  		  puts $cfg "SRC_HC_OPTS += -pgmP \"gcc3 -E traditional-cpp\""
		  		  puts $cfg "EXTRA_HSC2HS_OPTS += -I${prefix}/include"
		  		  puts $cfg "EXTRA_LD_OPTS += -L${prefix}/lib"
		  		  close $cfg

		  		  cd ${workpath}/${name}-bootstrap/bin
		  		  reinplace "s|/usr/local|${workpath}/${name}-bootstrap|" ghc
				}

		  configure.args-append	--with-gcc=gcc3			\
					--with-ghc='${workpath}/${name}-bootstrap/bin/ghc -pgmP \"gcc3 -E traditional-cpp\"'
		}


platform darwin 7 {
		  master_sites-append	${homepage}/dist/6.2.2/MacOSX/:bootstrap

		  distfiles-append	${name}-6.2.2-darwin-bootstrap.tar.bz2:bootstrap

		  checksums-append	ghc-6.2.2-darwin-bootstrap.tar.bz2 md5 de1e5d393b4d7c9027759110155eb3c0

		  pre-configure	{ set cfg [open "${worksrcpath}/mk/build.mk" w]
		  		  puts $cfg "#"
		  		  puts $cfg "# Local configuration overrides for DarwinPorts"
		  		  puts $cfg "#"
		  		  puts $cfg "ReadlineIncludePath=${prefix}/include"
		  		  puts $cfg "SRC_CC_OPTS += -I${prefix}/include"
		  		  puts $cfg "SRC_HC_OPTS += -I${prefix}/include -L${prefix}/lib"
		  		  puts $cfg "EXTRA_HSC2HS_OPTS += -I${prefix}/include"
		  		  puts $cfg "EXTRA_LD_OPTS += -L${prefix}/lib"
		  		  close $cfg

		  		  cd ${workpath}/${name}-bootstrap/bin
		  		  reinplace "s|/opt/local|${workpath}/${name}-bootstrap|" ghc
				}

		  configure.args-append --with-ghc='${workpath}/${name}-bootstrap/bin/ghc'
		}

#bugs		GHC does not support DESTDIR. Instead, we install	\
#		everything into ${destroot}/${prefix}, and then fix up	\
#		the five scripts which actually have the installation	\
#		path hard coded.
#
#		Yes, it actually depends on two different readline	\
#		libraries when built under Jaguar. The port itself	\
#		builds with readline 5.0, but the bootstrap compiler	\
#		needs readline 4.3.

use_autoconf	yes

configure.env	LDFLAGS="-L${prefix}/lib" CPPFLAGS="-I${prefix}/include" \
		CFLAGS="-I${prefix}/include"

configure.args	--prefix=${destroot}/${prefix} \
		--mandir=${destroot}/${prefix}/share/man/

default_variants	+opengl

variant opengl	{ configure.args-append --enable-hopengl }

post-destroot	{ reinplace s|${destroot}/${prefix}|${prefix}|g ${destroot}/${prefix}/bin/ghc
		  reinplace s|${destroot}/${prefix}|${prefix}|g ${destroot}/${prefix}/bin/ghci
		  reinplace s|${destroot}/${prefix}|${prefix}|g ${destroot}/${prefix}/bin/ghc-pkg
		  reinplace s|${destroot}/${prefix}|${prefix}|g ${destroot}/${prefix}/bin/ghcprof
		  reinplace s|${destroot}/${prefix}|${prefix}|g ${destroot}/${prefix}/bin/hsc2hs

		  reinplace "s|\\\$@\"\}|\\\$@\"\} -L${prefix}/lib -I${prefix}/include |" ${destroot}/${prefix}/bin/ghc

                  cd ${destroot}/${prefix}/lib/ghc-${version}
                  system "ranlib *.a"
		}

