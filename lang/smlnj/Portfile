# $Id: Portfile,v 1.3 2005/02/04 06:35:47 toby Exp $

PortSystem 1.0
name             smlnj
version          110.52
revision         1
categories       lang
maintainers      toby@opendarwin.org
description      Standard ML of New Jersey
long_description \
	Standard ML of New Jersey (abbreviated SML/NJ) is a \
	compiler for the Standard ML '97 programming language \
	with associated libraries, tools, and documentation. \
	SML/NJ is free, open source software.
homepage         http://www.smlnj.org/
platforms        darwin

master_sites     http://smlnj.cs.uchicago.edu/dist/working/${version}/
dist_subdir      ${name}/${version}

distfiles
checksums

# Files needed for basic distribution.
set srcs [list \
	config.tgz 95fc1334f160dea6d26b7f0794214896 \
	runtime.tgz 759c2233e125902bb912beec95677edd \
	system.tgz f758d8b8f11f4123db43c496451541cf \
	smlnj-lib.tgz cd94ffb77bb6a409b58bf74a5388b9a0 \
	smlnj-c.tgz 10f19c4f41134f974397cd90fae66d99 \
	cm.tgz ca0079c52cd8c9fdccfe5564550a27eb \
	MLRISC.tgz 6adf1991b60f0c3f1f1733b9051a16ef \
	ml-yacc.tgz 06c3c7b10db4bde721cf6a6be5d4795c \
	ml-nlffigen.tgz 023509ba46833c6b52184f2590d32ff3 \
	ml-nlffi-lib.tgz a5273804f900a1e4030360fc9ddf4411 \
	ml-lex.tgz 901e3f69defbcc0007691c9d1ceab681 \
	ml-burg.tgz 52a8a3597e7640248d3f3d3e9ac7d9b2 \
	eXene.tgz f0a94cb8b8dd4dc66d980c10a5a7fd5b \
	compiler.tgz 6a31f2e1ce4f679778b8988cd5850b4f \
	cml.tgz 92231d1464e69c5c96915af70270ca00 \
	ckit.tgz d0c75ee35422333155856b577b87ec91 \
]

foreach {tarball checksum} $srcs {
	distfiles-append $tarball
	checksums-append $tarball md5 $checksum
}

# Platform-specific boot code (omitted: alpha32, hppa, mipseb, sparc).
platform powerpc {
	distfiles-append boot.ppc-unix.tgz
	checksums-append boot.ppc-unix.tgz md5 8359f94e8e00c707a6cd5ce789cebb91
}
platform i386 {
	distfiles-append boot.x86-unix.tgz
	checksums-append boot.x86-unix.tgz md5 1f48da28eac0b7f0926c71ef75fbaf6e
}

### extract ###
pre-extract {
	file mkdir ${worksrcpath}
}
extract.dir          ${worksrcpath}
extract.only         config.tgz

### configure ###
configure {
	reinplace "s|SRCARCHIVEURL=.*|SRCARCHIVEURL=file://${distpath}|" \
		${worksrcpath}/config/srcarchiveurl

	reinplace "s|#request|request|" ${worksrcpath}/config/targets
}

### build ###
build.env            URLGETTER=curl
build.cmd            ${worksrcpath}/config/install.sh
build.target

### destroot ###
destroot {
	set smlnj_home ${prefix}/share/smlnj

	file mkdir ${destroot}${smlnj_home}
	file copy ${worksrcpath}/bin ${destroot}${smlnj_home}
	file copy ${worksrcpath}/lib ${destroot}${smlnj_home}

	xinstall -m 555 ${filespath}/sml.sh ${destroot}${prefix}/bin/sml
	reinplace "s|__SMLNJ_HOME__|${smlnj_home}|g" \
		${destroot}${prefix}/bin/sml

	foreach prog [glob -directory ${worksrcpath}/bin *] {
		set progname [file tail $prog]
		if {![string equal $progname sml]} {
			system "ln -s sml ${destroot}${prefix}/bin/${progname}"
		}
	}
}
