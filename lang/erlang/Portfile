# $Id$

PortSystem 1.0
name		erlang
version		R12B-5
revision        1
categories	lang erlang
maintainers	bfulgham@macports.org
platforms	darwin
description	The Erlang Programming Language
long_description                                                        \
                Erlang is a programming language designed at the        \
                Ericsson Computer Science Laboratory. Open-source       \
                Erlang is being released to help encourage the spread   \
                of Erlang outside Ericsson.                             \
                                                                        \
                We are releasing free of charge:                        \
                    The entire source code of the current Erlang        \
                    system.                                             \
                    Extensive libraries of code for building robust     \
                    fault-tolerant distributed applications.            \
                    All with documentation.                             \
                                                                        \
                All the above software has been battle tested in a      \
                number of Ericsson products, for example the new        \
                Ericsson ATM switch. 

homepage        http://www.erlang.org/
master_sites    http://www.erlang.org/download/

distfiles       otp_src_${version}${extract.suffix}                    \
                otp_doc_man_${version}${extract.suffix}                \
                otp_doc_html_${version}${extract.suffix}

checksums       otp_src_R12B-5.tar.gz \
                    md5     3751ea3fea669d2b25c67eeb883734bb \
                    sha1    6c45509acf70d35d5def2cbefd86ada093c1ac3a \
                    rmd160  7265ae8ebd045ec5b977148a7c9b995eb7ef2d2d \
                otp_doc_man_R12B-5.tar.gz \
                    md5     6231cb172847040395cc34b20781aa3b \
                    sha1    ae7036bd2afc9d1fca97f0de2eca84f56656def8 \
                    rmd160  e28d555d0a86fc69e0ee091864828c8eaa58d2be \
                otp_doc_html_R12B-5.tar.gz \
                    md5     fb0c5454bbd865e881b6712295f6d41f \
                    sha1    0bd369d02051e01bac58c9b8665bd3538e116f51 \
                    rmd160  b460906043171b27735332ec90c45e38d888869a

extract.only    otp_src_${version}${extract.suffix}

pre-patch       { file rename ${workpath}/otp_src_${version} ${workpath}/${name}-${version} }

# http://www.erlang.org/pipermail/erlang-bugs/2008-October/001023.html
# http://www.erlang.org/pipermail/erlang-bugs/2008-October/001024.html
# http://support.process-one.net/browse/EUNIT-13
patchfiles	patch-toolbar.erl \
                patch-erts_emulator_Makefile.in \
                patch-lib_ssl_c_src_esock_openssl.c \
                patch-lib_ssl_c_src_Makefile.dist \
                patch-lib_ssl_c_src_Makefile.in \
                patch-decode_big.c.diff \
                patch-decode_fun.c.diff \
                patch-eunit_xml.diff

configure.args  --prefix=${destroot}${prefix}	\
                --enable-kernel-poll            \
                --disable-smp-support           \
                --enable-hipe

variant smp	{
	configure.args-delete	--disable-smp-support
}

variant ssl	{
	configure.args-append    --with-ssl=${prefix}
	configure.ldflags-append -lz
	depends_build-append     port:openssl
	depends_run-append       port:openssl
}

variant no-hipe {
	# Currently produces bus errors in 10.5.3 due to changes in
	# signal handling
	configure.args-delete   --enable-hipe
}


platform i386 {
   pre-configure {
      file copy ${filespath}/mach_override.h ${workpath}/${name}-${version}/erts/emulator/hipe
      file copy ${filespath}/mach_override.c ${workpath}/${name}-${version}/erts/emulator/hipe
   }
}



depends_build   port:gawk
depends_run     port:tk

post-destroot	{
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_html_${version}${extract.suffix}"
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_man_${version}${extract.suffix}"
 
        set erts_dir   erts-5.6.5

        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/start
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/start

	foreach x {dialyzer ear ecc elink epmd erl erlc escript run_erl start to_erl typer} { file delete -force ${destroot}${prefix}/bin/${x} }
	foreach x {dialyzer erl erlc escript run_erl start to_erl typer} { system "ln -s ../lib/erlang/bin/${x} ${destroot}${prefix}/bin/${x}" }

	file delete -force ${destroot}${prefix}/lib/erlang/bin/epmd
	system "ln -s ../${erts_dir}/bin/epmd ${destroot}${prefix}/lib/erlang/bin/epmd"
}
