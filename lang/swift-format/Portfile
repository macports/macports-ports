# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

name                swift-format
categories          lang
platforms           darwin
license             MIT
maintainers         @goranmoomin openmaintainer
supported_archs     x86_64 arm64

description         Formatting technology for Swift source code
long_description    swift-format provides the formatting technology for \
                    SourceKit-LSP and the building blocks for doing \
                    code formatting transformations.

homepage            https://github.com/apple/swift-format

set swiftversions       {55 54 53 52}
set latest_version      0.50500.0
set latest_swiftversion [lindex ${swiftversions} 0]

options xcodeversion_range

proc setup {swiftversion} {
    switch ${swiftversion} {
        55 {
            xcodeversion_range  13.0
            github.setup        apple swift-format 0.50500.0
            checksums           rmd160  543c9c5f53e16fb4785d08a73d2e09bacfcdd40b \
                                sha256  0629aa72a5a3738f1c264bfaa8fbd718795bb2d695463b7aacf16a4c122ac499 \
                                size    230560
        }

        54 {
            xcodeversion_range  12.5 13.0
            github.setup        apple swift-format 0.50400.0
            checksums           rmd160  beb5b6df42f722293097d7eed88ba320023b6bda \
                                sha256  d8f128c1fb9a4c0f9d0bbebc4dbe6455dcb6026d7b279abbead4e1cb9d73b4de \
                                size    227662
        }

        53 {
            xcodeversion_range  12.0 12.5
            github.setup        apple swift-format 0.50300.0
            checksums           rmd160  281fcdccf1ca0bf3226e3c10a608bf8f0465e74b \
                                sha256  b2f494f7cd3d796ece7b73494997d0d1e07dcb31c66f777bc36611b5054ba977 \
                                size    225033
        }

        52 {
            xcodeversion_range  11.4 12.0
            github.setup        apple swift-format 0.50200.1
            checksums           rmd160  323cc7791fc3a79ede79047c519535d5a63e0d4f \
                                sha256  ae289bab4c286ae241d3920fe0f6c562b6f53f211a0e2a3c9f4b076260e72b72 \
                                size    213355
        }
    }
}

proc xcodeversion_get_minimum { } {
    global xcodeversion_range
    return [lindex ${xcodeversion_range} 0]
}

proc xcodeversion_get_maximum { } {
    global xcodeversion_range
    return [lindex ${xcodeversion_range} 1]
}

proc xcodeversion_run_range_check { } {
    global xcodeversion_range xcodeversion
    set minimum_xcodeversion [xcodeversion_get_minimum]
    set maximum_xcodeversion [xcodeversion_get_maximum]

    if {${maximum_xcodeversion} eq ""} {
        if {[vercmp ${xcodeversion} ${minimum_xcodeversion}] < 0} {
            known_fail yes
            pre-fetch {
                ui_error "${name} @${version} requires Xcode [xcodeversion_get_minimum] or later."
                return -code error "incompatible Xcode version"
            }
        }
    } else {
        if {[vercmp ${xcodeversion} ${minimum_xcodeversion}] < 0 || [vercmp ${xcodeversion} ${maximum_xcodeversion}] > 0} {
            known_fail yes
            pre-fetch {
                ui_error "${name} @${version} requires an Xcode between [xcodeversion_get_minimum] and [xcodeversion_get_maximum]."
                return -code error "incompatible Xcode version"
            }
        }

    }
}

foreach {swiftversion} ${swiftversions} {
    subport ${name}${swiftversion} {
        setup ${swiftversion}

        xcodeversion_run_range_check

        use_configure   no
        use_xcode       yes

        build.type      xcode
        build.cmd       swift
        build.args      --configuration release -Xswiftc -Onone --disable-sandbox
        build.target    build

        destroot {
            xinstall -m 755 ${worksrcpath}/.build/release/swift-format ${destroot}${prefix}/bin/
        }
    }
}

if {${name} eq ${subport}} {
    # Set up the stub port.
    version             ${latest_version}
    supported_archs     noarch
    distfiles
    depends_run         port:${name}${latest_swiftversion}
    use_configure       no
    build {}
    destroot {
        xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
        system "echo ${name} is a stub port > ${destroot}${prefix}/share/doc/${name}/README"
    }
}
