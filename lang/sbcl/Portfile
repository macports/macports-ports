# $Id: Portfile,v 1.15 2005/05/09 21:04:03 gwright Exp $

PortSystem 1.0
name		sbcl
version		0.9.0
set bootversion 0.9.0
categories	lang
maintainers	gwright@opendarwin.org waqar@opendarwin.org
platforms	darwin
description	The Steel Bank Common Lisp system
long_description	\
		Steel Bank Common Lisp (SBCL) is a Open Source		\
		development system for ANSI Common Lisp. It provides an	\
		interactive environment including an integrated native	\
		compiler, interpreter, and debugger. (And it, and its	\
		generated code, can also play nicely with Unix when	\
		running noninteractively.)

homepage	http://www.sbcl.org
master_sites	sourceforge
use_bzip2	yes

distfiles	${name}-${version}-source${extract.suffix}		\
		${name}-${bootversion}-powerpc-darwin-binary${extract.suffix}

distname	${name}-${version}-source
worksrcdir	${name}-${version}

checksums	${name}-${version}-source${extract.suffix}		\
			md5 9544e79998980bfc1f555cfb900399d7 \
		${name}-${bootversion}-powerpc-darwin-binary${extract.suffix} \
			md5 0b1e8c53d21ad5cf661d033fc437440b

use_configure	no

set host_lisp	"\"${workpath}/${name}-${bootversion}-powerpc-darwin/src/runtime/sbcl --core ${workpath}/${name}-${bootversion}-powerpc-darwin/output/sbcl.core --disable-debugger\" "

build		{ cd ${worksrcpath}
		  system "ulimit -s 8192"

		  system "unset LD_PREBIND && unset LD_PREBIND_ALLOW_OVERLAP && sh make.sh ${host_lisp}"
		}

default_variants	+test

variant test	{ test.run	yes
		  test.dir	${worksrcpath}/tests
		  test.cmd	sh
		  test.target	run-tests.sh
		}

destroot	{ cd ${worksrcpath}
		  system "INSTALL_ROOT=${destroot}/${prefix} sh install.sh"
		}

post-destroot	{ cd ${destroot}${prefix}/bin
		  file rename sbcl sbcl.bin

		  set script [open "${destroot}${prefix}/bin/sbcl" w 755]
                  puts $script "#!/bin/sh"
                  puts $script "${prefix}/bin/sbcl.bin --core ${prefix}/lib/${name}/${name}.core $@"
                  puts $script ""
                  close $script
                  system "chmod 755 ${destroot}${prefix}/bin/sbcl"
                }

