From dfe4b0e8dd8ecae05ea1fd5f115fafb38e02d64c Mon Sep 17 00:00:00 2001
From: "Kirill A. Korinsky" <kirill@korins.ky>
Date: Tue, 6 Jun 2023 15:15:56 +0200
Subject: [PATCH] Darwin: disable custom nanosleep before 10.6

See: https://github.com/sbcl/sbcl/commit/6d28b641b659b2be6ad7b329ae09cb592c1162a1
---
 src/runtime/darwin-os.c | 4 ++++
 src/runtime/wrap.c      | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git src/runtime/darwin-os.c src/runtime/darwin-os.c
index 6a1b29247..c3be53e05 100644
--- src/runtime/darwin-os.c
+++ src/runtime/darwin-os.c
@@ -165,6 +165,8 @@ futex_wake(int *lock_word, int n)
 #endif
 #endif
 
+#if __ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ >= 1060
+
 /* nanosleep() is not re-entrant on some versions of Darwin,
  * reimplement it using the underlying syscalls. */
 int
@@ -222,3 +224,5 @@ sb_nanosleep(time_t sec, int nsec) {
         }
     }
 }
+
+#endif
diff --git src/runtime/wrap.c src/runtime/wrap.c
index 8f8999e8a..94daf3fa7 100644
--- src/runtime/wrap.c
+++ src/runtime/wrap.c
@@ -524,7 +524,7 @@ int s_issock(mode_t mode)
 #endif /* !LISP_FEATURE_WIN32 */
 
 #ifdef LISP_FEATURE_UNIX
-#ifdef LISP_FEATURE_DARWIN
+#if defined(LISP_FEATURE_DARWIN) && (__ENVIRONMENT_MAC_OS_X_VERSION_MIN_REQUIRED__ >= 1060)
 /* nanosleep() is not re-entrant on some versions of Darwin and is
  * reimplemented using the underlying syscalls.
  */
-- 
2.41.0

