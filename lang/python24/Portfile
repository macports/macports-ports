# $Id$

PortSystem 1.0

name            python24
version         2.4.4
revision        1
set major_version   2
set minor_version   4
categories      lang
platforms       darwin freebsd linux
maintainers     nomaintainer@macports.org
description     An interpreted, object-oriented programming language
long_description    Python is an interpreted, interactive, object-oriented \
                    programming language.

homepage        http://www.python.org/
master_sites    ${homepage}/ftp/python/${version}/ \
                ftp://ftp.python.org/pub/python/${version}/
distname        Python-${version}
checksums       md5 0ba90c79175c017101100ebf5978e906
patchfiles      patch-configure \
                patch-Makefile.pre.in \
                patch-Lib-cgi.py \
                patch-Lib-site.py \
                patch-setup.py \
                patch-Include-pyport.h \
                patch-Mac-OSX-Makefile.in \
                patch-Mac-OSX-IDLE-Makefile.in \
                patch-Mac-OSX-PythonLauncher-Makefile.in

use_bzip2       yes

depends_lib     port:gettext

configure.args  --enable-shared \
                --mandir=${prefix}/share/man \
                --bindir=${prefix}/bin \
                --libdir=${prefix}/lib \
                --without-readline \
                --enable-framework=${prefix}/Library/Frameworks \
                --disable-tk \
                --enable-ipv6

post-patch {
    cd ${worksrcpath}
    reinplace "s|__PREFIX__|${prefix}|g" Lib/cgi.py
    reinplace "s|__PREFIX__|${prefix}|g" Lib/site.py
    reinplace "s|__PREFIX__|${prefix}|g" Mac/OSX/Makefile.in
    reinplace "s|__PREFIX__|${prefix}|g" setup.py
}

build.target    all libpython2.4.dylib

# Workaround for case-sensitive file systems
post-build {
    if { ![file exists ${worksrcpath}/python.exe] } {
        cd ${worksrcpath}
        ln -s python python.exe  
    }
}

test.run        yes
test.target     test

destroot.target frameworkinstall maninstall
post-destroot {
    if { [variant_isset macosx]} {
        set framewdir ${prefix}/Library/Frameworks/Python.framework
        xinstall -m 755 -d ${destroot}${framewdir}/Versions/2.4/include
        cd ${destroot}${framewdir}
           ln -s Versions/Current/lib Libraries
        cd ${destroot}${prefix}/bin
           ln -sf ${framewdir}/Versions/2.4/bin/pydoc pydoc
           ln -sf ${framewdir}/Versions/2.4/bin/pydoc pydoc24
        cd ${destroot}${framewdir}/Versions/2.4/lib/python2.4
           ln -s ${prefix}/lib/python2.4/config config
        cd ${destroot}${prefix}/lib
           ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib libpython${version}.dylib
           ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib libpython${major_version}.dylib
           ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib libpython.dylib
    } elseif { [variant_isset darwin]} {
        cd ${destroot}${prefix}/lib
           ln -s libpython${major_version}.${minor_version}.dylib libpython${version}.dylib
           ln -s libpython${major_version}.${minor_version}.dylib libpython${major_version}.dylib
           ln -s libpython${major_version}.${minor_version}.dylib libpython.dylib
    } else {
        system "cd ${destroot}${prefix}/lib && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython${version}.so && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython${major_version}.so && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython.so"
    }
}


# delete symlinks without version suffix, use python_select instead to choose version
platform darwin {
    post-destroot {
        cd ${destroot}${prefix}
        file delete bin/python
        file delete bin/pythonw
        file delete bin/idle
        file delete bin/pydoc
        file delete bin/smtpd.py
        file rename share/man/man1/python.1 share/man/man1/python2.4.1
    }
}

platform puredarwin {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-toolbox-glue --disable-framework
    destroot.target     install maninstall
}

platform darwin 8 {
    configure.compiler	gcc-4.0
    configure.args-append --with-cxx=/usr/bin/g++-4.0
}

platform darwin 9 {
    configure.cppflags-append    -D__DARWIN_UNIX03
}

platform freebsd {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-framework
    build.target        all libpython2.4.so
    destroot.target     install maninstall
}

platform linux {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-framework
    build.target        all libpython2.4.so
    destroot.target     install maninstall
}

livecheck.check regex
livecheck.url   http://www.python.org/download/releases/
livecheck.regex Python (2.4.\[0-9\]+)
