# $Id$

PortSystem 1.0

name            mzscheme
version         372
categories      lang scheme
platforms       darwin
maintainers     nomaintainer
description     MzScheme is an implementation of the Scheme programming language
long_description    ${description}

homepage        http://www.plt-scheme.org/software/mzscheme/
set subdir      ${version}/mz/
master_sites \
  http://download.plt-scheme.org/bundles/${subdir} \
  http://plt.cs.uchicago.edu/bundles/${subdir} \
  http://www.cs.utah.edu/plt/download/${subdir} \
  ftp://archive.informatik.uni-tuebingen.de/unix/language/plt/${subdir} \
  ftp://infogroep.be/pub/plt/bundles/${subdir} \
  http://gd.tuwien.ac.at/languages/scheme/plt/${subdir}
distfiles       mz-${version}-src-unix.tgz
checksums           md5     c755f4ba7191636c5eb587745e4c6a67 \
                    sha1    1601d3acc8d785656c9bbbefef6be7ea325b9b10 \
                    rmd160  b3389d390668dec5cc5b598307e0e1080f815e2f
depends_lib     port:jpeg \
                port:libpng \
                port:libiconv

worksrcdir      mz-${version}/src
set frameworks  ${prefix}/Library/Frameworks

post-patch {
  reinplace "s|collects|share/mzscheme|g" \
    ${worksrcpath}/mzscheme/src/startup.ss \
    ${worksrcpath}/mzscheme/src/startup.inc
  reinplace "s|~/Library/PLT Scheme/|${prefix}/share/mzscheme/|g" \
    ${worksrcpath}/mzscheme/src/file.c
  reinplace "s|@FRAMEWORK_INSTALL_DIR@|${destroot}${frameworks}|" \
    ${worksrcpath}/mzscheme/Makefile.in
}

configure.args  --enable-libfw

destroot.destdir    prefix=${destroot}${prefix}
post-destroot {
  file delete -force ${destroot}${prefix}/install \
    ${destroot}${prefix}/share/man
  file rename ${destroot}${prefix}/collects \
    ${destroot}${prefix}/share/mzscheme
  xinstall -m 755 -d ${destroot}${prefix}/share/doc/ \
    ${destroot}${prefix}/share/mzscheme/${version}/
  file rename ${destroot}${prefix}/man \
    ${destroot}${prefix}/share/man
  file rename ${destroot}${prefix}/doc \
    ${destroot}${prefix}/share/doc
  file delete -force ${destroot}${prefix}/lib/buildinfo

  ln -s ${frameworks}/PLT_MzScheme.framework/Versions/${version}/PLT_MzScheme \
    ${destroot}${prefix}/lib/libmzscheme.${version}.dylib
  
  system "/usr/bin/install_name_tool -change PLT_MzScheme.framework/Versions/${version}_3m/PLT_MzScheme ${frameworks}/PLT_MzScheme.framework/Versions/${version}_3m/PLT_MzScheme ${destroot}${prefix}/bin/mzscheme"

  ln -s .. ${destroot}${prefix}/share/mzscheme/${version}/collects
}
