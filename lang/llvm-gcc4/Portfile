PortSystem 1.0

name                    llvm-gcc4
version                 2.0
categories              lang
platforms               darwin
maintainers             erickt@macports.org
description             llvm is a next generation compiler infrastructure
long_description        llvm brings tools to work on the llvm intermediate \
                        language incl. a C and C++ frontend.

homepage                http://llvm.org/
master_sites            http://llvm.org/releases/${version}/

distname                ${name}-${version}.source
checksums               md5 648b6e1e73d770bbef2712b16a993548 \
                        sha1 4731bd86094fae2799bfd7f2760a4a3b05e14e43 \
                        rmd160 05eafd609990684a999f332bff782627cbe5cb50

depends_lib             port:llvm

worksrcdir              build

pre-configure {
  file mkdir ${workpath}/build
}

configure.cmd           ../llvm-gcc4-${version}.source/configure

configure.args-append   --enable-llvm=${prefix}/lib/llvm/obj \
                        --enable-languages=c,c++,objc,obj-c++ \
                        --libdir=${prefix}/lib/${name} \
                        --libexecdir=${prefix}/libexec/${name} \
                        --includedir=${prefix}/include/${name} \
                        --infodir=${prefix}/share/info \
                        --mandir=${prefix}/share/man \
                        --with-local-prefix=${prefix} \
                        --program-prefix=llvm- \
                        --disable-nls

destroot.destdir        prefix=${destroot}${prefix} \
                        libdir=${destroot}${prefix}/lib/${name} \
                        libexecdir=${destroot}${prefix}/libexec/${name} \
                        includedir=${destroot}${prefix}/include/${name} \
                        infodir=${destroot}${prefix}/share/info \
                        mandir=${destroot}${prefix}/share/man

post-destroot {
  cd ${destroot}${prefix}
  file delete -force share/man/man7
  file delete -force share/info
  file delete -force bin/gccld
  file delete -force bin/gccas
}

variant darwin {
  post-extract {
    system "rm -rf ${workpath}/llvm-gcc4-${version}.source/libstdc++-v3"
  }

  configure.args-append  --with-gxx-include-dir=/usr/include/c++/4.0.0
}

variant powerpc {
  set triple powerpc-apple-darwin8

  configure.env-append TRIPLE=${triple}
  configure.post_args  --build=${triple} --host=${triple} --target=${triple}
}

variant x86 {
  set triple i686-apple-darwin8

  configure.env-append TRIPLE=${triple} \
                       TARGETOPTIONS="--with-arch=nocona --with-tune=generic"
  configure.post_args  --build=${triple} --host=${triple} --target=${triple}
}
