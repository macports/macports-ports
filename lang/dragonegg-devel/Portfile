# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    dragonegg-devel
set llvm_version        3.0
categories              lang
platforms               darwin
maintainers             nomaintainer
license                 BSD

description             Dragonegg is a LLVM plug-in for GCC 4.5 or +
long_description        Dragonegg replaces GCC optimizers and code generators \
                        by the LLVM optimizing infrastructure. It supersedes \
                        llvm-gcc.

homepage                http://dragonegg.llvm.org/

depends_lib             port:llvm-${llvm_version}

version                 ${llvm_version}
epoch                   1
master_sites            http://llvm.org/releases/${version}/
extract.suffix          .tar.gz
distfiles               dragonegg-${version}${extract.suffix}
worksrcdir              dragonegg-${version}.src
checksums           sha1    9be8f055df814e56ea3585156da8c7e457f2cd7b \
                    rmd160  93aa8a463b6b5e1fb9cc1ee0a7c4d310a78ea64f \
                    sha256  72df1fd2e901b254ab8d1b5e7b93c7104751a613aca531f1483f9a637a5f6827

pre-fetch {
    ui_msg "Please remember to keep dragonegg and llvm in phase by updating llvm-3.0 first."
}

use_configure no

patchfiles revision.patch
patch.pre_args -p1

build.env-append LLVM_CONFIG=${prefix}/bin/llvm-config-mp-${version}

variant gcc45 conflicts gcc46 description {use Dragonegg with gcc45} {
    depends_lib-append port:gcc45
    build.env-append GCC=${prefix}/bin/gcc-mp-4.5
    global gcc_version
    set gcc_version 45
}

variant gcc46 conflicts gcc45 description {use Dragonegg with gcc46} {
    depends_lib-append port:gcc46
    build.env-append GCC=${prefix}/bin/gcc-mp-4.6
    global gcc_version
    set gcc_version 46
}

if {![variant_isset gcc46]} {
    default_variants +gcc45
}

build.target

destroot {
    xinstall -m 755 -d ${destroot}${prefix}/lib
    xinstall -m 755 ${worksrcpath}/dragonegg.so ${destroot}${prefix}/lib/dragonegg${gcc_version}.so
}
