# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0

name                photoqt
github.setup        luspi photoqt 3.4 v
revision            0
conflicts           photoqt-qt4
categories          graphics
license             GPL-2
maintainers         {@barracuda156 gmail.com:vital.had} openmaintainer

description         PhotoQt Image Viewer
long_description    PhotoQt is a simple yet powerful and good looking image viewer, based on Qt/QML, \
                    published as open-source and completely free.
homepage            https://photoqt.org

depends_lib-append  port:desktop-file-utils \
                    port:exiv2 \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:GraphicsMagick \
                    path:lib/pkgconfig/gtk+-3.0.pc:gtk3 \
                    port:shared-mime-info

if {${subport} eq "${name}"} {
    PortGroup       qt5 1.0

    conflicts       photoqt-qt4
    platforms       {darwin > 10}
    checksums       rmd160  15248da2baaf763e90ebebb36b1bdabeaaa59255 \
                    sha256  16ffaa5630d7afbe516015d228112dc224c23f1f457df8cfbe6c2500686e94ba \
                    size    4189570

    depends_lib-append \
                    port:kde-extra-cmake-modules \
                    port:libarchive \
                    port:libraw \
                    path:lib/pkgconfig/poppler.pc:poppler \
                    port:poppler-qt5 \
                    port:pugixml \
                    port:vips \
                    port:webp

    configure.args-append \
                    -DCHROMECAST=OFF \
                    -DDEVIL=OFF \
                    -DFREEIMAGE=OFF \
                    -DGRAPHICSMAGICK=ON \
                    -DIMAGEMAGICK=OFF \
                    -DENABLE_WEBP=ON \
                    -DLIBARCHIVE=ON \
                    -DLIBVIPS=ON \
                    -DPOPPLER=ON \
                    -DPUGIXML=ON \
                    -DQTPDF=OFF \
                    -DRAW=ON \
                    -DRESVG=OFF \
                    -DVIDEO_MPV=OFF \
                    -DVIDEO_QT=OFF

    if {${configure.build_arch} eq "arm64"} {
        # FIXME: at the moment it build on aarch64 but crashes on launch:
        # https://github.com/luspi/photoqt/issues/19
        qt5.depends_component \
                    qtmultimedia qtsvg qttools qttranslations sqlite-plugin

        # https://trac.macports.org/ticket/68508
        configure.args-append \
                    -DLOCATION=OFF
    } else {
        qt5.depends_component \
                    qtlocation qtmultimedia qtsvg qttools qttranslations sqlite-plugin
    }

    # Without this the build cannot find QtPlatformHeaders:
    configure.cxxflags-append \
                    -I${qt_includes_dir}
}

subport photoqt-qt4 {
    PortGroup       qt4 1.0

    # This is the last version to support Qt4.
    # TODO: restore Qt4 support into 1.x.
    github.setup    luspi photoqt-legacy 1.0 v
    revision        0
    conflicts       photoqt
    platforms       {darwin < 11}
    checksums       rmd160  6095ced5325995e6dd580f11b30975cf00638d2d \
                    sha256  68bcde5206ba0d49546280de70acec01e2a52b44c54481757ddd8c4e82aa21a8 \
                    size    704719

    patchfiles-append \
                    patch-exiv2.diff \
                    patch-include-magick.diff

    post-patch {
        reinplace "s,@PREFIX@,${prefix}," ${worksrcpath}/CMakeLists.txt
    }

    depends_lib-append \
                    port:phonon

    configure.args-append \
                    -DGM=ON \
                    -DPHONON=ON

    # filehandling.cpp: error: invalid conversion from 'QPushButton*' to 'CustomPushButton*' [-fpermissive]
    if {[string match *gcc* ${configure.compiler}]} {
        configure.cxxflags-append \
                    -fpermissive
    }
}

configure.args-append \
                    -DEXIV2=ON

compiler.cxx_standard   2011

post-activate {
    system "${prefix}/bin/update-desktop-database ${prefix}/share/applications"
    system "${prefix}/bin/update-mime-database ${prefix}/share/mime"
    system "${prefix}/bin/gtk-update-icon-cache-3.0 -f -t ${prefix}/share/icons/hicolor"
}
