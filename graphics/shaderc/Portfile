# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           cmake 1.1
PortGroup           legacysupport 1.1

version             v2024.3
revision            0
github.setup        google shaderc ${version}

categories          graphics devel
license             Apache Version-2.0
maintainers         {christophecvr @christophecvr} openmaintainer

description         A collection of tools, libraries and tests for shader compilation.
long_description    At the moment it includes: \
                    glslc, a command line compiler for GLSL/HLSL to SPIR-V, and \
                    libshaderc, a library API for accessing glslc functionality.
homepage            https://github.com/google/shaderc

checksums           shaderc-v2024.3.tar.gz \
                    rmd160  28cc1e3a47f74c37897ea49e632273dccc722617 \
                    sha256  e8fe28d01b7f9100118bc99f7421a1022d5bed3280c8ce50644d8462da649581 \
                    size    227486 \
                    abseil-cpp-1315c900e1ddbb08a23e06eeb9a06450052ccb5e.tar.gz \
                    rmd160  71e5b8890b144929c6d83bb10804ee676b8cfaee \
                    sha256  4ae9fc64860d5204f0ca6bd6c7a5f8e59ced118494db7e14537d8ed55dce5715 \
                    size    2222719 \
                    effcee-d74d33d93043952a99ae7cd7458baf6bc8df1da0.tar.gz \
                    rmd160  b17b18df022cab65d0dc9f3e11fda3e1e0a5c530 \
                    sha256  0708c376a0a0ee61c0f966ff4dea87a670988676bd16dd2928d4ea19921a6987 \
                    size    40054 \
                    googletest-1d17ea141d2c11b8917d2c7d029f1c4e2b9769b2.tar.gz \
                    rmd160  1edbe92ebafc58f5bd5ee9403fb20f178307a966 \
                    sha256  7aca173cc96c0feaa01035184e34b020daaa93ddc132c5a829b7ea34006f701b \
                    size    873606 \
                    re2-4a8cee3dd3c3d81b6fe8b867811e193d5819df07.tar.gz \
                    rmd160  e53e8805d1fdbeb656b1c583ceee0d0182268307 \
                    sha256  f0a65168e64a10ab556b265f2f411678e6b9555f21e04202f84f250b659954ba \
                    size    390803 \
                    SPIRV-Headers-2a9b6f951c7d6b04b6c21fe1bf3f475b68b84801.tar.gz \
                    rmd160  42dc68dd7bcd347bb42260a2fb6a38119ee21862 \
                    sha256  1698e1373bd6e59a263acef821c4d955c561b991feb6db8199833ef19ffe8a37 \
                    size    524052 \
                    SPIRV-Tools-01c8438ee4ac52c248119b7e03e0b021f853b51a.tar.gz \
                    rmd160  c9fcf458c852967740aec0a37b4178e89c083052 \
                    sha256  cda78525518987c262cca8cb04ca6479c0361c16db3c5a7042924063e101b847 \
                    size    3199699 \
                    glslang-467ce01c71e38cf01814c48987a5c0dadd914df4.tar.gz \
                    rmd160  7e5baff3f43db294a222d1c57f85ed10c99e8bcb \
                    sha256  390764c4df4e17c7831af747e58ceac80945f1750238b623ffaaa73538ccac4c \
                    size    3871722

set py_ver          3.12
set py_ver_nodot    [string map {. {}} ${py_ver}]

compiler.cxx_standard 2017

# Need to use MacPorts libc++ on macOS 10.14 Mojave and older, because
# Apple Clang only added support for the C++17 <filesystem> library
# starting in Xcode 11 (clang-1100) for macOS 10.15+.
# References:
# * https://stackoverflow.com/a/55353263
# * https://developer.apple.com/documentation/xcode-release-notes/xcode-11-release-notes
legacysupport.newest_darwin_requires_legacy 18
legacysupport.use_mp_libcxx yes

# Patching source to use Already installed SPIRV-Tools.
patchfiles              use-installed-spirv-tools.patch

depends_build-append    port:spirv-headers

depends_lib-append      port:glslang \
                        port:spirv-tools


depends_build-append    port:python${py_ver_nodot}
configure.python        ${prefix}/bin/python${py_ver}
configure.args-append   -DPYTHON_EXECUTABLE:FILEPATH=${configure.python}

# Only glslang is build to build shaderc glslang is not installed.
# Using installed SPIRV-Tools.
set submodules {
    KhronosGroup glslang 467ce01c71e38cf01814c48987a5c0dadd914df4 third_party/glslang
}

foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
    master_sites-append https://github.com/${sub_author}/${sub_project}/archive/${sub_commit}.tar.gz?dummy=:${sub_project}
    distfiles-append    ${sub_project}-${sub_commit}.tar.gz:${sub_project}
}

# FIXME : main module not extracted in worksrcpath with multiple download sources.
# Move extracted main module to worksrcpath
# Move submodules to cmakes expected location in worksrcpath
post-extract {
    move ${workpath}/google-shaderc-7223dc3 ${worksrcpath}
    foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
        move ${workpath}/${sub_project}-${sub_commit} ${worksrcpath}/${sub_dest}
    }
}

configure.args-append   -DSHADERC_ENABLE_WERROR_COMPILE=OFF \
                        -DSHADERC_SKIP_TESTS=ON \
                        -DUSE_EXTERNAL_SPIRV_TOOLS=ON \
                        -DCMAKE_INSTALL_PREFIX=${prefix}
