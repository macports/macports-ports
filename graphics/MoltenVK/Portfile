# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0

github.setup        KhronosGroup MoltenVK 1.1.10 v
epoch               1

set sdkversion      1.3.216.0
categories          graphics
maintainers         {ryandesign @ryandesign} openmaintainer
platforms           macosx
license             Apache-2

# MoltenVK would build for i386, but it uses Metal which only works on x86_64 and arm64
supported_archs     arm64 x86_64

description         an implementation of Vulkan for Metal

long_description    ${name} is an implementation of the high-performance, \
                    industry-standard Vulkan graphics and compute API, that \
                    runs on Apple's Metal graphics framework.

# Repackage the darwin16 package for darwin15, so we can only update the version after that
# is avalible on packages.macports
if {${os.major} == 15} {
    version             1.1.9
    master_sites        https://packages.macports.org/MoltenVK/
    distname            MoltenVK-${version}_0.darwin_16.x86_64
    checksums           sha256  84c49e85712d2bb19f5d00bd91df4dae9518bc31ca3265c56c1fdabae25fcf08 \
                        rmd160  bf7e89fc3f67c0aeb392149eae4ce51ee06d4f06 \
                        size    7026887
    use_bzip2           yes
    extract.suffix      .tbz2

    use_configure       no

    build {}

    destroot {
        delete ${destroot}${prefix}
        copy ${workpath}/opt/local ${destroot}${prefix}
    }
} else {
    distname            vulkansdk-macos-${sdkversion}
    use_dmg             yes

    # url only works for the latest avalible SDK, older versions will 404
    master_sites        https://sdk.lunarg.com/sdk/download/${sdkversion}/mac/

    checksums           sha256  c896c30dc483aaffd4d7a5ac4c1c9a49552aa3893ab76a1f54be00e72bd2f33f \
                        rmd160  8b7fe763abb5bc775dd2446e83289c15b0b023b7 \
                        size    274321502

    depends_build       port:p7zip
    depends_skip_archcheck p7zip

    use_configure       no

    build {
        # bypass the installer that requires macOS 10.13
        system "${prefix}/bin/7z x -aoa ${worksrcpath}/InstallVulkan.app/Contents/Resources/installer.dat -o${workpath}/VulkanSDK"
    }

    destroot {
        set output_dir ${workpath}/VulkanSDK

        # Xcode11 and later are required to use "xcframework"
        # Headers currently break build due to Xcode 12 ProcessXCFramework bug:
        # https://developer.apple.com/forums/thread/651043?answerId=628400022#628400022
        if {${os.major} >= 18} {
            file copy ${output_dir}/MoltenVK/MoltenVK.xcframework ${destroot}${frameworks_dir}
        }

        file copy ${output_dir}/macOS/bin/MoltenVKShaderConverter ${destroot}${prefix}/bin
        file attributes ${destroot}${prefix}/bin/MoltenVKShaderConverter -permissions +x
        file copy ${output_dir}/macOS/lib/libMoltenVK.dylib ${destroot}${prefix}/lib

        # vulkan and vk_video are provided via vulkan-headers
        file copy ${output_dir}/MoltenVK/include/MoltenVK ${destroot}${prefix}/include
    }
}

platform darwin {
    if {${os.major} < 15} {
        archive_sites
        distfiles
        depends_build
        known_fail  yes
        pre-fetch {
            ui_error "${subport} @${version} requires OS X El Capitan or later"
            return -code error "incompatible OS X version"
        }
    }
}
