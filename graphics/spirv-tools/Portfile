# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           cmake 1.1

github.setup        KhronosGroup SPIRV-Tools 2022.2 v
github.tarball_from archive
name                spirv-tools
revision            0

categories          graphics
license             Apache-2
maintainers         {judaew @judaew} openmaintainer

description         Various SPIRV tools
long_description    SPIRV assembler, binary module parser, disassembler, validator, and optimizer
homepage            https://vulkan.lunarg.com

checksums           SPIRV-Tools-2022.2.tar.gz \
                    rmd160  569cae2b37ac0891dec0debc9f18c5aae48da9b7 \
                    sha256  909fc7e68049dca611ca2d57828883a86f503b0353ff78bc594eddc65eb882b9 \
                    size    2994426 \
                    re2-0c5616df9c0aaa44c9440d87422012423d91c7d1.tar.gz \
                    rmd160  b22631d7187234e4ea6d909776db3fee81690f70 \
                    sha256  05a1960729d1053f170ba1ac52bd442cd47cdfbb95348f935fa1921439a9b80c \
                    size    381181 \
                    effcee-ddf5e2bb92957dc8a12c5392f8495333d6844133.tar.gz \
                    rmd160  297fe49fbd2b6b364dec0228dd0ce16d4ab1e028 \
                    sha256  5809b2f80b67dc231c52da743be37bb46c5ce4a59dde344761f7c4295119750c \
                    size    34389 \
                    SPIRV-Headers-4995a2f2723c401eb0ea3e10c81298906bf1422b.tar.gz \
                    rmd160  34bf49206a8e6351fc4a3a96fcc9a48927c9c197 \
                    sha256  2c9fe1bbd74a74fdabe40a7ffb322527dfc008c79e1d19d3cf41a5f006d9ab60 \
                    size    420432

set py_ver          3.10
set py_ver_nodot    [string map {. {}} ${py_ver}]
foreach stage {configure build destroot test} {
    ${stage}.env-append PATH=${frameworks_dir}/Python.framework/Versions/${py_ver}/bin:$env(PATH)
}
depends_build-append port:python${py_ver_nodot}

set submodules {
                    google re2 0c5616df9c0aaa44c9440d87422012423d91c7d1 external/re2
                    google effcee ddf5e2bb92957dc8a12c5392f8495333d6844133 external/effcee
                    KhronosGroup SPIRV-Headers 4995a2f2723c401eb0ea3e10c81298906bf1422b external/spirv-headers
}

foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
    master_sites-append https://github.com/${sub_author}/${sub_project}/archive/${sub_commit}.tar.gz?dummy=:${sub_project}
    distfiles-append    ${sub_project}-${sub_commit}.tar.gz:${sub_project}
}

post-extract {
    ln -s {*}[glob -directory ${workpath} -tails ${github.project}-*] ${worksrcpath}
    foreach {sub_author sub_project sub_commit sub_dest} ${submodules} {
        ln -s {*}[glob ${workpath}/${sub_project}-*] ${worksrcpath}/${sub_dest}
    }
}

configure.args-append \
                    -DSPIRV_WERROR=OFF \
                    -DBUILD_SHARED_LIBS=ON \
                    -DSPIRV_TOOLS_BUILD_STATIC=OFF
