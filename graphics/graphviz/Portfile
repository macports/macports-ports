# $Id$

PortSystem          1.0

name                graphviz
version             2.16.1
revision            1
categories          graphics
maintainers         ryandesign
homepage            http://www.graphviz.org/
platforms           darwin
distfiles           ${distname}${extract.suffix}:source

description \
	Graph visualization software from AT&T and Bell Labs

long_description \
	Graph Visualization Software from AT&T Laboratories and \
	Bell Laboratories (Lucent Technologies). \
	The package contains: \
		dot    - batch program for drawing directed graphs as \
		 hierarchies \
		neato  - batch program for drawing undirected graphs \
		 using Kamada-Kawai spring models. \
	Users wishing to have only the graph layout \
	programs (for non-interactive use) can use the +no_x11 \
	variant to build graphviz without its display routines.

master_sites \
	${homepage}pub/graphviz/ARCHIVE/:source \
	http://www.pixelglow.com/downloads/:guiapp

checksums \
	${distname}${extract.suffix} \
		md5 8952fb2a627b38e38ed429a3a9d5cc5c \
		sha1 46b704bd9b81922bcd17167c88f3278a9645e894 \
		rmd160 6d0f23fa176a1bef7ee0ca48cf1b700fe6cbfb42

platform darwin 6 {
	pre-fetch {
		ui_msg "Note: dot2gxl and gxl2dot do not build on Mac OS X 10.2 Jaguar,"
		ui_msg "but the rest of Graphviz should work correctly."
	}
	patchfiles-append \
		patch-Makefile.in
}

platform darwin 7 {
	configure.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.3
	build.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.3
	depends_lib-append \
		port:gnuregex
	post-extract {
		reinplace "s|<regex.h>|<gnuregex.h>|g" ${worksrcpath}/lib/gvc/gvconfig.c
	}
}

platform darwin 8 {
	configure.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.4
	build.env-append \
		MACOSX_DEPLOYMENT_TARGET=10.4
}

depends_lib \
	lib:libX11.6:XFree86 \
	port:cairo \
	port:pango \
	port:jpeg \
	port:libpng \
	port:freetype \
	port:expat \
	port:zlib \
	port:gettext

depends_build \
	port:pkgconfig

depends_run \
	port:urw-fonts

configure.args \
	--mandir=${prefix}/share/man \
	--with-mylibgd \
	--with-pangocairo \
	--disable-swig \
	--disable-sharp \
	--disable-guile \
	--disable-io \
	--disable-java \
	--disable-lua \
	--disable-ocaml \
	--disable-perl \
	--disable-php \
	--disable-python \
	--disable-python23 \
	--disable-python24 \
	--disable-python25 \
	--disable-r \
	--disable-ruby \
	--disable-tcl

variant guile description {Include Guile language bindings} {
	depends_lib-append \
		port:guile
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-guile
	configure.args-append \
		--enable-guile
}

variant lua description {Include Lua language bindings} {
	depends_lib-append \
		port:lua
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-lua
	configure.args-append \
		--enable-lua
}

variant ocaml description {Include Objective Caml language bindings} {
	depends_lib-append \
		port:ocaml
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-ocaml
	configure.args-append \
		--enable-ocaml
}

variant perl description {Include PERL 5.8 language bindings} {
	depends_lib-append \
		port:perl5.8
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-perl
	configure.args-append \
		--enable-perl
}

variant php description {Include PHP 4 language bindings} {
	depends_lib-append \
		port:php4
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-php
	configure.args-append \
		--enable-php
}

variant python description {Include Python 2.4 language bindings} {
	depends_lib-append \
		port:python24
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-python
	configure.args-append \
		--enable-python
}

variant ruby description {Include Ruby language bindings} {
	depends_lib-append \
		port:ruby
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-ruby
	configure.args-append \
		--enable-ruby
}

variant tcl description {Include Tcl language bindings} {
	depends_lib-append \
		port:tcl
	depends_build-append \
		port:swig
	configure.args-delete \
		--disable-swig \
		--disable-tcl
	configure.args-append \
		--enable-tcl
}

variant no_pangocairo description {Remove pangocairo support (no antialiased bitmapped output; no PDF output)} {
	depends_lib-delete \
		port:cairo \
		port:pango
	configure.args-delete \
		--with-pangocairo
	configure.args-append \
		--without-pangocairo
}

variant no_x11 requires no_pangocairo description {Remove X11 support (removes lefty; implies no_pangocairo)} {
	depends_lib-delete \
		lib:libX11.6:XFree86
	configure.args-append \
		--without-x
}

variant gui description {Include the Pixelglow Graphviz GUI} {
	distfiles-append \
		graphviz-1.13-v16.tgz:guiapp
	checksums-append \
		graphviz-1.13-v16.tgz \
			md5 a3278f993ef3ce021043a17b16a9fd5f \
			sha1 87ee05a99088a98aef4937d72c3bb6cf488e3074 \
			rmd160 35eac7c7013bddc0d1f107fcaf8e9c7d1e078231
	post-destroot {
		set apppath ${destroot}/Applications/MacPorts
		set macospath ${apppath}/Graphviz.app/Contents/MacOS
		set dispatcher graphviz-dispatcher.php
		xinstall -d ${apppath}
		file copy "${workpath}/Graphviz 1.13 (v16)/Graphviz.app" ${apppath}
		xinstall -m 755 ${filespath}/${dispatcher}.in ${macospath}/${dispatcher}
		reinplace "s%@PREFIX@%${prefix}%g" ${macospath}/${dispatcher}
		foreach prog {acyclic bcomps ccomps circo cvtgxl dijkstra dot gc gvcolor gvpack gvpr neato nop sccmap tred twopi unflatten} {
			delete ${macospath}/${prog}
			ln -s ${dispatcher} ${macospath}/${prog}
		}
	}
}

# Make the configuration file that makes the plugins work:
post-activate {
	system "dot -c"
}

livecheck.check     regex
livecheck.url       ${homepage}Download_source.php
livecheck.regex     ${name}-(\[0-9.\]+)\\.tar
