# $Id$

PortSystem 1.0

name            nginx
version         0.5.34
categories      www mail
platforms       darwin
maintainers     boeyms openmaintainer
description     High-performance HTTP(S) server, HTTP(S) reverse proxy and IMAP/POP3 proxy server
long_description    Nginx ("engine x") is a high-performance HTTP(S) server \
                    and reverse proxy, as well as an IMAP/POP3 proxy server. \
                    Nginx was written by Igor Sysoev for Rambler.ru, Russia's \
                    second-most visited website, where it has been running in \
                    production for over two and a half years. Igor has \
                    released the source code under a BSD-like license. \
                    Although still in beta, Nginx is known for its stability, \
                    rich feature set, simple configuration, and low resource \
                    consumption.
homepage        http://nginx.net/
master_sites    http://sysoev.ru/nginx
checksums       md5     8f7d3efcd7caaf1f06e4d95dfaeac238 \
                sha1    f76f6cb1ac0a316f20958bf7dc6a03723fb58edf \
                rmd160  a057651eb9065b1e491ce38c73bc9e4897c982c7

depends_lib     port:pcre port:zlib

patchfiles      patch-auto__install.diff patch-conf__nginx.conf.diff
post-patch {
    reinplace "s|__DESTROOT__|${destroot}|g" \
        ${worksrcpath}/auto/install
}

set pidfile     ${prefix}/var/run/${name}.pid

configure.args-append \
            --with-cc-opt=\"${configure.cppflags} ${configure.cflags}\" \
            --with-ld-opt=\"${configure.ldflags}\" \
            --conf-path=${prefix}/etc/${name}/${name}.conf \
            --error-log-path=${prefix}/var/log/${name}/error.log \
            --http-log-path=${prefix}/var/log/${name}/access.log \
            --pid-path=${pidfile} \
            --lock-path=${prefix}/var/run/${name}.lock \
            --http-client-body-temp-path=${prefix}/var/run/${name}/client_body_temp \
            --http-proxy-temp-path=${prefix}/var/run/${name}/proxy_temp \
            --http-fastcgi-temp-path=${prefix}/var/run/${name}/fastcgi_temp

build.target        build
destroot.keepdirs   ${destroot}${prefix}/var/log/${name} \
                    ${destroot}${prefix}/var/run/${name} 
post-destroot {
    set nginx_conf ${prefix}/etc/${name}/${name}.conf
    move ${destroot}${nginx_conf} ${destroot}${nginx_conf}.example
# Try to cover for the fact that, in earlier revisions of this port, the
# configuration file was installed live instead of an example, in which case an
# upgrade will clobber any customisations that a user might have made :(
    catch "exec port provides ${nginx_conf}" provides_output
    set nginx_conf_is_registered_to_nginx \
        [regexp "${nginx_conf} is provided by: ${name}" ${provides_output}]
    set nginx_conf_differs \
        [catch {exec cmp ${nginx_conf} ${worksrcpath}/conf/${name}.conf}]
    if { ${nginx_conf_is_registered_to_nginx} && ${nginx_conf_differs} } {
        copy ${nginx_conf} ${nginx_conf}.altered
        ui_msg ""
        ui_msg "###############################################################"
        ui_msg "# It appears that you have altered ${nginx_conf},"
        ui_msg "# and that upgrading or uninstalling your previous installation"
        ui_msg "# of ${name} will clobber your copy.  It has been copied to"
        ui_msg "# ${nginx_conf}.altered for preservation when you upgrade or"
        ui_msg "# uninstall ${name}.  This problem should not occur with future"
        ui_msg "# upgrades or installations of this port.\n"
        ui_msg "###############################################################"
        ui_msg ""
    }
}

startupitem.create      yes
startupitem.executable  ${prefix}/sbin/nginx
startupitem.pidfile     auto ${pidfile}

variant dav description {Add WebDAV support to server} {
    configure.args-append   --with-http_dav_module
}

variant flv description {Add FLV (Flash Video) streaming support to server} {
    configure.args-append   --with-http_flv_module
}

variant mail description {Add IMAP4/POP3 mail proxy support} {
    configure.args-append   --with-mail
}

variant ssl description {Add SSL (HTTPS) support to the server, and\
        also to the mail proxy if that is enabled} {
    depends_lib-append      port:openssl
    configure.args-append   --with-http_ssl_module
    if [variant_isset mail] {
        configure.args-append   --with-mail_ssl_module
    }
}

variant status description {Add /nginx_status support to the server} {
    configure.args-append   --with-http_stub_status_module
}

# This variant has been labelled "perl5" so as to allow users to easily stick
# with perl 5.x once perl 6.x is released; a "perl6" variant will also be added
# at that time.
variant perl5 description {Add perl support to the server} {
    depends_run-append	    port:perl5.8
    configure.args-append   --with-http_perl_module
}
