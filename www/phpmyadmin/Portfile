# $Id: Portfile,v 1.3 2005/02/28 22:26:40 rshaw Exp $
PortSystem		1.0

name			phpmyadmin
version			2.6.1-pl2
categories		www
maintainers		darwinports@opendarwin.org
description		A tool written in PHP intended to handle the administration \
				of MySQL over the Web.
long_description	phpMyAdmin is a tool written in PHP intended to handle \
				the administration  of MySQL over the Web. Currently it can \
				create and drop databases,  create/drop/alter tables, \
				delete/edit/add fields, execute any SQL statement, manage keys \
				on fields, manage privileges,export data into  various formats \
				and is available in 47 languages.
homepage		http://www.phpmyadmin.net
master_sites	sourceforge
distname		phpMyAdmin-${version}
use_bzip2		yes
checksums		md5 787feeebe16ef7ab43e75e4046550da2
platforms		darwin freebsd

# Not sure this is the best way to handle this, but it works for now
# if no apache variant is set, force set it
if { ![variant_isset apache] && ![variant_isset apache2] } {
	set variations(apache) +
}
# if no mysql variant is set, force set it
if { ![variant_isset mysql] && ![variant_isset mysql4] } {
	set variations(mysql4) +
}
# if no php variant is set, force set it
if { ![variant_isset php4] && ![variant_isset php5] } {
	set variations(php4) +
}

variant apache conflicts apache2 {
	if { ![variant_isset apache_layout] } {
		depends_lib-append	path:${prefix}/sbin/apxs:apache
	} 
}

variant apache_layout requires apache conflicts apache2 {
	depends_lib-append	path:${prefix}/apache/bin/apxs:apache
}

variant apache2 conflicts apache {
	depends_lib-append	path:${prefix}/apache2/bin/apxs:apache2
}

variant php4 conflicts php5 {
	if { [variant_isset apache2] } {
		depends_lib-append path:${prefix}/apache2/modules/libphp4.so:php4
	} else {
		if { ![variant_isset apache_layout] } {
			depends_lib-append path:${prefix}/libexec/apache/libphp4.so:php4
		} else {
			depends_lib-append path:${prefix}/apache/libexec/libphp4.so:php4
		}
	}
}

variant php5 conflicts php4 {
	if { [variant_isset apache2] } {
		depends_lib-append path:${prefix}/apache2/modules/libphp5.so:php5
	} else {
		if { ![variant_isset apache_layout] } {
			depends_lib-append path:${prefix}/libexec/apache/libphp5.so:php5
		} else {
			depends_lib-append path:${prefix}/apache/libexec/libphp5.so:php5
		}
	}
}

variant mysql conflicts mysql4 {
	depends_lib-append	lib:libmysqlclient:mysql
}

variant mysql4 conflicts mysql {
	depends_lib-append	path:${prefix}/lib/mysql/libmysqlclient_r.dylib:mysql4
}

use_configure   no
configure		{}
build			{}

destroot {
	if { [variant_isset apache] } {
		if { [variant_isset apache_layout] } {
			set docpath ${destroot}${prefix}/apache/htdocs
		} else {
			set docpath ${destroot}${prefix}/www/data
		}
	} elseif { [variant_isset apache2] } {
		set docpath ${destroot}${prefix}/apache2/htdocs
	}
	xinstall -d -m 0755 ${docpath}
	system "cp -R ${worksrcpath} ${docpath}/phpmyadmin"
	foreach confname {config config.footer config.header} {
		file rename ${docpath}/phpmyadmin/${confname}.inc.php \
			${docpath}/phpmyadmin/${confname}.inc.php-dist
	}
	if {$env(USER) == "root"} {
		system "chown -R root:wheel ${docpath}/phpmyadmin"
	}
}

post-activate {
	# Make sure initial conf file is present and setup correctly
	if { [variant_isset apache] } {
		if { [variant_isset apache_layout] } {
			set docpath ${prefix}/apache/htdocs
		} else {
			set docpath ${prefix}/www/data
		}
	} elseif { [variant_isset apache2] } {
		set docpath ${prefix}/apache2/htdocs
	}
	foreach confname {config config.footer config.header} {
		if {![file exists ${docpath}/phpmyadmin/${confname}.inc.php]} {
			xinstall -m 0644 ${docpath}/phpmyadmin/${confname}.inc.php-dist \
				${docpath}/phpmyadmin/${confname}.inc.php
		}
	}
}

