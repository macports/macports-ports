# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   github 1.0
PortGroup                   cmake 1.1
PortGroup                   compiler_blacklist_versions 1.0

github.setup                Stiffstream restinio 0.4.4 v
github.master_sites         https://github.com/${github.author}/${github.project}/archive/
distname                    ${github.tag_prefix}.${github.version}
extract.post_args           | tar -xf - && mv ${github.project}-${github.tag_prefix}.${github.version} ${github.author}-${github.project}-${distname}
categories                  www devel
platforms                   darwin
license                     BSD
maintainers                 @Lord-Kamina
description                 Header-only C++14 library that gives you an embedded HTTP/Websocket server.
depends_build-append        port:boost port:openssl port:pcre port:zlib bin:doxygen:doxygen
depends_lib-append          port:asio \
                            port:http-parser \
                            path:include/fmt/format.h:libfmt \
                            path:include/fmt/ostream.h:libfmt \
                            path:include/fmt/time.h:libfmt
long_description            RESTinio is a header-only C++14 library that gives you an embedded \
                            HTTP/Websocket server. It is based on standalone version of ASIO and targeted \
                            primarily for asynchronous processing of HTTP-requests.
checksums                   rmd160  25472318f996b53032397064b80e7fa80231d42b \
                            sha256  c94b16faa285e344af0234508a84c587eb3c35bd28bca285531d6be63066d5c4
homepage                    https://stiffstream.com/en/products/restinio.html
                    
extract.suffix              .tar.gz
extract.cmd                 gzip
patchfiles                  patch-CMakeLists.txt.diff \
                            patch-http-parser-location.diff \
                            patch-Doxyfile.diff


cmake.source_dir            ${worksrcpath}/dev
cmake.build_type            Release

configure.env-append        ASIO_STANDALONE=1 \
                            ASIO_HAS_STD_CHRONO=1 \
                            ASIO_DISABLE_STD_STRING_VIEW=1 \
                            FMT_HEADER_ONLY=1 \
                            RAPIDJSON_HAS_STDSTRING=1 \
                            RAPIDJSON_HAS_CXX11_RVALUE_REFS=1
configure.pre_args-delete   -DCMAKE_POLICY_DEFAULT_CMP0025=NEW
configure.optflags-delete -Os

cmake.generator             Unix Makefiles

compiler.blacklist          *gcc-3.* *gcc-4.* {*gcc-5.[0-3]} \
                            {clang < 800} macports-clang-3.4 macports-clang-3.5 macports-clang-3.6 macports-clang-3.7
pre-destroot    {
    if {${destroot.target} ne "install"} {
        set files [glob -tails -directory ${worksrcpath}/dev/${github.project}/ ./*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ impl/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ path2regex/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ router/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ transforms/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ utils/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ utils/impl/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ websocket/*.hpp]
        lappend files {*}[glob -tails -directory ${worksrcpath}/dev/${github.project}/ websocket/impl/*.hpp]
        set instdir "${destroot}${prefix}/include/${github.project}"
        xinstall -m 644 -d ${instdir}/impl
        xinstall -m 644 -d ${instdir}/path2regex
        xinstall -m 644 -d ${instdir}/router
        xinstall -m 644 -d ${instdir}/transforms
        xinstall -m 644 -d ${instdir}/utils/impl
        xinstall -m 644 -d ${instdir}/websocket/impl
        foreach x ${files} {
            xinstall -m 644 "${worksrcpath}/dev/${github.project}/${x}" "${instdir}/${x}"
        }
    }
}

post-destroot {
    if {${destroot.target} ne "install"} {
        set docdir "${destroot}${prefix}/share/doc/${github.project}"
        xinstall -m 644 -d "${docdir}/html/search"
        system -W ${worksrcpath}/dev "${prefix}/bin/doxygen ${worksrcpath}/dev/Doxyfile"
        xinstall -m 644 "${worksrcpath}/README.md" "${docdir}"
        xinstall -m 644 "${worksrcpath}/LICENSE" "${docdir}"
        xinstall -m 644 {*}[glob "${worksrcpath}/dev/doc/html/*.*" "${docdir}/html"]
        xinstall -m 644 {*}[glob "${worksrcpath}/dev/doc/html/search/*.*" "${docdir}/html/search"]
    }
}

destroot.target             ""

subport http-parser {
    PortGroup               github 1.0
    
    github.setup            nodejs http-parser 2.8.1 v
    github.tarball_from     releases
    license                 MIT
    description             http request/response parser for C.
    long_description        This is a parser for HTTP messages written in C. It parses both requests and responses. \
                            The parser is designed to be used in performance HTTP applications. \
                            It does not make any syscalls nor allocations, it does not buffer data, it can be interrupted at anytime. \
                            Depending on your architecture, it only requires about 40 bytes of data per message stream (in a web server that is per connection).
    checksums               rmd160  c2b861bdc2faa06c5a18bbf7c689205cee5e73fe \
                            sha256  51615f68b8d67eadfd2482decc63b3e55d749ce0055502bbb5b0032726d22d96
    github.master_sites     https://github.com/${github.author}/${github.project}/archive/
    distname                ${github.tag_prefix}${github.version}
    extract.post_args       | tar -xf - && mv ${github.project}-${github.version} ${github.author}-${github.project}-${distname}
    depends_build
    depends_lib
    use_autoconf            no
    patchfiles              patch-http-parser-Makefile.diff
    use_configure           no
    
    pre-configure {
    set configure.pre_args  ""
    set configure.args      ""
    set configure.post_args ""
    }
    build.target            ""
    build.env-append        PREFIX=${prefix}
    build.args              DESTDIR=${prefix}
    build.dir               ${worksrcpath}
    destroot.env-append     PREFIX=${prefix}
    destroot.target         install
}

subport asio {
    PortGroup                   github 1.0
    
    github.setup                chriskohlhoff asio 1.12.0
    github.tarball_from         releases
    github.master_sites         https://github.com/${github.author}/${github.project}/archive/
    master_sites                ${github.master_sites}
    distname                    ${github.project}-[strsed ${github.version} {g/\./-/}]
    extract.post_args           | tar -xf - && mv ${github.project}-${distname} ${github.author}-${distname}
    license                     Boost-1
    description                 Asio C++ Library.
    long_description            Asio is a cross-platform C++ library for network and low-level I/O programming that provides developers with a \
                                consistent asynchronous model using a modern C++ approach.
    checksums                   rmd160  6cec8bc795c0611975bc93f63ca3faf375180f67 \
                                sha256  fa8c3a16dc2163f5b3451f2a14ce95277c971f46700497d4e94af6059c00dc06
    depends_build               path:bin/autoconf:autoconf path:bin/automake:automake
    depends_lib                 port:boost
    post-extract {
        autoconf.dir                ${worksrcpath}/${github.project}
        configure.dir               ${worksrcpath}/${github.project}
    }
    patchfiles
    use_autoconf                yes
    autoconf.cmd                ./autogen.sh
    configure.cmd               ./configure
    configure.cxxflags-append   -std=gnu++14
    
    pre-configure {
    set configure.pre_args      ""
    set configure.args          --prefix=${prefix}
    set configure.post_args     ""
    }
    
    configure.env-append        ASIO_STANDALONE=1 \
                                ASIO_HAS_STD_CHRONO=1 \
                                ASIO_DISABLE_STD_STRING_VIEW=1

    destroot.target             install
}

build.post_args-delete      VERBOSE=ON
