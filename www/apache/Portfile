PortSystem 1.0

portname		apache
portversion		1.3.26


categories		www
maintainers		mike+apacheport@gene-hacker.net
description		"The extremely popular Apache http server"


master_sites		http://www.apache.org/dist/httpd/
distname		${portname}_${portversion}
checksums		${distname}${extract_sufx} md5 52e9b875597a208fca9d393e710087b6

configure.args		--with-layout=FreeBSD --server-uid=www \
			--server-gid=www --logfiledir=${prefix}/var/httpd
			--runtimedir=${prefix}/var/run --enable-module=most \
			--enable-shared=max

post-build	{ reinplace s|PREFIX|${prefix}|g "${portpath}/files/apache.sh" }

post-install 	{ system "mkdir -p ${prefix}/var/log/httpd ${prefix}/var/run"
		  system "mkdir -p ${prefix}/etc/rc.d/ && \
		  install -bC -o 0 ${portpath}/files/apache.sh ${prefix}/etc/rc.d/ " }

include		contents

#static mod_perl apache
#mod_perl will seg-fault if Apache::Request and Apache::Cookie are used together
#if you need both, use the mod_perl_expt variant below.
variant mod_perl {
	master_sites-append	http://www.apache.org/dist/perl/:perl

	distname	${portname}_${portversion}
	distfiles	${distname}${extract_sufx} mod_perl-1.27${extract_sufx}:perl
	extract.only 	${distname}${extract_sufx} mod_perl-1.27${extract_sufx}

	checksums	${distname}${extract_sufx} md5 52e9b875597a208fca9d393e710087b6 \
			mod_perl-1.27${extract_sufx} md5 bd07f4f1065eb0d0a8d8004219357d8c

	depends_lib bin:perl5.8.0:Perl5.8
	worksrcdir mod_perl-1.27

	# APACI_ARGS all on one line because otherwise apache gets upset
	# if the shell is csh/tcsh
	configure { system "cd ${workpath}/${worksrcdir} && \
		    perl Makefile.PL USE_APACI=1 EVERYTHING=1 \
		    DO_HTTPD=1 APACHE_PREFIX=${prefix} \
		    APACHE_SRC=../${distname}/src \
		    APACI_ARGS='--with-layout=FreeBSD --server-uid=www --server-gid=www --logfiledir=${prefix}/var/httpd --runtimedir=${prefix}/var/run --enable-module=most --enable-shared=max --disable-shared=perl'" }

	post-build { system "cd ${workpath}/${worksrcdir} && make test"
		     reinplace s|PREFIX|${prefix}|g "${portpath}/files/apache.sh"
		   }

	include contents-mod_perl
}


#static mod_perl apache with the lightweight libapreq that works on Darwin/Mac OSX
#normal mod_perl will seg-fault if Apache::Request and Apache::Cookie are used together
variant mod_perl_expt {
				
	master_sites-append	http://www.apache.org/dist/perl/:perl \
					http://www.apache.org/~joes/:apreq

	distname		${portname}_${portversion}
	distfiles		${distname}${extract_sufx} mod_perl-1.27${extract_sufx}:perl \
				apreq${extract_sufx}:apreq
	extract.only 	${distname}${extract_sufx} mod_perl-1.27${extract_sufx} \
				apreq${extract_sufx}
				
	patch_sites http://www.apache.org/~joes/
	patchfiles apreq.patch

	checksums	${distname}${extract_sufx} md5 52e9b875597a208fca9d393e710087b6 \
			mod_perl-1.27${extract_sufx} md5 bd07f4f1065eb0d0a8d8004219357d8c \
			apreq${extract_sufx} md5 122f54f2f3ab6bf76370558d92a7e086 \
			apreq.patch md5 585180d82c20767d48c04fb2b7320aec
			
	depends_lib bin:perl5.8.0:Perl5.8
	worksrcdir mod_perl-1.27
		
	patch { system "cd ${workpath}/${distname} && cp ${distpath}/apreq.patch . \
		&& patch -p0 < apreq.patch" }

	configure { system "cd ${workpath}/${worksrcdir} && \
		    perl Makefile.PL USE_APACI=1 EVERYTHING=1 \
		    DO_HTTPD=1 APACHE_PREFIX=${prefix} \
		    APACHE_SRC=../${distname}/src \
		    APACI_ARGS='--with-layout=FreeBSD --server-uid=www --server-gid=www --logfiledir=${prefix}/var/httpd --runtimedir=${prefix}/var/run --enable-module=most --enable-shared=max --disable-shared=perl'" }

	post-build { system "cd ${workpath}/${worksrcdir} && make test"
		     reinplace s|PREFIX|${prefix}|g "${portpath}/files/apache.sh"
		   }

	post-install { system "cd ${workpath}/httpd-apreq && perl Makefile.PL"
		       system "cd ${workpath}/httpd-apreq  && make && make install"
		       system "mkdir -p ${prefix}/var/log/httpd ${prefix}/var/run ${prefix}/etc/rc.d/"
		       system "install -bC -o 0 ${portpath}/files/apache.sh  ${prefix}/etc/rc.d/ " }

	include contents-mod_perl_expt

}
