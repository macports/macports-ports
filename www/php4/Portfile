# $Id: Portfile,v 1.6 2003/08/17 19:10:08 fkr Exp $

PortSystem 1.0
name            php4
version         4.3.2
revision		1
categories      www
maintainers    	bchesneau@mac.com
description     PHP: Hypertext Preprocessor
long_description 	PHP is a widely-used general-purpose scripting language \
			that is especially suited for Web development and can be \
			embedded into HTML. 
platforms	darwin freebsd
distname	php-${version}
worksrcdir	php-${version}
master_sites 	http://fr.php.net/distributions/ \
		http://www.php.net/distributions/
checksums	php-4.3.2.tar.gz md5 8433a1d0ce679780990d4813ae094590

depends_lib	lib:libcurl.2:curl \
		lib:libiconv.2:libiconv \
		lib:libexpat.0.4:expat  \
		lib:libintl:gettext \
		lib:libjpeg.9:jpeg \
		lib:libpng3:libpng \
		lib:libmhash:mhash \
		lib:libz.1:zlib

set imapversion 2002d
				
configure.env	LDFLAGS=-L${prefix}/lib CPPFLAGS=-I${prefix}/include

configure.args	--mandir=${prefix}/share/man --infodir=${prefix}/share/info \
		--with-config-file-path=${prefix}/etc --enable-calendar \
		--with-iconv=${prefix} --enable-exif --enable-ftp --enable-wddx\
		--with-zlib --with-curl=${prefix} --with-gd --with-jpeg-dir=${prefix} \
		--with-png-dir=${prefix} --without-mysql --with-gettext=${prefix} \
		--with-mhash=${prefix} --with-expat-dir=${prefix} --with-iconv-dir=${prefix} \
		--with-xmlrpc --enable-filepro --enable-bcmath

variant darwin {
	depends_lib-append	lib:libdl.1:dlcompat
}

variant apache {
	depends_lib-append	path:${prefix}/apache-1.3.28/sbin/apxs:apache
	configure.args-append --with-apxs=${prefix}/apache-1.3.28/sbin/apxs
}

variant apache2 {
        depends_lib-append      path:${prefix}/apache2/bin/apxs:apache2
	configure.args-append --with-apxs2=${prefix}/apache2/bin/apxs
}

variant mysql {
	depends_lib-append	lib:libmysqlclient:mysql
	configure.args-append	--with-mysql=${prefix}
}

variant postgresql {
	configure.env-append	LDFLAGS=-L${prefix}/lib -L${prefix}/pgsql
					
	depends_lib-append	lib:plpgsql:postgresql
	configure.args-append	--with-pgsql=${prefix}/pgsql 
}

variant imap {
	master_sites-append 	ftp://ftp.cac.washington.edu/imap/:imap\
				http://distfiles.opendarwin.org/:imap
	distfiles-append	imap-${imapversion}.tar.Z:imap
	checksums-append	imap-2002d.tar.Z md5 64e82a195d21481fc4c54c4ed9fe0527

	extract.only		php-${version}.tar.gz imap-${imapversion}.tar.Z
	configure.args-append 	--with-imap=../imap-${imapversion} --with-imap-ssl=/usr
}

pre-configure {
	if { [variant_isset imap] } {
		system "cd ${workpath}/imap-${imapversion} && \
						make osx SSLTYPE=nopwd"
		system "cd ${workpath}/${worksrcdir}"
	}
}

destroot.args	prefix=${destroot}${prefix}
	
post-destroot	{
	file mkdir ${destroot}${prefix}/etc
	system "cp ${workpath}/${worksrcdir}/php.ini-dist ${destroot}${prefix}/etc/php.ini"
}
