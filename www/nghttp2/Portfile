# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           compiler_blacklist_versions 1.0
PortGroup           cxx11 1.1
PortGroup           github 1.0
PortGroup           legacysupport 1.0

github.setup        tatsuhiro-t nghttp2 1.38.0 v
revision            0
categories          www
platforms           darwin
maintainers         {mps @Schamschula} openmaintainer
license             MIT

description         nghttp2 is an implementation of HTTP/2 in C.

long_description    ${description} Included are a HTTP/2 client, server and proxy. The \
                    package also provides a load test and benchmarking tool for HTTP/2.

github.tarball_from releases
use_xz              yes

checksums           rmd160  887ea354383fa461d5c1fa18560d44288c0561c0 \
                    sha256  ef75c761858241c6b4372fa6397aa0481a984b84b7b07c4ec7dc2d7b9eee87f8 \
                    size    1628356

# nghttp2 requires C++14
compiler.blacklist-append {clang < 602}

depends_build       port:pkgconfig

depends_lib         port:c-ares \
                    port:jansson \
                    port:libev \
                    port:libevent \
                    port:libxml2 \
                    path:lib/libssl.dylib:openssl \
                    port:zlib

# See: https://trac.macports.org/ticket/57960
patchfiles-append   patch-configure-nopython.diff \
                    patch-src-shrpx_client_handler.cc.diff \
                    src-shrpx_config.diff

use_autoreconf      yes

configure.args      --disable-silent-rules \
                    --disable-threads \
                    --enable-app \
                    ac_cv_prog_AWK=/usr/bin/awk

configure.env       JANSSON_CFLAGS=-I${prefix}/include \
                    LIBEVENT_OPENSSL_CFLAGS=-I${prefix}/include/event2 \
                    OPENSSL_CFLAGS=-I${prefix}/include/openssl

if {[vercmp [macports_version] 2.5.99] >= 0} {
    configure.env-append \
                    "JANSSON_LIBS=-L${prefix}/lib -ljansson" \
                    "LIBEVENT_OPENSSL_LIBS=-L${prefix}/lib -levent -levent_openssl" \
                    "OPENSSL_LIBS=-L${prefix}/lib -lcrypto -lssl"
} else {
    configure.env-append \
                    JANSSON_LIBS="-L${prefix}/lib -ljansson" \
                    LIBEVENT_OPENSSL_LIBS="-L${prefix}/lib -levent -levent_openssl" \
                    OPENSSL_LIBS="-L${prefix}/lib -lcrypto -lssl"
}

if {[variant_isset python27]} { set PythonVersion   2.7 }
if {[variant_isset python36]} { set PythonVersion   3.6 }
if {[variant_isset python37]} { set PythonVersion   3.7 }

if {[variant_isset python27] || [variant_isset python36] || [variant_isset python37]} {
    set PythonBranch    [join [lrange [split ${PythonVersion} .] 0 1] ""]

    depends_lib-append \
                    port:py${PythonBranch}-cython \
                    port:py${PythonBranch}-setuptools \
                    port:python${PythonBranch}

    configure.env-append \
                    CYTHON=${prefix}/bin/cython-${PythonVersion} \
                    PYTHON=${prefix}/bin/python${PythonVersion}

    destroot.env        PYTHONPATH=${destroot}${prefix}/lib/python${PythonVersion}/site-packages/

    pre-destroot {
        xinstall -d ${destroot}${prefix}/lib/python${PythonVersion}/site-packages/
    }
} else {
    configure.args-append \
                    --disable-python-bindings \
                    --without-cython
}

variant python27 conflicts python35 python36 python37 description {Build using Python 2.7} {
    if {[vercmp [macports_version] 2.5.99] >= 0} {
    configure.env-append   "PYTHON_EXTRA_LDFLAGS=-u _PyMac_Error ${frameworks_dir}/Python.framework/Versions/${PythonVersion}/Python"
    } else {
    configure.env-append   PYTHON_EXTRA_LDFLAGS="-u _PyMac_Error ${frameworks_dir}/Python.framework/Versions/${PythonVersion}/Python"
    }
}

variant python35 conflicts python27 python36 python37 description {Build using Python 3.5 - obsolete} {
    ui_error "Please do not install this variant since it has been replaced by the python37 variant."
    return -code error

    # remove after 08/25/2019
}

variant python36 conflicts python27 python35 python37 description {Build using Python 3.6} {}

variant python37 conflicts python27 python35 python36 description {Build using Python 3.7} {}
