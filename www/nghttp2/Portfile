# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           github 1.0
PortGroup           legacysupport 1.0

github.setup        nghttp2 nghttp2 1.43.0 v
revision            1
categories          www
platforms           darwin
maintainers         {mps @Schamschula} openmaintainer
license             MIT

description         An implementation of HTTP/2 in C.
long_description    {*}${description}

homepage            https://${name}.org

github.tarball_from releases
use_xz              yes

checksums           rmd160  180e966e128d9ca097f9c469508168bc0ac5beee \
                    sha256  f7d54fa6f8aed29f695ca44612136fa2359013547394d5dffeffca9e01a26b0f \
                    size    3973500

depends_build       port:pkgconfig

# See: https://trac.macports.org/ticket/57960
patchfiles-append   patch-src-shrpx_client_handler.cc.diff \
                    patch-src-shrpx_downstream_connection_pool.cc.diff \
                    src-shrpx_config.diff

use_autoreconf      yes

compiler.cxx_standard   2014

configure.args      --disable-silent-rules \
                    --disable-threads \
                    --enable-lib-only \
                    --disable-python-bindings \
                    --without-cython \
                    ac_cv_prog_AWK=/usr/bin/awk

if {${subport} eq ${name}} {
    build.dir       ${worksrcpath}/lib
    destroot.dir    ${worksrcpath}/lib
}

subport nghttp2-tools {
    description         Tools for nghttp2, an implementation of HTTP/2 in C.
    long_description    HTTP/2 client, server and proxy tools, as well as a \
                        load test and benchmarking tool for HTTP/2.

    configure.args-replace \
                        --enable-lib-only --enable-app

    depends_lib         port:c-ares \
                        port:jansson \
                        port:libev \
                        port:libevent \
                        port:libxml2 \
                        path:lib/libssl.dylib:openssl \
                        port:zlib

    depends_run         port:nghttp2

    configure.env       JANSSON_CFLAGS=-I${prefix}/include \
                        LIBEVENT_OPENSSL_CFLAGS=-I${prefix}/include/event2 \
                        OPENSSL_CFLAGS=-I${prefix}/include/openssl

    configure.env-append \
                        "JANSSON_LIBS=-L${prefix}/lib -ljansson" \
                        "LIBEVENT_OPENSSL_LIBS=-L${prefix}/lib -levent -levent_openssl" \
                        "OPENSSL_LIBS=-L${prefix}/lib -lcrypto -lssl"

    post-destroot {
        # remove files contained in the main port
        delete ${destroot}${prefix}/lib
        delete ${destroot}${prefix}/include
    }
}

set pyversions {27 36 37 38 39}

foreach pyversion ${pyversions} {
    subport py${pyversion}-${name} {
        PortGroup           python 1.0

        python.version      ${pyversion}

        description         Python ${python.branch} bindings for nghttp2.
        long_description    ${description}
        categories          www python
        homepage            https://nghttp2.org/documentation/python-apiref.html

        use_configure       yes

    if {${python.version} < 38} {
            github.setup        nghttp2 nghttp2 1.42.0 v

            checksums   rmd160  621df8daf88dcf017c5b426be09d99ab5dd1857d \
                        sha256  c5a7f09020f31247d0d1609078a75efadeccb7e5b86fc2e4389189b1b431fe63 \
                        size    3973284

            if {${python.version} eq 27} {
                configure.env-append   "PYTHON_EXTRA_LDFLAGS=-u _PyMac_Error ${frameworks_dir}/Python.framework/Versions/${python.version}/Python"
            }
        }

        depends_build-append \
                    port:py${python.version}-cython

        depends_lib-append \
                    port:nghttp2 \
                    port:py${python.version}-setuptools \
                    port:python${python.version}

        configure.args-replace \
                        --disable-python-bindings --enable-python-bindings
        configure.args-replace \
                        --without-cython --with-cython

        configure.env-append \
                      CYTHON=${prefix}/bin/cython-${python.branch} \
                      PYTHON=${prefix}/bin/python${python.branch}

        destroot.env   PYTHONPATH=${destroot}${prefix}/lib/python${python.branch}/site-packages/

        build.dir      ${worksrcpath}/python
        destroot.dir   ${worksrcpath}/python

        build.env-append LDFLAGS=-L${prefix}/lib

        pre-build {
            system -W ${worksrcpath}/python "cython-${python.branch} nghttp2.pyx"
        }
    }
}
