# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                pear-install-phar
version             20110901
revision            3
categories          php www
license             BSD PHP-3 LGPL-2.1+
platforms           darwin
maintainers         pixilla
homepage            http://pear.php.net
master_sites        http://pear.php.net
livecheck.type      moddate

dist_subdir         ${name}-${version}
distfiles           install-pear-nozlib.phar

checksums           rmd160  1eef5e3a68b5521e2d42e68d031fd79828709923 \
                    sha256  06757ae34c93d4aad8a3abc63958106ca11bb1a9a5f85e7e013d70077e4aafa1

set buildpath       ${worksrcpath}/build
set libpath         /lib/php/pear

subport php5-pear {

    set dbpath          /var/db/php5
    depends_lib         port:php5
}

subport php53-pear {

    set dbpath          /var/db/php53
    depends_lib         port:php53
}

subport php54-pear {

    set dbpath          /var/db/php54
    depends_lib         port:php54
}

use_configure       no

if {${name} == ${subport}} {

    description         PEAR installer phar
    long_description    ${description}

    extract.mkdir       yes
    extract {

        xinstall -d ${buildpath}${libpath}
        file copy ${distpath}/install-pear-nozlib.phar ${buildpath}${libpath}
    }

    build {}
    destroot {

        xinstall -d ${destroot}${prefix}${libpath}
        file copy ${buildpath}${libpath}/install-pear-nozlib.phar ${destroot}${prefix}${libpath}
    }
} else {

    description         PEAR build and repository support for php
    long_description    ${description}

    distfiles

    build {

        xinstall -d ${buildpath}${dbpath}
        set fp [open ${buildpath}${dbpath}/pear-ini.php w]
        puts $fp "<?php"
        puts $fp "# Automatically add the PEAR repository path to PHP's include_path."
        puts $fp "set_include_path ( get_include_path (  ) . PATH_SEPARATOR . '${prefix}/lib/php/pear' ) ;"
        close $fp
    
        set fp [open ${buildpath}${dbpath}/pear.ini w]
        puts $fp "; Do not edit this file; it is automatically generated by MacPorts."
        puts $fp "; Any changes you make will be lost if you upgrade or uninstall ${subport}-pear."
        puts $fp "; To configure PHP, edit ${prefix}/etc/${subport}/php.ini."
        puts $fp "auto_prepend_file = '${prefix}${dbpath}/pear/pear-ini.php'"
        close $fp
    }

    destroot {

        xinstall -d ${destroot}${prefix}${dbpath}/pear
        file copy ${buildpath}${dbpath}/pear-ini.php ${destroot}${prefix}${dbpath}/pear/pear-ini.php
        file copy ${buildpath}${dbpath}/pear.ini ${destroot}${prefix}${dbpath}/pear.ini
    }
}
