# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               php 1.1

name                    php-imagick
categories-append       graphics
maintainers             {ryandesign @ryandesign} openmaintainer
license                 PHP-3.01

php.branches            5.3 5.4 5.5 5.6 7.0 7.1 7.2 7.3 7.4 8.0 8.1 8.2 8.3 8.4 8.5
php.pecl                yes

description             PHP extension to create and modify images with \
                        ImageMagick

long_description        Imagick is a native PHP extension for creating and \
                        modifying images using the ImageMagick API

if {[vercmp ${php.branch} >= 5.4]} {
    epoch               1
    version             3.8.0
    revision            2
    checksums           rmd160  79656fcf0900a1456ddc5555ac2c6eb6389dbf88 \
                        sha256  bda67461c854f20d6105782b769c524fc37388b75d4481d951644d2167ffeec6 \
                        size    363874
} else {
    # imagick 3.4.0RC1 dropped support for PHP 5.3.
    # https://pecl.php.net/package-info.php?package=imagick&version=3.4.0RC1
    epoch               2
    version             3.3.0
    revision            2
    checksums           rmd160  5746dc20ed455049a6eb5cea8dfe2b6c702c8f7c \
                        sha256  bd69ebadcedda1d87592325b893fa78a5710a0ca7307f8e18c5e593949b1db2d \
                        size    179978
}

patch.pre_args-replace  -p0 -p1
patchfiles-append       patch_zend-smart-string.diff

if {${name} ne ${subport}} {
    conflicts           [string map {-i -g} ${subport}]

    depends_build-append \
                        path:bin/pkg-config:pkgconfig

    variant ImageMagick7 conflicts ImageMagick6 description {Use ImageMagick7 libraries} {
        depends_lib-append  port:ImageMagick7

        configure.args      --with-imagick=${prefix}/lib/ImageMagick7
    }
    
    variant ImageMagick6 conflicts ImageMagick7 description {Use ImageMagick6 libraries} {
        depends_lib-append  port:ImageMagick

        configure.args      --with-imagick=${prefix}
    }

    post-destroot {
        set docdir ${prefix}/share/doc/${subport}
        xinstall -d ${destroot}${docdir} ${destroot}${prefix}/share/examples
        xinstall -m 0644 -W ${worksrcpath} CREDITS ${destroot}${subport}
        copy ${worksrcpath}/examples ${destroot}${prefix}/share/examples/${subport}
    }

    # https://trac.macports.org/ticket/69390
    if {![variant_isset ImageMagick7] && ![variant_isset ImageMagick6] } {
        if {[vercmp ${php.branch} >=  7.4]} {
            default_variants +ImageMagick7
        } else {
            default_variants +ImageMagick6
        }
    }

}
